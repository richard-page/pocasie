<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes, maximum-scale=6, viewport-fit=cover" />
<title>Počasie</title>
<link rel="icon" type="image/png" href="favicon.png" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg0:#0b0f14; --bg1:#0e1620; --panel:#152433; --stroke:#233448;
    --txt:#eaf3ff; --muted:#a8bed5; --accent:#3ad0e6;
    --r:14px; --shadow:0 10px 28px rgba(0,0,0,.28);
    --gap:8px;
  }
  *{box-sizing:border-box}
  html,body{min-height:100%; margin:0; padding:0}
  body{
    color:var(--txt);
    font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:linear-gradient(180deg,var(--bg1),var(--bg0));
    overflow-x:hidden; overflow-y:auto;
    -webkit-text-size-adjust:100%; -webkit-tap-highlight-color:transparent;
    min-height:100dvh;
  }
  .wrap{width:100%; max-width:1120px; margin-inline:auto; padding:16px 12px 28px}
  header h1{margin:0 0 10px; text-align:center; font-size:28px; letter-spacing:.3px}

  .toolbar{display:grid; grid-template-columns:1fr; gap:10px; margin:10px 0 12px}
  .searchCol{display:flex; flex-direction:column; gap:6px; position:relative}
  .search{
    width:100%; background:#152535; border:1px solid var(--stroke); color:#fff;
    border-radius:12px; padding:12px 14px; outline:none; font-size:16px; min-height:46px;
  }
  .search:focus{border-color:#2e4a67}
  #suggestions{
    display:none; gap:6px; position:absolute; top:calc(100% + 6px); left:0; right:0; z-index:40;
    background:#0f1c2a; border:1px solid var(--stroke); border-radius:12px; padding:8px; max-height:55vh; overflow:auto;
  }
  .sugg{background:#13263a; border:1px solid var(--stroke); border-radius:10px; padding:10px 12px; cursor:pointer}

  .pill{
    background:#1b2c3d; border:1px solid var(--stroke); color:#dfeaff; border-radius:12px;
    padding:10px 12px; font-weight:600; cursor:pointer; min-height:40px; font-size:14px; text-align:center
  }
  .pill.active{background:var(--accent); border-color:#2abbd0; color:#002a32}

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid var(--stroke); border-radius:var(--r); box-shadow:var(--shadow); padding:14px;
  }
  .card h3{margin:0 0 10px; text-align:center; font-size:18px}

  #place{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-align:left; margin:0}

  .row{display:grid; grid-template-columns:1fr; gap:12px; margin-top:4px}
  .meta{display:grid; grid-template-columns:1fr; gap:8px; color:var(--muted); font-size:14px}
  .meta strong{color:#fff}

  .chipRow{display:flex; flex-direction:column; gap:10px; align-items:flex-start}
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    background:#143344; border:1px solid var(--stroke); color:#d8f7ff; border-radius:999px;
    padding:8px 14px; font-size:13px; line-height:1;
  }
  @media (min-width:900px){ .chipRow{flex-direction:row; flex-wrap:wrap} }

  .tempNow{font-size:44px; font-weight:700; line-height:1; margin:6px 0}
  .icon{width:64px; height:64px; display:flex; align-items:center; justify-content:center; font-size:48px}
  .gridInfo{display:grid; grid-template-columns:1fr auto; gap:14px; align-items:start}

  .chartWrap{height:220px}
  canvas{background:#0f1c2a; border:1px solid var(--stroke); border-radius:12px}

  .summarySection{margin-top:12px}
  .summarySection h3{margin-bottom:8px}
  #summary{margin:0 auto; max-width:720px; color:#dbeeff; background:#0f1c2a; border:1px solid var(--stroke); border-radius:10px; padding:12px; text-align:center}

  .histRow{display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap}
  .badge{display:inline-block; padding:6px 10px; border-radius:10px; font-weight:700}
  .badge.max{background:#ff5e5e; color:#fff}
  .badge.min{background:#ffd265; color:#2b2300}
  .histSub{color:#a8bed5; font-size:12px; margin-top:6px; text-align:center}

  footer{padding:14px 10px; text-align:center; color:#cfe8ff; font-size:14px; border-top:1px solid rgba(255,255,255,.12)}

  .colset{
    --cols:4;
    display:grid; gap:var(--gap);
    grid-auto-flow:column;
    grid-auto-columns: calc((100% - (var(--cols) - 1)*var(--gap)) / var(--cols));
    overflow-x:auto; overflow-y:hidden;
    scrollbar-gutter:stable both-edges;
    -webkit-overflow-scrolling:touch;
    touch-action:pan-y;
    overscroll-behavior-x:contain;
    cursor:grab;
    padding-bottom:8px;
  }
  .colset.dragging{cursor:grabbing; user-select:none}

  .col{
    background:var(--panel); border:1px solid var(--stroke); border-radius:12px; padding:10px;
    display:grid; grid-template-rows:auto auto auto auto auto auto; align-items:center; justify-items:center;
    text-align:center; min-height:176px; contain:content; position:relative;
  }
  .c-top{opacity:.9; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .c-row{
    color:#cfe6ff; font-size:11.5px; line-height:1.25; margin-top:6px;
    white-space:normal; overflow:visible; text-overflow:clip; word-break:break-word;
  }
  .c-max{font-size:26px; font-weight:700; color:#ff6c6c; margin-top:6px; line-height:1}
  .c-min{font-size:16px; color:#ffbb7c; margin-top:2px; line-height:1}
  .c-ico{font-size:26px; margin-top:6px}

  .rain-badge{
    position:absolute; top:6px; right:6px; font-size:18px; line-height:1;
    filter:drop-shadow(0 1px 2px rgba(0,0,0,.6));
    background:rgba(13,24,36,.6);
    border:1px solid rgba(255,255,255,.1);
    border-radius:10px; padding:2px 6px;
  }
  @media (max-width:720px){
    .rain-badge{top:auto; bottom:6px; right:6px}
  }

  .colset::-webkit-scrollbar{height:12px}
  .colset::-webkit-scrollbar-track{background:#0f1c2a; border-radius:8px}
  .colset::-webkit-scrollbar-thumb{background:#33516f; border-radius:8px}
  .colset::-webkit-scrollbar-thumb:hover{background:#3f6b94}
  .colset{scrollbar-width:thin; scrollbar-color:#33516f #0f1c2a}

  @media (min-width:900px){
    #parts.colset{--cols:4}
    #days.colset{--cols:7}
    #min15.colset{--cols:6}
  }

  @media (min-width:780px){
    .wrap{padding:22px 16px 36px}
    .row{grid-template-columns:1.05fr 1fr; gap:16px}
    .meta{grid-template-columns:repeat(2,minmax(0,1fr))}
    .chartWrap{height:260px}
  }
  @media (min-width:1100px){ .chartWrap{height:300px} }
</style>
</head>

<body>
  <div class="wrap">
    <header><h1>Počasie</h1></header>

    <div class="toolbar">
      <div class="searchCol">
        <input id="q" class="search" type="text" placeholder="Hľadaj mesto (napr. Bratislava, Košice)" />
        <div id="suggestions"></div>
      </div>
    </div>

    <div class="row">
      <section class="card">
        <div class="gridInfo">
          <div>
            <h3 id="place">—</h3>
            <div class="tempNow" id="temp">—°</div>

            <div class="chipRow">
              <span class="chip" id="uv">UV index —</span>
              <span class="chip" id="aqi">Kvalita ovzdušia —</span>
            </div>

            <div class="meta" style="margin-top:8px">
              <div>Pocitová teplota: <strong id="apparent">—</strong></div>
              <div>Vietor: <strong id="wind">—</strong></div>
              <div>Vlhkosť: <strong id="hum">—</strong></div>
              <div>Tlak: <strong id="press">—</strong></div>
              <div>Východ slnka: <strong id="sunrise">—</strong></div>
              <div>Západ slnka: <strong id="sunset">—</strong></div>
            </div>
          </div>
          <div id="icon" class="icon">—</div>
        </div>

        <div class="summarySection">
          <h3>Dnešný súhrn</h3>
          <p id="summary">—</p>
        </div>
      </section>

      <section class="card">
        <h3>Teplota počas 24 hodín</h3>
        <div class="chartWrap"><canvas id="hourly"></canvas></div>
      </section>
    </div>

    <section class="card" style="margin-top:12px">
      <h3>Dnešná predpoveď</h3>
      <div id="parts" class="colset"></div>
    </section>

    <section class="card" style="margin-top:12px">
      <h3 style="margin-bottom:8px">7-dňová predpoveď</h3>
      <div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <button class="pill" id="tab-ecmwf">ECMWF IFS</button>
        <button class="pill" id="tab-icon">DWD ICON</button>
        <button class="pill" id="tab-gfs">NOAA GFS</button>
      </div>
      <div id="days" class="colset"></div>
    </section>

    <section class="card" style="margin-top:12px">
      <h3>15-minútová predpoveď (24 h)</h3>
      <div id="min15" class="colset"></div>
    </section>

    <section class="card" style="margin-top:12px">
      <div class="head" style="text-align:center">
        <h3>Počasie presne pred rokom</h3>
        <div id="hist-date" style="color:var(--muted);font-size:12px">—</div>
      </div>
      <div class="histRow" style="margin-top:6px">
        <div id="hist-emoji" style="font-size:26px">—</div>
        <div style="font-weight:700" id="hist-text">—</div>
        <span class="badge max" id="hist-max">—</span>
        <span class="badge min" id="hist-min">—</span>
      </div>
      <div class="histSub" id="hist-extra">—</div>
    </section>
  </div>

  <footer>&copy; <span id="year"></span> Richard / Počasie</footer>

  <script>
    const APP_VERSION = '2025-08-14-rain-badge-mobile-fix';
    const $ = s => document.querySelector(s);

    const NBSP_NARROW = '\u202F';
    const fmt0 = (v,u='') => (v==null || Number.isNaN(v)) ? '—' : (Math.round(v) + u);
    const fmt1 = (v,u='') => (v==null || Number.isNaN(v)) ? '—' : ((Math.round(v*10)/10).toFixed(1) + u);

    const WMO = {0:['Jasno'],1:['Prevažne jasno'],2:['Polojasno'],3:['Zamračené'],
      45:['Hmla'],48:['Mrznúca hmla'],51:['Slabé mrholenie'],53:['Mrholenie'],55:['Silné mrholenie'],
      61:['Slabý dážď'],63:['Dážď'],65:['Lejak'],66:['Mrznúci dážď'],67:['Mrznúci dážď'],
      71:['Slabé sneženie'],73:['Sneženie'],75:['Silné sneženie'],77:['Snehové zrná'],
      80:['Prehánky'],81:['Prehánky'],82:['Silné prehánky'],85:['Snehové prehánky'],86:['Silné snehové prehánky'],
      95:['Búrky'],96:['Búrky s krúpami'],99:['Silné búrky s krúpami']};

    const RAIN_CODES = new Set([51,53,55,61,63,65,66,67,80,81,82,95,96,99]);

    const uvCat = u => u<3?'nízky':u<6?'mierny':u<8?'vysoký':u<11?'veľmi vysoký':'extrémny';

    const wmoEmoji = (code, night=false)=>{
      const k = Number(code);
      if ([0,1].includes(k)) return night ? '🌙' : '☀️';
      if (k===2) return night ? '🌙' : '⛅';
      if (k===3) return '☁️';
      if ([45,48].includes(k)) return '🌫️';
      if ([51,53,55].includes(k)) return '🌦️';
      if ([61,63,65,80,81,82].includes(k)) return '🌧️';
      if ([71,73,75,77,85,86].includes(k)) return '❄️';
      if ([95,96,99].includes(k)) return '⛈️';
      return night ? '🌙' : '🌤️';
    };

    function willRain({code=null, precip=null, temp=null, prob=null}={}){
      if (prob!=null && prob > 0) return true;
      if (code!=null && RAIN_CODES.has(Number(code))) return true;
      if (precip!=null && precip > 0){
        if (temp==null) return true;
        return temp>1;
      }
      return false;
    }
    function addRainBadge(el){
      el.insertAdjacentHTML('beforeend', `<div class="rain-badge" aria-label="Zrážky" title="Zrážky">💧</div>`);
    }

    function isNightAt(dtLike, daily){
      const dt = typeof dtLike==='string' ? new Date(dtLike) : dtLike;
      try{
        const dayStr = dt.toISOString().slice(0,10);
        const i = daily?.time?.indexOf(dayStr);
        if (i>=0 && daily.sunrise?.[i] && daily.sunset?.[i]){
          const sr = new Date(daily.sunrise[i]);
          const ss = new Date(daily.sunset[i]);
          return (dt < sr || dt >= ss);
        }
      }catch(_){}
      const h = dt.getHours();
      return (h<6 || h>=21);
    }

    const pad = n => String(n).padStart(2,'0');
    const localHourKey = (date)=>{
      const d = typeof date==='string' ? new Date(date) : new Date(date);
      return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) + 'T' + pad(d.getHours());
    };

    function valueAtHourLocal(timesISO, arr, date){
      const key = localHourKey(date);
      let idx = timesISO.findIndex(t => t.slice(0,13) === key);
      if (idx >= 0) return arr[idx];
      let best=0, bestDiff=1e18;
      timesISO.forEach((t,i)=>{ const diff=Math.abs(new Date(t)-new Date(date)); if(diff<bestDiff){best=i;bestDiff=diff;} });
      return arr[best];
    }

    const lerp=(a,b,t)=>a+(b-a)*t;
    function valueAt15min(timesISO, arr, date){
      const ts=timesISO.map(t=>new Date(t));
      for(let i=0;i<ts.length-1;i++){
        const t0=ts[i], t1=ts[i+1];
        if(date>=t0 && date<=t1){
          const r=(date-t0)/(t1-t0), v0=arr[i], v1=arr[i+1];
          if(v0==null || v1==null) return null;
          return lerp(v0,v1,r);
        }
      }
      return null;
    }
    function codeAt15min(timesISO, codes, date){
      const ts=timesISO.map(t=>new Date(t));
      for(let i=0;i<ts.length-1;i++){
        const t0=ts[i], t1=ts[i+1];
        if(date>=t0 && date<=t1){ return (date < new Date((t0.getTime()+t1.getTime())/2)) ? codes[i] : codes[i+1]; }
      }
      return codes[codes.length-1] ?? 0;
    }

    function pickDayCondition(d){
      const times=d.hourly?.time||[], codes=d.hourly?.weather_code||[];
      const day=(d.current?.time||'').slice(0,10); let startH=9,endH=18;
      const sr=d.daily?.sunrise?.[0], ss=d.daily?.sunset?.[0];
      if(sr && ss){
        const sh=new Date(sr).getHours(), eh=new Date(ss).getHours();
        if(!Number.isNaN(sh) && !Number.isNaN(eh) && sh<eh){startH=sh;endH=eh;}
      }
      const freq=new Map();
      for(let i=0;i<times.length;i++){
        if(!times[i].startsWith(day)) continue;
        const h=Number(times[i].slice(11,13)); if(h<startH || h>endH) continue;
        const c=(codes[i]??0); freq.set(c,(freq.get(c)||0)+1);
      }
      let best=d.daily?.weather_code?.[0] ?? codes[0] ?? 0, bestCnt=-1;
      freq.forEach((cnt,code)=>{ if(cnt>bestCnt){bestCnt=cnt;best=code;} });
      return best;
    }

    const aqiCat = (v)=>{
      if(v==null||Number.isNaN(v)) return '—';
      if(v<=50) return 'dobrá'; if(v<=100) return 'mierne zhoršená';
      if(v<=150) return 'riziková'; if(v<=200) return 'zlá';
      if(v<=300) return 'veľmi zlá'; return 'nebezpečná';
    };

    let state={place:'—', lat:48.1486, lon:17.1077, last:null};
    let hourlyChart=null, activeModel='ecmwf';
    const LS_KEY='wx_prefs_v3';

    try{
      const raw=localStorage.getItem(LS_KEY);
      if(raw){
        const p=JSON.parse(raw);
        if(+p.lat && +p.lon && p.place){ state={...state, ...p}; }
      }
    }catch(_){}
    const savePrefs=()=>{ try{ localStorage.setItem(LS_KEY, JSON.stringify({lat:state.lat, lon:state.lon, place:state.place})); }catch(_){} };

    async function reverseGeocodeOpenMeteo(lat, lon){
      try{
        const url = `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=sk&format=json`;
        const j = await fetch(url).then(r=>r.json());
        const r = j?.results?.[0];
        if (r){
          const name = r.name || r.city || r.town || r.village || '';
          const admin = r.admin1 ? `, ${r.admin1}` : '';
          const cc = r.country_code ? `, ${r.country_code}` : '';
          if (name) return `${name}${admin}${cc}`;
          if (r.admin1) return `${r.admin1}${cc}`;
        }
      }catch(_){}
      return null;
    }
    async function reverseGeocodeNominatim(lat, lon){
      try{
        const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=sk`;
        const res = await fetch(url, {headers:{'Accept':'application/json'}});
        const data = await res.json();
        const a = data.address || {};
        const name = a.city || a.town || a.village || a.municipality || a.hamlet || a.suburb || '';
        const admin = a.state || a.county || a.region || '';
        const cc = a.country_code ? `, ${a.country_code.toUpperCase()}` : '';
        if (name) return `${name}${admin?`, ${admin}`:''}${cc}`;
        if (admin) return `${admin}${cc}`;
      }catch(_){}
      return null;
    }
    async function reverseGeocode(lat, lon){
      const a = await reverseGeocodeOpenMeteo(lat, lon);
      if (a) return a;
      const b = await reverseGeocodeNominatim(lat, lon);
      if (b) return b;
      return 'Moja poloha';
    }

    async function setLocation(lat,lon,labelOpt){
      state.lat=lat; state.lon=lon;
      state.place = labelOpt || await reverseGeocode(lat, lon) || 'Moja poloha';
      savePrefs();
      await fetchWeather().catch(e=>alert(e.message));
    }

    function initGeolocation(){
      if(!('geolocation'in navigator)){ fetchWeather().catch(()=>{}); return; }
      const placeEl=$('#place'); placeEl.textContent='Zisťujem polohu…';
      navigator.geolocation.getCurrentPosition(async pos=>{
        const {latitude, longitude} = pos.coords;
        await setLocation(latitude, longitude);
      }, _=>{
        fetchWeather().catch(()=>{});
      }, {enableHighAccuracy:true, timeout:10000, maximumAge:300000});
    }

    async function fetchWeather(){
      const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;
      const p=new URLSearchParams({
        latitude:state.lat, longitude:state.lon, timezone:tz,
        current:'temperature_2m,apparent_temperature,relative_humidity_2m,pressure_msl,wind_speed_10m,weather_code,uv_index',
        hourly:'temperature_2m,precipitation,weather_code,wind_speed_10m',
        daily:'weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,precipitation_sum,uv_index_max,wind_speed_10m_max,sunrise,sunset',
        forecast_days:'3'
      });
      const r=await fetch(`https://api.open-meteo.com/v1/forecast?${p}&v=${APP_VERSION}`);
      state.last=await r.json();
      renderAll(); drawHourly(); await fetchAQ().catch(()=>{}); fetchModels(activeModel); fetchHistory().catch(()=>{});
    }

    function renderAll(){
      const d=state.last, cur=d.current;
      $('#place').textContent=state.place;
      $('#temp').textContent=fmt0(cur.temperature_2m,'°');
      $('#apparent').textContent=fmt0(cur.apparent_temperature,'°');
      $('#wind').textContent=fmt1(cur.wind_speed_10m, NBSP_NARROW+'km/h');
      $('#hum').textContent=fmt0(cur.relative_humidity_2m, NBSP_NARROW+'%');
      $('#press').textContent=fmt0(cur.pressure_msl, NBSP_NARROW+'hPa');
      $('#icon').textContent=wmoEmoji(cur.weather_code, isNightAt(cur.time, d.daily));

      const uvi=(cur.uv_index ?? d.daily?.uv_index_max?.[0] ?? null);
      $('#uv').textContent = uvi!=null ? `UV index ${fmt1(uvi)} • ${uvCat(uvi)}` : 'UV index —';

      const dd=d.daily, tmax=dd.temperature_2m_max[0], tmin=dd.temperature_2m_min[0], ps=dd.precipitation_sum[0], pp=dd.precipitation_probability_max?.[0], wmax=dd.wind_speed_10m_max[0];
      const condToday=(WMO[pickDayCondition(d)]?.[0])||'—';
      const rainTxt = ps < 0.1 ? (pp && pp>20 ? `bez výrazných zrážok (pravdepodobnosť ${pp}%)` : 'bez zrážok') : `zrážky do ${fmt1(ps, NBSP_NARROW+'mm')}`;
      const uvTxt = dd.uv_index_max?.[0]!=null ? `UV ${uvCat(dd.uv_index_max[0])} (max ${fmt1(dd.uv_index_max[0])})` : 'UV údaj nedostupný';
      $('#summary').innerHTML=`Dnes <strong>${condToday.toLowerCase()}</strong>, max <strong>${fmt0(tmax,'°')}</strong>, min <strong>${fmt0(tmin,'°')}</strong>, ${rainTxt}, vietor do <s

<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Predpoveƒè poƒçasia</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{
    --glass: rgba(255,255,255,.08);
    --glass-b: rgba(255,255,255,.18);
    --hero-icon: 70px;
    --hero-temp: 4rem;
  }

  /* BOX SIZING */
  *{ box-sizing:border-box !important; }
  html,body{
      width:100% !important;
      max-width:100% !important;
      overflow-y: auto !important;
      overflow-x: hidden !important;
      scrollbar-width: none;
      -ms-overflow-style: none;
  }

  /* Skrytie scrollbaru */
  html::-webkit-scrollbar,
  body::-webkit-scrollbar {
      display: none;
  }

  body{
    margin:0; color:#fff;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    background:#0e4d73;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
  }
  .glass{ background:var(--glass); border:1px solid var(--glass-b); backdrop-filter:blur(12px); border-radius:1rem }
  .mono{ font-feature-settings:"tnum" 1,"lnum" 1 }

  /* Bezpeƒçn√© oblasti pre mobiln√© zariadenia */
  .safe-top { padding-top: env(safe-area-inset-top); }
  .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

  .hero{
    position:relative; isolation:isolate;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    width:100%;
    padding:1rem 1rem 0.5rem;
    text-align:center;
    overflow:hidden;
    min-height: 200px;
  }

  body[data-mode="day"] .hero{ background:#176ea9 }
  body[data-mode="night"] .hero{ background:#08273b }
  body[data-mode="night"] .hero::after{
    content:""; position:absolute; inset:0; z-index:-1; pointer-events:none; opacity:.45;
    background:
      radial-gradient(2px 2px at 12% 18%, #fff 40%, transparent 42%),
      radial-gradient(1.5px 1.5px at 35% 28%, #fff 45%, transparent 47%),
      radial-gradient(1.8px 1.8px at 66% 14%, #fff 45%, transparent 47%),
      radial-gradient(1.8px 1.8px at 82% 40%, #fff 45%, transparent 47%),
      radial-gradient(1.8px 1.8px at 18% 65%, #fff 45%, transparent 47%),
      radial-gradient(1.8px 1.8px at 58% 73%, #fff 45%, transparent 47%),
      radial-gradient(1.8px 1.8px at 88% 78%, #fff 45%, transparent 47%),
      radial-gradient(1.6px 1.6px at 44% 86%, #fff 45%, transparent 47%)
  }

  #heroPlace{
      font-size:1.1rem; font-weight:600; opacity:.95; letter-spacing:.2px;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:90%;
      margin-bottom: 0.5rem;
  }
  #heroIcon{ width:var(--hero-icon); height:var(--hero-icon); margin:.2rem auto; font-size:calc(var(--hero-icon) - 10px); line-height:var(--hero-icon) }
  #heroTemp{ font-size:var(--hero-temp); line-height:1; font-weight:700; letter-spacing:1px; margin-bottom: 0.5rem; }

  .sticky-header{ position:sticky; top:0; z-index:40; background:rgba(14, 77, 115, 0.9); backdrop-filter:blur(10px); }
  .tbl th,.tbl td{ padding:.5rem .6rem; white-space:nowrap; font-size:0.9rem; }
  .tbl thead th{ position:sticky; top:0; background:rgba(0,0,0,.15); backdrop-filter:blur(6px) }
  .val-bold{ font-weight:600; color:#fff }

  .tabs-nav{ display:grid; grid-template-columns:1fr 1fr; background:rgba(0,0,0,.2); padding:.2rem; border-radius:1rem; margin:0.5rem 0; }
  .tab-btn{ padding:.5rem .8rem; border-radius:.75rem; font-weight:600; text-align:center; background:none; border:0; color:#fff; cursor:pointer; transition:background .2s ease; font-size:0.9rem; }
  .tab-btn[aria-selected="true"]{ background:#fff; color:#0b1720; box-shadow:0 2px 8px rgba(0,0,0,.2) }
  .tab-content{ padding-top:0.5rem; }
  .tab-content.hidden{ display:none }

  .card{ border-radius:1rem; border:1px solid var(--glass-b); background:var(--glass); margin-bottom:0.5rem; }
  .acc-btn{ width:100%; background:none; border:0; cursor:pointer; padding:.7rem .8rem; display:flex; align-items:center; gap:.5rem; text-align:left; color:#fff }
  .acc-head{ flex:1; min-width:0 }
  .acc-right{ margin-left:auto; display:flex; gap:.3rem; white-space:nowrap; align-items:center; }
  .chev{ transition:transform .22s ease; flex-shrink: 0; }
  .acc-btn[aria-expanded="true"] .chev{ transform:rotate(180deg) }
  .panel-wrap{ height:0; overflow:hidden; transition:height .22s ease }
  .panel{ padding:0 .8rem .8rem .8rem; }

  .suggest-wrap{ position:relative; }
  .suggest{
    position:absolute; top:100%; left:0; right:0; margin-top:.25rem;
    background:#fff; color:#0b1720; border-radius:.75rem; border:1px solid rgba(0,0,0,.08);
    box-shadow:0 10px 25px rgba(0,0,0,.25); overflow:auto; max-height:16rem; z-index:50;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  .suggest::-webkit-scrollbar { display: none; }
  .suggest.hidden{ display:none }
  .suggest-item{ display:flex; align-items:center; gap:.5rem; padding:.4rem .6rem; cursor:pointer; font-size:0.9rem; }
  .suggest-item:hover,.suggest-item[aria-selected="true"]{ background:#eef6ff }
  .flag{ width:16px; flex:0 0 16px; }
  .s-meta{ font-size:.75rem; color:#425466 }
  .s-name{ font-weight:600; }

  #ptr{ position:sticky; top:0; height:0; overflow:visible; z-index:45; }
  #ptr .spinner{
    margin:.25rem auto 0; width:30px; height:30px; border-radius:9999px;
    border:3px solid rgba(255,255,255,.28); border-top-color:#fff;
    animation:spin 1s linear infinite; opacity:0; transform:scale(.8); transition:opacity .15s ease, transform .15s ease;
  }
  #ptr.active .spinner{ opacity:1; transform:scale(1) }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  .overflow-x-auto::-webkit-scrollbar { display: none; }
  .overflow-x-auto { scrollbar-width: none; -ms-overflow-style: none; }

  /* Kompaktn√Ω dizajn pre mal√© obrazovky */
  @media (max-width: 640px) {
    :root {
      --hero-icon: 60px;
      --hero-temp: 3.5rem;
    }
    
    .hero {
      padding: 0.5rem 1rem 0.25rem;
      min-height: 160px;
    }
    
    #heroPlace { font-size: 1rem; max-width: 85%; }
    #heroTemp { font-size: var(--hero-temp); margin-bottom: 0.25rem; }
    
    .glass { border-radius: 0.8rem; }
    .card { border-radius: 0.8rem; margin-bottom: 0.4rem; }
    
    .acc-btn { padding: 0.6rem 0.7rem; }
    .panel { padding: 0 0.7rem 0.7rem 0.7rem; }
    
    .tabs-nav { margin: 0.3rem 0; }
    .tab-btn { padding: 0.4rem 0.6rem; font-size: 0.85rem; }
  }

  @media (max-width: 380px) {
    :root {
      --hero-icon: 50px;
      --hero-temp: 3rem;
    }
    
    .hero { min-height: 140px; }
    #heroPlace { font-size: 0.9rem; }
  }

  /* Zv√Ωraznenie d√¥le≈æit√Ωch prvkov */
  .current-weather { background: linear-gradient(135deg, #1e88e5, #1565c0); }
  .important-card { background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2); }
</style>
</head>
<body data-mode="day">

<!-- Hlavn√Ω hero section - kompaktnej≈°√≠ -->
<section class="hero safe-top">
  <div id="heroPlace">‚Äî</div>
  <div id="heroIcon" aria-hidden="true">‚õÖ</div>
  <div id="heroTemp" class="mono">--¬∞</div>
</section>

<!-- Hlaviƒçka s vyhƒæad√°van√≠m -->
<header class="sticky-header">
  <div class="w-full px-3 py-2">
    <div class="suggest-wrap w-full max-w-full mx-auto">
      <form id="searchForm" class="flex gap-2" novalidate>
        <input id="cityInput" placeholder="Zadaj mesto"
               class="flex-1 px-3 py-2 rounded-lg bg-white/20 border border-white/20 placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50 text-white"
               autocomplete="off" inputmode="search" type="search" />
        <button id="searchBtn" type="submit"
                class="px-4 py-2 rounded-lg bg-white/30 hover:bg-white/40 text-white font-medium transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </button>
      </form>
      <div id="citySuggestions" class="suggest hidden"></div>
    </div>
  </div>
</header>

<div id="ptr"><div class="spinner"></div></div>

<!-- Hlavn√Ω obsah -->
<main id="refreshContainer" class="w-full px-2 pb-4 safe-bottom space-y-2">

  <!-- Tab sekcia -->
  <section class="glass p-3">
    <div class="tabs-nav">
        <button id="tab24hBtn" class="tab-btn" aria-selected="true" data-tab="hourly">24h</button>
        <button id="tab10dBtn" class="tab-btn" aria-selected="false" data-tab="daily">10 dn√≠</button>
    </div>

    <div id="hourlyContent" class="tab-content" data-tab-content="hourly">
        <div class="hidden lg:block overflow-x-auto">
            <table class="tbl w-full min-w-[800px] text-sm">
                <thead>
                    <tr class="text-white/90">
                        <th>ƒåas</th><th>Poƒçasie</th><th>Teplota</th><th>Zr√°≈æky</th><th>Vietor</th>
                    </tr>
                </thead>
                <tbody id="hourRows" class="divide-y divide-white/10"></tbody>
            </table>
        </div>
        <div id="hourList" class="block lg:hidden space-y-1"></div>
    </div>
    
    <div id="dailyContent" class="tab-content hidden" data-tab-content="daily">
        <div id="dailyList" class="space-y-1"></div>
    </div>
  </section>

  <!-- D√¥le≈æit√© inform√°cie - kompaktnej≈°ie -->
  <section class="grid grid-cols-2 gap-2">
    <div class="glass p-3 text-center important-card">
      <div class="text-white/70 text-sm mb-1">UV index</div>
      <div id="uvNow" class="mono font-semibold text-lg">‚Äî</div>
      <div class="text-white/60 text-xs">max: <span id="uvMax">‚Äî</span></div>
    </div>

    <div class="glass p-3 text-center important-card">
      <div class="text-white/70 text-sm mb-1">Pred rokom</div>
      <div id="historyTemp" class="mono font-semibold text-lg">‚Äî</div>
      <div class="text-white/60 text-xs" id="historyPrecip">‚Äî</div>
    </div>
  </section>

  <!-- Stav naƒç√≠tania a chyby -->
  <div id="loading" class="hidden text-center py-6">
    <div class="inline-block w-6 h-6 border-3 border-white/30 border-t-white rounded-full animate-spin"></div>
    <p class="mt-2 text-white/80">Naƒç√≠tavam‚Ä¶</p>
  </div>
  
  <div id="err" class="hidden glass p-3 border-red-500 border bg-red-800/20">
    <div class="text-center text-red-100 font-medium flex items-center justify-center gap-2 text-sm">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      Nepodarilo sa naƒç√≠ta≈• √∫daje
    </div>
  </div>
  
  <!-- P√§ta -->
  <div class="pt-1 text-white/40 text-xs text-center">
    √ödaje poskytuje <a href="https://open-meteo.com/" target="_blank" rel="noopener noreferrer" class="hover:text-white/60 underline">Open-Meteo</a>
  </div>
  
</main>

<script>
const API='https://api.open-meteo.com/v1';
const GEO='https://geocoding-api.open-meteo.com/v1';
const ARCH='https://archive-api.open-meteo.com/v1/era5';
const NOMINATIM_API = 'https://nominatim.openstreetmap.org/reverse?format=json&extratags=1&addressdetails=1&zoom=14&accept-language=sk';

const el={
  form:document.getElementById('searchForm'),
  input:document.getElementById('cityInput'),
  suggest:document.getElementById('citySuggestions'),
  hourRows:document.getElementById('hourRows'),
  hourList:document.getElementById('hourList'),
  dailyList:document.getElementById('dailyList'),
  historyTemp:document.getElementById('historyTemp'),
  historyPrecip:document.getElementById('historyPrecip'),
  uvNow:document.getElementById('uvNow'),
  uvMax:document.getElementById('uvMax'),
  heroPlace:document.getElementById('heroPlace'),
  heroIcon:document.getElementById('heroIcon'),
  heroTemp:document.getElementById('heroTemp'),
  loading:document.getElementById('loading'),
  err:document.getElementById('err'),
  ptr:document.getElementById('ptr'),
  refreshContainer:document.getElementById('refreshContainer'),
  tab24hBtn: document.getElementById('tab24hBtn'),
  tab10dBtn: document.getElementById('tab10dBtn'),
  hourlyContent: document.getElementById('hourlyContent'),
  dailyContent: document.getElementById('dailyContent'),
};

function sanitizeCode(c){ c=Number(c); return (c===45||c===48)?3:c; }
function iconFor(code){
  code=sanitizeCode(code);
  if([0,1].includes(code)) return '‚òÄÔ∏è';
  if(code===2) return '‚õÖ';
  if(code===3) return '‚òÅÔ∏è';
  if([51,53,55].includes(code)) return 'üå¶Ô∏è';
  if([61,63,65,80,81,82].includes(code)) return 'üåßÔ∏è';
  if([71,73,75,77].includes(code)) return 'üå®Ô∏è';
  if([95,96,99].includes(code)) return '‚õàÔ∏è';
  return 'üå§Ô∏è';
}
function descFor(c){
  c=sanitizeCode(c);
  const d={0:'Jasno',1:'Preva≈æne jasno',2:'ƒåiastoƒçne oblaƒçno',3:'Zamraƒçen√©',
           51:'Mrholenie',53:'Mrholenie',55:'Mrholenie',61:'Slab√Ω d√°≈æƒè',63:'D√°≈æƒè',65:'Siln√Ω d√°≈æƒè',
           71:'Sne≈æenie',73:'Sne≈æenie',75:'Siln√© sne≈æenie',77:'Snehov√© zrn√°',
           80:'Preh√°nky',81:'Preh√°nky',82:'Siln√© preh√°nky',
           95:'B√∫rka',96:'B√∫rka',99:'Siln√° b√∫rka'};
  return d[c]||'‚Äî';
}
function withIcon(code){ return `${iconFor(code)} ${descFor(code)}`; }
function dd2dir(dd){ if(dd==null||isNaN(dd)) return '‚Äî'; const deg=((dd%360)+360)%360; const dirs=['S','SV','V','JV','J','JZ','Z','SZ']; return dirs[Math.floor((deg+22.5)/45)%8]; }
function fmtTime(iso){ const d=new Date(iso); return d.getHours().toString().padStart(2,'0')+':00'; }
function fmtDay(iso){ const d=new Date(iso); const days=['Ne','Po','Ut','St','≈†t','Pi','So']; return days[d.getDay()]; }
const flag=(cc)=> String.fromCodePoint(...[...cc.toUpperCase()].map(c=>127397+c.charCodeAt(0)));
function cityLabel(x){ return (typeof x==='string'?(x.split(',')[0]):(x?.name||'')).trim()||'‚Äî'; }

async function geocodeAll(q,count=8){
  const r=await fetch(`${GEO}/search?name=${encodeURIComponent(q)}&count=${count}&language=sk&format=json`);
  const j=await r.json();
  return j.results||[];
}
async function reverseGeocode(lat, lon) {
    const url = `${NOMINATIM_API}&lat=${lat}&lon=${lon}`;
    try {
        const r = await fetch(url);
        if (!r.ok) return null;
        const j = await r.json();
        const addr = j.address;
        if (!addr) return null;
        const name = addr.city || addr.town || addr.village || addr.municipality || addr.county;
        if (name) {
            return { name: name, latitude: lat, longitude: lon, country_code: addr.country_code ? addr.country_code.toUpperCase() : 'SK', admin1: addr.state || '' };
        }
        const fallbackName = addr.county || addr.state || 'Aktu√°lna poloha';
        return { 
            name: fallbackName, 
            latitude: lat, 
            longitude: lon, 
            country_code: addr.country_code ? addr.country_code.toUpperCase() : 'SK', 
            admin1: addr.state || ''
        };
    } catch (e) {
        console.error("Chyba pri volan√≠ Nominatim reverseGeocode:", e);
        return null;
    }
}
async function fetchWx(lat,lon){
  const url=`${API}/forecast?latitude=${lat}&longitude=${lon}`
    +`&current=temperature_2m,is_day,weather_code`
    +`&hourly=temperature_2m,dew_point_2m,surface_pressure,weather_code,precipitation_probability,precipitation,wind_speed_10m,wind_direction_10m,cloud_cover,uv_index`
    +`&daily=weather_code,temperature_2m_max,temperature_2m_min,uv_index_max`
    +`&timezone=auto&forecast_days=16`;
  const r=await fetch(url); if(!r.ok) throw new Error('api'); return await r.json();
}
async function fetchHistoryExact(lat,lon){
  const d=new Date(); d.setFullYear(d.getFullYear()-1);
  const date=d.toISOString().slice(0,10);
  const url=`${ARCH}?latitude=${lat}&longitude=${lon}`
    +`&start_date=${date}&end_date=${date}`
    +`&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,weathercode`
    +`&timezone=auto`;
  const r=await fetch(url); if(!r.ok) throw new Error('arch1'); return await r.json();
}

function renderHero(city, wx){
  const isDay = !!wx.current.is_day;
  const code = sanitizeCode(wx.current.weather_code);
  document.body.setAttribute('data-mode', isDay ? 'day' : 'night');
  el.heroPlace.textContent = city?.__isCurrentLocation && !city.name ? 'Aktu√°lna poloha' : cityLabel(city);
  el.heroTemp.textContent  = Math.round(wx.current.temperature_2m)+'¬∞';
  el.heroIcon.textContent  = iconFor(code);
}
function renderHourly(wx){
  const H=wx.hourly; el.hourRows.innerHTML=''; el.hourList.innerHTML='';
  const now=new Date(); let start=0; for(let i=0;i<H.time.length;i++){ if(new Date(H.time[i])>=now){ start=i; break; } }
  const end=Math.min(start+24,H.time.length);
  for(let i=start;i<end;i++){
    const code=sanitizeCode(H.weather_code[i]);
    const temp=Math.round(H.temperature_2m[i]);
    const pop=H.precipitation_probability?.[i];
    const pmm=H.precipitation?.[i];
    const wind=H.wind_speed_10m?.[i], wdir=H.wind_direction_10m?.[i];

    // Tabuƒæka pre desktop
    const tr=document.createElement('tr'); tr.className='hover:bg-white/10';
    tr.innerHTML=`<td class="mono">${fmtTime(H.time[i])}</td><td class="text-white/85 font-medium">${withIcon(code)}</td><td class="val-bold mono">${temp}¬∞</td><td class="val-bold mono">${pop!=null?`${pop}%`:'‚Äî'} ¬∑ ${pmm!=null?pmm.toFixed(1):'0.0'} mm</td><td class="val-bold mono">${wind!=null?`${Math.round(wind)} km/h ${dd2dir(wdir)}`:'‚Äî'}</td>`;
    el.hourRows.appendChild(tr);

    // Karty pre mobil
    const card=document.createElement('div'); card.className='card';
    const btn=document.createElement('button'); btn.className='acc-btn'; btn.type='button'; btn.setAttribute('aria-expanded','false');
    btn.innerHTML=`<div class="acc-head"><div><div class="mono font-semibold text-sm">${fmtTime(H.time[i])} ¬∑ ${temp}¬∞</div><div class="text-white/80 text-xs">${withIcon(code)}</div></div></div><div class="acc-right"><span class="mono text-sm">${pop!=null?`${pop}%`:'‚Äî'}</span><svg class="chev" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></div>`;
    const wrap=document.createElement('div'); wrap.className='panel-wrap';
    const panel=document.createElement('div'); panel.className='panel';
    panel.innerHTML=`<div class="grid grid-cols-2 gap-2 mt-2 text-xs"><div class="glass p-2 rounded-lg"><div class="text-white/70">Zr√°≈æky</div><div class="mono font-semibold">${pmm!=null?pmm.toFixed(1):'0.0'} mm</div></div><div class="glass p-2 rounded-lg"><div class="text-white/70">Vietor</div><div class="mono font-semibold">${wind!=null?`${Math.round(wind)} km/h`:'‚Äî'}</div></div><div class="glass p-2 rounded-lg"><div class="text-white/70">Smer</div><div class="mono font-semibold">${dd2dir(wdir)}</div></div><div class="glass p-2 rounded-lg"><div class="text-white/70">Tlak</div><div class="mono font-semibold">${H.surface_pressure?.[i]!=null?Math.round(H.surface_pressure[i]):'‚Äî'} hPa</div></div></div>`;
    wrap.appendChild(panel); card.appendChild(btn); card.appendChild(wrap); el.hourList.appendChild(card);
    let open=false; const setH=()=>{ wrap.style.height=open?panel.scrollHeight+'px':'0px'; };
    btn.addEventListener('click',()=>{ if(wrap.style.height==='auto'){ wrap.style.height=panel.scrollHeight+'px'; } open=!open; btn.setAttribute('aria-expanded',String(open)); requestAnimationFrame(setH); });
    wrap.addEventListener('transitionend',e=>{ if(e.propertyName!=='height')return; if(open){ wrap.style.height='auto'; } });
  }
}
function renderDaily(wx){
  const D=wx.daily; el.dailyList.innerHTML=''; const n=Math.min(10,D.time.length);
  for(let i=0;i<n;i++){
    const d=new Date(D.time[i]); 
    const dayName = fmtDay(D.time[i]);
    const dayNumber = d.getDate();
    const month = d.getMonth() + 1;
    
    const tmin=Math.round(D.temperature_2m_min[i]); 
    const tmax=Math.round(D.temperature_2m_max[i]); 
    const code=sanitizeCode(D.weather_code[i]);
    
    const card=document.createElement('div'); card.className='glass p-3 rounded-xl';
    card.innerHTML=`<div class="flex items-center justify-between"><div><div class="font-medium text-sm">${dayName} ${dayNumber}.${month}.</div><div class="text-white/70 text-xs">${withIcon(code)}</div></div><div class="mono font-semibold">${tmax}¬∞ <span class="text-white/80">${tmin}¬∞</span></div></div>`;
    el.dailyList.appendChild(card);
  }
}
function renderHistoryExact(hist){
  const H=hist.daily; const dateStr=H.time?.[0];
  if(!dateStr){ 
    el.historyTemp.textContent = '‚Äî';
    el.historyPrecip.textContent = '‚Äî';
    return; 
  }
  const tmax=Math.round(H.temperature_2m_max?.[0]) || '‚Äî'; 
  const pr=(H.precipitation_sum?.[0] ?? 0).toFixed(1);
  el.historyTemp.textContent = tmax !== '‚Äî' ? tmax + '¬∞' : '‚Äî';
  el.historyPrecip.textContent = pr + ' mm';
}
function renderUV(wx){
  const H=wx.hourly; let uvNow=null; const now=new Date();
  for(let i=0;i<H.time.length;i++){ if(new Date(H.time[i])>=now){ uvNow=H.uv_index?.[i] ?? null; break; } }
  const uvMax = wx.daily.uv_index_max?.[0] ?? null;
  el.uvNow.textContent = uvNow!=null ? uvNow.toFixed(1) : '‚Äî';
  el.uvMax.textContent = uvMax!=null ? uvMax.toFixed(1) : '‚Äî';
}

async function run(queryOrCityObj){
  el.loading.classList.remove('hidden'); el.err.classList.add('hidden');
  try{
    let city = typeof queryOrCityObj==='object'
      ? queryOrCityObj
      : (await geocodeAll(cityLabel(queryOrCityObj),1))[0];
    if(!city) throw new Error('notfound');

    const wx=await fetchWx(city.latitude,city.longitude);
    const hist=await fetchHistoryExact(city.latitude,city.longitude);

    renderHero(city,wx);
    renderHourly(wx);
    renderDaily(wx);
    renderHistoryExact(hist);
    renderUV(wx);

    localStorage.setItem('lastCity', JSON.stringify({
        name: city.name,
        latitude: city.latitude,
        longitude: city.longitude,
        country_code: city.country_code,
        __isCurrentLocation: !!city.__isCurrentLocation
    }));
  }catch(e){ console.error(e); el.err.classList.remove('hidden'); }
  finally{ el.loading.classList.add('hidden'); }
}

function switchTab(tabName) {
    const allBtns = [el.tab24hBtn, el.tab10dBtn];
    const allContents = [el.hourlyContent, el.dailyContent];

    allBtns.forEach(btn => {
        const isActive = btn.getAttribute('data-tab') === tabName;
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
    });

    allContents.forEach(content => {
        const isActive = content.getAttribute('data-tab-content') === tabName;
        content.classList.toggle('hidden', !isActive);
    });
}

el.tab24hBtn.addEventListener('click', () => switchTab('hourly'));
el.tab10dBtn.addEventListener('click', () => switchTab('daily'));

let selIndex=-1;
let lastSuggest=[];
function hideSuggest(){ el.suggest.classList.add('hidden'); el.suggest.innerHTML=''; selIndex=-1; lastSuggest=[]; }
function showSuggest(){ el.suggest.classList.remove('hidden'); }
function cityRow(c){
  const admin = c.admin1 || c.admin2 || c.admin3 || '';
  const country = c.country || '';
  const meta = [admin, country].filter(Boolean).join(' ¬∑ ');
  return `
    <div class="s-name">${c.name}</div>
    <div class="s-meta">${meta}</div>
  `;
}
function renderSuggest(items){
  el.suggest.innerHTML='';
  items.forEach((c,idx)=>{
    const d=document.createElement('div');
    d.className='suggest-item';
    d.setAttribute('role','option');
    d.setAttribute('data-idx',idx);
    d.innerHTML=`<span class="flag">${c.country_code?flag(c.country_code):''}</span><div>${cityRow(c)}</div>`;
    d.addEventListener('mousedown',e=>{ e.preventDefault(); choose(idx); });
    el.suggest.appendChild(d);
  });
  if(items.length===0){
    const d=document.createElement('div');
    d.className='suggest-item'; d.innerHTML='<div class="s-meta">≈Ωiadne v√Ωsledky</div>';
    el.suggest.appendChild(d);
  }
  showSuggest();
}
async function suggest(q){
  q = cityLabel(q);
  if(!q){ hideSuggest(); return; }
  try{
    const res=await geocodeAll(q,8);
    lastSuggest=res;
    renderSuggest(res);
  }catch{ hideSuggest(); }
}
function choose(i){
  const c=lastSuggest[i]; if(!c) return;
  el.input.value = cityLabel(c);
  hideSuggest();
  run(c);
}
el.input.addEventListener('input', (e)=>{ suggest(e.target.value); });
el.input.addEventListener('keydown',(e)=>{
  const items=[...el.suggest.querySelectorAll('.suggest-item')];
  if(e.key==='ArrowDown'){ if(items.length){ e.preventDefault(); selIndex=(selIndex+1)%items.length; updateSel(items); } }
  else if(e.key==='ArrowUp'){ if(items.length){ e.preventDefault(); selIndex=(selIndex-1+items.length)%items.length; updateSel(items); } }
  else if(e.key==='Enter'){ if(selIndex>=0 && lastSuggest[selIndex]){ e.preventDefault(); choose(selIndex); } }
  else if(e.key==='Escape'){ hideSuggest(); }
});
function updateSel(items){
  items.forEach((it,i)=> it.setAttribute('aria-selected', i===selIndex ? 'true' : 'false'));
  const active=items[selIndex]; if(active){ active.scrollIntoView({block:'nearest'}); }
}
document.addEventListener('click',(e)=>{ if(!e.target.closest('.suggest-wrap')) hideSuggest(); });
el.form.addEventListener('submit', (ev)=>{
  ev.preventDefault();
  const q=cityLabel(el.input.value);
  if(q) run(q);
});

let startY=0, pulling=false, activated=false;
const THRESH=72;
function ptrReset(){ pulling=false; activated=false; startY=0; el.ptr.classList.remove('active'); }
el.refreshContainer.addEventListener('touchstart',(e)=>{
  if(window.scrollY===0){ startY=e.touches[0].clientY; pulling=true; }
},{passive:true});
el.refreshContainer.addEventListener('touchmove',(e)=>{
  if(!pulling) return;
  const dy=e.touches[0].clientY-startY;
  if(dy>10){ e.preventDefault(); }
  if(dy>THRESH && !activated){ activated=true; el.ptr.classList.add('active'); }
},{passive:false});
el.refreshContainer.addEventListener('touchend', async ()=>{
  if(pulling && activated){
    checkAndroidLocationEnabled(true); 
  }
  ptrReset();
});

const locationOptions = { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }; 

function getCityFromStorage() {
    const last = localStorage.getItem('lastCity');
    try { 
        return last ? JSON.parse(last) : null; 
    } catch (e) { 
        console.error("Chyba pri parsovan√≠ lastCity:", e); 
        return null;
    }
}

function checkAndroidLocationEnabled(forceFetch=false) {
  const cityObj = getCityFromStorage();

  if (cityObj && !forceFetch) {
    el.input.value = cityLabel(cityObj);
    run(cityObj);
    return;
  }
  
  if (typeof median !== 'undefined' && median.android && median.android.geoLocation) {
    median.android.geoLocation.isLocationServicesEnabled({
      callback: function(result) {
        if (result.enabled) {
          getCurrentLocation();
        } else {
          requestAndroidLocationPermission();
          handleLocationFailure(); 
        }
      }
    });
  } else if ('geolocation' in navigator) {
    getCurrentLocation();
  } else {
    handleLocationFailure(); 
  }
}

function requestAndroidLocationPermission() {
  if (typeof median !== 'undefined' && median.android && median.android.geoLocation) {
    median.android.geoLocation.promptLocationServices();
  }
}

function getCurrentLocation() {
  navigator.geolocation.getCurrentPosition(locationSuccess, locationError, locationOptions);
}

async function locationSuccess(position) {
  const latitude = position.coords.latitude;
  const longitude = position.coords.longitude;
  
  let locatedCity = null;
  try {
      locatedCity = await reverseGeocode(latitude, longitude);
  } catch (e) {
      locatedCity = null;
  }

  const cityToUse = {
    name: locatedCity?.name || "", 
    latitude: latitude,
    longitude: longitude,
    country_code: locatedCity?.country_code || "SK",
    __isCurrentLocation: true
  };
  
  if(el.input) {
    el.input.value = cityToUse.name;
  }

  run(cityToUse);
}

function locationError(error) {
  handleLocationFailure();
}

function handleLocationFailure() {
    const cityObj = getCityFromStorage();
    el.loading.classList.add('hidden');

    if (cityObj) {
        el.input.value = cityLabel(cityObj);
        run(cityObj);
    } else {
        el.err.classList.remove('hidden');
        el.heroPlace.textContent = 'Poloha nezisten√°';
        el.heroTemp.textContent  = '--¬∞';
        el.heroIcon.textContent  = '‚ùì';
    }
}

checkAndroidLocationEnabled();
</script>
</body>
</html>

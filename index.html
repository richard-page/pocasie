<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Počasie — Open-Meteo</title>
  <meta name="description" content="Jednoduchá a rýchla meteo appka s dátami z Open-Meteo." />
  <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
  <style>
    :root{
      --bg:#0b0f14;--card:#0f151c;--muted:#8aa0b3;--text:#eaf2f8;--acc:#53b3ff;
      --good:#2ecc71;--warn:#f1c40f;--bad:#e74c3c;--grid:#1a2430;
    }
    @media (prefers-color-scheme: light){
      :root{--bg:#f7fbff;--card:#ffffff;--muted:#5b6b7a;--text:#091520;--acc:#0077ff;--grid:#e8eef5}
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:var(--acc);text-decoration:none}
    .wrap{max-width:1100px;margin:auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .brand{font-weight:700;font-size:18px;letter-spacing:.3px}
    .search{position:relative;flex:1;min-width:240px}
    .search input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--grid);background:var(--card);color:var(--text)}
    .suggest{position:absolute;top:44px;left:0;right:0;background:var(--card);border:1px solid var(--grid);border-radius:10px;overflow:hidden;z-index:20;display:none;max-height:260px;overflow:auto}
    .suggest button{display:block;width:100%;padding:10px 12px;background:transparent;border:0;text-align:left;color:var(--text);cursor:pointer}
    .suggest button:hover{background:rgba(0,0,0,.06)}
    .controls{display:flex;gap:8px;align-items:center}
    .pill{padding:8px 10px;border-radius:10px;background:var(--card);border:1px solid var(--grid);cursor:pointer}
    .favlist{display:flex;gap:6px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--grid);border-radius:16px;padding:16px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:1.2fr .8fr}
    .g3{grid-template-columns:repeat(3,1fr)}
    @media (max-width:900px){.g2{grid-template-columns:1fr}}
    .current{display:grid;grid-template-columns:auto 1fr;gap:12px;align-items:center}
    .bigtemp{font-size:56px;font-weight:800;line-height:1}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .tag{padding:4px 8px;border:1px solid var(--grid);border-radius:999px;font-size:12px}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .kpi div{padding:10px;border:1px dashed var(--grid);border-radius:10px;text-align:center}
    .aqi{font-weight:700}
    .aqi.good{color:var(--good)} .aqi.fair{color:#27ae60} .aqi.mod{color:var(--warn)} .aqi.poor{color:#d35400} .aqi.vpoor{color:var(--bad)} .aqi.haz{color:#8e44ad}
    .days{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    @media (max-width:900px){.days{grid-template-columns:repeat(3,1fr)}}
    .day{padding:10px;border:1px solid var(--grid);border-radius:12px;text-align:center}
    .mini{font-size:12px;color:var(--muted)}
    .temps{font-weight:700}
    svg.chart{width:100%;height:220px;display:block}
    footer{margin:18px 0 10px;color:var(--muted);font-size:13px}
    .btn{cursor:pointer}
    .heart{filter:drop-shadow(0 0 0 rgba(0,0,0,0))}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">⛅ Počasie (Open-Meteo)</div>
      <div class="search">
        <input id="q" placeholder="Nájdi mesto… (napr. Bratislava, Košice)" autocomplete="off" />
        <div id="suggest" class="suggest"></div>
      </div>
      <div class="controls">
        <button id="unitTemp" class="pill btn" title="Teplota">°C</button>
        <button id="unitWind" class="pill btn" title="Rýchlosť vetra">km/h</button>
        <button id="unitPrec" class="pill btn" title="Zrážky">mm</button>
        <button id="toggleTheme" class="pill btn" title="Tmavý/Svetlý">🌓</button>
        <button id="refresh" class="pill btn" title="Obnoviť">↻</button>
      </div>
    </header>

    <div class="favlist" id="favlist"></div>

    <section class="grid g2">
      <div class="card" id="currentCard">
        <div class="current">
          <div id="icon" aria-hidden="true"></div>
          <div>
            <div class="row">
              <h2 id="loc">—</h2>
              <button id="favBtn" class="pill btn" title="Pridať k obľúbeným">☆ Uložiť</button>
            </div>
            <div class="row">
              <div class="bigtemp" id="temp">—</div>
              <div>
                <div id="desc">—</div>
                <div class="muted" id="updated">—</div>
              </div>
            </div>
            <div class="row">
              <span class="tag" id="feels">Pocitovo —</span>
              <span class="tag" id="wind">Vietor —</span>
              <span class="tag" id="gust">Nárazy —</span>
              <span class="tag" id="hum">Vlhkosť —</span>
              <span class="tag" id="press">Tlak —</span>
              <span class="tag" id="cloud">Oblačnosť —</span>
              <span class="tag" id="prec">Zrážky —</span>
              <span class="tag" id="uv">UV —</span>
            </div>
            <div class="kpi">
              <div>Východ <div id="sunrise">—</div></div>
              <div>Západ <div id="sunset">—</div></div>
              <div>Deň/Noc <div id="isday">—</div></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Kvalita ovzdušia</h3>
        <div class="row">
          EU AQI: <span id="aqi" class="aqi">—</span>
          <span class="tag" id="pm25">PM2.5 —</span>
          <span class="tag" id="uv_now">UV —</span>
        </div>
        <p class="mini">0–20 dobré · 20–40 uspokojivé · 40–60 mierne · 60–80 zlé · 80–100 veľmi zlé · &gt;100 extrémne</p>
      </div>
    </section>

    <section class="card">
      <h3>Hodinový prehľad (24 h)</h3>
      <svg class="chart" id="hourlyChart" viewBox="0 0 1000 300" preserveAspectRatio="none" aria-label="Graf teploty a pravdepodobnosti zrážok"></svg>
      <div class="mini">Plná čiara: teplota · Stĺpce: pravdepodobnosť zrážok (%)</div>
    </section>

    <section class="card">
      <h3>7-dňová predpoveď</h3>
      <div class="days" id="days"></div>
    </section>

    <footer>
      Dáta: <a href="https://open-meteo.com/" target="_blank" rel="noopener">Open-Meteo</a>. Posledná aktualizácia: <span id="tstamp">—</span>.
    </footer>
  </div>

<script>
/* ====== Nastavenia + stav ====== */
const state = {
  coords: {lat: 48.1486, lon: 17.1077}, // fallback: Bratislava
  place: 'Bratislava, SK',
  units: { temp: 'celsius', wind: 'kmh', prec: 'mm' },
  data: null, air: null, timezone: 'auto'
};

/* ====== Pomocné mapovania ====== */
const WMO = {
  0:"Jasno", 1:"Prevažne jasno", 2:"Polooblačno", 3:"Zamračené",
  45:"Hmla", 48:"Mrznúca hmla",
  51:"Mrholenie ľahké",53:"Mrholenie",55:"Mrholenie silné",
  56:"Mrznúce mrholenie ľahké",57:"Mrznúce mrholenie silné",
  61:"Dážď slabý",63:"Dážď",65:"Lejak",
  66:"Mrznúci dážď slabý",67:"Mrznúci dážď silný",
  71:"Sneženie slabé",73:"Sneženie",75:"Husté sneženie",
  77:"Snehové zrná",80:"Prehánky slabé",81:"Prehánky",82:"Prívalové prehánky",
  85:"Snehové prehánky",86:"Silné snehové prehánky",
  95:"Búrky",96:"Búrky s krúpami",99:"Silné búrky s krúpami"
};
// jednoduché SVG ikony podľa kategórie
function iconFor(code, isDay){
  const sun = '<circle cx="30" cy="30" r="12" stroke="currentColor" stroke-width="3" fill="none"/>'+
              (isDay?'<line x1="30" y1="8" x2="30" y2="0"/><line x1="30" y1="60" x2="30" y2="52"/><line x1="8" y1="30" x2="0" y2="30"/><line x1="60" y1="30" x2="52" y2="30"/>' : '');
  const cloud = '<ellipse cx="30" cy="38" rx="22" ry="13"/><ellipse cx="18" cy="42" rx="12" ry="9"/>';
  const rain = '<line x1="18" y1="52" x2="14" y2="64"/><line x1="28" y1="52" x2="24" y2="64"/><line x1="38" y1="52" x2="34" y2="64"/>';
  const snow = '<text x="16" y="60" font-size="20">*</text><text x="30" y="60" font-size="20">*</text>';
  let body='';
  if(code===0) body=sun;
  else if([1,2].includes(code)) body=sun+cloud;
  else if(code===3) body=cloud;
  else if([51,53,55,56,57,61,63,65,66,67,80,81,82].includes(code)) body=cloud+rain;
  else if([71,73,75,77,85,86].includes(code)) body=cloud+snow;
  else if([45,48].includes(code)) body=cloud;
  else if([95,96,99].includes(code)) body=cloud+rain+'<polygon points="28,18 32,28 24,28" />';
  else body=cloud;
  return `<svg width="72" height="72" viewBox="0 0 60 60" fill="currentColor" aria-hidden="true">${body}</svg>`;
}
function degToArrow(d){ return `→ ${d}°`; }
function fmt(n,u=''){ return (n===null||n===undefined||Number.isNaN(n))?'—':`${Math.round(n)}${u}`; }
function fmt1(n,u=''){ return (n==null)?'—':`${(Math.round(n*10)/10).toFixed(1)}${u}`; }
function aqiClass(v){ if(v==null) return ''; if(v<20) return 'good'; if(v<40) return 'fair'; if(v<60) return 'mod'; if(v<80) return 'poor'; if(v<100) return 'vpoor'; return 'haz'; }
function localDateStr(s){ try{ return new Date(s).toLocaleString([], {hour:'2-digit', minute:'2-digit'});}catch{ return '—'; } }

/* ====== API ====== */
async function fetchAll(){
  const {lat,lon} = state.coords;
  const params = new URLSearchParams({
    latitude: lat, longitude: lon, timezone: state.timezone,
    temperature_unit: state.units.temp==='celsius'?'celsius':'fahrenheit',
    wind_speed_unit: state.units.wind,
    precipitation_unit: state.units.prec,
    current: [
      'temperature_2m','relative_humidity_2m','apparent_temperature','precipitation',
      'weather_code','cloud_cover','pressure_msl','wind_speed_10m','wind_direction_10m','wind_gusts_10m','is_day'
    ].join(','),
    hourly: [
      'temperature_2m','precipitation_probability','precipitation','weather_code',
      'wind_speed_10m','relative_humidity_2m','pressure_msl','apparent_temperature','uv_index'
    ].join(','),
    daily: [
      'weather_code','temperature_2m_max','temperature_2m_min','uv_index_max',
      'precipitation_sum','precipitation_hours','sunrise','sunset','wind_speed_10m_max','wind_gusts_10m_max'
    ].join(',')
  });
  const fUrl = `https://api.open-meteo.com/v1/forecast?${params.toString()}`;
  const aParams = new URLSearchParams({
    latitude: lat, longitude: lon, timezone: state.timezone,
    current: ['european_aqi','pm2_5','uv_index'].join(','),
    hourly: ['european_aqi','pm2_5','uv_index'].join(',')
  });
  const aUrl = `https://air-quality-api.open-meteo.com/v1/air-quality?${aParams.toString()}`;

  const [fRes, aRes] = await Promise.all([fetch(fUrl), fetch(aUrl)]);
  if(!fRes.ok) throw new Error('Forecast API chyba');
  state.data = await fRes.json();
  state.air = aRes.ok ? await aRes.json() : null;
  localStorage.setItem('lastForecast', JSON.stringify({t:Date.now(), state}));
}

/* ====== UI render ====== */
function render(){
  const d = state.data; if(!d) return;
  const c = d.current;
  const isDay = !!c.is_day;
  const code = c.weather_code;
  document.getElementById('icon').innerHTML = iconFor(code, isDay);
  document.getElementById('loc').textContent = state.place;
  document.getElementById('temp').textContent = fmt1(c.temperature_2m, '°' + (state.units.temp==='celsius'?'C':'F'));
  document.getElementById('desc').textContent = WMO[code] ?? '—';
  document.getElementById('updated').textContent = `Čas: ${new Date().toLocaleString()}`;
  document.getElementById('feels').textContent = `Pocitovo ${fmt1(c.apparent_temperature, '°')}`;
  document.getElementById('wind').textContent = `Vietor ${fmt1(c.wind_speed_10m, ` ${state.units.wind}`)} ${degToArrow(c.wind_direction_10m)}`;
  document.getElementById('gust').textContent = `Nárazy ${fmt1(c.wind_gusts_10m, ` ${state.units.wind}`)}`;
  document.getElementById('hum').textContent = `Vlhkosť ${fmt(c.relative_humidity_2m, '%')}`;
  document.getElementById('press').textContent = `Tlak ${fmt1(c.pressure_msl, ' hPa')}`;
  document.getElementById('cloud').textContent = `Oblačnosť ${fmt(c.cloud_cover, '%')}`;
  document.getElementById('prec').textContent = `Zrážky ${fmt1(c.precipitation, ` ${state.units.prec}`)}`;

  // Denné agregáty
  const dd = d.daily;
  document.getElementById('sunrise').textContent = localDateStr(dd.sunrise[0]);
  document.getElementById('sunset').textContent = localDateStr(dd.sunset[0]);
  document.getElementById('isday').textContent = c.is_day ? 'Deň' : 'Noc';
  document.getElementById('uv').textContent = `UV max ${fmt1(dd.uv_index_max[0])}`;
  document.getElementById('tstamp').textContent = new Date().toLocaleString();

  // Air quality
  if(state.air && state.air.current){
    const A = state.air.current;
    const aqi = A.european_aqi ?? null;
    const pm = A.pm2_5 ?? null;
    const uvn = A.uv_index ?? null;
    const aqiEl = document.getElementById('aqi');
    aqiEl.textContent = aqi==null?'—':Math.round(aqi);
    aqiEl.className = `aqi ${aqiClass(aqi)}`;
    document.getElementById('pm25').textContent = `PM2.5 ${fmt1(pm,' µg/m³')}`;
    document.getElementById('uv_now').textContent = `UV ${fmt1(uvn)}`;
  }

  // 24h hodinový graf
  drawHourlyChart(d);

  // 7-dňové karty
  const days = document.getElementById('days');
  days.innerHTML='';
  for(let i=0;i<Math.min(7, d.daily.time.length);i++){
    const code = d.daily.weather_code[i];
    const day = new Date(d.daily.time[i]).toLocaleDateString([], {weekday:'short', day:'2-digit', month:'2-digit'});
    const el = document.createElement('div');
    el.className='day';
    el.innerHTML = `
      <div>${day}</div>
      <div style="height:54px">${iconFor(code, true)}</div>
      <div class="temps">${fmt1(d.daily.temperature_2m_max[i],'°')} / ${fmt1(d.daily.temperature_2m_min[i],'°')}</div>
      <div class="mini">${WMO[code]??''}</div>
      <div class="mini">Zrážky: ${fmt1(d.daily.precipitation_sum[i], ' '+state.units.prec)}</div>
      <div class="mini">UV max: ${fmt1(d.daily.uv_index_max[i])}</div>
      <div class="mini">Východ: ${new Date(d.daily.sunrise[i]).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
      <div class="mini">Západ: ${new Date(d.daily.sunset[i]).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
    `;
    days.appendChild(el);
  }

  // obľúbené
  rebuildFavs();
}

function drawHourlyChart(d){
  const svg = document.getElementById('hourlyChart');
  const h = d.hourly;
  // nájdeme najbližších 24 hodín od aktuálnej hodiny
  const now = Date.now();
  let startIdx = 0;
  for(let i=0;i<h.time.length;i++){ if(new Date(h.time[i]).getTime() >= now){ startIdx=i; break; } }
  const N = Math.min(24, h.time.length-startIdx);
  const temps = h.temperature_2m.slice(startIdx, startIdx+N);
  const pops = (h.precipitation_probability||[]).slice(startIdx, startIdx+N).map(v=>v??0);
  const times = h.time.slice(startIdx, startIdx+N);

  const W=1000, H=300, pad=40, chartH=200, baseY=230;
  const tMin = Math.min(...temps), tMax = Math.max(...temps);
  const tScale = v => baseY - ( (v - tMin) / Math.max(1,(tMax-tMin)) ) * chartH;
  const x = i => pad + i*((W-2*pad)/(N-1));

  let path = '';
  temps.forEach((v,i)=>{ path += (i?'L':'M')+x(i)+','+tScale(v)+' '; });

  // stĺpce pre POP
  let bars = '';
  pops.forEach((p,i)=>{
    const bw = (W-2*pad)/N * 0.6;
    const bx = x(i) - bw/2;
    const by = baseY;
    const bh = (p/100)*chartH;
    bars += `<rect x="${bx}" y="${by-bh}" width="${bw}" height="${bh}" opacity="0.35"></rect>`;
  });

  // os X popisky hodín
  let ticks = '';
  times.forEach((t,i)=>{
    const hh = new Date(t).toLocaleTimeString([], {hour:'2-digit'});
    if(i%3===0){
      ticks += `<text x="${x(i)}" y="${baseY+20}" font-size="12" text-anchor="middle">${hh}</text>`;
    }
  });

  // min/max popis
  const desc = `<text x="${W-pad}" y="${pad}" font-size="12" text-anchor="end">min ${fmt1(tMin,'°')} · max ${fmt1(tMax,'°')}</text>`;

  svg.innerHTML = `
    <rect x="0" y="0" width="${W}" height="${H}" fill="transparent" />
    <g stroke="currentColor" stroke-width="1" opacity="0.12">
      ${[0,0.25,0.5,0.75,1].map(f=>`<line x1="${pad}" y1="${baseY - f*chartH}" x2="${W-pad}" y2="${baseY - f*chartH}" />`).join('')}
    </g>
    <g fill="currentColor">${bars}</g>
    <path d="${path}" fill="none" stroke="currentColor" stroke-width="2.5" />
    ${ticks}
    ${desc}
  `;
}

/* ====== Geokódovanie + vyhľadávanie ====== */
const $q = document.getElementById('q'), $sug = document.getElementById('suggest');
let sugAbort = null;
$q.addEventListener('input', async (e)=>{
  const q = e.target.value.trim();
  if(q.length<2){ $sug.style.display='none'; return; }
  if(sugAbort) sugAbort.abort();
  sugAbort = new AbortController();
  const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=8&language=sk`;
  try{
    const r = await fetch(url, {signal: sugAbort.signal});
    if(!r.ok) throw 0;
    const j = await r.json();
    $sug.innerHTML='';
    (j.results||[]).forEach(loc=>{
      const b = document.createElement('button');
      const label = `${loc.name}${loc.admin1?`, ${loc.admin1}`:''}, ${loc.country_code}`;
      b.textContent = label;
      b.addEventListener('click', ()=>{
        state.coords = {lat: loc.latitude, lon: loc.longitude};
        state.place = label;
        $q.value=''; $sug.style.display='none';
        loadAndRender();
      });
      $sug.appendChild(b);
    });
    $sug.style.display = (j.results && j.results.length) ? 'block' : 'none';
  }catch{ $sug.style.display='none'; }
});
document.addEventListener('click', (e)=>{ if(!document.querySelector('.search').contains(e.target)) $sug.style.display='none'; });

/* ====== Obľúbené ====== */
function getFavs(){ try{ return JSON.parse(localStorage.getItem('favs')||'[]'); }catch{return[];} }
function saveFav(l){ localStorage.setItem('favs', JSON.stringify(l)); }
function toggleFav(){
  const favs = getFavs();
  const key = `${state.place}|${state.coords.lat}|${state.coords.lon}`;
  const i = favs.findIndex(x=>x.key===key);
  if(i>=0) favs.splice(i,1); else favs.push({key, place:state.place, lat:state.coords.lat, lon:state.coords.lon});
  saveFav(favs); rebuildFavs();
}
function rebuildFavs(){
  const favs = getFavs(); const box = document.getElementById('favlist'); box.innerHTML='';
  favs.slice(0,20).forEach(f=>{
    const b = document.createElement('button'); b.className='pill btn';
    b.textContent = f.place;
    b.addEventListener('click', ()=>{ state.coords={lat:f.lat,lon:f.lon}; state.place=f.place; loadAndRender(); });
    box.appendChild(b);
  });
  document.getElementById('favBtn').textContent = favs.some(x=>x.place===state.place && x.lat===state.coords.lat && x.lon===state.coords.lon) ? '★ Uložené' : '☆ Uložiť';
}

/* ====== Ovládanie jednotiek, téma, refresh ====== */
document.getElementById('unitTemp').onclick=()=>{
  state.units.temp = state.units.temp==='celsius' ? 'fahrenheit':'celsius';
  document.getElementById('unitTemp').textContent = state.units.temp==='celsius'?'°C':'°F';
  loadAndRender();
};
document.getElementById('unitWind').onclick=()=>{
  state.units.wind = state.units.wind==='kmh'?'mph':'kmh';
  document.getElementById('unitWind').textContent = state.units.wind;
  loadAndRender();
};
document.getElementById('unitPrec').onclick=()=>{
  state.units.prec = state.units.prec==='mm'?'inch':'mm';
  document.getElementById('unitPrec').textContent = state.units.prec;
  loadAndRender();
};
document.getElementById('toggleTheme').onclick=()=>{ document.documentElement.classList.toggle('light'); };
document.getElementById('refresh').onclick=()=> loadAndRender();
document.getElementById('favBtn').onclick=toggleFav;

/* ====== Načítanie + geolokácia ====== */
async function loadAndRender(){
  try{
    await fetchAll();
    render();
  }catch(e){
    console.error(e);
    // fallback na cache
    const last = localStorage.getItem('lastForecast');
    if(last){
      try{
        const j = JSON.parse(last);
        Object.assign(state, j.state);
        render();
      }catch{}
    }
  }
}
function tryGeolocate(){
  if(!('geolocation' in navigator)){ loadAndRender(); return; }
  navigator.geolocation.getCurrentPosition(
    pos => { state.coords = {lat:pos.coords.latitude, lon:pos.coords.longitude}; state.place='Moja poloha'; loadAndRender(); },
    err => loadAndRender(),
    {timeout: 8000, maximumAge: 30_000, enableHighAccuracy: false}
  );
}

/* ====== Štart ====== */
(function init(){
  // načítaj posledné
  try{
    const last = JSON.parse(localStorage.getItem('lastForecast')||'null');
    if(last && last.state){ Object.assign(state, { ...state, ...last.state }); }
  }catch{}
  document.getElementById('unitTemp').textContent = state.units.temp==='celsius'?'°C':'°F';
  document.getElementById('unitWind').textContent = state.units.wind;
  document.getElementById('unitPrec').textContent = state.units.prec;
  tryGeolocate();
})();
</script>
</body>
</html>

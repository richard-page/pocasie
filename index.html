<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes, maximum-scale=6, viewport-fit=cover" />
<title>Počasie</title>
<link rel="icon" type="image/png" href="favicon.png" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg0:#0b0f14; --bg1:#0e1620; --panel:#152433; --stroke:#233448;
    --txt:#eaf3ff; --muted:#a8bed5; --accent:#3ad0e6;
    --r:14px; --shadow:0 10px 28px rgba(0,0,0,.28);
    --gap:8px
  }
  *{box-sizing:border-box}
  html,body{min-height:100%; margin:0; padding:0}
  body{
    color:var(--txt);
    font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:linear-gradient(180deg,var(--bg1),var(--bg0));
    overflow-x:hidden; overflow-y:auto; -webkit-text-size-adjust:100%; -webkit-tap-highlight-color:transparent; min-height:100dvh
  }
  .wrap{width:100%; max-width:1120px; margin-inline:auto; padding:22px 14px 40px}
  header h1{margin:0 0 14px; text-align:center; font-size:28px; letter-spacing:.3px}

  .toolbar{display:grid; grid-template-columns:1fr; gap:12px; margin:14px 0 14px}
  .searchCol{display:flex; flex-direction:column; gap:8px; position:relative}
  .search{width:100%; background:#152535; border:1px solid var(--stroke); color:#fff; border-radius:12px; padding:12px 14px; outline:none; font-size:16px; min-height:46px}
  .search:focus{border-color:#2e4a67}
  #suggestions{display:none; gap:6px; position:absolute; top:calc(100% + 6px); left:0; right:0; z-index:40; background:#0f1c2a; border:1px solid var(--stroke); border-radius:12px; padding:8px; max-height:55vh; overflow:auto}
  .sugg{background:#13263a; border:1px solid var(--stroke); border-radius:10px; padding:10px 12px; cursor:pointer}

  .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid var(--stroke); border-radius:var(--r); box-shadow:var(--shadow); padding:16px 14px}
  .card h3{margin:0 0 14px; text-align:center; font-size:18px}
  section.card{margin-top:18px !important}

  #place{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-align:left; margin:0}

  .row{display:grid; grid-template-columns:1fr; gap:18px; margin-top:6px}
  .meta{display:grid; grid-template-columns:1fr; gap:10px; color:var(--muted); font-size:14px}
  .meta strong{color:#fff}

  .chipRow{display:flex; flex-direction:column; gap:10px; align-items:flex-start}
  .chip{display:inline-flex; align-items:center; gap:8px; background:#143344; border:1px solid var(--stroke); color:#d8f7ff; border-radius:999px; padding:8px 14px; font-size:13px; line-height:1}
  @media (min-width:900px){ .chipRow{flex-direction:row; flex-wrap:wrap} }

  .tempNow{font-size:44px; font-weight:700; line-height:1; margin:6px 0}
  .icon{width:64px; height:64px; display:flex; align-items:center; justify-content:center; font-size:48px}
  .gridInfo{display:grid; grid-template-columns:1fr auto; gap:16px; align-items:start}

  .chartWrap{height:240px}
  canvas{background:#0f1c2a; border:1px solid var(--stroke); border-radius:12px}

  .summarySection{margin-top:14px}
  .summarySection h3{margin-bottom:10px}
  #summary{margin:0 auto; max-width:780px; color:#dbeeff; background:#0f1c2a; border:1px solid var(--stroke); border-radius:10px; padding:12px; text-align:center}

  .histRow{display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap}
  .badge{display:inline-block; padding:6px 10px; border-radius:10px; font-weight:700}
  .badge.max{background:#ff5e5e; color:#fff}
  .badge.min{background:#ffd265; color:#2b2300}
  .histSub{color:#a8bed5; font-size:12px; margin-top:6px; text-align:center}

  footer{padding:18px 10px; text-align:center; color:#cfe8ff; font-size:14px; border-top:1px solid rgba(255,255,255,.12)}

  /* horizontálne karty – 4 na mobil */
  .colset{
    --cols:4;
    display:flex;
    gap:var(--gap);
    overflow-x:auto; overflow-y:hidden;
    scrollbar-gutter:stable both-edges;
    -webkit-overflow-scrolling:touch;
    touch-action:pan-x pan-y;
    overscroll-behavior-x:contain;
    padding:8px 0 12px;
    scroll-snap-type:x proximity
  }
  .colset.dragging{cursor:grabbing; user-select:none}

  .col{
    flex:0 0 calc((100% - (var(--cols) - 1)*var(--gap)) / var(--cols));
    background:var(--panel); border:1px solid var(--stroke); border-radius:12px;
    padding:14px;
    display:grid; grid-template-rows:auto auto auto auto auto;
    align-items:center; justify-items:center;
    text-align:center; min-height:182px; position:relative; row-gap:12px;
    min-width:0; overflow:visible;
    scroll-snap-align:start;
    cursor:pointer;
  }
  .colset.dragging .col{ cursor:grabbing; }

  /* Nadpis karty (vyžiadané) */
  .c-top{
    width:100%;
    min-height:2.4em;
    display:flex; align-items:center; justify-content:center;
    padding-inline:8px;
  }
  .c-top__inner{
    white-space:nowrap;
    overflow:visible;
    text-overflow:unset;
    font-weight:600;
    font-size:clamp(11px, 3.4vw, 16px);
    line-height:1.2;
    text-align:center;
  }
  /* jemné minimum, aby sa „Poobede“ zmestilo na 1 riadok */
  .karta, .col{ min-width:100px; }

  .temps{display:grid; place-items:center; width:100%; min-width:0}
  .temps .c-max{font-size:28px; font-weight:700; color:#ff6c6c; line-height:1}
  .temps .c-min{font-size:18px; color:#ffbb7c; margin-top:4px; line-height:1}

  .c-ico{font-size:26px; line-height:1; display:flex; align-items:center; justify-content:center; margin:2px 0 4px}

  .metrics{display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; width:100%}
  .metric{display:flex; flex-direction:column; align-items:center; gap:8px; width:auto}
  .metric .m-ico{line-height:1; font-size:18px}
  .metric .m-txt{min-width:0; white-space:normal; text-align:center; font-size:13.5px; font-weight:500; color:#e9f3ff; letter-spacing:.02px; line-height:1.28; padding-inline:8px}

  /* rozbaľovací detail v karte */
  .drawer{
    width:100%;
    background:#0f1c2a;
    border:1px solid var(--stroke);
    border-radius:10px;
    padding:10px 12px;
    text-align:left;
    max-height:0;
    overflow:hidden;
    opacity:.0;
    transition:max-height .25s ease, opacity .25s ease, margin-top .25s ease;
  }
  .col.open .drawer{
    margin-top:6px;
    max-height:260px;
    opacity:1;
  }
  .drawer .line{display:flex; align-items:center; gap:10px; margin:6px 0; font-size:14px}
  .drawer .dot{width:6px; height:6px; border-radius:50%; background:#3ad0e6}

  @media (max-width:640px){
    .col{min-height:198px; row-gap:14px}
    .c-top{min-height:2.2em}
    .temps .c-max{font-size:30px}
    .temps .c-min{font-size:20px}
    .metric .m-txt{font-size:14px}
  }
  @media (max-width:420px){ .temps .c-max{font-size:26px} .temps .c-min{font-size:17px} }
  @media (min-width:900px){
    #parts{--cols:4} #days{--cols:7} #min15{--cols:6}
    .temps .c-max{font-size:32px} .temps .c-min{font-size:19px}
  }

  .colset::-webkit-scrollbar{height:10px}
  .colset::-webkit-scrollbar-track{background:#0f1c2a; border-radius:8px}
  .colset::-webkit-scrollbar-thumb{background:#33516f; border-radius:8px}
  .colset::-webkit-scrollbar-thumb:hover{background:#3f6b94}
  .colset{scrollbar-width:thin; scrollbar-color:#33516f #0f1c2a}

  @media (min-width:780px){
    .wrap{padding:24px 16px 44px}
    .row{grid-template-columns:1.05fr 1fr; gap:18px}
    .meta{grid-template-columns:repeat(2,minmax(0,1fr))}
    .chartWrap{height:270px}
  }
  @media (min-width:1100px){ .chartWrap{height:300px} }

  #err{position:fixed;left:10px;right:10px;bottom:12px;background:#2a1111;border:1px solid #6b2a2a;color:#ffd9d9;border-radius:10px;padding:10px 12px;font-size:14px;display:none;z-index:99}
</style>
</head>
<body>
  <div class="wrap">
    <header><h1>Počasie</h1></header>

    <div class="toolbar">
      <div class="searchCol">
        <input id="q" class="search" type="text" placeholder="Hľadaj mesto (napr. Bratislava, Košice)" />
        <div id="suggestions"></div>
      </div>
    </div>

    <div class="row">
      <section class="card">
        <div class="gridInfo">
          <div>
            <h3 id="place">—</h3>
            <div class="tempNow" id="temp">—°</div>
            <div class="chipRow">
              <span class="chip" id="uv">UV index —</span>
              <span class="chip" id="aqi">Kvalita ovzdušia —</span>
            </div>
            <div class="meta" style="margin-top:8px">
              <div>Pocitová teplota: <strong id="apparent">—</strong></div>
              <div>Vietor: <strong id="wind">—</strong></div>
              <div>Vlhkosť: <strong id="hum">—</strong></div>
              <div>Tlak: <strong id="press">—</strong></div>
              <div>Východ slnka: <strong id="sunrise">—</strong></div>
              <div>Západ slnka: <strong id="sunset">—</strong></div>
            </div>
          </div>
          <div id="icon" class="icon">—</div>
        </div>

        <div class="summarySection">
          <h3>Dnešný súhrn</h3>
          <p id="summary">—</p>
        </div>
      </section>

      <section class="card">
        <h3>Teplota počas 24 hodín</h3>
        <div class="chartWrap"><canvas id="hourly"></canvas></div>
      </section>
    </div>

    <section class="card">
      <h3>Dnešná predpoveď</h3>
      <div id="parts" class="colset" role="list"></div>
    </section>

    <section class="card">
      <h3>7-dňová predpoveď</h3>
      <div id="days" class="colset" role="list"></div>
    </section>

    <section class="card">
      <h3>15-minútová predpoveď (24 h)</h3>
      <div id="min15" class="colset" role="list"></div>
    </section>

    <section class="card">
      <div class="head" style="text-align:center">
        <h3>Počasie presne pred rokom</h3>
        <div id="hist-date" style="color:var(--muted);font-size:12px">—</div>
      </div>
      <div class="histRow" style="margin-top:8px">
        <div id="hist-emoji" style="font-size:26px">—</div>
        <div style="font-weight:700" id="hist-text">—</div>
        <span class="badge max" id="hist-max">—</span>
        <span class="badge min" id="hist-min">—</span>
      </div>
      <div class="histSub" id="hist-extra">—</div>
    </section>
  </div>

  <footer>&copy; <span id="year"></span> Richard / Počasie</footer>
  <div id="err"></div>

  <script>
    const APP_VERSION = '2025-08-17-final-accordion-v7';
    const $ = s => document.querySelector(s);
    const NBSP_NARROW = '\u202F';
    const fmt0 = (v,u='') => (v==null || Number.isNaN(v)) ? '—' : (Math.round(v) + u);
    const fmt1 = (v,u='') => (v==null || Number.isNaN(v)) ? '—' : ((Math.round(v*10)/10).toFixed(1) + u);

    const WMO = {
      0:['Jasno'],1:['Prevažne jasno'],2:['Polojasno'],3:['Zamračené'],
      45:['Hmla'],48:['Mrznúca hmla'],
      51:['Slabé mrholenie'],53:['Mrholenie'],55:['Silné mrholenie'],
      61:['Slabý dážď'],63:['Dážď'],65:['Lejak'],66:['Mrznúci dážď'],67:['Mrznúci dážď'],
      71:['Slabé sneženie'],73:['Sneženie'],75:['Silné sneženie'],77:['Snehové zrná'],
      80:['Prehánky'],81:['Prehánky'],82:['Silné prehánky'],
      85:['Snehové prehánky'],86:['Silné snehové prehánky'],
      95:['Búrky'],96:['Búrky s krúpami'],99:['Silné búrky s krúpami']
    };
    const RAIN_CODES = new Set([51,53,55,61,63,65,66,67,80,81,82,95,96,99]);
    const uvCat = u => u<3?'nízky':u<6?'mierny':u<8?'vysoký':u<11?'veľmi vysoký':'extrémny';
    const windEmoji = ()=> '💨';

    function wmoEmoji(code, night=false, ctx={}){
      const k = Number(code);
      // "Okrem hmly to tam nechcem" -> hmla = alternatíva (nie ikonka hmly)
      function fogAlt(){
        const t = Number.isFinite(ctx.temp) ? ctx.temp : null;
        const w = Number.isFinite(ctx.wind) ? ctx.wind : null;
        const p = Number.isFinite(ctx.precip) ? ctx.precip : null;
        const prob = Number.isFinite(ctx.prob) ? ctx.prob : null;
        if(t!=null && t<=0) return '❄️';
        if((p!=null && p>0) || (prob!=null && prob>=30)) return '🌧️';
        if(w!=null && w>=20) return '💨';
        return night ? '🌙' : '☁️';
      }
      if ([45,48].includes(k)) return fogAlt();
      if ([0,1].includes(k)) return night ? '🌙' : '☀️';
      if (k===2) return night ? '🌙' : '⛅';
      if (k===3) return '☁️';
      if ([51,53,55].includes(k)) return '🌦️'; // mrholenie -> prehánky štýl
      if ([61,63,65,80,81,82].includes(k)) return ([80,81,82].includes(k) ? '🌦️' : '🌧️');
      if ([71,73,75,77,85,86].includes(k)) return '❄️';
      if ([95,96,99].includes(k)) return '⛈️';
      return night ? '🌙' : '🌤️';
    }

    function isNightAt(dtLike, daily){
      const dt = typeof dtLike==='string' ? new Date(dtLike) : dtLike;
      try{
        const dayStr = dt.toISOString().slice(0,10);
        const times = daily && daily.time ? daily.time : [];
        const i = times.indexOf(dayStr);
        if (i>=0 && daily && daily.sunrise && daily.sunset && daily.sunset[i]){
          const sr = new Date(daily.sunrise[i]);
          const ss = new Date(daily.sunset[i]);
          return (dt < sr || dt >= ss);
        }
      }catch(e){}
      const h = dt.getHours();
      return (h<6 || h>=21);
    }

    const pad = n => String(n).padStart(2,'0');
    const localHourKey = (date)=>{
      const d = typeof date==='string' ? new Date(date) : new Date(date);
      return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) + 'T' + pad(d.getHours());
    };

    function valueAtHourLocal(timesISO, arr, date){
      if(!timesISO || !arr || !timesISO.length) return null;
      const key = localHourKey(date);
      let idx = timesISO.findIndex(t => (t||'').slice(0,13) === key);
      if (idx >= 0) return arr[idx];
      let best=0, bestDiff=1e18;
      timesISO.forEach((t,i)=>{ const diff=Math.abs(new Date(t)-new Date(date)); if(diff<bestDiff){best=i;bestDiff=diff;} });
      return arr[best];
    }

    const lerp=(a,b,t)=>a+(b-a)*t;
    function valueAt15min(timesISO, arr, date){
      if(!timesISO || !arr) return null;
      const ts=timesISO.map(t=>new Date(t));
      for(let i=0;i<ts.length-1;i++){
        const t0=ts[i], t1=ts[i+1];
        if(date>=t0 && date<=t1){
          const r=(date-t0)/(t1-t0), v0=arr[i], v1=arr[i+1];
          if(v0==null || v1==null) return null;
          return lerp(v0,v1,r);
        }
      }
      return null;
    }
    function codeAt15min(timesISO, codes, date){
      if(!timesISO || !codes) return 0;
      const ts=timesISO.map(t=>new Date(t));
      for(let i=0;i<ts.length-1;i++){
        const t0=ts[i], t1=ts[i+1];
        if(date>=t0 && date<=t1){
          const mid=(t0.getTime()+t1.getTime())/2;
          return (date.getTime() < mid) ? (codes[i]??0) : (codes[i+1]??0);
        }
      }
      return codes[codes.length-1] ?? 0;
    }

    function pickDayCondition(d){
      const times=(d.hourly && d.hourly.time) ? d.hourly.time : [];
      const codes=(d.hourly && d.hourly.weather_code) ? d.hourly.weather_code : [];
      const day=(d.current && d.current.time ? d.current.time : '').slice(0,10);
      let startH=9,endH=18;
      const sr=(d.daily && d.daily.sunrise && d.daily.sunrise[0]) ? d.daily.sunrise[0] : null;
      const ss=(d.daily && d.daily.sunset && d.daily.sunset[0]) ? d.daily.sunset[0] : null;
      if(sr && ss){
        const sh=new Date(sr).getHours(), eh=new Date(ss).getHours();
        if(!Number.isNaN(sh) && !Number.isNaN(eh) && sh<eh){startH=sh;endH=eh;}
      }
      const freq={};
      for(let i=0;i<times.length;i++){
        if(!times[i] || !times[i].startsWith(day)) continue;
        const h=Number(times[i].slice(11,13)); if(h<startH || h>endH) continue;
        const c=(codes[i]??0); freq[c]=(freq[c]||0)+1;
      }
      let best=(d.daily && d.daily.weather_code && d.daily.weather_code[0]!=null) ? d.daily.weather_code[0] : (codes[0] ?? 0);
      let bestCnt=-1;
      Object.keys(freq).forEach(k=>{ const cnt=freq[k]; if(cnt>bestCnt){bestCnt=cnt; best=Number(k);} });
      return best;
    }

    /* --------- Agregácie + odhady --------- */
    function sumInRange(times, arr, start, end){
      if(!times || !arr) return 0;
      let s=0;
      for(let i=0;i<times.length;i++){
        const t=new Date(times[i]); if(t>=start && t<end){ const v=arr[i]; if(Number.isFinite(v)) s+=v; }
      }
      return s;
    }
    function avgInRange(times, arr, start, end){
      if(!times || !arr) return null;
      let s=0,c=0;
      for(let i=0;i<times.length;i++){
        const t=new Date(times[i]); if(t>=start && t<end){ const v=arr[i]; if(Number.isFinite(v)){ s+=v; c++; } }
      }
      return c? (s/c) : null;
    }
    function wetHoursInRange(times, precip, start, end, thr=0.1){
      if(!times || !precip) return 0;
      let h=0;
      for(let i=0;i<times.length;i++){
        const t=new Date(times[i]); if(t>=start && t<end){ const v=precip[i]; if(Number.isFinite(v) && v>=thr) h++; }
      }
      return h;
    }
    function probMaxInRange(times, prob, start, end){
      if(!times || !prob) return null;
      let m=null;
      for(let i=0;i<times.length;i++){
        const t=new Date(times[i]); if(t>=start && t<end){ const v=prob[i]; if(Number.isFinite(v)) m = (m==null? v : Math.max(m,v)); }
      }
      return m;
    }
    function ratioRainyHours(times, precip, codes, start, end){
      if(!times) return null;
      let rainy=0, total=0;
      for(let i=0;i<times.length;i++){
        const t=new Date(times[i]);
        if(t>=start && t<end){
          total++;
          const p = precip && Number.isFinite(precip[i]) ? precip[i] : 0;
          const c = codes ? (codes[i]??0) : 0;
          if(p>=0.1 || RAIN_CODES.has(c)) rainy++;
        }
      }
      return total? Math.round(100*rainy/total) : null;
    }
    function mmRange(sum, prob){
      // heuristika: min = 0 ak pravd. < 50 %, inak 50 % zo sumy
      const min = (prob!=null && prob>=50) ? (sum*0.5) : 0;
      const max = sum;
      return (fmt1(min) + NBSP_NARROW + '–' + fmt1(max, NBSP_NARROW+'mm'));
    }
    function durRange(hoursWet){
      const min = (hoursWet>0) ? Math.max(0, hoursWet-1) : 0;
      const max = hoursWet;
      return min+'–'+max+' h';
    }

    const aqiCat = v=>{
      if(v==null||Number.isNaN(v)) return '—';
      if(v<=50) return 'dobrá'; if(v<=100) return 'mierne zhoršená';
      if(v<=150) return 'riziková'; if(v<=200) return 'zlá';
      if(v<=300) return 'veľmi zlá'; return 'nebezpečná';
    };

    let state={place:'—', lat:48.1486, lon:17.1077, last:null};
    let hourlyChart=null;
    const LS_KEY='wx_prefs_v3';

    const toast=msg=>{ const el=$('#err'); if(!el) return; el.textContent=msg; el.style.display='block'; setTimeout(()=>{el.style.display='none'}, 4500) };

    // ukáž chybu JS (ak by niečo spadlo)
    window.addEventListener('error', e=>toast(e.message||'Chyba'));

    try{
      const raw=localStorage.getItem(LS_KEY);
      if(raw){
        const p=JSON.parse(raw);
        if(+p.lat && +p.lon && p.place){ state={...state, ...p}; }
      }
    }catch(e){}

    const savePrefs=()=>{ try{ localStorage.setItem(LS_KEY, JSON.stringify({lat:state.lat, lon:state.lon, place:state.place})); }catch(e){} };

    async function reverseGeocodeOpenMeteo(lat, lon){
      try{
        const url='https://geocoding-api.open-meteo.com/v1/reverse?latitude='+lat+'&longitude='+lon+'&language=sk&format=json';
        const j=await fetch(url).then(r=>r.json());
        const r=j && j.results && j.results[0] ? j.results[0] : null;
        if (r){
          const name=r.name||r.city||r.town||r.village||'';
          const admin=r.admin1?(', '+r.admin1):'';
          const cc=r.country_code?(', '+r.country_code):'';
          if (name) return name+admin+cc;
          if (r.admin1) return r.admin1+cc;
        }
      }catch(e){}
      return null;
    }
    async function reverseGeocodeNominatim(lat, lon){
      try{
        const url='https://nominatim.openstreetmap.org/reverse?lat='+lat+'&lon='+lon+'&format=json&accept-language=sk';
        const res=await fetch(url,{headers:{'Accept':'application/json'}});
        const data=await res.json();
        const a=data.address||{};
        const name=a.city||a.town||a.village||a.municipality||a.hamlet||a.suburb||'';
        const admin=a.state||a.county||a.region||'';
        const cc=a.country_code?(', '+a.country_code.toUpperCase()):'';
        if(name) return name+(admin? ', '+admin:'')+cc;
        if(admin) return admin+cc;
      }catch(e){}
      return null;
    }
    async function reverseGeocode(lat, lon){
      const a=await reverseGeocodeOpenMeteo(lat, lon); if(a) return a;
      const b=await reverseGeocodeNominatim(lat, lon); if(b) return b;
      return 'Moja poloha';
    }

    async function setLocation(lat,lon,labelOpt){
      state.lat=lat; state.lon=lon;
      const label = labelOpt || await reverseGeocode(lat, lon) || 'Moja poloha';
      state.place = label;
      savePrefs();
      await fetchWeather().catch(e=>toast(e.message||'Chyba načítania počasia'));
    }

    function initGeolocation(){
      if(!('geolocation'in navigator)){ fetchWeather().catch(()=>toast('Geolokácia nedostupná')); return; }
      const placeEl=$('#place'); placeEl.textContent='Zisťujem polohu…';
      navigator.geolocation.getCurrentPosition(async pos=>{
        const {latitude, longitude}=pos.coords||{};
        if (latitude!=null && longitude!=null) await setLocation(latitude, longitude);
        else fetchWeather().catch(()=>toast('Geolokácia zlyhala'));
      }, ()=>{
        fetchWeather().catch(()=>toast('Geolokácia zablokovaná'));
      }, {enableHighAccuracy:true, timeout:10000, maximumAge:300000});
    }

    /* ------- FETCH s FALLBACKOM ------- */
    async function fetchWeather(){
      const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;
      const baseParams={
        latitude:state.lat, longitude:state.lon, timezone:tz,
        current:'temperature_2m,apparent_temperature,relative_humidity_2m,pressure_msl,wind_speed_10m,weather_code,uv_index',
        daily:'weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,precipitation_sum,uv_index_max,wind_speed_10m_max,wind_gusts_10m_max,sunrise,sunset',
        forecast_days:'7'
      };
      const richHourly='temperature_2m,precipitation,precipitation_probability,weather_code,wind_speed_10m,wind_gusts_10m,relative_humidity_2m,pressure_msl';
      const safeHourly='temperature_2m,precipitation,weather_code,wind_speed_10m';

      async function tryFetch(hourlyList){
        const p=new URLSearchParams({...baseParams, hourly:hourlyList});
        const res=await fetch('https://api.open-meteo.com/v1/forecast?'+p+'&v='+APP_VERSION);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const j=await res.json();
        if(j && j.error) throw new Error('API error');
        return j;
      }

      try{
        state.last=await tryFetch(richHourly);
      }catch(_){
        state.last=await tryFetch(safeHourly);
      }

      if(state.place==='—'){
        try{ const label=await reverseGeocode(state.lat, state.lon); if(label){ state.place=label; savePrefs(); } }catch(_){}
      }

      renderAll(); drawHourly(); await fetchAQ().catch(()=>{}); renderDays(state.last); fetchHistory().catch(()=>{});
    }

    function renderAll(){
      const d=state.last || {}; const cur=d.current || {};
      $('#place').textContent=state.place;
      $('#temp').textContent=fmt0(cur.temperature_2m,'°');
      $('#apparent').textContent=fmt0(cur.apparent_temperature,'°');
      $('#wind').textContent=fmt1(cur.wind_speed_10m, NBSP_NARROW+'km/h');
      $('#hum').textContent=fmt0(cur.relative_humidity_2m, NBSP_NARROW+'%');
      $('#press').textContent=fmt0(cur.pressure_msl, NBSP_NARROW+'hPa');
      $('#icon').textContent=wmoEmoji(cur.weather_code, isNightAt(cur.time, d.daily||{}), {temp:cur.temperature_2m, wind:cur.wind_speed_10m});

      const uvi=(cur.uv_index!=null ? cur.uv_index : (d.daily && d.daily.uv_index_max && d.daily.uv_index_max[0]!=null ? d.daily.uv_index_max[0] : null));
      $('#uv').textContent = uvi!=null ? ('UV index '+fmt1(uvi)+' • '+uvCat(uvi)) : 'UV index —';

      const dd=d.daily || {};
      const tmax=dd.temperature_2m_max && dd.temperature_2m_max[0];
      const tmin=dd.temperature_2m_min && dd.temperature_2m_min[0];
      const ps=dd.precipitation_sum && dd.precipitation_sum[0];
      const pp=dd.precipitation_probability_max && dd.precipitation_probability_max[0];
      const wmax=dd.wind_speed_10m_max && dd.wind_speed_10m_max[0];
      const condToday=(WMO[pickDayCondition(d)] && WMO[pickDayCondition(d)][0])||'—';
      const rainTxt = (ps!=null && ps >= 0.1) ? ('zrážky do '+fmt1(ps, NBSP_NARROW+'mm')) : ((pp!=null && pp>20) ? ('bez výrazných zrážok (pravdepodobnosť '+pp+'%)') : 'bez zrážok');
      const uvTxt = (dd.uv_index_max && dd.uv_index_max[0]!=null) ? ('UV '+uvCat(dd.uv_index_max[0])+' (max '+fmt1(dd.uv_index_max[0])+')') : 'UV údaj nedostupný';
      $('#summary').innerHTML='Dnes <strong>'+condToday.toLowerCase()+'</strong>, max <strong>'+fmt0(tmax,'°')+'</strong>, min <strong>'+fmt0(tmin,'°')+'</strong>, '+rainTxt+', vietor do <strong>'+fmt1(wmax, NBSP_NARROW+'km/h')+'</strong>, '+uvTxt+'.';

      const sr=(dd.sunrise && dd.sunrise[0]) ? new Date(dd.sunrise[0]) : null;
      const ss=(dd.sunset && dd.sunset[0]) ? new Date(dd.sunset[0]) : null;
      $('#sunrise').textContent=sr?sr.toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit'}):'—';
      $('#sunset').textContent=ss?ss.toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit'}):'—';

      renderParts(); renderMin15();
    }

    async function fetchAQ(){
      try{
        const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;
        const p=new URLSearchParams({latitude:state.lat, longitude:state.lon, timezone:tz, hourly:'us_aqi,pm2_5,pm10'});
        const j=await fetch('https://air-quality-api.open-meteo.com/v1/air-quality?'+p+'&v='+APP_VERSION).then(r=>r.json());
        const t=(state && state.last && state.last.current && state.last.current.time) ? state.last.current.time : (j.hourly && j.hourly.time ? j.hourly.time[0] : null);
        const aqi=valueAtHourLocal(j.hourly.time, j.hourly.us_aqi, t);
        const chip=$('#aqi'); const num=(aqi==null||Number.isNaN(aqi))?'—':String(Math.round(aqi));
        chip.textContent='Kvalita ovzdušia '+num+' • '+aqiCat(aqi);
      }catch(e){ $('#aqi').textContent='Kvalita ovzdušia —'; }
    }

    function drawHourly(){
      const d=state.last || {}; const cur=d.current || {};
      const hours=(d.hourly && d.hourly.time) ? d.hourly.time : [];
      if(!hours.length) return;
      const key=localHourKey(cur.time || hours[0]);
      let i=hours.findIndex(h=>(h||'').slice(0,13)===key); if(i<0)i=0;
      const labels=hours.slice(i,i+24).map(h=>(h||'').split('T')[1]||'');
      const t24=(d.hourly && d.hourly.temperature_2m) ? d.hourly.temperature_2m.slice(i,i+24) : [];
      if(hourlyChart) try{ hourlyChart.destroy(); }catch(_){}
      if (window.Chart){
        hourlyChart=new Chart($('#hourly'),{
          type:'line',
          data:{labels, datasets:[{label:'Teplota (°C)', data:t24, borderWidth:2, pointRadius:2, tension:.35}]},
          options:{responsive:true, maintainAspectRatio:false, interaction:{mode:'nearest', intersect:false},
            scales:{x:{grid:{color:'rgba(255,255,255,.08)'}}, y:{grid:{color:'rgba(255,255,255,.08)'}}},
            plugins:{legend:{display:false}}
          }
        });
      }
    }

    function tLabel(html){ return '<div class="c-top"><span class="c-top__inner">'+html+'</span></div>'; }

    /* ---- Drag + klik (PC aj mobil) ---- */
    function enableDragScroll(el){
      let isDown=false, startX=0, startScroll=0, lastX=0, lastT=0, vx=0, moved=false;
      const DRAG_THRESHOLD=6;

      el.addEventListener('pointerdown', e=>{
        if(e.button!==0) return;
        isDown=true; moved=false;
        startX=e.clientX; startScroll=el.scrollLeft;
        lastX=e.clientX; lastT=performance.now(); vx=0;
        el.setPointerCapture(e.pointerId);
        if(e.pointerType!=='mouse') e.preventDefault();
        el.classList.remove('dragging');
      });

      el.addEventListener('pointermove', e=>{
        if(!isDown) return;
        const now=performance.now();
        const dx=e.clientX-startX;
        if(Math.abs(dx)>DRAG_THRESHOLD){ moved=true; el.classList.add('dragging'); }
        el.scrollLeft = startScroll - dx;
        const ddx=e.clientX-lastX, dt=Math.max(1, now-lastT);
        vx = -(ddx/dt); lastX=e.clientX; lastT=now;
      });

      function momentum(v){
        let velocity=v*14; const friction=0.92;
        function step(){
          if(Math.abs(velocity)<0.25) return;
          el.scrollLeft += velocity; velocity*=friction;
          if(el.scrollLeft<=0 || Math.ceil(el.scrollLeft)>=el.scrollWidth-el.clientWidth) return;
          requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      }

      el.addEventListener('pointerup', e=>{
        if(!isDown) return;
        isDown=false; el.classList.remove('dragging');
        try{ el.releasePointerCapture(e.pointerId) }catch(_){}
        if(moved){ momentum(vx); }
        el.dataset.justDragged = moved ? '1' : '0';
        setTimeout(()=>{ el.dataset.justDragged='0'; }, 60);
      });

      el.addEventListener('pointercancel', ()=>{ isDown=false; el.classList.remove('dragging') });
      el.addEventListener('wheel', (e)=>{ const delta = Math.abs(e.deltaY) > Math.abs(e.deltaX) ? e.deltaY : e.deltaX; el.scrollLeft += delta * 0.6; e.preventDefault() }, {passive:false});
    }

    function toggleCard(card){
      const isOpen = card.classList.toggle('open');
      card.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    }
    function attachAccordion(container){
      container.addEventListener('click', (e)=>{
        if(container.dataset.justDragged === '1') return;
        const card = e.target.closest('.col');
        if(!card || !container.contains(card)) return;
        toggleCard(card);
      });
      container.addEventListener('keydown', (e)=>{
        if(e.key!=='Enter' && e.key!==' ') return;
        const card = e.target.closest('.col');
        if(!card) return;
        e.preventDefault();
        toggleCard(card);
      });
    }

    /* ------- DNEŠNÉ ČASTI ------- */
    function renderParts(){
      const wrap=$('#parts'); if(!wrap) return; wrap.innerHTML='';
      const d=state.last || {}, h=d.hourly||{}, dd=d.daily||{};
      if(!(h.time && h.time.length)) { wrap.innerHTML='<div style="opacity:.8;color:#bcd1e5;padding:8px 10px;">Bez dát</div>'; return; }

      const base=new Date((d.current && d.current.time) ? d.current.time : h.time[0]);
      const dayStart=new Date(base); dayStart.setHours(0,0,0,0);

      const SLOTS=[
        {label:'Doobede', startH:6,  endH:12},
        {label:'Poobede', startH:12, endH:18},
        {label:'Večer',   startH:18, endH:24},
        {label:'Noc',     startH:0,  endH:6, shift:+1}
      ];

      SLOTS.forEach(s=>{
        const start=new Date(dayStart); const end=new Date(dayStart);
        if(s.shift===+1){ start.setDate(start.getDate()+1); end.setDate(end.getDate()+1); }
        start.setHours(s.startH,0,0,0); end.setHours(s.endH,0,0,0);

        const mid=new Date((start.getTime()+end.getTime())/2);
        const temp=valueAtHourLocal(h.time, h.temperature_2m, mid);
        const wind=avgInRange(h.time, h.wind_speed_10m, start, end);
        const prcpSum=sumInRange(h.time, h.precipitation, start, end);
        const wetH=wetHoursInRange(h.time, h.precipitation, start, end);
        let prob=probMaxInRange(h.time, h.precipitation_probability, start, end);
        if(prob==null) prob = ratioRainyHours(h.time, h.precipitation, h.weather_code, start, end);
        if(prob==null && dd.precipitation_probability_max && dd.precipitation_probability_max[0]!=null) prob=dd.precipitation_probability_max[0];

        const code=codesModeInRange(h.time, h.weather_code, start, end);

        const el=document.createElement('div'); el.className='col'; el.tabIndex=0; el.setAttribute('role','button'); el.setAttribute('aria-expanded','false');
        el.innerHTML=
          tLabel(s.label) +
          '<div class="temps"><div class="c-max">'+fmt0(temp,'°')+'</div><div class="c-min">'+(temp!=null?fmt0(temp-5,'°'):'—')+'</div></div>'+
          '<div class="c-ico">'+wmoEmoji(code, isNightAt(start,d.daily||{}), {temp, wind, precip: prcpSum, prob})+'</div>'+
          '<div class="metrics">'+
            '<div class="metric"><span class="m-ico">💧</span><span class="m-txt">'+(prob!=null? (Math.round(prob)+' %'): '—')+'</span></div>'+
          '</div>'+
          '<div class="drawer">'+
            '<div class="line"><span class="dot"></span><span><strong>Zrážky:</strong> '+(prob!=null?Math.round(prob)+' %':'—')+' | '+mmRange(prcpSum, prob)+' | '+durRange(wetH)+'</span></div>'+
            '<div class="line"><span class="dot"></span><span><strong>Vietor:</strong> '+(wind!=null?fmt1(wind,NBSP_NARROW+'km/h'):'—')+'</span></div>'+
          '</div>';
        wrap.appendChild(el);
      });

      enableDragScroll(wrap);
      attachAccordion(wrap);
    }

    /* ------- 7 dní ------- */
    function renderDays(data){
      const box=$('#days'); if(!box) return; box.innerHTML='';
      const d=data||state.last||{}; const days=(d.daily||{}); const times=days.time||[];
      const h=state.last.hourly||{};
      const n=Math.min(7,times.length);

      if(!n){ box.innerHTML='<div style="opacity:.8;color:#bcd1e5;padding:8px 10px;">Bez dát</div>'; return; }

      for(let i=0;i<n;i++){
        const start=new Date(times[i]+'T00:00:00');
        const end=new Date(start); end.setDate(end.getDate()+1);

        const max=days.temperature_2m_max?days.temperature_2m_max[i]:null;
        const min=days.temperature_2m_min?days.temperature_2m_min[i]:null;
        const code=days.weather_code?days.weather_code[i]:null;

        let prob=days.precipitation_probability_max?days.precipitation_probability_max[i]:null;
        if(prob==null) prob = ratioRainyHours(h.time||[], h.precipitation||[], h.weather_code||[], start, end);

        const sumDaily=(days.precipitation_sum && days.precipitation_sum[i]!=null) ? days.precipitation_sum[i] : null;
        const sumHourly=sumInRange(h.time||[], h.precipitation||[], start, end);
        const totalMM = (sumDaily!=null ? sumDaily : sumHourly);
        const wetH=wetHoursInRange(h.time||[], h.precipitation||[], start, end);

        const top = start.toLocaleDateString('sk-SK',{weekday:'short'})+' '+start.toLocaleDateString('sk-SK',{day:'2-digit',month:'2-digit'});
        const dayIco = wmoEmoji(code, false, {prob, temp:(max!=null&&min!=null)?(max+min)/2:null});

        const el=document.createElement('div'); el.className='col'; el.tabIndex=0; el.setAttribute('role','button'); el.setAttribute('aria-expanded','false');
        el.innerHTML=
          tLabel(top)+
          '<div class="temps"><div class="c-max">'+fmt0(max,'°')+'</div><div class="c-min">'+fmt0(min,'°')+'</div></div>'+
          '<div class="c-ico">'+dayIco+'</div>'+
          '<div class="metrics"><div class="metric"><span class="m-ico">💧</span><span class="m-txt">'+(prob!=null?prob+' %':'—')+'</span></div></div>'+
          '<div class="drawer">'+
            '<div class="line"><span class="dot"></span><span><strong>Zrážky:</strong> '+(prob!=null?prob+' %':'—')+' | '+mmRange(totalMM||0, prob)+' | '+durRange(wetH)+'</span></div>'+
            (days.wind_speed_10m_max && days.wind_speed_10m_max[i]!=null ? '<div class="line"><span class="dot"></span><span><strong>Vietor:</strong> do '+fmt1(days.wind_speed_10m_max[i],NBSP_NARROW+'km/h')+'</span></div>' : '')+
            (days.wind_gusts_10m_max && days.wind_gusts_10m_max[i]!=null ? '<div class="line"><span class="dot"></span><span><strong>Nárazy:</strong> do '+fmt1(days.wind_gusts_10m_max[i],NBSP_NARROW+'km/h')+'</span></div>' : '')+
          '</div>';
        box.appendChild(el);
      }

      enableDragScroll(box);
      attachAccordion(box);
    }

    /* ------- 15-minútové karty ------- */
    function renderMin15(){
      const d=state.last || {}; const box=$('#min15'); if(!box) return; box.innerHTML='';
      if(!(d.hourly && d.hourly.time && d.hourly.time.length)){ box.innerHTML='<div style="opacity:.8;color:#bcd1e5;padding:8px 10px;">Bez dát</div>'; return; }

      const start=new Date((d.current && d.current.time) ? d.current.time : d.hourly.time[0]);
      const m=start.getMinutes(); const add=(15-(m%15))%15; if(add>0) start.setMinutes(m+add,0,0);

      for(let k=0;k<96;k++){
        const t=new Date(start.getTime()+k*15*60*1000);
        const tmp=valueAt15min(d.hourly.time, d.hourly.temperature_2m, t);
        const prepRate=valueAt15min(d.hourly.time, d.hourly.precipitation, t); // mm/h
        let prob=valueAt15min(d.hourly.time, d.hourly.precipitation_probability, t);
        if(prob==null && d.daily && d.daily.precipitation_probability_max) prob=d.daily.precipitation_probability_max[0] ?? null;
        const code=codeAt15min(d.hourly.time, d.hourly.weather_code, t);
        const wind=valueAt15min(d.hourly.time, d.hourly.wind_speed_10m, t);

        const mmQuarter = Number.isFinite(prepRate) ? (prepRate*0.25) : 0;
        const durTxt = (mmQuarter>0) ? '0–0.25 h' : '0 h';

        const el=document.createElement('div'); el.className='col'; el.tabIndex=0; el.setAttribute('role','button'); el.setAttribute('aria-expanded','false');
        el.innerHTML=
          tLabel(t.toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit'}))+
          '<div class="temps"><div class="c-max">'+fmt0(tmp,'°')+'</div><div class="c-min">'+(tmp!=null?fmt0(tmp-5,'°'):'—')+'</div></div>'+
          '<div class="c-ico">'+wmoEmoji(code, isNightAt(t,d.daily||{}), {temp: tmp, wind, precip: prepRate, prob})+'</div>'+
          '<div class="metrics">'+
            '<div class="metric"><span class="m-ico">💧</span><span class="m-txt">'+(prob!=null?Math.round(prob)+' %':'—')+'</span></div>'+
          '</div>'+
          '<div class="drawer">'+
            '<div class="line"><span class="dot"></span><span><strong>Zrážky:</strong> '+(prob!=null?Math.round(prob)+' %':'—')+' | '+('0–'+fmt1(mmQuarter, NBSP_NARROW+'mm'))+' | '+durTxt+'</span></div>'+
            '<div class="line"><span class="dot"></span><span><strong>Vietor:</strong> '+(wind!=null?fmt1(wind,NBSP_NARROW+'km/h'):'—')+'</span></div>'+
          '</div>';
        box.appendChild(el);
      }

      enableDragScroll(box);
      attachAccordion(box);
    }

    async function fetchHistory(){
      try{
        const baseTime=(state && state.last && state.last.current && state.last.current.time) ? new Date(state.last.current.time) : new Date();
        const lastYear=new Date(baseTime); lastYear.setFullYear(lastYear.getFullYear()-1);
        const day=lastYear.toISOString().slice(0,10);
        $('#hist-date').textContent=new Intl.DateTimeFormat('sk-SK',{dateStyle:'full'}).format(lastYear);
        const p=new URLSearchParams({latitude:state.lat, longitude:state.lon, start_date:day, end_date:day, daily:'weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum', timezone:'auto'});
        const j=await fetch('https://archive-api.open-meteo.com/v1/archive?'+p+'&v='+APP_VERSION).then(r=>r.json());
        const dd=j.daily || {};
        const code=dd.weather_code ? dd.weather_code[0] : null;
        const tmax=dd.temperature_2m_max ? dd.temperature_2m_max[0] : null;
        const tmin=dd.temperature_2m_min ? dd.temperature_2m_min[0] : null;
        const pr=(dd.precipitation_sum && dd.precipitation_sum[0]!=null) ? dd.precipitation_sum[0] : 0;
        const avgT = (tmax!=null && tmin!=null) ? (tmax+tmin)/2 : null;
        $('#hist-emoji').textContent=wmoEmoji(code,false,{temp:avgT,precip:pr});
        $('#hist-text').textContent=(WMO[code] && WMO[code][0])||'—';
        $('#hist-max').textContent=fmt1(tmax,'°C');
        $('#hist-min').textContent=fmt1(tmin,'°C');
        $('#hist-extra').textContent=pr>0?('Zrážky: '+fmt1(pr, NBSP_NARROW+'mm')):'Bez zrážok.';
      }catch(e){
        $('#hist-extra').textContent='Históriu sa nepodarilo načítať.';
      }
    }

    /* --- vyhľadávanie miest --- */
    let timer;
    $('#q').addEventListener('input', e=>{
      const q=e.target.value.trim(); clearTimeout(timer);
      if(q.length<2){ $('#suggestions').style.display='none'; return }
      timer=setTimeout(async ()=>{
        const url='https://geocoding-api.open-meteo.com/v1/search?name='+encodeURIComponent(q)+'&count=6&language=sk&format=json';
        const res=await fetch(url).then(r=>r.json()).catch(()=>({}));
        const arr=res.results||[];
        const box=$('#suggestions'); box.innerHTML=''; box.style.display='grid';
        if(!arr.length){ box.innerHTML='<div class="sugg">Nič sa nenašlo</div>'; return }
        arr.forEach(p=>{
          const b=document.createElement('div'); b.className='sugg';
          b.textContent=p.name+(p.admin1?(', '+p.admin1):'')+', '+p.country_code;
          b.addEventListener('click', ()=>{ setLocation(p.latitude,p.longitude,b.textContent); box.style.display='none' });
          box.appendChild(b);
        });
      },250);
    });
    document.addEventListener('click', e=>{ const box=$('#suggestions'); if(box && !box.contains(e.target) && e.target!==$('#q')) box.style.display='none' });

    document.getElementById('year').textContent=new Date().getFullYear();

    function initSections(){ ['parts','days','min15'].forEach(id=>{ const el=document.getElementById(id); if(el){ enableDragScroll(el); attachAccordion(el); } }) }

    initGeolocation();
    window.addEventListener('resize', ()=>{ if(state.last){ drawHourly(); renderMin15() }});
    setTimeout(()=>{ if(!state.last) fetchWeather().catch(()=>toast('Načítanie počasia zlyhalo')) },1200);
    initSections();

    if(!window.__wx_auto_refresh){
      window.__wx_auto_refresh=setInterval(()=>{
        if(state.lat && state.lon){ fetchWeather().catch(()=>{}); fetchAQ().catch(()=>{}) }
      }, 5*60*1000);
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Predpoveď počasia</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root { --glass: rgba(255,255,255,.08); --glass-b: rgba(255,255,255,.18); }
  *{ box-sizing:border-box }
  html,body{ width:100%; max-width:100%; overflow-x:hidden }
  body{
    margin:0; color:#fff;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    background:#0e4d73;
  }
  .glass{ background:var(--glass); border:1px solid var(--glass-b); backdrop-filter:blur(12px); border-radius:1rem }
  .hero{ display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:56vh; text-align:center; }
  #heroIcon{ width:130px; height:130px; margin:1rem auto }
  #heroTemp{ font-size:6rem; font-weight:700 }
  .sticky-header{ position:sticky; top:0; z-index:50 }
  .tbl th,.tbl td{ padding:.6rem .75rem; white-space:nowrap }
  .emo{ font-size:1.5em }
  #permMsg{ font-size:.9rem; color:#fff; opacity:.85; }
</style>
</head>
<body data-mode="day">

<section class="hero">
  <div id="heroPlace">—</div>
  <div id="heroIcon"></div>
  <div id="heroTemp">--°</div>
</section>

<header class="sticky-header w-full glass">
  <div class="w-full px-4 py-3 flex flex-col gap-2 items-center">
    <form id="searchForm" class="grid grid-cols-1 gap-2 w-full sm:w-[560px] place-items-center" novalidate>
      <input id="cityInput" placeholder="Zadajte mesto"
        class="w-full px-4 py-2.5 rounded-lg bg-white/20 border border-white/20 placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50"
        autocomplete="off" inputmode="search" type="search" />
      <div class="flex gap-2">
        <button id="searchBtn" type="submit"
          class="px-4 py-2.5 rounded-lg bg-white/30 hover:bg-white/40 text-white font-medium">
          Hľadať
        </button>
        <button id="geoBtn" type="button"
          class="px-4 py-2.5 rounded-lg bg-white/20 hover:bg-white/30 text-white font-medium">
          Použiť moju polohu
        </button>
      </div>
    </form>
    <div id="permMsg"></div>
  </div>
</header>

<main class="w-full px-3 py-4 space-y-4">
  <div id="dailyList" class="space-y-2"></div>
  <div id="loading" class="hidden text-center py-6">Načítavam…</div>
  <div id="err" class="hidden text-center text-red-300">Nepodarilo sa načítať údaje.</div>
</main>

<script>
const API='https://api.open-meteo.com/v1';
const GEO='https://geocoding-api.open-meteo.com/v1';
const IPINFO='https://ipapi.co/json/';

const el={
  heroPlace:document.getElementById('heroPlace'),
  heroIcon:document.getElementById('heroIcon'),
  heroTemp:document.getElementById('heroTemp'),
  permMsg:document.getElementById('permMsg'),
  loading:document.getElementById('loading'),
  err:document.getElementById('err'),
  dailyList:document.getElementById('dailyList'),
  geoBtn:document.getElementById('geoBtn'),
  input:document.getElementById('cityInput')
};

// === pomocné ===
function iconFor(code){
  if([0,1].includes(code))return'☀️';
  if(code===2)return'⛅';
  if(code===3)return'☁️';
  if([61,63,65,80,81,82].includes(code))return'🌧️';
  if([71,73,75].includes(code))return'🌨️';
  if([95,96,99].includes(code))return'⛈️';
  return'🌤️';
}
function descFor(code){
  const d={0:'Jasno',1:'Prevažne jasno',2:'Čiastočne oblačno',3:'Zamračené',
           61:'Slabý dážď',63:'Mierny dážď',65:'Silný dážď',71:'Sneženie',95:'Búrka'};
  return d[code]||'—';
}

// === API volania ===
async function fetchWx(lat,lon){
  const url=`${API}/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,is_day,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=10`;
  const r=await fetch(url);
  if(!r.ok)throw new Error('api');
  return await r.json();
}
async function reverseGeocode(lat,lon){
  const r=await fetch(`${GEO}/reverse?latitude=${lat}&longitude=${lon}&language=sk`);
  const j=await r.json(); const res=j.results&&j.results[0];
  if(!res)return'Vaša poloha';
  return res.name||res.admin2||res.admin1||'Vaša poloha';
}
async function ipFallback(){
  const r=await fetch(IPINFO);
  const j=await r.json();
  if(!j||!j.latitude)return null;
  return {lat:j.latitude,lon:j.longitude,city:j.city||'Podľa IP'};
}

// === Render ===
function renderWeather(city,wx){
  el.heroPlace.textContent=city;
  el.heroIcon.textContent=iconFor(wx.current.weather_code);
  el.heroTemp.textContent=Math.round(wx.current.temperature_2m)+'°';
  const D=wx.daily;
  el.dailyList.innerHTML='';
  for(let i=0;i<D.time.length;i++){
    const d=new Date(D.time[i]);
    const name=d.toLocaleDateString('sk-SK',{weekday:'short'});
    const tmax=Math.round(D.temperature_2m_max[i]);
    const tmin=Math.round(D.temperature_2m_min[i]);
    const code=D.weather_code[i];
    const div=document.createElement('div');
    div.className='glass p-3 rounded-lg flex justify-between';
    div.innerHTML=`<div>${name} ${d.getDate()}. ${iconFor(code)} ${descFor(code)}</div>
                   <div>${tmax}° / ${tmin}°</div>`;
    el.dailyList.appendChild(div);
  }
}

// === Logika lokalizácie ===
async function getPosition(){
  return new Promise((res,rej)=>{
    if(!navigator.geolocation) return rej('unsupported');
    navigator.geolocation.getCurrentPosition(
      pos=>res({lat:pos.coords.latitude,lon:pos.coords.longitude}),
      err=>rej(err),
      {enableHighAccuracy:true,timeout:10000,maximumAge:0}
    );
  });
}

async function locateAndLoad(){
  el.loading.classList.remove('hidden');
  el.err.classList.add('hidden');
  el.permMsg.textContent='Zisťujem polohu…';
  try{
    const {lat,lon}=await getPosition(); // pokus o natívne povolenie
    const city=await reverseGeocode(lat,lon);
    const wx=await fetchWx(lat,lon);
    renderWeather(city,wx);
    el.permMsg.textContent='';
  }catch(e){
    // ak používateľ odmietne alebo chyba – fallback podľa IP
    console.warn('geo err:',e);
    const ip=await ipFallback();
    if(ip){
      const city=ip.city;
      const wx=await fetchWx(ip.lat,ip.lon);
      renderWeather(city,wx);
      el.permMsg.textContent='(Poloha podľa IP)';
    }else{
      const wx=await fetchWx(48.1486,17.1077); // Bratislava
      renderWeather('Bratislava',wx);
      el.permMsg.textContent='(Predvolená poloha: Bratislava)';
    }
  }finally{
    el.loading.classList.add('hidden');
  }
}

// === Ovládanie ===
el.geoBtn.addEventListener('click',()=>locateAndLoad());
document.getElementById('searchForm').addEventListener('submit',async ev=>{
  ev.preventDefault();
  const q=el.input.value.trim();
  if(!q)return;
  el.loading.classList.remove('hidden');
  try{
    const r=await fetch(`${GEO}/search?name=${encodeURIComponent(q)}&count=1&language=sk`);
    const j=await r.json();
    if(!j.results||!j.results[0])throw new Error();
    const city=j.results[0];
    const wx=await fetchWx(city.latitude,city.longitude);
    renderWeather(city.name,wx);
    el.permMsg.textContent='';
  }catch{
    el.err.classList.remove('hidden');
  }finally{
    el.loading.classList.add('hidden');
  }
});

// automatický pokus po načítaní
locateAndLoad();
</script>
</body>
</html>

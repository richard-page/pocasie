<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes, maximum-scale=6, viewport-fit=cover" />
  <title>Meteo Pulse</title>
  <link rel="icon" type="image/png" href="https://placehold.co/32x32/1b2230/eaf3ff?text=M" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --ink:#eaf3ff; --muted:#a8bed5; --ink-weak:#cfe1f6;
      --bg0:#0b0e15; --bg1:#0e1420;
      --panel:#111b2a; --glass:#0d1422;
      --stroke:#233448; --glow:#4bd1ff; --hot:#ff6d7a; --warm:#ffb773;
      --r:16px; --gap:10px; --shadow:0 12px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family:"Plus Jakarta Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 100% -10%, rgba(45,161,255,.20), transparent 70%),
        radial-gradient(900px 500px at -20% 100%, rgba(141,61,255,.15), transparent 60%),
        linear-gradient(180deg,var(--bg1),var(--bg0));
      -webkit-text-size-adjust:100%;
    }

    .shell{max-width:1140px;margin:auto;padding:20px 14px 36px}
    .topbar{
      display:flex; align-items:center; gap:10px; margin-bottom:16px
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.2px; font-size:20px
    }
    .brand .dot{width:12px;height:12px;border-radius:999px;background:conic-gradient(from 90deg, #4bd1ff, #8b6cff)}
    .search{
      flex:1; position:relative
    }
    .search input{
      width:100%; background:var(--panel); color:#fff; border:1px solid var(--stroke);
      border-radius:12px; padding:12px 14px; outline:none; font-size:15px
    }
    .search input:focus{border-color:#355b80; box-shadow:0 0 0 3px rgba(75,209,255,.12)}
    #sugg{position:absolute;left:0;right:0;top:calc(100% + 6px);display:none;z-index:30;
      background:var(--glass); border:1px solid var(--stroke); border-radius:12px; padding:8px; max-height:50vh; overflow:auto}
    .sugg{padding:10px;border:1px solid var(--stroke); background:#0f1b2b; border-radius:10px; margin-bottom:6px; cursor:pointer}
    .sugg:last-child{margin-bottom:0}

    /* HERO PANEL */
    .hero{
      display:grid; grid-template-columns:1.05fr 1fr; gap:14px
    }
    @media (max-width:780px){ .hero{grid-template-columns:1fr} }

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke); border-radius:var(--r); box-shadow:var(--shadow); padding:16px 14px
    }
    .panel h3{margin:0 0 12px; font-size:18px; text-align:center}

    .now{
      display:grid; grid-template-columns:1fr auto; gap:16px; align-items:center
    }
    .place{margin:0; font-size:18px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .temp{font-size:56px; font-weight:700; line-height:1}
    .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px}
    .chip{display:inline-flex; align-items:center; gap:8px; background:#14283a; border:1px solid var(--stroke); border-radius:999px; padding:8px 12px; font-size:13px}
    .now .emoji{font-size:64px; display:flex; align-items:center; justify-content:center}

    .facts{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px; margin-top:10px; color:var(--ink-weak); font-size:14px}
    .facts strong{color:#fff}

    .summary{background:#0f1b2b; border:1px solid var(--stroke); border-radius:12px; padding:10px; text-align:center; margin-top:10px; color:#cfe1f6}

    /* RAILS (horizont√°lne kolekcie) ‚Äî 4 KARTY NA MOBILE */
    .rail{
      --cols:4;
      display:flex; gap:var(--gap);
      overflow-x:auto; overflow-y:hidden;
      scrollbar-gutter:stable both-edges;
      -webkit-overflow-scrolling:touch;
      padding:10px 6px 12px;
      scroll-snap-type:x proximity;
      cursor:grab
    }
    .rail.drag{cursor:grabbing; user-select:none}

    .tile{
      flex:0 0 calc((100% - (var(--cols) - 1)*var(--gap)) / var(--cols));
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--stroke); border-radius:14px; padding:12px;
      display:grid; grid-template-rows:auto auto auto auto; row-gap:8px; justify-items:center; min-height:180px;
      scroll-snap-align:start
    }
    .t-top{opacity:.92; font-weight:600}
    .t-temps{display:grid; place-items:center}
    .t-max{font-size:28px; font-weight:700; color:var(--hot); line-height:1}
    .t-min{font-size:18px; color:var(--warm); line-height:1; margin-top:2px}
    .t-ico{font-size:26px}

    /* Key‚ÄìValue metriky ‚Äì nezalamova≈• */
    .kv{display:grid; grid-template-columns:auto 1fr auto; gap:6px; align-items:center; width:100%}
    .kv .k{font-size:13px; color:#e9f3ff; opacity:.9; white-space:nowrap}
    .kv .v{font-size:13px; font-weight:700; white-space:nowrap}
    .kv .ico{font-size:16px}

    @media (min-width:900px){
      #rail-days{--cols:7}
      #rail-min15{--cols:6}
      .temp{font-size:64px}
    }

    /* chart box */
    .chartbox{height:260px}
    canvas{background:#0f1b2b; border:1px solid var(--stroke); border-radius:12px}

    /* toast */
    #toast{position:fixed;left:10px;right:10px;bottom:12px;z-index:50;display:none;background:#2a1111;border:1px solid #6b2a2a;color:#ffd9d9;border-radius:10px;padding:10px 12px;font-size:14px}
  </style>
</head>

<body>
  <div class="shell">
    <div class="topbar">
      <div class="brand"><span class="dot"></span> Meteo&nbsp;Pulse</div>
      <div class="search">
        <input id="q" type="text" placeholder="Zadaj mesto (napr. ≈Ωilina, Ko≈°ice)" />
        <div id="sugg"></div>
      </div>
    </div>

    <section class="hero">
      <div class="panel">
        <div class="now">
          <div>
            <h2 id="place" class="place">‚Äî</h2>
            <div id="temp" class="temp">‚Äî¬∞</div>
            <div class="chips">
              <span id="uv" class="chip">UV ‚Äî</span>
              <span id="aqi" class="chip">AQI ‚Äî</span>
            </div>
            <div class="facts">
              <div>Pocitov√°: <strong id="apparent">‚Äî</strong></div>
              <div>Vietor: <strong id="wind">‚Äî</strong></div>
              <div>Vlhkos≈•: <strong id="hum">‚Äî</strong></div>
              <div>Tlak: <strong id="press">‚Äî</strong></div>
              <div>V√Ωchod: <strong id="sunrise">‚Äî</strong></div>
              <div>Z√°pad: <strong id="sunset">‚Äî</strong></div>
            </div>
          </div>
          <div id="emoji" class="emoji">‚Äî</div>
        </div>
        <div class="summary" id="summary">‚Äî</div>
      </div>

      <div class="panel">
        <h3>Teplota poƒças 24 hod√≠n</h3>
        <div class="chartbox"><canvas id="chart"></canvas></div>
      </div>
    </section>

    <section class="panel" style="margin-top:16px">
      <h3>Dnes v ≈°tyroch blokoch</h3>
      <div id="rail-parts" class="rail"></div>
    </section>

    <section class="panel" style="margin-top:16px">
      <h3>Najbli≈æ≈°√≠ch 7 dn√≠</h3>
      <div id="rail-days" class="rail"></div>
    </section>

    <section class="panel" style="margin-top:16px">
      <h3>Predpoveƒè po 15 min (24 h)</h3>
      <div id="rail-min15" class="rail"></div>
    </section>

    <section class="panel" style="margin-top:16px">
      <h3>Presne pred rokom</h3>
      <div class="rail" style="--cols:4">
        <div class="tile" id="hist-card" style="min-height:150px">
          <div class="t-top" id="hist-date">‚Äî</div>
          <div class="t-ico" id="hist-emoji">‚Äî</div>
          <div class="t-temps">
            <div class="t-max" id="hist-max">‚Äî</div>
            <div class="t-min" id="hist-min">‚Äî</div>
          </div>
          <div class="kv"><span class="ico">üìù</span><span class="k">Popis</span><span class="v" id="hist-text">‚Äî</span></div>
        </div>
      </div>
    </section>
  </div>

  <footer style="text-align:center;color:#cfe1f6;padding:16px 10px;border-top:1px solid rgba(255,255,255,.12)">
    &copy; <span id="year"></span> Meteo Pulse
  </footer>
  <div id="toast"></div>

  <script>
    /* ---------- mini utility ---------- */
    const $ = s => document.querySelector(s);
    const NB = '\u202F';
    const fmt0 = (v,u='') => (v==null||Number.isNaN(v)) ? '‚Äî' : (Math.round(v)+u);
    const fmt1 = (v,u='') => (v==null||Number.isNaN(v)) ? '‚Äî' : ((Math.round(v*10)/10).toFixed(1)+u);
    const pad = n => String(n).padStart(2,'0');
    const year = new Date().getFullYear(); $('#year').textContent = year;

    const toast = (t)=>{ const el=$('#toast'); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none', 4500) };

    /* ---------- constants ---------- */
    const WMO = {
      0:['Jasno'],1:['Preva≈æne jasno'],2:['Polojasno'],3:['Zamraƒçen√©'],
      45:['Hmla'],48:['Mrzn√∫ca hmla'],
      51:['Slab√© mrholenie'],53:['Mrholenie'],55:['Siln√© mrholenie'],
      61:['Slab√Ω d√°≈æƒè'],63:['D√°≈æƒè'],65:['Lejak'],66:['Mrzn√∫ci d√°≈æƒè'],67:['Mrzn√∫ci d√°≈æƒè'],
      71:['Slab√© sne≈æenie'],73:['Sne≈æenie'],75:['Siln√© sne≈æenie'],77:['Snehov√© zrn√°'],
      80:['Preh√°nky'],81:['Preh√°nky'],82:['Siln√© preh√°nky'],
      85:['Snehov√© preh√°nky'],86:['Siln√© snehov√© preh√°nky'],
      95:['B√∫rky'],96:['B√∫rky s kr√∫pami'],99:['Siln√© b√∫rky s kr√∫pami']
    };
    const RAIN_CODES = new Set([51,53,55,61,63,65,66,67,80,81,82,95,96,99]);
    const uvCat = u => u<3?'n√≠zky':u<6?'mierny':u<8?'vysok√Ω':u<11?'veƒæmi vysok√Ω':'extr√©mny';
    const windIco = 'üí®';

    const state = { place:'‚Äî', lat:48.1486, lon:17.1077, data:null, aqi:null, hist:null };
    const LSKEY = 'mpulse_prefs_v1';
    try{ const raw=localStorage.getItem(LSKEY); if(raw){ const p=JSON.parse(raw); if(+p.lat && +p.lon && p.place) Object.assign(state,p);} }catch(e){}

    /* ---------- helpers for time-aligned values ---------- */
    const hourKey = d => {const x=new Date(d); return x.getFullYear()+'-'+pad(x.getMonth()+1)+'-'+pad(x.getDate())+'T'+pad(x.getHours())}
    function valueAtHour(times, arr, date){
      if(!times||!arr||!times.length) return null;
      const key=hourKey(date); let i=times.findIndex(t=>t.slice(0,13)===key);
      if(i>=0) return arr[i];
      let best=0,bd=1e18; times.forEach((t,idx)=>{const diff=Math.abs(new Date(t)-new Date(date)); if(diff<bd){bd=diff; best=idx}});
      return arr[best];
    }
    const lerp = (a,b,t)=>a+(b-a)*t;
    function valueAt15m(times, arr, date){
      if(!times||!arr) return null;
      const ts=times.map(t=>new Date(t));
      for(let i=0;i<ts.length-1;i++){ const t0=ts[i], t1=ts[i+1];
        if(date>=t0 && date<=t1){ const r=(date-t0)/(t1-t0); const v0=arr[i], v1=arr[i+1]; if(v0==null||v1==null) return null; return lerp(v0,v1,r); }}
      return null;
    }
    function codeAt15m(times, codes, date){
      if(!times||!codes) return 0;
      const ts=times.map(t=>new Date(t));
      for(let i=0;i<ts.length-1;i++){ const t0=ts[i], t1=ts[i+1];
        if(date>=t0 && date<=t1){ const mid=(t0.getTime()+t1.getTime())/2; return (date<new Date(mid))?codes[i]:codes[i+1]; } }
      return codes[codes.length-1] ?? 0;
    }

    const willRain = ({code,precip,temp,prob,precipSum}={})=>{
      if(prob!=null && prob>=30) return true;
      if(code!=null && RAIN_CODES.has(Number(code))) return true;
      if(precipSum!=null && precipSum>=0.1) return true;
      if(precip!=null && precip>0){ if(temp==null) return true; return temp>1 }
      return false;
    };

    function isNightAt(dtLike, daily){
      const dt=new Date(dtLike);
      try{
        const d=dt.toISOString().slice(0,10);
        const i=(daily?.time||[]).indexOf(d);
        if(i>=0 && daily.sunrise?.[i] && daily.sunset?.[i]){
          const sr=new Date(daily.sunrise[i]); const ss=new Date(daily.sunset[i]);
          return (dt<sr || dt>=ss);
        }
      }catch(e){}
      const h=dt.getHours(); return (h<6 || h>=21);
    }

    function emoji(code, night=false, ctx={}){
      const k=Number(code);
      const fog=()=>{
        const t=Number.isFinite(ctx.temp)?ctx.temp:null;
        const w=Number.isFinite(ctx.wind)?ctx.wind:null;
        const p=Number.isFinite(ctx.precip)?ctx.precip:null;
        const pr=Number.isFinite(ctx.prob)?ctx.prob:null;
        if(t!=null && t<=0) return '‚ùÑÔ∏è';
        if((p!=null && p>0) || (pr!=null && pr>=30)) return 'üåßÔ∏è';
        if(w!=null && w>=20) return 'üí®';
        return night?'üåô':'‚òÅÔ∏è';
      };
      if([45,48].includes(k)) return fog();
      if([0,1].includes(k)) return night?'üåô':'‚òÄÔ∏è';
      if(k===2) return night?'üåô':'‚õÖ';
      if(k===3) return '‚òÅÔ∏è';
      if([51,53,55].includes(k)) return 'üå¶Ô∏è';
      if([61,63,65,80,81,82].includes(k)) return 'üåßÔ∏è';
      if([71,73,75,77,85,86].includes(k)) return '‚ùÑÔ∏è';
      if([95,96,99].includes(k)) return '‚õàÔ∏è';
      return night?'üåô':'üå§Ô∏è';
    }

    /* ---------- data load ---------- */
    async function geocodeReverse(lat,lon){
      try{
        const u=`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=sk&format=json`;
        const j=await fetch(u).then(r=>r.json()); const r=j?.results?.[0];
        if(r){ const name=r.name||r.city||r.town||r.village||''; const admin=r.admin1?`, ${r.admin1}`:''; const cc=r.country_code?`, ${r.country_code}`:''; return (name||admin)?(name+admin+cc):'Moja poloha' }
      }catch(e){}
      return 'Moja poloha';
    }

    async function loadAll(){
      const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;
      const p = new URLSearchParams({
        latitude:state.lat, longitude:state.lon, timezone:tz,
        current:'temperature_2m,apparent_temperature,relative_humidity_2m,pressure_msl,wind_speed_10m,weather_code,uv_index,is_day',
        hourly:'time,temperature_2m,precipitation_probability,weather_code,uv_index,wind_speed_10m',
        daily:'time,weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,precipitation_sum,uv_index_max,wind_speed_10m_max,sunrise,sunset',
        forecast_days:'7', models:'best_match'
      });
      const url=`https://api.open-meteo.com/v1/forecast?${p}`;
      const aqiUrl=`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${state.lat}&longitude=${state.lon}&hourly=european_aqi&timezone=${encodeURIComponent(tz)}`;
      const dayAgo=new Date(); dayAgo.setFullYear(dayAgo.getFullYear()-1); const day=dayAgo.toISOString().slice(0,10);
      const histUrl=`https://archive-api.open-meteo.com/v1/archive?latitude=${state.lat}&longitude=${state.lon}&start_date=${day}&end_date=${day}&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto`;

      const [w,aqi,hist]=await Promise.all([
        fetch(url).then(r=>r.json()).catch(()=>({})),
        fetch(aqiUrl).then(r=>r.json()).catch(()=>({})),
        fetch(histUrl).then(r=>r.json()).catch(()=>({}))
      ]);

      if(!w || w.error){ toast(w?.reason||'Naƒç√≠tanie poƒçasia zlyhalo'); return; }
      state.data=w; state.aqi=aqi; state.hist=hist;
      state.place = await geocodeReverse(state.lat,state.lon);
      localStorage.setItem(LSKEY, JSON.stringify({lat:state.lat, lon:state.lon, place:state.place}));
      renderAll();
    }

    /* ---------- render ---------- */
    let chart=null;

    function renderAll(){
      const d=state.data; if(!d) return;
      const cur=d.current || {}, day=d.daily || {};
      const night = cur.is_day===0;

      $('#place').textContent=state.place;
      $('#temp').textContent=fmt0(cur.temperature_2m,'¬∞');
      $('#emoji').textContent=emoji(cur.weather_code, night, {temp:cur.temperature_2m, wind:cur.wind_speed_10m, precip:cur.precipitation});
      $('#apparent').textContent=fmt0(cur.apparent_temperature,'¬∞');
      $('#wind').textContent=fmt0(cur.wind_speed_10m, NB+' km/h');
      $('#hum').textContent=fmt0(cur.relative_humidity_2m, NB+' %');
      $('#press').textContent=fmt0(cur.pressure_msl, NB+' hPa');
      $('#sunrise').textContent=new Date(day.sunrise[0]).toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit'});
      $('#sunset').textContent=new Date(day.sunset[0]).toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit'});

      const uNow=valueAtHour(d.hourly.time, d.hourly.uv_index, new Date());
      $('#uv').textContent = uNow!=null ? `UV ${fmt0(uNow)} ‚Ä¢ ${uvCat(uNow)}` : 'UV ‚Äî';

      const aqit = state.aqi?.hourly?.time, aqiv=state.aqi?.hourly?.european_aqi;
      const aNow = (aqit && aqiv) ? valueAtHour(aqit, aqiv, new Date()) : null;
      $('#aqi').textContent = aNow!=null ? `AQI ${Math.round(aNow)} ‚Ä¢ ${aqiCat(aNow)}` : 'AQI ‚Äî';

      const max=day.temperature_2m_max?.[0], min=day.temperature_2m_min?.[0];
      const condTxt=(WMO[cur.weather_code]?.[0]) || '‚Äî';
      $('#summary').innerHTML = `Dnes <strong>${condTxt.toLowerCase()}</strong>, max <strong>${fmt0(max,'¬∞')}</strong>, min <strong>${fmt0(min,'¬∞')}</strong>.`;

      drawChart(d);
      renderParts(d);
      renderDays(d);
      renderMin15(d);
      renderHistory(state.hist);
    }

    function aqiCat(v){
      if(v==null||Number.isNaN(v)) return '‚Äî';
      if(v<=50) return 'dobr√°'; if(v<=100) return 'mierne zhor≈°en√°';
      if(v<=150) return 'rizikov√°'; if(v<=200) return 'zl√°'; if(v<=300) return 'veƒæmi zl√°'; return 'nebezpeƒçn√°';
    }

    function drawChart(d){
      const ctx=$('#chart').getContext('2d');
      const labels=d.hourly.time.map(t=>t.slice(11,16));
      const temps=d.hourly.temperature_2m;
      if(chart) chart.destroy();
      chart=new Chart(ctx,{
        type:'line',
        data:{labels,datasets:[{label:'Teplota (¬∞C)', data:temps, borderWidth:2, pointRadius:2, tension:.35, borderColor:'#4bd1ff'}]},
        options:{responsive:true, maintainAspectRatio:false,
          scales:{x:{grid:{color:'rgba(255,255,255,.08)'}}, y:{grid:{color:'rgba(255,255,255,.08)'}}},
          plugins:{legend:{display:false}}
        }
      });
    }

    function cardHTML({top,max,min,ico,kv=[]}){
      const rows = kv.map(([i,k,v])=>`<div class="kv"><span class="ico">${i}</span><span class="k">${k}</span><span class="v">${v}</span></div>`).join('');
      return `<div class="tile">
        <div class="t-top">${top}</div>
        <div class="t-temps"><div class="t-max">${max}</div>${min?`<div class="t-min">${min}</div>`:''}</div>
        <div class="t-ico">${ico}</div>
        ${rows}
      </div>`;
    }

    function renderParts(d){
      const rail=$('#rail-parts'); rail.innerHTML='';
      const base=new Date(d.current.time || Date.now());
      const labels=['Doobeda','Poobede','Veƒçer','Noc'];
      const hrs=[10,15, (new Date(d.daily.sunset[0]).getHours()||20)+1, 2];
      labels.forEach((L,idx)=>{
        const dt=new Date(base); dt.setHours(hrs[idx],0,0,0);
        const t=valueAtHour(d.hourly.time, d.hourly.temperature_2m, dt);
        const c=valueAtHour(d.hourly.time, d.hourly.weather_code, dt);
        const p=valueAtHour(d.hourly.time, d.hourly.precipitation_probability, dt);
        const w=valueAtHour(d.hourly.time, d.hourly.wind_speed_10m, dt);
        const ico=emoji(c, isNightAt(dt, d.daily), {temp:t, prob:p, wind:w});
        rail.insertAdjacentHTML('beforeend', cardHTML({
          top:L, max:fmt0(t,'¬∞'), min:fmt0((t!=null?t-5:null),'¬∞'),
          ico, kv:[['üíß','Zr√°≈æky', p!=null?fmt0(p,'%'):'‚Äî'], [windIco,'Vietor', fmt0(w, NB+'km/h')]]
        }));
      });
    }

    function renderDays(d){
      const rail=$('#rail-days'); rail.innerHTML='';
      const n=Math.min(7, d.daily.time.length);
      for(let i=0;i<n;i++){
        const dt=new Date(d.daily.time[i]+'T00:00:00');
        const dd=dt.toLocaleDateString('sk-SK',{weekday:'short', day:'2-digit', month:'2-digit'});
        const code=d.daily.weather_code[i];
        const ico=emoji(code,false,{prob:d.daily.precipitation_probability_max[i]});
        rail.insertAdjacentHTML('beforeend', cardHTML({
          top:dd, max:fmt0(d.daily.temperature_2m_max[i],'¬∞'), min:fmt0(d.daily.temperature_2m_min[i],'¬∞'),
          ico, kv:[['üíß','Pravdep.', d.daily.precipitation_probability_max[i]!=null?fmt0(d.daily.precipitation_probability_max[i],'%'):'‚Äî'],
                   [windIco,'Vietor', fmt0(d.daily.wind_speed_10m_max[i], NB+'km/h')]]
        }));
      }
    }

    function renderMin15(d){
      const rail=$('#rail-min15'); rail.innerHTML='';
      // Open-Meteo nemus√≠ ma≈• v≈ædy minutely_15 ‚Äì pou≈æijeme ‚Äûhodinov√Ω‚Äú fallback
      const m15=d.minutely_15;
      if(!m15 || !m15.time){ rail.innerHTML='<div style="opacity:.8;color:#cfe1f6;padding:8px 10px;">Min√∫tov√° predpoveƒè nedostupn√°</div>'; return; }
      const start=new Date(d.current.time || Date.now());
      const m=start.getMinutes(); const add=(15-(m%15))%15; if(add>0) start.setMinutes(m+add,0,0);
      for(let k=0;k<96;k++){
        const t=new Date(start.getTime()+k*15*60*1000);
        const tmp=valueAt15m(m15.time, m15.temperature_2m, t);
        const code=codeAt15m(m15.time, m15.weather_code, t);
        const prep=valueAt15m(m15.time, m15.precipitation, t);
        const ico=emoji(code, isNightAt(t, d.daily), {temp:tmp,precip:prep});
        rail.insertAdjacentHTML('beforeend', cardHTML({
          top:t.toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit'}),
          max:fmt0(tmp,'¬∞'), min:'',
          ico, kv:[['üíß','Zr√°≈æky', prep!=null?fmt1(prep, NB+'mm/h'):'‚Äî']]
        }));
      }
    }

    function renderHistory(h){
      const dd=h?.daily||{}; if(!dd.time?.length){ $('#hist-date').textContent='‚Äî'; return; }
      const code=dd.weather_code[0]; const tmax=dd.temperature_2m_max[0]; const tmin=dd.temperature_2m_min[0];
      const dt=new Date(dd.time[0]+'T00:00:00');
      $('#hist-date').textContent = dt.toLocaleDateString('sk-SK',{dateStyle:'full'});
      $('#hist-emoji').textContent = emoji(code);
      $('#hist-text').textContent = (WMO[code] && WMO[code][0])||'‚Äî';
      $('#hist-max').textContent = fmt1(tmax,'¬∞C');
      $('#hist-min').textContent = fmt1(tmin,'¬∞C');
    }

    /* ---------- interactions ---------- */
    function enableDrag(el){
      let down=false, startX=0, startScroll=0;
      el.addEventListener('pointerdown',e=>{ if(e.button!==0) return; down=true; el.classList.add('drag'); startX=e.clientX; startScroll=el.scrollLeft; el.setPointerCapture(e.pointerId) });
      el.addEventListener('pointermove',e=>{ if(!down) return; el.scrollLeft = startScroll - (e.clientX-startX) });
      el.addEventListener('pointerup',e=>{ down=false; el.classList.remove('drag'); try{el.releasePointerCapture(e.pointerId)}catch(_){} });
      el.addEventListener('pointercancel',()=>{ down=false; el.classList.remove('drag') });
    }
    ['rail-parts','rail-days','rail-min15'].forEach(id=>{ const el=document.getElementById(id); if(el) enableDrag(el) });

    // geolok√°cia
    function initGeo(){
      if(!('geolocation' in navigator)){ loadAll(); return; }
      navigator.geolocation.getCurrentPosition(async pos=>{
        state.lat=pos.coords.latitude; state.lon=pos.coords.longitude; await loadAll();
      }, _=> loadAll(), {enableHighAccuracy:true, timeout:10000, maximumAge:300000});
    }

    // vyhƒæad√°vanie
    let tmr=null;
    $('#q').addEventListener('input', ()=>{
      clearTimeout(tmr); const box=$('#sugg'); const q=$('#q').value.trim();
      if(q.length<3){ box.style.display='none'; return }
      tmr=setTimeout(async ()=>{
        try{
          const u=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=8&language=sk&format=json`;
          const j=await fetch(u).then(r=>r.json()); const arr=j.results||[];
          box.innerHTML=''; box.style.display='block';
          if(!arr.length){ box.innerHTML='<div class="sugg" style="opacity:.8">Niƒç sa nena≈°lo</div>'; return }
          arr.forEach(p=>{
            const it=document.createElement('div'); it.className='sugg';
            it.textContent = p.name + (p.admin1?`, ${p.admin1}`:'') + ', ' + p.country_code;
            it.addEventListener('click', async ()=>{
              state.lat=p.latitude; state.lon=p.longitude; state.place=it.textContent;
              box.style.display='none'; await loadAll();
            });
            box.appendChild(it);
          });
        }catch(e){ box.style.display='none'; }
      },250);
    });
    document.addEventListener('click', e=>{ const box=$('#sugg'); if(box && !box.contains(e.target) && e.target!==$('#q')) box.style.display='none' });

    /* ---------- boot ---------- */
    initGeo();
    // auto-refresh ka≈æd√Ωch 5 min
    setInterval(()=>{ if(state.lat && state.lon) loadAll(); }, 5*60*1000);
  </script>
</body>
</html>

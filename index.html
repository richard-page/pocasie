<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Počasie Radar - Predpoveď počasia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    :root{
      --card-blur: 8px;
    }

    html,body{
      font-family:'Inter',sans-serif;
      background: linear-gradient(135deg,#f8fafc 0%,#e2e8f0 50%,#cbd5e1 100%);
      min-height:100vh;
      margin:0;
      padding:0;
    }

    .weather-card{
      background: rgba(255,255,255,0.88);
      -webkit-backdrop-filter: blur(var(--card-blur));
      backdrop-filter: blur(var(--card-blur));
      box-shadow: 0 4px 16px rgba(0,0,0,.15);
      border:1px solid rgba(255,255,255,0.18);
      transition: box-shadow .2s ease;
      will-change: box-shadow;
    }
    .weather-card:hover{
      box-shadow: 0 8px 28px rgba(0,0,0,.22);
    }

    .header-gradient{
      background: linear-gradient(135deg,#1e40af 0%,#3730a3 50%,#581c87 100%);
      box-shadow: 0 4px 20px rgba(0,0,0,.25);
    }

    .loading-spinner{
      border:3px solid #e2e8f0;border-radius:50%;
      border-top:3px solid #3b82f6;width:30px;height:30px;animation:spin 1s linear infinite;
    }
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    .fade-in{animation:fadeIn .4s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    .hourly-scroll{scrollbar-width:thin;scrollbar-color:#cbd5e1 #f1f5f9}
    .hourly-scroll::-webkit-scrollbar{height:6px}
    .hourly-scroll::-webkit-scrollbar-track{background:#f1f5f9;border-radius:3px}
    .hourly-scroll::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px}
    .hourly-scroll::-webkit-scrollbar-thumb:hover{background:#94a3b8}

    .temp-high{color:#dc2626;font-weight:600}
    .temp-low{color:#2563eb;font-weight:500}
    .current-temp{font-size:3.5rem;font-weight:300;color:#1e293b}

    .detail-item{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f1f5f9}
    .detail-item:last-child{border-bottom:none}

    .nav-tabs{border-bottom:2px solid #e2e8f0}
    .nav-tab{padding:12px 24px;cursor:pointer;border-bottom:2px solid transparent;transition:all .15s}
    .nav-tab.active{border-bottom-color:#3b82f6;color:#3b82f6;font-weight:600}
    .nav-tab:hover{background:rgba(59,130,246,.1)}

    .glass-effect{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2)}
    .gradient-text{background:linear-gradient(135deg,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .floating-animation{animation:float 6s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}

    /* Výkon: renderuj veľké sekcie len keď sú v zornom poli */
    #hourlyTab, #dailyTab{content-visibility:auto;contain-intrinsic-size:800px 600px}

    /* Prepínače pre graf */
    .chip{
      display:inline-flex;align-items:center;gap:.5rem;
      border:1px solid #e5e7eb;border-radius:9999px;padding:.35rem .75rem;
      font-size:.875rem;cursor:pointer;user-select:none;
      transition:background .15s,border-color .15s,color .15s;
    }
    .chip[data-active="true"]{
      background:#eff6ff;border-color:#93c5fd;color:#1d4ed8;
      font-weight:600;
    }

    @media (prefers-reduced-motion:reduce){
      .floating-animation{animation:none}
      .weather-card:hover{box-shadow:0 4px 16px rgba(0,0,0,.15)}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header-gradient text-white shadow-lg">
    <div class="container mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="text-2xl floating-animation">🌤️</div>
          <h1 class="text-xl font-semibold gradient-text">Počasie Radar</h1>
        </div>
        <div class="text-sm opacity-90" id="lastUpdate">Posledná aktualizácia: --:--</div>
      </div>
    </div>
  </header>

  <div class="container mx-auto px-4 py-6 max-w-6xl min-h-screen">
    <!-- Search Section -->
    <div class="weather-card rounded-lg p-4 mb-6">
      <div class="flex flex-col sm:flex-row gap-3">
        <div class="flex-1 relative">
          <input id="cityInput" type="text" placeholder="Zadajte názov mesta (napr. Bratislava, Košice, Prešov...)"
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <button onclick="searchWeather()"
          class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-lg font-medium transition-all duration-300 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl">
          🔍 Vyhľadať
        </button>
        <button onclick="getCurrentLocation()"
          class="px-6 py-3 bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 text-white rounded-lg font-medium transition-all duration-300 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl">
          📍 Moja poloha
        </button>
      </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="hidden text-center py-12">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p class="text-gray-600">Načítavam údaje o počasí...</p>
    </div>

    <!-- Error -->
    <div id="error" class="hidden weather-card rounded-lg p-6 mb-6 text-center">
      <div class="text-6xl mb-4">⚠️</div>
      <h3 class="text-xl font-semibold text-gray-800 mb-2">Chyba pri načítavaní</h3>
      <p class="text-gray-600" id="errorMessage"></p>
    </div>

    <!-- Weather Content -->
    <div id="weatherContent" class="hidden fade-in">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Main -->
        <div class="lg:col-span-3 space-y-6">
          <!-- Current Weather -->
          <div class="weather-card rounded-lg p-6">
            <div class="flex flex-col sm:flex-row items-start justify-between mb-6">
              <div class="mb-4 sm:mb-0">
                <h2 class="text-3xl font-bold text-gray-800 mb-2" id="cityName">Bratislava</h2>
                <p class="text-gray-600 mb-1" id="currentDate"></p>
                <p class="text-sm text-gray-500" id="coordinates"></p>
              </div>
              <div class="flex items-center gap-6">
                <span class="text-7xl floating-animation" id="weatherIcon">☀️</span>
                <div class="text-right">
                  <div class="current-temp gradient-text" id="temperature">22°</div>
                  <div class="text-gray-600 font-medium text-lg" id="weatherDescription">Slnečno</div>
                </div>
              </div>
            </div>
            <!-- Quick Stats -->
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 pt-4 border-t border-gray-200">
              <div class="text-center">
                <div class="text-gray-500 text-sm mb-1">Pocitová</div>
                <div class="font-semibold text-gray-800" id="feelsLike">25°C</div>
              </div>
              <div class="text-center">
                <div class="text-gray-500 text-sm mb-1">Vietor</div>
                <div class="font-semibold text-gray-800" id="windSpeed">12 km/h</div>
              </div>
              <div class="text-center">
                <div class="text-gray-500 text-sm mb-1">Vlhkosť</div>
                <div class="font-semibold text-gray-800" id="humidity">65%</div>
              </div>
              <div class="text-center">
                <div class="text-gray-500 text-sm mb-1">Tlak</div>
                <div class="font-semibold text-gray-800" id="pressure">1013 hPa</div>
              </div>
            </div>
          </div>

          <!-- Tabs -->
          <div class="weather-card rounded-lg">
            <div class="nav-tabs flex">
              <div class="nav-tab active" onclick="showTab('hourly', this)">Hodinová predpoveď</div>
              <div class="nav-tab" onclick="showTab('daily', this)">7-dňová predpoveď</div>
            </div>
          </div>

          <!-- Hourly -->
          <div id="hourlyTab" class="weather-card rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-gray-800">Hodinová predpoveď na najbližších 24 hodín</h3>
              <div class="flex items-center gap-2">
                <button id="chipActual" class="chip" data-active="true" onclick="toggleSeries('actual')">
                  <span class="inline-block w-3 h-3 rounded-full bg-blue-500"></span> Teplota
                </button>
                <button id="chipFeels" class="chip" data-active="true" onclick="toggleSeries('feels')">
                  <span class="inline-block w-3 h-3 rounded-full bg-orange-500"></span> Pocitová
                </button>
              </div>
            </div>

            <div class="hourly-scroll overflow-x-auto mb-6">
              <div class="flex gap-4 pb-2" id="hourlyForecast" style="min-width: 1200px;"></div>
            </div>

            <!-- Insights -->
            <div class="border-t border-gray-200 pt-6">
              <h4 class="text-md font-semibold text-gray-800 mb-4">Prehľad dňa</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-4 rounded-lg text-white shadow">
                  <div class="flex items-center gap-3 mb-2">
                    <span class="text-2xl">🌡️</span>
                    <div>
                      <div class="font-medium">Teplotný rozsah</div>
                      <div class="text-blue-100 text-sm" id="tempRange">15°C - 22°C</div>
                    </div>
                  </div>
                </div>
                <div class="bg-gradient-to-br from-green-500 to-emerald-600 p-4 rounded-lg text-white shadow">
                  <div class="flex items-center gap-3 mb-2">
                    <span class="text-2xl">💨</span>
                    <div>
                      <div class="font-medium">Priemerný vietor</div>
                      <div class="text-green-100 text-sm" id="avgWind">12 km/h</div>
                    </div>
                  </div>
                </div>
                <div class="bg-gradient-to-br from-purple-500 to-violet-600 p-4 rounded-lg text-white shadow">
                  <div class="flex items-center gap-3 mb-2">
                    <span class="text-2xl">💧</span>
                    <div>
                      <div class="font-medium">Max pravdepodobnosť dažďa</div>
                      <div class="text-purple-100 text-sm" id="rainChance">—</div>
                    </div>
                  </div>
                </div>
                <div class="bg-gradient-to-br from-orange-500 to-red-500 p-4 rounded-lg text-white shadow">
                  <div class="flex items-center gap-3 mb-2">
                    <span class="text-2xl">☀️</span>
                    <div>
                      <div class="font-medium">Najlepší čas vonku</div>
                      <div class="text-orange-100 text-sm" id="bestTime">—</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Temp chart -->
            <div class="border-t border-gray-200 pt-6 mt-6">
              <h4 class="text-md font-semibold text-gray-800 mb-4">Graf teplôt za 24 hodín</h4>
              <div class="bg-white p-6 rounded-lg shadow border">
                <div class="relative">
                  <svg id="tempChartSvg" width="100%" height="220" class="overflow-visible"></svg>
                </div>
                <div class="mt-4 text-center">
                  <div class="flex items-center justify-center gap-4 text-sm text-gray-600">
                    <div class="flex items-center gap-2">
                      <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                      <span>Teplota (°C)</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <div class="w-3 h-3 bg-orange-500 rounded-full"></div>
                      <span>Pocitová teplota (°C)</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Daily -->
          <div id="dailyTab" class="hidden weather-card rounded-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">7-dňová predpoveď</h3>
            <div class="space-y-2" id="dailyForecast"></div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1 space-y-6">
          <div class="weather-card rounded-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Podrobnosti</h3>
            <div class="space-y-1">
              <div class="detail-item"><span class="text-gray-600">Viditeľnosť</span><span class="font-medium" id="visibility">—</span></div>
              <div class="detail-item"><span class="text-gray-600">UV index</span><span class="font-medium" id="uvIndex">—</span></div>
              <div class="detail-item"><span class="text-gray-600">Východ slnka</span><span class="font-medium" id="sunrise">—</span></div>
              <div class="detail-item"><span class="text-gray-600">Západ slnka</span><span class="font-medium" id="sunset">—</span></div>
              <div class="detail-item"><span class="text-gray-600">Dĺžka dňa</span><span class="font-medium" id="dayLength">—</span></div>
            </div>
          </div>

          <div class="weather-card rounded-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Doplnkové informácie</h3>
            <div class="space-y-3">
              <div class="bg-blue-50 p-3 rounded-lg">
                <div class="text-sm text-blue-800 font-medium mb-1">Kvalita vzduchu</div>
                <div class="text-blue-600 text-sm">Dobré podmienky</div>
              </div>
              <div class="bg-green-50 p-3 rounded-lg">
                <div class="text-sm text-green-800 font-medium mb-1">Podmienky pre šport</div>
                <div class="text-green-600 text-sm">Vhodné pre aktivity vonku</div>
              </div>
              <div class="bg-orange-50 p-3 rounded-lg">
                <div class="text-sm text-orange-800 font-medium mb-1">UV ochrana</div>
                <div class="text-orange-600 text-sm" id="uvAdvice">Použite opaľovací krém</div>
              </div>
            </div>
          </div>

          <div class="weather-card rounded-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Rýchle odkazy</h3>
            <div class="space-y-2">
              <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm text-gray-600">📊 Podrobné grafy</button>
              <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm text-gray-600">🌍 Mapa počasia</button>
              <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm text-gray-600">📱 Mobilná aplikácia</button>
              <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm text-gray-600">⚠️ Výstrahy</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-white border-t border-gray-200 mt-12 shadow-lg">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
        <div>
          <div class="flex items-center gap-2 mb-4">
            <span class="text-2xl">🌤️</span>
            <h3 class="text-lg font-semibold text-gray-800">Počasie Radar</h3>
          </div>
          <p class="text-gray-600 text-sm">Presné predpovede počasia pre Slovensko a celý svet. Aktuálne údaje každú hodinu.</p>
        </div>
        <div>
          <h4 class="font-semibold text-gray-800 mb-3">Predpovede</h4>
          <ul class="space-y-2 text-sm text-gray-600">
            <li><a href="#" class="hover:text-blue-600 transition-colors">Hodinová predpoveď</a></li>
            <li><a href="#" class="hover:text-blue-600 transition-colors">7-dňová predpoveď</a></li>
            <li><a href="#" class="hover:text-blue-600 transition-colors">Mesačná predpoveď</a></li>
            <li><a href="#" class="hover:text-blue-600 transition-colors">Sezónna predpoveď</a></li>
          </ul>
        </div>
        <div>
          <h4 class="font-semibold text-gray-800 mb-3">Mapy a radary</h4>
          <ul class="space-y-2 text-sm text-gray-600">
            <li><a href="#" class="hover:text-blue-600 transition-colors">Zrážkový radar</a></li>
            <li><a href="#" class="hover:text-blue-600 transition-colors">Satelitné snímky</a></li>
            <li><a href="#" class="hover:text-blue-600 transition-colors">Mapa teplôt</a></li>
            <li><a href="#" class="hover:text-blue-600 transition-colors">Mapa vetra</a></li>
          </ul>
        </div>
        <div>
          <h4 class="font-semibold text-gray-800 mb-3">Služby</h4>
          <ul class="space-y-2 text-sm text-gray-600">
            <li><a href="#" class="hover:text-blue-600 transition-colors">Mobilná aplikácia</a></li>
            <li><a href="#" class="hover:text-blue-600 transition-colors">API pre vývojárov</a></li>
            <li><a href="#" class="hover:text-blue-600 transition-colors">Výstrahy SMS/Email</a></li>
            <li><a href="#" class="hover:text-blue-600 transition-colors">Profesionálne služby</a></li>
          </ul>
        </div>
      </div>
      <div class="border-t border-gray-200 mt-8 pt-6 flex flex-col sm:flex-row justify-between items-center">
        <p class="text-gray-500 text-sm">© 2025 Počasie Radar. Všetky práva vyhradené.</p>
        <div class="flex gap-4 mt-4 sm:mt-0">
          <a href="#" class="text-gray-400 hover:text-gray-600 transition-colors">Ochrana súkromia</a>
          <a href="#" class="text-gray-400 hover:text-gray-600 transition-colors">Podmienky použitia</a>
          <a href="#" class="text-gray-400 hover:text-gray-600 transition-colors">Kontakt</a>
        </div>
      </div>
    </div>
  </footer>

  <script>
    // --- MAPPING ---
    const weatherEmojis = {0:'☀️',1:'🌤️',2:'⛅',3:'☁️',45:'🌫️',48:'🌫️',51:'🌦️',53:'🌦️',55:'🌧️',56:'🌨️',57:'🌨️',61:'🌧️',63:'🌧️',65:'🌧️',66:'🌨️',67:'🌨️',71:'❄️',73:'❄️',75:'❄️',77:'❄️',80:'🌦️',81:'🌧️',82:'🌧️',85:'🌨️',86:'🌨️',95:'⛈️',96:'⛈️',99:'⛈️'};
    const weatherDescriptions = {0:'Jasno',1:'Prevažne jasno',2:'Čiastočne oblačno',3:'Zamračené',45:'Hmla',48:'Námraza',51:'Slabé mrholenie',53:'Mrholenie',55:'Husté mrholenie',56:'Slabé mrznúce mrholenie',57:'Husté mrznúce mrholenie',61:'Slabý dážď',63:'Dážď',65:'Silný dážď',66:'Slabý mrznúci dážď',67:'Silný mrznúci dážď',71:'Slabé sneženie',73:'Sneženie',75:'Silné sneženie',77:'Snehové zrná',80:'Slabé prehánky',81:'Prehánky',82:'Silné prehánky',85:'Slabé snehové prehánky',86:'Silné snehové prehánky',95:'Búrka',96:'Búrka s krupobitím',99:'Silná búrka s krupobitím'};

    // --- STATE ---
    let currentCity = 'Bratislava';
    let currentLat = 48.1486;
    let currentLon = 17.1077;
    let activeTab = 'hourly';

    const chartState = {
      hourly: null,
      minTemp: 0,
      maxTemp: 0,
      showActual: true,
      showFeels: true
    };

    window.onload = function () {
      updateCurrentDate();
      updateLastUpdate();
      fetchWeatherData(currentLat, currentLon);

      document.getElementById('cityInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') searchWeather();
      });

      // Reflow grafu pri zmene veľkosti
      window.addEventListener('resize', () => {
        if (chartState.hourly) updateTemperatureChart(chartState);
      });
    };

    function updateCurrentDate(){
      const now = new Date();
      const options = {weekday:'long',year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'};
      document.getElementById('currentDate').textContent = now.toLocaleDateString('sk-SK', options);
    }
    function updateLastUpdate(){
      const now = new Date();
      document.getElementById('lastUpdate').textContent =
        `Posledná aktualizácia: ${now.toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit'})}`;
    }

    function showTab(tabName, el){
      document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
      if (el) el.classList.add('active');
      document.getElementById('hourlyTab').classList.toggle('hidden', tabName !== 'hourly');
      document.getElementById('dailyTab').classList.toggle('hidden', tabName !== 'daily');
      activeTab = tabName;
    }

    function showLoading(){document.getElementById('loading').classList.remove('hidden');document.getElementById('weatherContent').classList.add('hidden');document.getElementById('error').classList.add('hidden')}
    function hideLoading(){document.getElementById('loading').classList.add('hidden')}
    function showError(message){document.getElementById('error').classList.remove('hidden');document.getElementById('errorMessage').textContent=message;document.getElementById('weatherContent').classList.add('hidden');hideLoading()}
    function showWeatherContent(){document.getElementById('weatherContent').classList.remove('hidden');document.getElementById('error').classList.add('hidden');hideLoading()}

    async function searchWeather(){
      const city = document.getElementById('cityInput').value.trim();
      if (!city) return;
      showLoading();
      try{
        const geoResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`);
        const geoData = await geoResponse.json();
        if(geoData.length===0){showError('Mesto nebolo nájdené. Skúste iný názov.');return;}
        const lat = parseFloat(geoData[0].lat), lon = parseFloat(geoData[0].lon);
        currentCity = geoData[0].display_name.split(',')[0];
        currentLat=lat; currentLon=lon;
        await fetchWeatherData(lat, lon);
      }catch(e){showError('Chyba pri vyhľadávaní mesta. Skontrolujte internetové pripojenie.')}
    }

    function getCurrentLocation(){
      if(!navigator.geolocation){showError('Geolokácia nie je podporovaná vo vašom prehliadači.');return;}
      showLoading();
      navigator.geolocation.getCurrentPosition(async pos=>{
        const lat = pos.coords.latitude, lon = pos.coords.longitude;
        currentLat=lat; currentLon=lon;
        try{
          const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
          const g = await r.json();
          currentCity = g.address?.city || g.address?.town || g.address?.village || 'Vaša poloha';
        }catch{ currentCity='Vaša poloha' }
        await fetchWeatherData(lat, lon);
      }, _=> showError('Nepodarilo sa získať vašu polohu. Skúste zadať mesto manuálne.'));
    }

    async function fetchWeatherData(lat, lon){
      try{
        // DÔLEŽITÉ: pridali sme hourly=apparent_temperature + precipitation_probability
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
          `&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,visibility,surface_pressure` +
          `&hourly=temperature_2m,apparent_temperature,weather_code,wind_speed_10m,relative_humidity_2m,precipitation_probability,precipitation` +
          `&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,uv_index_max` +
          `&timezone=auto&forecast_days=7&temperature_unit=celsius&wind_speed_unit=kmh&precipitation_unit=mm&timeformat=iso8601`;

        const response = await fetch(url);
        if(!response.ok) throw new Error('Chyba pri načítavaní údajov o počasí');

        const data = await response.json();
        updateWeatherDisplay(data);
        updateLastUpdate();
        showWeatherContent();
      }catch(e){
        console.error(e);
        showError('Nepodarilo sa načítať údaje o počasí. Skúste to znovu.');
      }
    }

    function updateWeatherDisplay(data){
      const current = data.current;
      const hourly = data.hourly;
      const daily = data.daily;

      // Header
      document.getElementById('cityName').textContent = currentCity;
      document.getElementById('coordinates').textContent = `${currentLat.toFixed(4)}°, ${currentLon.toFixed(4)}°`;
      document.getElementById('temperature').textContent = `${Math.round(current.temperature_2m)}°`;
      document.getElementById('weatherIcon').textContent = weatherEmojis[current.weather_code] || '🌤️';
      document.getElementById('weatherDescription').textContent = weatherDescriptions[current.weather_code] || 'Neznáme';
      document.getElementById('feelsLike').textContent = `${Math.round(current.apparent_temperature)}°C`;
      document.getElementById('windSpeed').textContent = `${Math.round(current.wind_speed_10m)} km/h`;
      document.getElementById('humidity').textContent = `${current.relative_humidity_2m}%`;
      document.getElementById('pressure').textContent = `${Math.round(current.surface_pressure)} hPa`;
      document.getElementById('visibility').textContent = `${Math.round(current.visibility/1000)} km`;

      // Daily details
      if (daily.uv_index_max && daily.uv_index_max[0]!=null){
        const uv = Math.round(daily.uv_index_max[0]);
        document.getElementById('uvIndex').textContent = uv;
        document.getElementById('uvAdvice').textContent = uv >= 6 ? 'Silné UV – chráňte sa' : 'Použite opaľovací krém';
      }
      if (daily.sunrise && daily.sunrise[0]){
        const sunrise = new Date(daily.sunrise[0]);
        const sunset = new Date(daily.sunset[0]);
        document.getElementById('sunrise').textContent = sunrise.toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit'});
        document.getElementById('sunset').textContent  = sunset.toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit'});
        const dl = sunset - sunrise;
        const h = Math.floor(dl / 3600000), m = Math.floor((dl % 3600000) / 60000);
        document.getElementById('dayLength').textContent = `${h}h ${m}m`;
      }

      // Hourly list (24h)
      const hCont = document.getElementById('hourlyForecast');
      hCont.innerHTML = '';

      let minT =  Infinity, maxT = -Infinity, sumWind = 0;
      let bestStart = null, bestScore = -Infinity;
      const now = new Date(hourly.time[0]).getHours();

      const maxRainProb = Math.max(...hourly.precipitation_probability.slice(0,24).map(v=>v ?? 0));
      document.getElementById('rainChance').textContent = `${Math.round(maxRainProb)}%`;

      for (let i=0;i<24;i++){
        const time = new Date(hourly.time[i]);
        const hour = time.getHours().toString().padStart(2,'0');
        const temp = Math.round(hourly.temperature_2m[i]);
        const feels = Math.round((hourly.apparent_temperature?.[i] ?? temp));
        const wcode = hourly.weather_code[i];
        const wind  = Math.round(hourly.wind_speed_10m[i]);
        const hum   = hourly.relative_humidity_2m[i];
        const pprob = hourly.precipitation_probability?.[i] ?? 0;

        // min/max/avg
        if (temp < minT) minT = temp;
        if (temp > maxT) maxT = temp;
        sumWind += wind;

        // jednoduché skóre pre „najlepší čas vonku“ (preferuj teplo, málo dažďa, primeraný vietor)
        if (hour >= 10 && hour <= 18){
          const score = temp*2 - (pprob*0.8) - Math.max(0, wind-20);
          if (score > bestScore){ bestScore = score; bestStart = hour; }
        }

        const card = document.createElement('div');
        card.className = 'flex-shrink-0 bg-gray-50 rounded-lg p-4 text-center min-w-[136px] border';
        card.innerHTML = `
          <div class="text-gray-600 text-sm font-medium mb-2">${hour}:00</div>
          <div class="text-3xl mb-2">${weatherEmojis[wcode] || '🌤️'}</div>
          <div class="text-gray-800 font-semibold text-lg mb-1">${temp}°C <span class="text-gray-400 text-sm">(${feels}°)</span></div>
          <div class="text-gray-500 text-xs mb-1">💨 ${wind} km/h</div>
          <div class="text-gray-500 text-xs mb-1">💧 ${hum}%</div>
          <div class="text-gray-500 text-xs">☔ ${pprob ?? 0}%</div>
        `;
        hCont.appendChild(card);
      }

      document.getElementById('tempRange').textContent = `${minT}°C - ${maxT}°C`;
      document.getElementById('avgWind').textContent = `${Math.round(sumWind/24)} km/h`;
      const bestStartNum = parseInt(bestStart ?? (new Date(hourly.time[0]).getHours()),10);
      const bestEnd = ((bestStartNum+2)%24).toString().padStart(2,'0');
      const bestStartStr = (bestStartNum).toString().padStart(2,'0');
      document.getElementById('bestTime').textContent = `${bestStartStr}:00 - ${bestEnd}:00`;

      // Uložiť stav pre graf
      chartState.hourly = hourly;
      chartState.minTemp = minT;
      chartState.maxTemp = maxT;
      updateTemperatureChart(chartState);

      // Daily forecast
      const dCont = document.getElementById('dailyForecast');
      dCont.innerHTML = '';
      for (let i=0;i<7;i++){
        const date = new Date(daily.time[i]);
        const tmax = Math.round(daily.temperature_2m_max[i]);
        const tmin = Math.round(daily.temperature_2m_min[i]);
        const code = daily.weather_code[i];
        const dayName = i===0?'Dnes':i===1?'Zajtra':date.toLocaleDateString('sk-SK',{weekday:'long'});
        const dateStr = date.toLocaleDateString('sk-SK',{day:'numeric',month:'short'});
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between p-4 hover:bg-gray-50 rounded-lg border-b border-gray-100';
        row.innerHTML = `
          <div class="flex items-center gap-4 flex-1">
            <span class="text-3xl">${weatherEmojis[code] || '🌤️'}</span>
            <div>
              <div class="text-gray-800 font-medium">${dayName}</div>
              <div class="text-gray-500 text-sm">${dateStr}</div>
            </div>
            <div class="flex-1 text-center">
              <div class="text-gray-600 text-sm">${weatherDescriptions[code] || 'Neznáme'}</div>
            </div>
          </div>
          <div class="text-right">
            <div class="flex items-center gap-2">
              <span class="temp-high">${tmax}°</span>
              <span class="text-gray-400">/</span>
              <span class="temp-low">${tmin}°</span>
            </div>
          </div>
        `;
        dCont.appendChild(row);
      }

      updateCurrentDate();
    }

    function toggleSeries(which){
      if (which==='actual'){
        chartState.showActual = !chartState.showActual;
        document.getElementById('chipActual').dataset.active = String(chartState.showActual);
      } else {
        chartState.showFeels  = !chartState.showFeels;
        document.getElementById('chipFeels').dataset.active = String(chartState.showFeels);
      }
      updateTemperatureChart(chartState);
    }

    function updateTemperatureChart(state){
      const hourly = state.hourly;
      if (!hourly) return;

      const svg = document.getElementById('tempChartSvg');
      const { width:clientW } = svg.getBoundingClientRect();
      const width = clientW || 800;
      const height = 220;
      const padding = 40;
      const cW = width - 2*padding;
      const cH = height - 2*padding;

      svg.innerHTML='';
      svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

      const minTemp = state.minTemp;
      // chráň pred delením nulou
      const spread = Math.max(1, (state.maxTemp - state.minTemp));

      // Grid
      const grid = document.createElementNS('http://www.w3.org/2000/svg','g');
      for (let i=0;i<=4;i++){
        const y = padding + (cH/4)*i;
        const line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1',padding); line.setAttribute('y1',y);
        line.setAttribute('x2',width-padding); line.setAttribute('y2',y);
        line.setAttribute('stroke','#e5e7eb'); line.setAttribute('stroke-width','1');
        grid.appendChild(line);

        const temp = state.maxTemp - (spread/4)*i;
        const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
        txt.setAttribute('x', padding-10); txt.setAttribute('y', y+4);
        txt.setAttribute('text-anchor','end'); txt.setAttribute('font-size','12'); txt.setAttribute('fill','#6b7280');
        txt.textContent = `${Math.round(temp)}°`;
        grid.appendChild(txt);
      }
      svg.appendChild(grid);

      // časové značky + body
      const actualPts = [];
      const feelsPts = [];
      const timeLabels = [];

      for (let i=0;i<24;i++){
        const temp = hourly.temperature_2m[i];
        const feels = hourly.apparent_temperature?.[i] ?? temp;
        const time = new Date(hourly.time[i]);
        const x = padding + (cW/23)*i;
        const yA = padding + cH - ((temp  - minTemp)/spread)*cH;
        const yF = padding + cH - ((feels - minTemp)/spread)*cH;

        actualPts.push(`${x},${yA}`);
        feelsPts.push(`${x},${yF}`);

        if (i%4===0){
          timeLabels.push({x, label:`${time.getHours().toString().padStart(2,'0')}:00`});
        }
      }

      // Gradients
      const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
      const g1 = document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
      g1.id='tempGradient'; g1.setAttribute('x1','0%'); g1.setAttribute('y1','0%'); g1.setAttribute('x2','0%'); g1.setAttribute('y2','100%');
      const s11 = document.createElementNS('http://www.w3.org/2000/svg','stop'); s11.setAttribute('offset','0%'); s11.setAttribute('stop-color','#3b82f6'); s11.setAttribute('stop-opacity','0.3');
      const s12 = document.createElementNS('http://www.w3.org/2000/svg','stop'); s12.setAttribute('offset','100%'); s12.setAttribute('stop-color','#3b82f6'); s12.setAttribute('stop-opacity','0.1');
      g1.appendChild(s11); g1.appendChild(s12);

      const g2 = document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
      g2.id='feelsGradient'; g2.setAttribute('x1','0%'); g2.setAttribute('y1','0%'); g2.setAttribute('x2','0%'); g2.setAttribute('y2','100%');
      const s21 = document.createElementNS('http://www.w3.org/2000/svg','stop'); s21.setAttribute('offset','0%'); s21.setAttribute('stop-color','#f97316'); s21.setAttribute('stop-opacity','0.3');
      const s22 = document.createElementNS('http://www.w3.org/2000/svg','stop'); s22.setAttribute('offset','100%'); s22.setAttribute('stop-color','#f97316'); s22.setAttribute('stop-opacity','0.1');
      g2.appendChild(s21); g2.appendChild(s22);

      defs.appendChild(g1); defs.appendChild(g2);
      svg.appendChild(defs);

      // Area (len pre zapnuté série)
      if (chartState.showActual){
        const area = document.createElementNS('http://www.w3.org/2000/svg','path');
        const path = `M ${actualPts[0]} L ${actualPts.join(' L ')} L ${width-padding},${padding+cH} L ${padding},${padding+cH} Z`;
        area.setAttribute('d', path); area.setAttribute('fill','url(#tempGradient)');
        svg.appendChild(area);
      }

      // Lines
      if (chartState.showActual){
        const lineA = document.createElementNS('http://www.w3.org/2000/svg','path');
        lineA.setAttribute('d', `M ${actualPts.join(' L ')}`);
        lineA.setAttribute('stroke','#3b82f6'); lineA.setAttribute('stroke-width','3'); lineA.setAttribute('fill','none');
        lineA.setAttribute('stroke-linecap','round'); lineA.setAttribute('stroke-linejoin','round');
        svg.appendChild(lineA);
      }
      if (chartState.showFeels){
        const lineF = document.createElementNS('http://www.w3.org/2000/svg','path');
        lineF.setAttribute('d', `M ${feelsPts.join(' L ')}`);
        lineF.setAttribute('stroke','#f97316'); lineF.setAttribute('stroke-width','2'); lineF.setAttribute('fill','none');
        lineF.setAttribute('stroke-dasharray','5,5'); lineF.setAttribute('stroke-linecap','round');
        svg.appendChild(lineF);
      }

      // Points + tooltip (len pre skutočnú teplotu, aby to nebolo preplnené)
      if (chartState.showActual){
        actualPts.forEach((pt,i)=>{
          const [x,y]=pt.split(',').map(Number);
          const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
          c.setAttribute('cx',x); c.setAttribute('cy',y); c.setAttribute('r','4');
          c.setAttribute('fill','#3b82f6'); c.setAttribute('stroke','white'); c.setAttribute('stroke-width','2');
          const temp = Math.round(hourly.temperature_2m[i]);
          const time = new Date(hourly.time[i]);
          c.style.cursor='pointer';

          c.addEventListener('mouseenter',function(){
            this.setAttribute('r','6');
            const tooltip = document.createElementNS('http://www.w3.org/2000/svg','g'); tooltip.id='tooltip';
            const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
            rect.setAttribute('x', x-28); rect.setAttribute('y', y-36);
            rect.setAttribute('width','56'); rect.setAttribute('height','24');
            rect.setAttribute('fill','#1f2937'); rect.setAttribute('rx','4');
            const text = document.createElementNS('http://www.w3.org/2000/svg','text');
            text.setAttribute('x', x); text.setAttribute('y', y-20);
            text.setAttribute('text-anchor','middle'); text.setAttribute('font-size','12'); text.setAttribute('fill','white');
            text.textContent = `${temp}°C`;
            tooltip.appendChild(rect); tooltip.appendChild(text); svg.appendChild(tooltip);
          });
          c.addEventListener('mouseleave',function(){
            this.setAttribute('r','4');
            const tip = document.getElementById('tooltip'); if (tip) tip.remove();
          });

          svg.appendChild(c);
        });
      }

      // Time labels
      timeLabels.forEach(l=>{
        const t = document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('x', l.x); t.setAttribute('y', height-10);
        t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','12'); t.setAttribute('fill','#6b7280');
        t.textContent = l.label; svg.appendChild(t);
      });
    }
  </script>
</body>
</html>

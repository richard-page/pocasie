<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Jednoduch√° predpoveƒè ‚Äî poloha</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto; margin:0; background:#0b3b52; color:#fff; min-height:100vh; display:flex; flex-direction:column; align-items:center;}
  .card{background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); padding:16px; border-radius:12px; width:96%; max-width:760px; margin:18px 0;}
  header{padding:28px 16px; text-align:center;}
  h1{margin:0 0 6px; font-size:20px}
  p.sub{margin:0; color:#d6f0ffcc; font-size:13px}
  .controls{display:flex; gap:10px; justify-content:center; margin-top:12px; flex-wrap:wrap}
  button{background:#fff2; border:1px solid #ffffff22; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600}
  button:active{transform:translateY(1px)}
  .status{font-size:13px; color:#d6f0ffcc; margin-top:8px; text-align:center}
  .hero{display:flex; gap:12px; align-items:center; justify-content:center; margin-top:8px;}
  .temp{font-size:44px; font-weight:700}
  .label{font-size:16px}
  .forecast{display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:10px; margin-top:12px}
  .day{background:rgba(0,0,0,0.12); padding:8px; border-radius:8px; text-align:center}
  .small{font-size:12px; color:#d6f0ffcc}
  .debug{font-size:12px;color:#ffd6d6;margin-top:8px}
  a.link{color:#bfefff;font-size:12px}
</style>
</head>
<body>
  <header>
    <h1>Jednoduch√° predpoveƒè (poloha)</h1>
    <p class="sub">Klikni ‚ÄûPou≈æi≈• moju polohu‚Äú pre zobrazenie predpovede pre tvoju lokalitu. Ak prompt neuk√°≈æe, pou≈æije sa poloha podƒæa IP.</p>
  </header>

  <div class="card" id="mainCard">
    <div style="display:flex;flex-direction:column;align-items:center">
      <div class="hero">
        <div class="label" id="place">‚Äî</div>
      </div>

      <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
        <div class="temp" id="temp">--¬∞</div>
      </div>

      <div class="controls">
        <button id="btnGeo">Pou≈æi≈• moju polohu</button>
        <button id="btnIP">Pou≈æi≈• lokalitu podƒæa IP</button>
        <button id="btnBratislava">Predvolen√°: Bratislava</button>
      </div>

      <div class="status" id="status">ƒåak√°m na akciu‚Ä¶</div>

      <div class="forecast" id="forecast"></div>
      <div class="debug" id="debug" style="display:none"></div>
    </div>
  </div>

<script>
/* ---------- jednoduch√© constants ---------- */
const GEO_API = 'https://geocoding-api.open-meteo.com/v1';
const WX_API  = 'https://api.open-meteo.com/v1/forecast';
const IPAPI   = 'https://ipapi.co/json/';
const DEFAULT = {lat:48.1486, lon:17.1077, label:'Bratislava'};

/* ---------- elementy ---------- */
const el = {
  btnGeo: document.getElementById('btnGeo'),
  btnIP: document.getElementById('btnIP'),
  btnBratislava: document.getElementById('btnBratislava'),
  status: document.getElementById('status'),
  place: document.getElementById('place'),
  temp: document.getElementById('temp'),
  forecast: document.getElementById('forecast'),
  debug: document.getElementById('debug')
};

/* ---------- util (bez zlo≈æitost√≠) ---------- */
function setStatus(s){ el.status.textContent = s; }
function dbg(...a){ el.debug.style.display='block'; el.debug.textContent = a.map(x=>typeof x==='object'?JSON.stringify(x):String(x)).join(' | '); console.log(...a); }

/* ---------- reverse geocode -> pekn√Ω label ---------- */
async function reverseLabel(lat, lon){
  try{
    const res = await fetch(`${GEO_API}/reverse?latitude=${lat}&longitude=${lon}&language=sk`);
    const j = await res.json();
    const r = j.results && j.results[0];
    if(!r) return 'Va≈°a poloha';
    // prefer city -> admin2 -> admin1 -> country
    return (r.name && r.name.trim()) || r.admin2 || r.admin1 || r.country || 'Va≈°a poloha';
  }catch(e){
    return 'Va≈°a poloha';
  }
}

/* ---------- ziskaj pocasie a vykresli (jednoducho) ---------- */
async function loadWeatherFor(lat, lon, labelHint){
  setStatus('Naƒç√≠tavam poƒçasie‚Ä¶');
  el.forecast.innerHTML = '';
  try{
    // current + 5 day
    const url = `${WX_API}?latitude=${lat}&longitude=${lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto&forecast_days=5`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('wx failed');
    const j = await r.json();

    // label
    const label = labelHint || await reverseLabel(lat, lon);
    el.place.textContent = label;

    // temp
    if(j.current_weather && typeof j.current_weather.temperature === 'number'){
      el.temp.textContent = Math.round(j.current_weather.temperature) + '¬∞';
    } else { el.temp.textContent = '--¬∞'; }

    // daily
    const daily = j.daily || {};
    const time = daily.time || [];
    const tmax = daily.temperature_2m_max || [];
    const tmin = daily.temperature_2m_min || [];
    const codes = daily.weathercode || [];
    el.forecast.innerHTML = '';
    for(let i=0;i<time.length;i++){
      const d = new Date(time[i]);
      const day = d.toLocaleDateString('sk-SK', {weekday:'short', day:'numeric'});
      const max = tmax[i] !== undefined ? Math.round(tmax[i]) + '¬∞' : '‚Äî';
      const min = tmin[i] !== undefined ? Math.round(tmin[i]) + '¬∞' : '‚Äî';
      const code = codes[i] !== undefined ? codes[i] : null;
      const ico = weatherIcon(code);
      const box = document.createElement('div');
      box.className = 'day';
      box.innerHTML = `<div class="small">${day}</div><div style="font-size:20px">${ico}</div><div style="margin-top:6px">${max} / <span class="small">${min}</span></div>`;
      el.forecast.appendChild(box);
    }

    setStatus('Hotovo');
  }catch(err){
    setStatus('Chyba pri naƒç√≠tan√≠ poƒçasia');
    dbg('weather error', err);
  }
}

/* ---------- jednoduch√° ikonka z weathercode (len orientaƒçne) ---------- */
function weatherIcon(code){
  if(code==null) return '‚Äî';
  const c = Number(code);
  if([0,1].includes(c)) return '‚òÄÔ∏è';
  if(c===2) return '‚õÖ';
  if(c===3) return '‚òÅÔ∏è';
  if([51,53,55].includes(c)) return 'üå¶Ô∏è';
  if([61,63,65,80,81,82].includes(c)) return 'üåßÔ∏è';
  if([71,73,75].includes(c)) return 'üå®Ô∏è';
  if([95,96,99].includes(c)) return '‚õàÔ∏è';
  return 'üå§Ô∏è';
}

/* ---------- z√≠skanie polohy cez W3C (vyvol√° syst√©mov√Ω prompt v prehliadaƒçi/WebView) ---------- */
function getPositionOnce(timeout=10000){
  return new Promise((resolve, reject) => {
    if(!('geolocation' in navigator)) return reject(new Error('Geolocation unsupported'));
    navigator.geolocation.getCurrentPosition(
      pos => resolve({lat: pos.coords.latitude, lon: pos.coords.longitude}),
      err => reject(err),
      { enableHighAccuracy: true, timeout: timeout, maximumAge: 0 }
    );
  });
}

/* ---------- fallback podƒæa IP ---------- */
async function ipLocation(){
  try{
    const r = await fetch(IPAPI, {cache:'no-store'});
    if(!r.ok) throw new Error('ipapi failed');
    const j = await r.json();
    if(j && typeof j.latitude === 'number' && typeof j.longitude === 'number'){
      return {lat: j.latitude, lon: j.longitude, city: j.city || null};
    }
  }catch(e){
    dbg('ip fallback error', e);
  }
  return null;
}

/* ---------- ovl√°danie: jednoduch√© a priamoƒçiare ---------- */
async function onUseMyLocation(){
  setStatus('Po≈æiada sa o povolenie polohy‚Ä¶ (ak prostredie podporuje)');
  try{
    const p = await getPositionOnce();
    setStatus('Poloha z√≠skan√° z GPS ‚Äî naƒç√≠tavam poƒçasie');
    const label = await reverseLabel(p.lat, p.lon).catch(()=>null);
    await loadWeatherFor(p.lat, p.lon, label);
  }catch(err){
    dbg('getPositionOnce failed', err);
    // ak pou≈æ√≠vateƒæ odmietol alebo prompt nie je povolen√Ω ‚Üí fallback podƒæa IP
    setStatus('Ne√∫spech pri z√≠skan√≠ GPS. Pokraƒçujem podƒæa IP...');
    const ip = await ipLocation();
    if(ip){
      const label = ip.city || await reverseLabel(ip.lat, ip.lon);
      await loadWeatherFor(ip.lat, ip.lon, label);
      setStatus('(Poloha podƒæa IP ‚Äî menej presn√°)');
    }else{
      // posledn√Ω fallback: Bratislava
      await loadWeatherFor(DEFAULT.lat || 48.1486, DEFAULT.lon || 17.1077, DEFAULT.label || 'Bratislava');
      setStatus('(Predvolen√°: Bratislava)');
    }
  }
}

async function onUseIP(){
  setStatus('Zis≈•ujem polohu podƒæa IP‚Ä¶');
  const ip = await ipLocation();
  if(ip){
    const label = ip.city || await reverseLabel(ip.lat, ip.lon);
    await loadWeatherFor(ip.lat, ip.lon, label);
    setStatus('(Poloha podƒæa IP)');
  }else{
    setStatus('IP fallback zlyhal ‚Äî pou≈æijem Bratislavu');
    await loadWeatherFor(DEFAULT.lat, DEFAULT.lon, DEFAULT.label);
  }
}

async function onBratislava(){
  setStatus('Naƒç√≠tavam predvolen√∫ lokalitu (Bratislava)‚Ä¶');
  await loadWeatherFor(DEFAULT.lat, DEFAULT.lon, DEFAULT.label);
  setStatus('(Predvolen√°: Bratislava)');
}

/* ---------- bindy ---------- */
el.btnGeo.addEventListener('click', onUseMyLocation);
el.btnIP.addEventListener('click', onUseIP);
el.btnBratislava.addEventListener('click', onBratislava);

/* ---------- auto pokus pri naƒç√≠tan√≠: sk√∫si prompt raz (m√¥≈æe vyvola≈• syst√©mov√Ω dialog) ---------- */
(async function init(){
  setStatus('Automatick√Ω pokus o polohu‚Ä¶');
  try{
    // sk√∫si≈• prompt; ak to zlyh√°, nech nech√°me pou≈æ√≠vateƒæa klikn√∫≈•
    const p = await getPositionOnce().catch(e=>{ throw e; });
    setStatus('Poloha z√≠skan√° automaticky, naƒç√≠tavam poƒçasie‚Ä¶');
    const label = await reverseLabel(p.lat, p.lon).catch(()=>null);
    await loadWeatherFor(p.lat, p.lon, label);
  }catch(e){
    dbg('auto geo failed', e);
    setStatus('Automatick√Ω pokus zlyhal ‚Äî kliknite "Pou≈æi≈• moju polohu" alebo vyberte IP/Bratislava.');
    // nech√°me pou≈æ√≠vateƒæa spusti≈• ruƒçne; nemus√≠me ihneƒè fallbackova≈•
  }
})();
</script>
</body>
</html>

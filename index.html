<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Poƒçasie</title>
<link rel="icon" type="image/png" href="favicon.png" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg0:#0b0f14; --bg1:#0e1620; --stroke:#233448; --txt:#eaf3ff; --muted:#a8bed5; --accent:#3ad0e6;
    --r:14px; --shadow:0 10px 28px rgba(0,0,0,.28);
    --tmax:#ff5757; --tmin:#ffb35c;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--txt); font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:#0b0f14; min-height:100dvh; display:flex; flex-direction:column;
    -webkit-text-size-adjust:100%; -webkit-tap-highlight-color:transparent; overflow-x:hidden;
  }
  body::before{content:""; position:fixed; inset:-1px; z-index:-1;
    background:radial-gradient(120vw 80vh at 50% -10%, #102538 0%, #0f1a26 50%, #0b0f14 100%), linear-gradient(180deg, var(--bg1), var(--bg0));
    background-attachment:fixed,fixed; background-size:160vw 120vh, 100% 100%;
  }
  .wrap{width:100%; max-width:1120px; margin-inline:auto; padding:16px 12px 28px; flex:1}
  header h1{margin:0 0 10px; text-align:center; font-size:28px; letter-spacing:.3px}

  .toolbar{display:grid; grid-template-columns:1fr; gap:10px; margin:10px 0 12px}
  .searchCol{display:flex; flex-direction:column; gap:6px; position:relative}
  .search{width:100%; background:#152535; border:1px solid var(--stroke); color:#fff; border-radius:12px; padding:12px 14px; outline:none; font-size:16px; min-height:46px}
  .search:focus{border-color:#2e4a67}
  #suggestions{display:none; gap:6px; position:absolute; top:calc(100% + 6px); left:0; right:0; z-index:40; background:#0f1c2a; border:1px solid var(--stroke); border-radius:12px; padding:8px; max-height:55vh; overflow:auto}
  .sugg{background:#13263a; border:1px solid var(--stroke); border-radius:10px; padding:10px 12px; cursor:pointer}

  .pill{background:#1b2c3d; border:1px solid var(--stroke); color:#dfeaff; border-radius:12px; padding:10px 12px; font-weight:600; cursor:pointer; min-height:40px; font-size:14px; text-align:center}
  .pill.active{background:var(--accent); border-color:#2abbd0; color:#002a32}

  .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid var(--stroke); border-radius:var(--r); box-shadow:var(--shadow); padding:14px}
  .card h3{margin:0 0 10px; text-align:center; font-size:18px}

  #place{display:block; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .row{display:grid; grid-template-columns:1fr; gap:12px; margin-top:4px}
  .meta{display:grid; grid-template-columns:1fr; gap:8px; color:var(--muted); font-size:14px}
  .meta strong{color:#fff}
  .chipRow{display:inline-flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:4px}
  .chip{display:inline-flex; gap:8px; align-items:center; background:#143344; border:1px solid var(--stroke); color:#d8f7ff; border-radius:999px; padding:6px 10px; font-size:12px}
  #uv,#aqi{white-space:nowrap}
  .tempNow{font-size:44px; font-weight:700; line-height:1; margin:6px 0}
  .icon{width:64px; height:64px; display:flex; align-items:center; justify-content:center; font-size:48px}
  .gridInfo{display:grid; grid-template-columns:1fr auto; gap:14px; align-items:start}

  /* kr√°tke sloty Doobeda/Poobede/Veƒçer/Noc */
  .partsWrap{display:grid; grid-template-columns:repeat(4,1fr); gap:12px}
  .part{background:#152433; border:1px solid var(--stroke); border-radius:12px; padding:12px; text-align:center}
  .part .lbl{opacity:.9; margin-bottom:6px; font-weight:600}
  .part .emoji{font-size:24px}
  .part .val{font-weight:700; font-size:26px; margin:8px 0 4px}
  .part .sub{color:#bcd1e5; font-size:12px}

  /* 7-d≈àov√°: presne ‚Äûstƒ∫pce‚Äú */
  .daysGrid{display:grid; gap:12px}
  /* desktop viac, mobil presne 3 */
  @media (min-width:901px){ .daysGrid{grid-template-columns:repeat(6,1fr)} }
  @media (max-width:900px){ .daysGrid{grid-template-columns:repeat(3,1fr)} }

  .dayCol{
    background:#152433; border:1px solid var(--stroke); border-radius:12px; padding:12px;
    display:flex; flex-direction:column; align-items:center; justify-content:flex-start; min-height:220px;
  }
  .dayCol .label{font-size:14px; opacity:.95; margin-bottom:2px}
  .dayCol .date{font-size:12px; color:var(--muted); margin-bottom:6px}
  .dayCol .em{font-size:26px; margin:8px 0}
  .dayCol .tmax{color:var(--tmax); font-size:28px; font-weight:700; line-height:1}
  .dayCol .tmin{color:var(--tmin); font-size:18px; line-height:1.1; margin-top:6px}
  .dayCol .meta2{margin-top:10px; display:flex; flex-direction:column; gap:6px; align-items:center; font-size:14px}
  .metaRow{display:inline-flex; align-items:center; gap:8px; color:#dbe8fa}
  .metaRow .ico{width:18px; text-align:center; opacity:.9}

  /* 15-min (24 h) ‚Äì horizont√°lny slider, bez sivej ƒçiary */
  .hscroll{display:flex; gap:10px; overflow-x:auto; padding:6px 2px 8px; -ms-overflow-style:none; scrollbar-width:none}
  .hscroll::-webkit-scrollbar{display:none}

  .chartWrap{height:220px}
  canvas{background:#0f1c2a; border:1px solid var(--stroke); border-radius:12px}

  .summarySection{margin-top:12px}
  .summarySection h3{margin-bottom:8px}
  #summary{margin:0 auto; max-width:720px; color:#dbeeff; background:#0f1c2a; border:1px solid var(--stroke); border-radius:10px; padding:12px; text-align:center}

  footer{padding:14px 10px; text-align:center; color:#cfe8ff; font-size:14px; border-top:1px solid rgba(255,255,255,.12)}

  /* Mobil ‚Äì viac stƒ∫pcov do ≈°√≠rky obrazovky */
  @media (max-width:900px){
    .partsWrap{grid-template-columns:repeat(2,1fr)}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header><h1>Poƒçasie</h1></header>

    <div class="toolbar">
      <div class="searchCol">
        <input id="q" class="search" type="text" placeholder="Hƒæadaj mesto (napr. Bratislava, Ko≈°ice)" />
        <div id="suggestions"></div>
      </div>
    </div>

    <div class="row">
      <section class="card">
        <div class="gridInfo">
          <div>
            <h3 id="place">Bratislava, SK</h3>
            <div id="time" style="color:var(--muted);font-size:14px">‚Äî</div>
            <div class="tempNow" id="temp">‚Äî¬∞</div>

            <div class="chipRow">
              <span class="chip" id="uv">UV index ‚Äî</span>
              <span class="chip" id="aqi">Kvalita ovzdu≈°ia ‚Äî</span>
            </div>

            <div class="meta" style="margin-top:8px">
              <div>Pocitov√° teplota: <strong id="apparent">‚Äî</strong></div>
              <div>Vietor: <strong id="wind">‚Äî</strong></div>
              <div>Vlhkos≈•: <strong id="hum">‚Äî</strong></div>
              <div>Tlak: <strong id="press">‚Äî</strong></div>
              <div>V√Ωchod slnka: <strong id="sunrise">‚Äî</strong></div>
              <div>Z√°pad slnka: <strong id="sunset">‚Äî</strong></div>
            </div>
          </div>
          <div id="icon" class="icon">‚Äî</div>
        </div>

        <div class="summarySection">
          <h3>Dne≈°n√Ω s√∫hrn</h3>
          <p id="summary">‚Äî</p>
        </div>
      </section>

      <section class="card">
        <h3>Teplota poƒças 24 hod√≠n</h3>
        <div class="chartWrap"><canvas id="hourly"></canvas></div>
      </section>
    </div>

    <section class="card" style="margin-top:12px">
      <h3>Predpoveƒè</h3>
      <div id="parts" class="partsWrap"></div>
    </section>

    <section class="card" style="margin-top:12px">
      <h3 style="margin-bottom:8px">7-d≈àov√° predpoveƒè</h3>
      <div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <button class="pill" id="tab-ecmwf">ECMWF IFS</button>
        <button class="pill" id="tab-icon">ICON (DWD)</button>
        <button class="pill" id="tab-gfs">GFS (NOAA)</button>
      </div>
      <div id="days" class="daysGrid"></div>
    </section>

    <section class="card" style="margin-top:12px">
      <h3>15-min√∫tov√° predpoveƒè (24 h)</h3>
      <div id="min15" class="hscroll"></div>
    </section>
  </div>

  <footer>&copy; <span id="year"></span> Richard / Poƒçasie</footer>

  <script>
    const APP_VERSION = '2025-08-14-columns-exact';

    const $ = s => document.querySelector(s);
    const fmt0 = (v,u='') => (v==null||Number.isNaN(v))?'‚Äî':`${Math.round(v)}${u}`;
    const fmt1 = (v,u='') => (v==null||Number.isNaN(v))?'‚Äî':`${(Math.round(v*10)/10).toFixed(1)}${u}`;

    const WMO = {
      0:['Jasno'],1:['Preva≈æne jasno'],2:['Polojasno'],3:['Zamraƒçen√©'],
      45:['Hmla'],48:['Mrzn√∫ca hmla'],
      51:['Slab√© mrholenie'],53:['Mrholenie'],55:['Siln√© mrholenie'],
      61:['Slab√Ω d√°≈æƒè'],63:['D√°≈æƒè'],65:['Lejak'],
      66:['Mrzn√∫ci d√°≈æƒè'],67:['Mrzn√∫ci d√°≈æƒè'],
      71:['Slab√© sne≈æenie'],73:['Sne≈æenie'],75:['Siln√© sne≈æenie'],
      77:['Snehov√© zrn√°'],
      80:['Preh√°nky'],81:['Preh√°nky'],82:['Siln√© preh√°nky'],
      85:['Snehov√© preh√°nky'],86:['Siln√© snehov√© preh√°nky'],
      95:['B√∫rky'],96:['B√∫rky s kr√∫pami'],99:['Siln√© b√∫rky s kr√∫pami']
    };

    const uvCat = u => u<3?'n√≠zky':u<6?'mierny':u<8?'vysok√Ω':u<11?'veƒæmi vysok√Ω':'extr√©mny';

    function wmoEmoji(code,isNight=false){
      const k = Number(code);
      if([0,1].includes(k)) return isNight?'üåô':'‚òÄÔ∏è';
      if(k===2) return isNight?'üåô':'‚õÖ';
      if(k===3) return '‚òÅÔ∏è';
      if([45,48].includes(k)) return 'üå´Ô∏è';
      if([51,53,55].includes(k)) return 'üå¶Ô∏è';
      if([61,63,65,80,81,82].includes(k)) return 'üåßÔ∏è';
      if([71,73,75,77,85,86].includes(k)) return '‚ùÑÔ∏è';
      if([95,96,99].includes(k)) return '‚õàÔ∏è';
      return isNight?'üåô':'üå§Ô∏è';
    }
    function isNightAt(dtLike,daily){
      const dt = typeof dtLike==='string'?new Date(dtLike):dtLike;
      try{
        const dayStr = dt.toISOString().slice(0,10);
        const i = daily?.time?.indexOf(dayStr);
        if(i>=0 && daily.sunrise?.[i] && daily.sunset?.[i]){
          const sr = new Date(daily.sunrise[i]), ss = new Date(daily.sunset[i]);
          return (dt<sr || dt>=ss);
        }
      }catch(_){}
      const h = dt.getHours(); return (h<6||h>=21);
    }

    function aqiCat(v){
      if(v==null||Number.isNaN(v)) return '‚Äî';
      if(v<=50) return 'dobr√°';
      if(v<=100) return 'mierne zhor≈°en√°';
      if(v<=150) return 'rizikov√°';
      if(v<=200) return 'zl√°';
      if(v<=300) return 'veƒæmi zl√°';
      return 'nebezpeƒçn√°';
    }

    let state={place:'Bratislava, SK', lat:48.1486, lon:17.1077, last:null};
    let hourlyChart=null; let activeModel='ecmwf';
    const LS_KEY='wx_prefs_v3';

    try{const v=localStorage.getItem('app_version'); if(v!==APP_VERSION) localStorage.setItem('app_version',APP_VERSION);}catch(_){}
    (()=>{
      try{const raw=localStorage.getItem(LS_KEY);
        if(raw){const p=JSON.parse(raw);
          if(typeof p.lat==='number'&&typeof p.lon==='number'&&typeof p.place==='string'){state=p;}
        }}catch(_){}
    })();
    const savePrefs=()=>{try{localStorage.setItem(LS_KEY,JSON.stringify({lat:state.lat,lon:state.lon,place:state.place}));}catch(_){ }};

    async function reverseGeocode(lat,lon){
      try{
        const u=`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=sk`;
        const r=await fetch(u,{headers:{'Accept':'application/json'}}); const j=await r.json();
        const a=j.address||{}; let name=a.city||a.town||a.village||a.municipality||a.hamlet||a.suburb||'';
        const cc=a.country_code?`, ${a.country_code.toUpperCase()}`:''; if(name) return `${name}${cc}`;
      }catch(_){}
      try{
        const u=`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=sk&format=json`;
        const j=await fetch(u).then(r=>r.json()); const r=j?.results?.[0];
        if(r){const name=r.name||r.city||r.town||r.village||''; const cc=r.country_code?`, ${r.country_code}`:''; if(name) return `${name}${cc}`;}
      }catch(_){}
      return `${lat.toFixed(3)}, ${lon.toFixed(3)}`;
    }
    async function setLocation(lat,lon,labelOpt){
      state.lat=lat; state.lon=lon; state.place=labelOpt||await reverseGeocode(lat,lon);
      savePrefs(); await fetchWeather().catch(e=>alert(e.message));
    }
    function initGeolocation(){
      if(!('geolocation' in navigator)){fetchWeather().catch(()=>{}); return;}
      const el=$('#place'); const prev=el.textContent; el.textContent='Zis≈•ujem polohu‚Ä¶';
      navigator.geolocation.getCurrentPosition(async pos=>{
        const {latitude,longitude}=pos.coords; await setLocation(latitude,longitude);
      }, _=>{el.textContent=prev; fetchWeather().catch(()=>{});},{enableHighAccuracy:true,timeout:10000,maximumAge:300000});
    }

    async function fetchWeather(){
      const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;
      const p=new URLSearchParams({
        latitude:state.lat, longitude:state.lon, timezone:tz,
        current:'temperature_2m,apparent_temperature,relative_humidity_2m,pressure_msl,wind_speed_10m,weather_code,uv_index',
        hourly:'temperature_2m,precipitation,weather_code,wind_speed_10m',
        daily:'time,weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,precipitation_sum,uv_index_max,wind_speed_10m_max,sunrise,sunset',
        forecast_days:'3'
      });
      const r=await fetch(`https://api.open-meteo.com/v1/forecast?${p}&v=${APP_VERSION}`);
      state.last=await r.json();
      renderAll(); drawHourly(); await fetchAQ().catch(()=>{}); fetchModels(activeModel);
    }

    function renderAll(){
      const d=state.last, cur=d.current, tz=d.timezone;
      $('#place').textContent=state.place;
      $('#time').textContent=new Intl.DateTimeFormat('sk-SK',{dateStyle:'medium',timeStyle:'short',timeZone:tz}).format(new Date(cur.time));
      $('#temp').textContent=fmt0(cur.temperature_2m,'¬∞');
      $('#apparent').textContent=fmt0(cur.apparent_temperature,'¬∞');
      $('#wind').textContent=fmt1(cur.wind_speed_10m,' km/h');
      $('#hum').textContent=fmt0(cur.relative_humidity_2m,'%');
      $('#press').textContent=fmt0(cur.pressure_msl,' hPa');
      $('#icon').textContent=wmoEmoji(cur.weather_code,isNightAt(cur.time,d.daily));

      const uvi=(cur.uv_index ?? d.daily?.uv_index_max?.[0] ?? null);
      $('#uv').textContent= uvi!=null ? `UV index ${fmt1(uvi)} ‚Ä¢ ${uvCat(uvi)}` : 'UV index ‚Äî';

      const dd=d.daily;
      const sr=dd.sunrise?.[0]?new Date(dd.sunrise[0]):null;
      const ss=dd.sunset?.[0]?new Date(dd.sunset[0]):null;
      $('#sunrise').textContent=sr?sr.toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit'}) :'‚Äî';
      $('#sunset').textContent =ss?ss.toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit'}) :'‚Äî';

      // kr√°tke 4 sloty
      renderParts();
      // 7-d≈àov√© stƒ∫pce
      renderDays(dd);
      // 24h / 15min
      renderMin15();
    }

    async function fetchAQ(){
      try{
        const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;
        const p=new URLSearchParams({latitude:state.lat, longitude:state.lon, timezone:tz, hourly:'us_aqi,pm2_5,pm10'});
        const r=await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?${p}&v=${APP_VERSION}`);
        const j=await r.json();
        const t=(state?.last?.current?.time)||j.hourly.time[0];
        const idx=j.hourly.time.findIndex(x=>x.slice(0,13)===t.slice(0,13));
        const aqi= idx>=0 ? j.hourly.us_aqi[idx] : null;
        $('#aqi').textContent= aqi!=null ? `Kvalita ovzdu≈°ia ${Math.round(aqi)} ‚Ä¢ ${aqiCat(aqi)}` : 'Kvalita ovzdu≈°ia ‚Äî';
      }catch(_){ $('#aqi').textContent='Kvalita ovzdu≈°ia ‚Äî'; }
    }

    function drawHourly(){
      const d=state.last, cur=d.current, hours=d.hourly.time, key=(cur.time||'').slice(0,13);
      let i=hours.findIndex(h=>h.slice(0,13)===key); if(i<0) i=0;
      const labels=hours.slice(i,i+24).map(h=>h.split('T')[1]);
      const t24=d.hourly.temperature_2m.slice(i,i+24);
      if(hourlyChart) hourlyChart.destroy();
      hourlyChart=new Chart($('#hourly'),{
        type:'line',
        data:{labels, datasets:[{label:'Teplota (¬∞C)', data:t24, borderWidth:2, pointRadius:2, tension:.35}]},
        options:{responsive:true, maintainAspectRatio:false,
          interaction:{mode:'nearest', intersect:false},
          scales:{x:{grid:{color:'rgba(255,255,255,.08)'}}, y:{grid:{color:'rgba(255,255,255,.08)'}}},
          plugins:{legend:{labels:{color:'#fff'}, onClick:()=>{}, onHover:(e)=>{if(e&&e.native) e.native.target.style.cursor='default';}}}}
      });
    }

    function valueAtHour(timesISO, arr, targetISO){
      const idx=timesISO.findIndex(t=>t.slice(0,13)===targetISO.slice(0,13));
      if(idx>=0) return arr[idx];
      let best=0, diff=1e18;
      timesISO.forEach((t,i)=>{const d=Math.abs(new Date(t)-new Date(targetISO)); if(d<diff){diff=d; best=i;}});
      return arr[best];
    }
    const lerp=(a,b,t)=>a+(b-a)*t;
    function valueAt15min(timesISO, arr, date){
      const ts=timesISO.map(t=>new Date(t));
      for(let i=0;i<ts.length-1;i++){
        const t0=ts[i], t1=ts[i+1];
        if(date>=t0 && date<=t1){
          const r=(date-t0)/(t1-t0), v0=arr[i], v1=arr[i+1];
          if(v0==null||v1==null) return null;
          return lerp(v0,v1,r);
        }
      }
      return null;
    }
    function codeAt15min(timesISO, codes, date){
      const ts=timesISO.map(t=>new Date(t));
      for(let i=0;i<ts.length-1;i++){
        const t0=ts[i], t1=ts[i+1];
        if(date>=t0 && date<=t1){
          const mid=new Date((t0.getTime()+t1.getTime())/2);
          return date<mid?codes[i]:codes[i+1];
        }
      }
      return codes[codes.length-1]??0;
    }

    function renderParts(){
      const wrap=$('#parts'); wrap.innerHTML='';
      const d=state.last; const base=new Date(d.current.time);
      const slot=(h,label)=>{
        const dt=new Date(base); dt.setHours(h,0,0,0);
        const iso=dt.toISOString();
        const temp=valueAtHour(d.hourly.time,d.hourly.temperature_2m,iso);
        const pr=valueAtHour(d.hourly.time,d.hourly.precipitation,iso);
        const wind=valueAtHour(d.hourly.time,d.hourly.wind_speed_10m,iso);
        const code=valueAtHour(d.hourly.time,d.hourly.weather_code,iso);
        const el=document.createElement('div'); el.className='part';
        el.innerHTML=`<div class="lbl">${label}</div>
                      <div class="emoji">${wmoEmoji(code,isNightAt(dt,d.daily))}</div>
                      <div class="val">${fmt0(temp,'¬∞')}</div>
                      <div class="sub">Zr√°≈æky ${fmt1(pr,' mm/h')} ¬∑ Vietor ${fmt1(wind,' km/h')}</div>`;
        wrap.appendChild(el);
      };
      slot(10,'Doobeda'); slot(15,'Poobede'); slot(21,'Veƒçer');
      const n=new Date(base); n.setDate(base.getDate()+1); n.setHours(2,0,0,0); slot(n.getHours(),'Noc');
    }

    function renderDays(dd){
      const box=$('#days'); box.innerHTML='';
      const n=Math.min(7, dd.time.length);
      const today = new Date().toISOString().slice(0,10);

      for(let i=0;i<n;i++){
        const dstr=dd.time[i];
        const dt=new Date(dstr+'T00:00:00');
        const label = (dstr===today) ? 'dnes' :
                      (i===1 || (new Date(dd.time[0]) - new Date().setHours(0,0,0,0) === 0 && i===1)) ? 'zajtra' :
                      dt.toLocaleDateString('sk-SK',{weekday:'long'});
        const dateStr=dt.toLocaleDateString('sk-SK',{day:'2-digit',month:'2-digit'});
        const code=dd.weather_code?.[i];
        const tmax=dd.temperature_2m_max[i], tmin=dd.temperature_2m_min[i];
        const pp=dd.precipitation_probability_max?.[i];

        // dƒ∫≈æka d≈àa (h)
        let dayHours='‚Äî';
        try{
          const sr=new Date(dd.sunrise[i]); const ss=new Date(dd.sunset[i]);
          const h=(ss - sr)/36e5; dayHours = Math.round(h)+' h';
        }catch(_){}

        const el=document.createElement('div'); el.className='dayCol';
        el.innerHTML = `
          <div class="label">${label}</div>
          <div class="date">${dateStr}</div>
          <div class="tmax">${fmt0(tmax,'¬∞')}</div>
          <div class="tmin">${fmt0(tmin,'¬∞')}</div>
          <div class="em">${wmoEmoji(code,false)}</div>
          <div class="meta2">
            <div class="metaRow"><span class="ico">‚òÄ</span><span>${dayHours}</span></div>
            <div class="metaRow"><span class="ico">üíß</span><span>${pp!=null?pp:0} %</span></div>
          </div>`;
        box.appendChild(el);
      }
    }

    function renderMin15(){
      const d=state.last; const box=$('#min15'); box.innerHTML='';
      if(!d?.hourly?.time?.length){ box.innerHTML='<div style="opacity:.8;color:#bcd1e5;padding:8px 10px;">Bez d√°t</div>'; return; }
      const start=new Date(d.current.time);
      const m=start.getMinutes(); const add=(15-(m%15))%15; if(add>0) start.setMinutes(m+add,0,0);
      for(let k=0;k<96;k++){
        const t=new Date(start.getTime()+k*15*60*1000);
        const tmp=valueAt15min(d.hourly.time,d.hourly.temperature_2m,t);
        const prep=valueAt15min(d.hourly.time,d.hourly.precipitation,t);
        const code=codeAt15min(d.hourly.time,d.hourly.weather_code,t);
        const wind=valueAt15min(d.hourly.time,d.hourly.wind_speed_10m,t);
        const el=document.createElement('div'); el.className='part'; el.style.minWidth='140px';
        el.innerHTML=`<div class="lbl">${t.toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit'})}</div>
                      <div class="emoji">${wmoEmoji(code,isNightAt(t,d.daily))}</div>
                      <div class="val">${fmt0(tmp,'¬∞')}</div>
                      <div class="sub">Zr√°≈æky ${prep!=null?fmt1(prep,' mm/h'):'‚Äî'} ¬∑ Vietor ${wind!=null?fmt1(wind,' km/h'):'‚Äî'}</div>`;
        box.appendChild(el);
      }
    }

    async function fetchModels(which){
      activeModel=which;
      ['ecmwf','icon','gfs'].forEach(id=>{const b=document.querySelector(`#tab-${id}`); if(b) b.classList.toggle('active', id===which);});
      const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;
      const daily='time,weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,sunrise,sunset';
      let base=''; if(which==='ecmwf') base='https://api.open-meteo.com/v1/ecmwf';
      if(which==='icon') base='https://api.open-meteo.com/v1/dwd-icon';
      if(which==='gfs') base='https://api.open-meteo.com/v1/gfs';
      const p=new URLSearchParams({latitude:state.lat, longitude:state.lon, timezone:tz, daily, forecast_days:'7'});
      try{const r=await fetch(`${base}?${p}&v=${APP_VERSION}`); const j=await r.json(); renderDays(j.daily);}
      catch(_){ $('#days').innerHTML='<div style="color:#ffd4d4">Model sa nepodarilo naƒç√≠ta≈•.</div>'; }
    }

    document.getElementById('tab-ecmwf').addEventListener('click',()=>fetchModels('ecmwf'));
    document.getElementById('tab-icon').addEventListener('click', ()=>fetchModels('icon'));
    document.getElementById('tab-gfs').addEventListener('click',  ()=>fetchModels('gfs'));

    // vyhƒæad√°vanie
    let timer;
    $('#q').addEventListener('input', e=>{
      const q=e.target.value.trim(); clearTimeout(timer);
      if(q.length<2){ $('#suggestions').style.display='none'; return; }
      timer=setTimeout(async ()=>{
        const url=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=6&language=sk&format=json`;
        const res=await fetch(url).then(r=>r.json()).catch(()=>({}));
        const arr=res.results||[]; const box=$('#suggestions'); box.innerHTML=''; box.style.display='grid';
        if(!arr.length){ box.innerHTML='<div class="sugg">Niƒç sa nena≈°lo</div>'; return; }
        arr.forEach(p=>{
          const b=document.createElement('div'); b.className='sugg';
          b.textContent=`${p.name}${p.admin1?`, ${p.admin1}`:''}, ${p.country_code}`;
          b.addEventListener('click',()=>{ setLocation(p.latitude,p.longitude,b.textContent); box.style.display='none'; });
          box.appendChild(b);
        });
      },250);
    });
    document.addEventListener('click',e=>{ const box=$('#suggestions'); if(box && !box.contains(e.target) && e.target!==$('#q')) box.style.display='none'; });

    document.getElementById('year').textContent=new Date().getFullYear();
    initGeolocation();
    window.addEventListener('resize',()=>{ if(state.last){ drawHourly(); renderMin15(); }});
    setTimeout(()=>{ if(!state.last) fetchWeather().catch(()=>{}); },1200);
    fetchModels('ecmwf');

    if(!window.__wx_auto_refresh){
      window.__wx_auto_refresh=setInterval(()=>{ if(state.lat&&state.lon){ fetchWeather().catch(()=>{}); fetchAQ().catch(()=>{}); }},5*60*1000);
    }
  </script>
</body>
</html>

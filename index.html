<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes, maximum-scale=6, viewport-fit=cover" />
  <title>Poƒçasie</title>
  <link rel="icon" type="image/png" href="https://placehold.co/32x32/143344/d8f7ff?text=W" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <!-- Tailwind (m√¥≈æe osta≈•, hlavn√© rozlo≈æenia rie≈°i custom CSS ni≈æ≈°ie) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/sk.min.js"></script>

  <style>
    :root{
      --bg0:#0b0f14; --bg1:#0e1620; --panel:#152433; --stroke:#233448;
      --txt:#eaf3ff; --muted:#a8bed5; --accent:#3ad0e6;
      --r:14px; --shadow:0 10px 28px rgba(0,0,0,.28);
      --gap:10px;
    }
    *{box-sizing:border-box}
    html,body{min-height:100%; margin:0; padding:0}
    body{
      color:var(--txt); font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,var(--bg1),var(--bg0));
      overflow-x:hidden; overflow-y:auto; -webkit-text-size-adjust:100%; -webkit-tap-highlight-color:transparent; min-height:100dvh
    }
    .wrap{width:100%; max-width:1120px; margin-inline:auto; padding:22px 14px 40px}
    header h1{margin:0 0 14px; text-align:center; font-size:28px; letter-spacing:.3px}

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke); border-radius:var(--r); box-shadow:var(--shadow); padding:16px 14px;
      transition:box-shadow .25s ease, transform .25s ease
    }
    .card:hover{ box-shadow:0 15px 35px rgba(0,0,0,.35); transform:translateY(-1px) }
    .card h3{margin:0 0 14px; text-align:center; font-size:18px}

    /* HORIZONT√ÅLNE LISTY ‚Äî presne 4 karty na mobil */
    .colset{
      --cols:4;
      display:flex; gap:var(--gap);
      overflow-x:auto; overflow-y:hidden;
      scrollbar-gutter:stable both-edges;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior-x:contain;
      cursor:grab; padding:10px 6px 14px;
      scroll-snap-type:x proximity;
    }
    .colset.dragging{cursor:grabbing; user-select:none}

    .col{
      flex:0 0 calc((100% - (var(--cols) - 1)*var(--gap)) / var(--cols));
      background:var(--panel); border:1px solid var(--stroke); border-radius:12px; padding:12px;
      display:grid; grid-template-rows:auto auto auto auto; align-items:center; justify-items:center;
      text-align:center; min-height:182px; position:relative; row-gap:8px; min-width:0;
      scroll-snap-align:start
    }

    .c-top{opacity:.9; line-height:1.1}
    .temps{display:grid; place-items:center; width:100%}
    .temps .c-max{font-size:28px; font-weight:700; color:#ff6c6c; line-height:1}
    .temps .c-min{font-size:18px; color:#ffbb7c; margin-top:4px; line-height:1}
    .c-ico{font-size:26px; line-height:1}

    /* METRIKY: kƒæ√∫ƒç | hodnota (nezalamova≈•) */
    .metrics{display:flex; flex-direction:column; gap:6px; width:100%}
    .metric.kv{display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:6px}
    .metric .m-ico{font-size:16px}
    .metric .m-key{font-size:13px; color:#e9f3ff; opacity:.9; white-space:nowrap}
    .metric .m-val{font-size:13px; font-weight:600; color:#e9f3ff; white-space:nowrap}
    .metric .m-txt{font-size:13px; color:#e9f3ff; white-space:nowrap}

    /* men≈°ie telef√≥ny */
    @media (max-width:420px){
      .temps .c-max{font-size:26px}
      .temps .c-min{font-size:17px}
      .c-ico{font-size:24px}
      .metric .m-key,.metric .m-val,.metric .m-txt{font-size:12.3px}
    }

    /* v√§ƒç≈°ie displeje ‚Äî in√Ω poƒçet kariet na viewport */
    @media (min-width:900px){
      #parts{--cols:4}
      #days{--cols:7}
      #min15{--cols:6}
      .temps .c-max{font-size:32px}
      .temps .c-min{font-size:19px}
    }

    .colset::-webkit-scrollbar{height:10px}
    .colset::-webkit-scrollbar-track{background:#0f1c2a; border-radius:8px}
    .colset::-webkit-scrollbar-thumb{background:#33516f; border-radius:8px}
    .colset::-webkit-scrollbar-thumb:hover{background:#3f6b94}
    .colset{scrollbar-width:thin; scrollbar-color:#33516f #0f1c2a}
  </style>
</head>

<body>
  <div class="wrap">
    <header><h1 class="text-3xl font-bold">Poƒçasie</h1></header>

    <div class="toolbar">
      <div class="relative">
        <input id="q" class="w-full bg-[#152535] border border-[#233448] text-white rounded-xl p-3 outline-none focus:border-[#3ad0e6] transition-colors" type="text" placeholder="Hƒæadaj mesto (napr. Bratislava, Ko≈°ice)" />
        <div id="suggestions" class="absolute top-full left-0 right-0 z-40 hidden grid gap-1 p-2 bg-[#0f1c2a] border border-[#233448] rounded-xl max-h-[55vh] overflow-y-auto"></div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mt-5">
      <section class="card">
        <div class="grid grid-cols-2 gap-4 items-start">
          <div>
            <h3 id="place" class="text-xl font-semibold overflow-hidden whitespace-nowrap text-ellipsis">‚Äî</h3>
            <div class="text-5xl font-bold mt-2" id="temp">‚Äî¬∞</div>
            <div class="flex flex-wrap gap-2 mt-4">
              <span class="bg-[#143344] border border-[#233448] text-[#d8f7ff] rounded-full px-4 py-2 text-sm" id="uv">UV index ‚Äî</span>
              <span class="bg-[#143344] border border-[#233448] text-[#d8f7ff] rounded-full px-4 py-2 text-sm" id="aqi">Kvalita ovzdu≈°ia ‚Äî</span>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-4 text-[#a8bed5] text-sm">
              <div>Pocitov√° teplota: <strong id="apparent" class="text-white">‚Äî</strong></div>
              <div>Vietor: <strong id="wind" class="text-white">‚Äî</strong></div>
              <div>Vlhkos≈•: <strong id="hum" class="text-white">‚Äî</strong></div>
              <div>Tlak: <strong id="press" class="text-white">‚Äî</strong></div>
              <div>V√Ωchod slnka: <strong id="sunrise" class="text-white">‚Äî</strong></div>
              <div>Z√°pad slnka: <strong id="sunset" class="text-white">‚Äî</strong></div>
            </div>
          </div>
          <div id="icon" class="text-7xl flex items-center justify-center">‚Äî</div>
        </div>

        <div class="mt-6">
          <h3 class="text-lg font-semibold mb-2">Dne≈°n√Ω s√∫hrn</h3>
          <p id="summary" class="bg-[#0f1c2a] border border-[#233448] text-[#dbeeff] rounded-lg p-3 text-center">‚Äî</p>
        </div>
      </section>

      <section class="card">
        <h3 class="text-lg font-semibold mb-2 text-center">Teplota poƒças 24 hod√≠n</h3>
        <div class="h-64 md:h-72 mt-4"><canvas id="hourly"></canvas></div>
      </section>
    </div>

    <section class="card mt-5">
      <h3 class="text-lg font-semibold text-center">Dne≈°n√° predpoveƒè</h3>
      <div id="parts" class="colset"></div>
    </section>

    <section class="card mt-5">
      <h3 class="text-lg font-semibold text-center">7-d≈àov√° predpoveƒè</h3>
      <div id="days" class="colset"></div>
    </section>

    <section class="card mt-5">
      <h3 class="text-lg font-semibold text-center">15-min√∫tov√° predpoveƒè (24 h)</h3>
      <div id="min15" class="colset"></div>
    </section>

    <section class="card mt-5">
      <div class="text-center">
        <h3 class="text-lg font-semibold">Poƒçasie presne pred rokom</h3>
        <div id="hist-date" class="text-[#a8bed5] text-sm">‚Äî</div>
      </div>
      <div class="flex flex-wrap items-center justify-center gap-4 mt-4">
        <div id="hist-emoji" class="text-4xl">‚Äî</div>
        <div class="font-bold text-xl" id="hist-text">‚Äî</div>
        <span class="bg-[#ff5e5e] text-white font-bold rounded-lg px-3 py-1" id="hist-max">‚Äî</span>
        <span class="bg-[#ffd265] text-[#2b2300] font-bold rounded-lg px-3 py-1" id="hist-min">‚Äî</span>
      </div>
      <div class="text-[#a8bed5] text-xs mt-2 text-center" id="hist-extra">‚Äî</div>
    </section>
  </div>

  <footer class="text-center py-4 text-[#cfe8ff] text-sm border-t border-t-[rgba(255,255,255,.12)] mt-5">
    &copy; <span id="year"></span> Richard / Poƒçasie
  </footer>
  <div id="err" class="fixed left-3 right-3 bottom-3 bg-[#2a1111] border border-[#6b2a2a] text-[#ffd9d9] rounded-lg p-3 text-sm hidden z-50"></div>

  <script>
    const APP_VERSION='2025-08-15-flex-4cards-final';
    const $ = s => document.querySelector(s);
    const NBSP_NARROW = '\u202F';
    const fmt0 = (v,u='') => (v==null || Number.isNaN(v)) ? '‚Äî' : (Math.round(v)+u);
    const fmt1 = (v,u='') => (v==null || Number.isNaN(v)) ? '‚Äî' : ((Math.round(v*10)/10).toFixed(1)+u);

    const WMO={0:['Jasno'],1:['Preva≈æne jasno'],2:['Polojasno'],3:['Zamraƒçen√©'],45:['Hmla'],48:['Mrzn√∫ca hmla'],
      51:['Slab√© mrholenie'],53:['Mrholenie'],55:['Siln√© mrholenie'],
      61:['Slab√Ω d√°≈æƒè'],63:['D√°≈æƒè'],65:['Lejak'],66:['Mrzn√∫ci d√°≈æƒè'],67:['Mrzn√∫ci d√°≈æƒè'],
      71:['Slab√© sne≈æenie'],73:['Sne≈æenie'],75:['Siln√© sne≈æenie'],77:['Snehov√© zrn√°'],
      80:['Preh√°nky'],81:['Preh√°nky'],82:['Siln√© preh√°nky'],
      85:['Snehov√© preh√°nky'],86:['Siln√© snehov√© preh√°nky'],
      95:['B√∫rky'],96:['B√∫rky s kr√∫pami'],99:['Siln√© b√∫rky s kr√∫pami']};
    const RAIN_CODES=new Set([51,53,55,61,63,65,66,67,80,81,82,95,96,99]);
    const uvCat=u=>u<3?'n√≠zky':u<6?'mierny':u<8?'vysok√Ω':u<11?'veƒæmi vysok√Ω':'extr√©mny';
    const windEmoji=()=> 'üí®';

    function wmoEmoji(code, night=false, ctx={}){
      const k=Number(code);
      function fog(){ const t=Number.isFinite(ctx.temp)?ctx.temp:null;
        const w=Number.isFinite(ctx.wind)?ctx.wind:null;
        const p=Number.isFinite(ctx.precip)?ctx.precip:null;
        const prob=Number.isFinite(ctx.prob)?ctx.prob:null;
        if(t!=null && t<=0) return '‚ùÑÔ∏è';
        if((p!=null && p>0)||(prob!=null && prob>=30)) return 'üåßÔ∏è';
        if(w!=null && w>=20) return 'üí®';
        return night?'üåô':'‚òÅÔ∏è';
      }
      if([45,48].includes(k)) return fog();
      if([0,1].includes(k)) return night?'üåô':'‚òÄÔ∏è';
      if(k===2) return night?'üåô':'‚õÖ';
      if(k===3) return '‚òÅÔ∏è';
      if([51,53,55].includes(k)) return 'üå¶Ô∏è';
      if([61,63,65,80,81,82].includes(k)) return 'üåßÔ∏è';
      if([71,73,75,77,85,86].includes(k)) return '‚ùÑÔ∏è';
      if([95,96,99].includes(k)) return '‚õàÔ∏è';
      return night?'üåô':'üå§Ô∏è';
    }
    function willRain({code,precip,temp,prob,precipSum}={}){
      if(prob!=null && prob>=30) return true;
      if(code!=null && RAIN_CODES.has(Number(code))) return true;
      if(precipSum!=null && precipSum>=0.1) return true;
      if(precip!=null && precip>0){ if(temp==null) return true; return temp>1 }
      return false;
    }
    function isNightAt(dtLike,daily){
      const dt=typeof dtLike==='string'?new Date(dtLike):dtLike;
      try{
        const dayStr=dt.toISOString().slice(0,10);
        const times=daily && daily.time ? daily.time:[];
        const i=times.indexOf(dayStr);
        if(i>=0 && daily && daily.sunrise && daily.sunset && daily.sunset[i]){
          const sr=new Date(daily.sunrise[i]); const ss=new Date(daily.sunset[i]);
          return (dt<sr || dt>=ss);
        }
      }catch(_){}
      const h=dt.getHours(); return (h<6 || h>=21);
    }
    const pad=n=>String(n).padStart(2,'0');
    const localHourKey=(date)=>{ const d=typeof date==='string'?new Date(date):new Date(date);
      return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'T'+pad(d.getHours()); };
    function valueAtHourLocal(timesISO,arr,date){
      if(!timesISO||!arr||!timesISO.length) return null;
      const key=localHourKey(date); let idx=timesISO.findIndex(t=>t.slice(0,13)===key);
      if(idx>=0) return arr[idx];
      let best=0, bestDiff=1e18;
      timesISO.forEach((t,i)=>{const diff=Math.abs(new Date(t)-new Date(date)); if(diff<bestDiff){best=i;bestDiff=diff}});
      return arr[best];
    }
    const lerp=(a,b,t)=>a+(b-a)*t;
    function valueAt15min(timesISO,arr,date){
      if(!timesISO||!arr) return null;
      const ts=timesISO.map(t=>new Date(t));
      for(let i=0;i<ts.length-1;i++){ const t0=ts[i], t1=ts[i+1];
        if(date>=t0 && date<=t1){ const r=(date-t0)/(t1-t0), v0=arr[i], v1=arr[i+1];
          if(v0==null || v1==null) return null; return lerp(v0,v1,r); } }
      return null;
    }
    function codeAt15min(timesISO,codes,date){
      if(!timesISO||!codes) return 0;
      const ts=timesISO.map(t=>new Date(t));
      for(let i=0;i<ts.length-1;i++){ const t0=ts[i], t1=ts[i+1];
        if(date>=t0 && date<=t1){ const mid=(t0.getTime()+t1.getTime())/2; return (date<new Date(mid))?codes[i]:codes[i+1]; } }
      return codes[codes.length-1] ?? 0;
    }
    function pickDayCondition(d){
      const times=(d.hourly && d.hourly.time)?d.hourly.time:[];
      const codes=(d.hourly && d.hourly.weather_code)?d.hourly.weather_code:[];
      const day=(d.current && d.current.time? d.current.time:'').slice(0,10);
      let startH=9,endH=18;
      const sr=(d.daily && d.daily.sunrise && d.daily.sunrise[0])?d.daily.sunrise[0]:null;
      const ss=(d.daily && d.daily.sunset && d.daily.sunset[0])?d.daily.sunset[0]:null;
      if(sr && ss){ const sh=new Date(sr).getHours(), eh=new Date(ss).getHours(); if(!Number.isNaN(sh)&&!Number.isNaN(eh)&&sh<eh){startH=sh;endH=eh;} }
      const freq={}; for(let i=0;i<times.length;i++){ if(!times[i].startsWith(day)) continue;
        const h=Number(times[i].slice(11,13)); if(h<startH||h>endH) continue; const c=(codes[i]??0); freq[c]=(freq[c]||0)+1; }
      let best=(d.daily && d.daily.weather_code && d.daily.weather_code[0]!=null)?d.daily.weather_code[0]:(codes[0]??0);
      let bestCnt=-1; Object.keys(freq).forEach(k=>{const cnt=freq[k]; if(cnt>bestCnt){bestCnt=cnt; best=Number(k)}}); return best;
    }
    const aqiCat=v=>{ if(v==null||Number.isNaN(v)) return '‚Äî'; if(v<=50) return 'dobr√°'; if(v<=100) return 'mierne zhor≈°en√°';
      if(v<=150) return 'rizikov√°'; if(v<=200) return 'zl√°'; if(v<=300) return 'veƒæmi zl√°'; return 'nebezpeƒçn√°'; };

    let state={place:'‚Äî', lat:48.1486, lon:17.1077, last:null, aqi:null, hist:null};
    let hourlyChart=null;
    const LS_KEY='wx_prefs_v3';
    const toast=(msg)=>{ const el=$('#err'); if(!el) return; el.textContent=msg; el.style.display='block'; setTimeout(()=>{el.style.display='none'}, 5000) };

    try{ const raw=localStorage.getItem(LS_KEY); if(raw){ const p=JSON.parse(raw); if(+p.lat && +p.lon && p.place){ state={...state, ...p}; } } }catch(_){}
    const savePrefs=()=>{ try{ localStorage.setItem(LS_KEY, JSON.stringify({lat:state.lat, lon:state.lon, place:state.place})); }catch(_){ } };

    async function reverseGeocodeOpenMeteo(){
      if(!state.lat||!state.lon) return;
      try{
        const url=`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${state.lat}&longitude=${state.lon}&language=sk&format=json`;
        const j=await fetch(url).then(r=>r.json()); const r=j?.results?.[0];
        if(r){ const name=r.name||r.city||r.town||r.village||''; const admin=r.admin1?`, ${r.admin1}`:''; const cc=r.country_code?`, ${r.country_code}`:''; if(name) state.place=name+admin+cc; }
      }catch(_){}
    }

    async function fetchWeather(){
      const {lat,lon}=state; if(!lat||!lon) return;
      const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,apparent_temperature,precipitation,wind_speed_10m,relative_humidity_2m,pressure_msl,is_day&hourly=temperature_2m,relative_humidity_2m,precipitation_probability,weather_code,uv_index,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,sunrise,sunset,uv_index_max,precipitation_sum,precipitation_probability_max,wind_speed_10m_max&timezone=auto&forecast_days=7`;
      const aqiUrl=`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=european_aqi&timezone=auto`;
      const histUrl=`https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${moment().subtract(1,'years').format('YYYY-MM-DD')}&end_date=${moment().subtract(1,'years').format('YYYY-MM-DD')}&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`;

      const [res,aqiRes,histRes]=await Promise.all([
        fetch(url).then(r=>r.json()).catch(()=>({})),
        fetch(aqiUrl).then(r=>r.json()).catch(()=>({})),
        fetch(histUrl).then(r=>r.json()).catch(()=>({}))
      ]);
      if(res && !res.error){ state.last=res; state.aqi=aqiRes; state.hist=histRes; await reverseGeocodeOpenMeteo(); savePrefs(); renderData(); }
      else toast(res?.reason || 'Naƒç√≠tanie poƒçasia zlyhalo');
    }

    function setLocation(lat,lon,place){ state.lat=lat; state.lon=lon; if(place) state.place=place; state.last=null; savePrefs(); fetchWeather().catch(()=>toast('Naƒç√≠tanie poƒçasia zlyhalo')); }

    function renderData(){
      if(!state.last) return;
      const d=state.last, cur=d.current, daily=d.daily, aqi=state.aqi||{};
      const isNight = (cur?.is_day===0);

      $('#place').textContent=state.place;
      $('#temp').textContent=fmt0(cur.temperature_2m,'¬∞');
      $('#icon').textContent=wmoEmoji(cur.weather_code, isNight, {temp:cur.temperature_2m, precip:cur.precipitation, wind:cur.wind_speed_10m});

      const uvNow=valueAtHourLocal(d.hourly.time, d.hourly.uv_index, new Date());
      $('#uv').textContent = (uvNow!=null?`UV index ${fmt0(uvNow)} (${uvCat(uvNow)})`:'UV index ‚Äî');

      const aqiTime = aqi?.hourly?.time;
      const aqiVals = aqi?.hourly?.european_aqi;
      const aqiVal = (aqiTime && aqiVals) ? valueAtHourLocal(aqiTime, aqiVals, new Date()) : null;
      $('#aqi').textContent = `Kvalita ovzdu≈°ia ${aqiVal!=null?Math.round(aqiVal):'‚Äî'} (${aqiCat(aqiVal)})`;

      $('#apparent').textContent=fmt0(cur.apparent_temperature,'¬∞');
      $('#wind').textContent=fmt0(cur.wind_speed_10m, NBSP_NARROW+' km/h');
      $('#hum').textContent=fmt0(cur.relative_humidity_2m, NBSP_NARROW+' %');
      $('#press').textContent=fmt0(cur.pressure_msl, NBSP_NARROW+' hPa');
      $('#sunrise').textContent=moment(daily.sunrise[0]).format('HH:mm');
      $('#sunset').textContent=moment(daily.sunset[0]).format('HH:mm');

      const condToday=(WMO[pickDayCondition({hourly:d.hourly, current:cur, daily})]||['‚Äî'])[0];
      const tmax=daily.temperature_2m_max[0], tmin=daily.temperature_2m_min[0];
      $('#summary').innerHTML=`Dnes <strong>${condToday.toLowerCase()}</strong>, max <strong>${fmt0(tmax,'¬∞')}</strong>, min <strong>${fmt0(tmin,'¬∞')}</strong>.`;

      renderHourly(); renderForecastParts(); renderForecastDays(); renderMin15(); renderHistory();
    }

    function renderHourly(){
      if(!state.last) return;
      const d=state.last; const labels=d.hourly.time.map(t=>moment(t).format('HH:mm')); const t=d.hourly.temperature_2m;
      const ctx=$('#hourly').getContext('2d'); if(hourlyChart) hourlyChart.destroy();
      hourlyChart=new Chart(ctx,{type:'line',
        data:{labels, datasets:[{label:'Teplota (¬∞C)', data:t, borderColor:'#3ad0e6', borderWidth:2, pointBackgroundColor:'#3ad0e6', pointBorderColor:'#3ad0e6', tension:.35, fill:false}]},
        options:{responsive:true, maintainAspectRatio:false,
          scales:{x:{ticks:{color:'#a8bed5', autoSkip:true, maxRotation:0, minRotation:0}, grid:{color:'rgba(35,52,72,.2)'}},
                  y:{ticks:{color:'#a8bed5'}, grid:{color:'rgba(35,52,72,.2)'}}},
          plugins:{legend:{display:false}, tooltip:{backgroundColor:'#152433', titleColor:'#eaf3ff', bodyColor:'#eaf3ff', borderColor:'#233448', borderWidth:1}}
        }});
    }

    function renderForecastParts(){
      if(!state.last) return; const d=state.last;
      const base=moment().startOf('day'); const el=$('#parts'); el.innerHTML='';
      const labels=['Doobeda','Poobede','Veƒçer','Noc']; const hours=[10,15,(moment(d.daily.sunset[0]).hour()||20)+1,2];
      for(let i=0;i<4;i++){
        const dt = (i===2 && d.daily.sunset?.[0]) ? moment(d.daily.sunset[0]).add(30,'minutes') : base.clone().add(hours[i],'hours');
        const temp=valueAtHourLocal(d.hourly.time, d.hourly.temperature_2m, dt.toDate());
        const code=valueAtHourLocal(d.hourly.time, d.hourly.weather_code, dt.toDate());
        const prob=valueAtHourLocal(d.hourly.time, d.hourly.precipitation_probability, dt.toDate());
        const wind=valueAtHourLocal(d.hourly.time, d.hourly.wind_speed_10m, dt.toDate());
        const night=isNightAt(dt.toISOString(), d.daily);

        const card=document.createElement('div'); card.className='col';
        card.innerHTML =
          `<div class="c-top">${labels[i]}</div>
           <div class="temps"><div class="c-max">${fmt0(temp,'¬∞')}</div><div class="c-min">${temp!=null?fmt0(temp-5,'¬∞'):'‚Äî'}</div></div>
           <div class="c-ico">${wmoEmoji(code, night, {temp, prob, wind})}</div>
           <div class="metrics">
             <div class="metric kv"><span class="m-ico">üíß</span><span class="m-key">Zr√°≈æky</span><span class="m-val">${prob!=null?fmt0(prob,'%'):'‚Äî'}</span></div>
             <div class="metric kv"><span class="m-ico">${windEmoji()}</span><span class="m-key">Vietor</span><span class="m-val">${fmt0(wind, NBSP_NARROW+'km/h')}</span></div>
           </div>`;
        el.appendChild(card);
      }
    }

    function renderForecastDays(){
      if(!state.last) return; const d=state.last; const el=$('#days'); el.innerHTML='';
      const n=Math.min(7, d.daily.time.length);
      for(let i=0;i<n;i++){
        const dt=moment(d.daily.time[i]);
        const code=d.daily.weather_code[i];
        const will=willRain({code, prob:d.daily.precipitation_probability_max[i], precipSum:d.daily.precipitation_sum[i]});
        const avgT=(d.daily.temperature_2m_max[i]+d.daily.temperature_2m_min[i])/2;
        const ico=wmoEmoji(code,false,{prob:d.daily.precipitation_probability_max[i], temp:avgT});
        const card=document.createElement('div'); card.className='col';
        card.innerHTML =
          `<div class="c-top">${dt.format('ddd DD.MM.')}</div>
           <div class="temps"><div class="c-max">${fmt0(d.daily.temperature_2m_max[i],'¬∞')}</div><div class="c-min">${fmt0(d.daily.temperature_2m_min[i],'¬∞')}</div></div>
           <div class="c-ico">${ico}</div>
           <div class="metrics">
             <div class="metric kv"><span class="m-ico">üíß</span><span class="m-key">Pravdep.</span><span class="m-val">${d.daily.precipitation_probability_max[i]!=null?fmt0(d.daily.precipitation_probability_max[i],'%'):'‚Äî'}</span></div>
             <div class="metric kv"><span class="m-ico">${windEmoji()}</span><span class="m-key">Vietor</span><span class="m-val">${fmt0(d.daily.wind_speed_10m_max[i], NBSP_NARROW+'km/h')}</span></div>
           </div>`;
        el.appendChild(card);
      }
    }

    function renderMin15(){
      if(!state.last) return;
      const d=state.last; const el=$('#min15'); el.innerHTML='';
      // ak API neposkytne minutely_15, zobraz spr√°vu
      const m15=d.minutely_15; if(!m15 || !m15.time){ el.innerHTML='<div style="opacity:.8;color:#bcd1e5;padding:8px 10px;">Min√∫tov√° predpoveƒè nedostupn√°</div>'; return; }

      const start=moment();
      // 24 h => 96 slotov (po 15 min)
      for(let k=0;k<96;k++){
        const dt=start.clone().add(k*15,'minutes');
        const temp=valueAt15min(m15.time, m15.temperature_2m, dt.toDate());
        const code=codeAt15min(m15.time, m15.weather_code, dt.toDate());
        const precip=valueAt15min(m15.time, m15.precipitation, dt.toDate());
        const night=isNightAt(dt.toISOString(), d.daily);

        const card=document.createElement('div'); card.className='col';
        card.innerHTML =
         `<div class="c-top">${dt.format('HH:mm')}</div>
          <div class="temps"><div class="c-max">${fmt0(temp,'¬∞')}</div></div>
          <div class="c-ico">${wmoEmoji(code, night, {temp, precip})}</div>
          <div class="metrics">
            <div class="metric kv"><span class="m-ico">üíß</span><span class="m-key">Zr√°≈æky</span><span class="m-val">${precip!=null?fmt1(precip, NBSP_NARROW+' mm/h'):'‚Äî'}</span></div>
          </div>`;
        el.appendChild(card);
      }
    }

    function renderHistory(){
      const h=state.hist?.daily; if(!h || !h.time?.length){ $('#hist-date').textContent='√ödaje spred roka nie s√∫ dostupn√©'; return; }
      const dt=moment(h.time[0]); const code=h.weather_code[0]; const tmax=h.temperature_2m_max[0]; const tmin=h.temperature_2m_min[0];
      $('#hist-date').textContent = `D≈àa ${dt.format('D. M. YYYY')}`;
      $('#hist-emoji').textContent = wmoEmoji(code);
      $('#hist-text').textContent = (WMO[code] && WMO[code][0]) || '‚Äî';
      $('#hist-max').textContent = fmt1(tmax,'¬∞C');
      $('#hist-min').textContent = fmt1(tmin,'¬∞C');
      $('#hist-extra').textContent = '';
    }

    // drag scroll
    function enableDragScroll(el){
      let down=false, sx=0, sl=0;
      el.addEventListener('pointerdown',e=>{ down=true; el.classList.add('dragging'); sx=e.clientX; sl=el.scrollLeft; el.setPointerCapture(e.pointerId); });
      el.addEventListener('pointermove',e=>{ if(!down) return; el.scrollLeft = sl - (e.clientX - sx); });
      el.addEventListener('pointerup',e=>{ down=false; el.classList.remove('dragging'); try{el.releasePointerCapture(e.pointerId)}catch(_){}} );
      el.addEventListener('pointercancel',()=>{ down=false; el.classList.remove('dragging'); });
      el.addEventListener('wheel',e=>{ const delta=Math.abs(e.deltaY)>Math.abs(e.deltaX)?e.deltaY:e.deltaX; el.scrollLeft += delta*0.6; e.preventDefault() }, {passive:false});
    }

    // geolok√°cia
    function initGeolocation(){
      if("geolocation" in navigator){
        navigator.geolocation.getCurrentPosition(pos=>{ setLocation(pos.coords.latitude, pos.coords.longitude, state.place); },
          _=>{ toast('Nepodarilo sa zisti≈• polohu.'); fetchWeather().catch(()=>toast('Naƒç√≠tanie poƒçasia zlyhalo')); });
      }else{ toast('Prehliadaƒç nepodporuje geolok√°ciu.'); fetchWeather().catch(()=>toast('Naƒç√≠tanie poƒçasia zlyhalo')); }
    }

    // vyhƒæad√°vanie miest
    let tmr=null;
    $('#q').addEventListener('input', ()=>{
      clearTimeout(tmr);
      tmr=setTimeout(async ()=>{
        const q=$('#q').value.trim(); const box=$('#suggestions');
        if(q.length<3){ box.style.display='none'; return }
        const url=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=8&language=sk&format=json`;
        const j=await fetch(url).then(r=>r.json()).catch(()=>({})); const arr=j.results||[];
        box.innerHTML=''; box.style.display='grid';
        if(!arr.length){ box.innerHTML='<div class="text-[#a8bed5] p-2">Niƒç sa nena≈°lo</div>'; return }
        arr.forEach(p=>{
          const b=document.createElement('div');
          b.className='bg-[#13263a] border border-[#233448] rounded-xl p-3 cursor-pointer hover:bg-[#1a3045] transition-colors';
          b.textContent = p.name + (p.admin1?(', '+p.admin1):'') + ', ' + p.country_code;
          b.addEventListener('click', ()=>{ setLocation(p.latitude,p.longitude,b.textContent); box.style.display='none' });
          box.appendChild(b);
        });
      },250);
    });
    document.addEventListener('click', e=>{ const box=$('#suggestions'); if(box && !box.contains(e.target) && e.target!==$('#q')) box.style.display='none' });

    document.getElementById('year').textContent=new Date().getFullYear();

    function initDragBars(){ ['parts','days','min15'].forEach(id=>{ const el=document.getElementById(id); if(el) enableDragScroll(el); }) }

    initGeolocation();
    setTimeout(()=>{ if(!state.last) fetchWeather().catch(()=>toast('Naƒç√≠tanie poƒçasia zlyhalo')); }, 1200);
    window.addEventListener('resize', ()=>{ if(state.last) renderHourly() });
    initDragBars();
  </script>
</body>
</html>

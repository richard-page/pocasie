<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Meteo ON-TOP ‚Ä¢ Open-Meteo</title>
  <meta name="theme-color" content="#0ea5e9" />
  <meta name="description" content="Kreat√≠vny meteoweb s d√°tami z Open-Meteo: aktu√°lne poƒçasie, hodinov√° a denn√° predpoveƒè, grafy, radar. PWA, dark/light re≈æim, geolok√°cia." />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Inline manifest ako data:URL (single-file PWA) -->
  <link rel="manifest" id="manifestLink" href="data:application/json,{
    &quot;name&quot;:%22Meteo%20ON-TOP%22,
    &quot;short_name&quot;:%22Meteo%22,
    &quot;start_url&quot;:%22./%22,
    &quot;display&quot;:%22standalone%22,
    &quot;background_color&quot;:%22#0ea5e9%22,
    &quot;theme_color&quot;:%22#0ea5e9%22,
    &quot;icons&quot;:[
      {&quot;src&quot;:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Cdefs/%3E%3Ccircle cx='128' cy='128' r='120' fill='%230ea5e9'/%3E%3Cpath d='M176 148a44 44 0 1 1-82.3-20.2A36 36 0 0 1 128 76c18.9 0 34.6 14.3 36.7 32.7A36 36 0 0 1 176 148Z' fill='white'/%3E%3C/svg%3E%22, &quot;sizes&quot;:%22256x256%22, &quot;type&quot;:%22image/svg+xml%22}
    ]
  }" />

  <style>
    :root{
      --bg-1:#0ea5e9; /* sky-500 */
      --bg-2:#2563eb; /* blue-600 */
      --bg-3:#111827; /* gray-900 */
      --card:rgba(255,255,255,.14);
      --glass:blur(20px);
      --txt:#0b1220;
      --txt-inv:#ffffff;
      --ring:rgba(255,255,255,.35);
    }
    html,body{height:100%;}
    body{
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--txt-inv);
      background: radial-gradient(1200px 800px at 100% -10%, rgba(255,255,255,.08), transparent 40%), linear-gradient(135deg, var(--bg-1), var(--bg-2));
      transition: background 600ms ease, color 300ms ease;
      min-height:100vh;
    }
    .glass{
      background: var(--card);
      -webkit-backdrop-filter: var(--glass);
      backdrop-filter: var(--glass);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card-hover{
      transition: transform 220ms ease, box-shadow 220ms ease, border-color 220ms ease;
    }
    .card-hover:hover{
      transform: translateY(-2px);
      box-shadow: 0 16px 38px rgba(0,0,0,.35);
      border-color: var(--ring);
    }
    .hero-grad{
      background: conic-gradient(from 220deg at 50% 50%, rgba(255,255,255,.12), transparent 30%) no-repeat;
    }
    .skeleton{
      position:relative;
      overflow:hidden;
      background: linear-gradient(90deg, rgba(255,255,255,.10) 0%, rgba(255,255,255,.20) 50%, rgba(255,255,255,.10) 100%);
      background-size: 200% 100%;
      animation: sk 1.2s infinite linear;
      border-radius: 12px;
    }
    @keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .chip{
      background: rgba(255,255,255,.13);
      border:1px solid rgba(255,255,255,.15);
      padding:.35rem .65rem;
      border-radius: 999px;
    }
    .fade-in{ animation: fade 380ms ease both; }
    @keyframes fade{ from{opacity:0; transform: translateY(4px)} to{opacity:1; transform:none} }

    /* Dark / Light toggle (body.dark uses deeper background; body.light inverts cards) */
    body.light{
      color:#0b1220;
      background: linear-gradient(135deg, #f5fbff, #e8f1ff);
    }
    body.light .glass{
      background: rgba(255,255,255,.8);
      border-color: rgba(0,0,0,.06);
      box-shadow: 0 8px 24px rgba(12,32,80,.06);
    }
    body.light .chip{
      background: rgba(0,0,0,.06);
      border-color: rgba(0,0,0,.08);
    }

    /* Scrollbar minimal */
    ::-webkit-scrollbar{height:10px;width:10px}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.25);border-radius:999px}
    body.light ::-webkit-scrollbar-thumb{background:rgba(0,0,0,.2)}
  </style>
</head>
<body class="antialiased selection:bg-white/30 selection:text-black">

  <!-- Top bar -->
  <header class="px-4 md:px-8 pt-4 pb-3">
    <div class="max-w-6xl mx-auto flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="glass w-10 h-10 grid place-items-center rounded-xl hero-grad">
          <span class="text-xl">‚õÖ</span>
        </div>
        <div>
          <h1 class="text-xl md:text-2xl font-semibold tracking-tight">Meteo <span class="opacity-90">ON-TOP</span></h1>
          <p class="text-xs md:text-sm opacity-70 -mt-0.5">Open-Meteo ‚Ä¢ r√Ωchle & presn√©</p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnTheme" class="chip hover:opacity-80 transition" title="Dark/Light">üåô</button>
        <button id="btnInstall" class="chip hover:opacity-80 transition hidden" title="In≈°talova≈• ako PWA">‚¨áÔ∏è In≈°talova≈•</button>
        <a href="#" class="chip hover:opacity-80 transition" id="aboutBtn" title="O projekte">‚ÑπÔ∏è Info</a>
      </div>
    </div>
  </header>

  <!-- Search / Actions -->
  <section class="px-4 md:px-8 pb-4">
    <div class="max-w-6xl mx-auto grid gap-3 md:grid-cols-[1fr_auto_auto]">
      <div class="glass p-2 md:p-3 flex items-center gap-2 card-hover">
        <span class="pl-2 text-lg">üîé</span>
        <input id="q" class="w-full bg-transparent outline-none placeholder:opacity-60 text-base md:text-lg" placeholder="Zadaj mesto (napr. Bratislava)..." />
        <div id="suggest" class="absolute mt-14 ml-12 w-[calc(100%-6rem)] md:w-[32rem] z-20 hidden"></div>
      </div>
      <button id="btnGeo" class="glass px-4 py-3 font-semibold card-hover">üìç Moja poloha</button>
      <button id="btnSearch" class="glass px-4 py-3 font-semibold card-hover">Hƒæada≈•</button>
    </div>
  </section>

  <!-- Alerts line -->
  <section class="px-4 md:px-8">
    <div id="banner" class="max-w-6xl mx-auto hidden">
      <div class="glass p-3 flex items-center justify-between gap-3 border border-white/20 card-hover">
        <div class="flex items-center gap-3">
          <span>üö®</span>
          <p id="bannerText" class="text-sm md:text-base"></p>
        </div>
        <button id="bannerClose" class="chip">‚úñ</button>
      </div>
    </div>
  </section>

  <!-- Main content -->
  <main class="px-4 md:px-8 pb-20">
    <div class="max-w-6xl mx-auto grid gap-6">
      <!-- CURRENT -->
      <section id="currentSection" class="grid gap-6 md:grid-cols-3">
        <!-- Left: Current big card -->
        <article class="glass p-5 md:p-6 card-hover md:col-span-2">
          <div class="flex items-start md:items-center justify-between gap-4">
            <div>
              <h2 id="locName" class="text-2xl md:text-3xl font-bold tracking-tight">‚Äî</h2>
              <p id="locMeta" class="opacity-80 text-sm md:text-base">Vyber mesto alebo povoƒæ polohu</p>
            </div>
            <div class="text-6xl md:text-7xl leading-none select-none" id="currentIcon">‚è≥</div>
          </div>

          <div class="mt-6 grid grid-cols-2 sm:grid-cols-4 gap-4">
            <div class="glass p-4">
              <div class="text-4xl font-semibold" id="curTemp">‚Äî¬∞C</div>
              <div class="opacity-80 text-sm">Teplota</div>
            </div>
            <div class="glass p-4">
              <div class="text-2xl" id="curFeels">‚Äî¬∞C</div>
              <div class="opacity-80 text-sm">Pocitov√°</div>
            </div>
            <div class="glass p-4">
              <div class="text-2xl" id="curWind">‚Äî km/h</div>
              <div class="opacity-80 text-sm">Vietor</div>
            </div>
            <div class="glass p-4">
              <div class="text-2xl" id="curHumidity">‚Äî%</div>
              <div class="opacity-80 text-sm">Vlhkos≈•</div>
            </div>
            <div class="glass p-4">
              <div class="text-2xl" id="curPressure">‚Äî hPa</div>
              <div class="opacity-80 text-sm">Tlak</div>
            </div>
            <div class="glass p-4">
              <div class="text-2xl" id="curUv">‚Äî</div>
              <div class="opacity-80 text-sm">UV index</div>
            </div>
            <div class="glass p-4">
              <div class="text-2xl" id="curDew">‚Äî¬∞C</div>
              <div class="opacity-80 text-sm">Rosn√Ω bod</div>
            </div>
            <div class="glass p-4">
              <div class="text-2xl" id="curVis">‚Äî km</div>
              <div class="opacity-80 text-sm">Dohƒæadnos≈•</div>
            </div>
          </div>

          <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="glass p-4">
              <div class="text-sm opacity-80">V√Ωchod slnka</div>
              <div class="text-xl" id="sunrise">‚Äî</div>
            </div>
            <div class="glass p-4">
              <div class="text-sm opacity-80">Z√°pad slnka</div>
              <div class="text-xl" id="sunset">‚Äî</div>
            </div>
            <div class="glass p-4">
              <div class="text-sm opacity-80">F√°za Mesiaca</div>
              <div class="text-xl" id="moon">‚Äî</div>
            </div>
            <div class="glass p-4">
              <div class="text-sm opacity-80">Aktualizovan√©</div>
              <div class="text-xl" id="updated">‚Äî</div>
            </div>
          </div>
        </article>

        <!-- Right: Hourly scroller -->
        <aside class="glass p-5 md:p-6 card-hover">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">Hodinov√° predpoveƒè (24h)</h3>
            <div class="flex items-center gap-2 text-sm">
              <span class="chip" id="hourUnits">¬∞C</span>
            </div>
          </div>
          <div id="hourlyWrap" class="flex gap-3 overflow-x-auto pb-2">
            <!-- skeletons -->
            <div class="w-24 shrink-0">
              <div class="skeleton h-24"></div><div class="h-2"></div><div class="skeleton h-4"></div>
            </div>
            <div class="w-24 shrink-0">
              <div class="skeleton h-24"></div><div class="h-2"></div><div class="skeleton h-4"></div>
            </div>
            <div class="w-24 shrink-0">
              <div class="skeleton h-24"></div><div class="h-2"></div><div class="skeleton h-4"></div>
            </div>
          </div>
        </aside>
      </section>

      <!-- DAILY -->
      <section class="grid gap-6">
        <div class="flex items-center justify-between">
          <h3 class="text-lg md:text-xl font-semibold">Denn√° predpoveƒè (7 dn√≠)</h3>
          <div class="text-sm flex items-center gap-2">
            <button id="btnC" class="chip">¬∞C</button>
            <button id="btnF" class="chip">¬∞F</button>
          </div>
        </div>
        <div id="dailyGrid" class="grid grid-cols-2 md:grid-cols-7 gap-4">
          <!-- skeleton cards -->
          <div class="glass p-4 card-hover"><div class="skeleton h-6 mb-3"></div><div class="skeleton h-10"></div><div class="h-2"></div><div class="skeleton h-4"></div></div>
          <div class="glass p-4 card-hover"><div class="skeleton h-6 mb-3"></div><div class="skeleton h-10"></div><div class="h-2"></div><div class="skeleton h-4"></div></div>
          <div class="glass p-4 card-hover"><div class="skeleton h-6 mb-3"></div><div class="skeleton h-10"></div><div class="h-2"></div><div class="skeleton h-4"></div></div>
          <div class="glass p-4 card-hover"><div class="skeleton h-6 mb-3"></div><div class="skeleton h-10"></div><div class="h-2"></div><div class="skeleton h-4"></div></div>
          <div class="glass p-4 card-hover"><div class="skeleton h-6 mb-3"></div><div class="skeleton h-10"></div><div class="h-2"></div><div class="skeleton h-4"></div></div>
          <div class="glass p-4 card-hover"><div class="skeleton h-6 mb-3"></div><div class="skeleton h-10"></div><div class="h-2"></div><div class="skeleton h-4"></div></div>
          <div class="glass p-4 card-hover"><div class="skeleton h-6 mb-3"></div><div class="skeleton h-10"></div><div class="h-2"></div><div class="skeleton h-4"></div></div>
        </div>
      </section>

      <!-- CHARTS -->
      <section class="grid md:grid-cols-2 gap-6">
        <article class="glass p-5 md:p-6 card-hover">
          <h3 class="text-lg font-semibold mb-3">Teplota (min/max)</h3>
          <canvas id="chartTemp" height="240"></canvas>
        </article>
        <article class="glass p-5 md:p-6 card-hover">
          <h3 class="text-lg font-semibold mb-3">Zr√°≈æky a vietor</h3>
          <canvas id="chartPcpWind" height="240"></canvas>
        </article>
      </section>

      <!-- RADAR -->
      <section class="grid gap-3">
        <div class="flex items-center justify-between">
          <h3 class="text-lg md:text-xl font-semibold">Radar / mapa zr√°≈æok</h3>
          <div class="text-sm opacity-80">Windy embed</div>
        </div>
        <div class="glass p-2 md:p-3 card-hover">
          <iframe id="radarFrame" class="w-full rounded-xl" style="height: 420px;"
                  src="https://embed.windy.com/embed2.html?lat=48.7&lon=19.7&zoom=6&level=surface&overlay=rain&menu=&message=true&marker=&calendar=&pressure=&type=map&location=coordinates&detail=&detailLat=48.7&detailLon=19.7&metricWind=km/h&metricTemp=%C2%B0C"
                  loading="lazy" referrerpolicy="no-referrer" ></iframe>
        </div>
      </section>

      <!-- FOOTER -->
      <footer class="opacity-80 text-sm text-center pt-6 pb-2">
        D√°ta: <a class="underline" href="https://open-meteo.com/" target="_blank" rel="noopener">Open-Meteo</a> ‚Ä¢
        Radar: Windy ‚Ä¢
        Vytvoren√© ako single-file PWA ‚Ä¢
        <span id="buildStamp"></span>
      </footer>
    </div>
  </main>

  <!-- INFO MODAL -->
  <dialog id="about" class="glass p-0 w-[min(92vw,640px)] rounded-2xl text-left">
    <div class="p-5 md:p-6">
      <div class="flex items-start justify-between">
        <h3 class="text-xl font-semibold">O projekte</h3>
        <button class="chip" onclick="about.close()">‚úñ</button>
      </div>
      <div class="mt-3 space-y-3 text-sm leading-6">
        <p>T√°to aplik√°cia pou≈æ√≠va <b>Open-Meteo</b> (bez kƒæ√∫ƒça) a be≈æ√≠ kompletne v prehliadaƒçi. Vie:
          aktu√°lne poƒçasie, hodinov√∫ aj denn√∫ predpoveƒè, grafy, radar, geolok√°ciu, PWA in≈°tal√°ciu a offline cache.</p>
        <p>Re≈æim <b>Dark/Light</b> si appka zapam√§t√°. Posledn√∫ lokalitu tie≈æ.</p>
        <p>V≈°etko je v jednom s√∫bore <code>index.html</code> ‚Äì manifest aj service worker s√∫ vlo≈æen√© dynamicky.</p>
      </div>
      <div class="mt-4 flex justify-end">
        <button class="chip" onclick="about.close()">Rozumiem</button>
      </div>
    </div>
  </dialog>

  <script>
    /* =========================
       UTIL
    ========================== */
    const $ = (q,root=document)=>root.querySelector(q);
    const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));
    const clamp=(n,min,max)=>Math.min(Math.max(n,min),max);
    const formatTime = (iso, tzOffsetMinutes=0) => {
      try{
        const d = new Date(iso);
        if(Number.isFinite(tzOffsetMinutes) && tzOffsetMinutes!==0){
          d.setMinutes(d.getMinutes()+tzOffsetMinutes);
        }
        return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      }catch{ return '‚Äî' }
    };
    const formatDate = iso => {
      try{
        const d = new Date(iso);
        return d.toLocaleDateString([], {weekday:'short', day:'2-digit', month:'2-digit'});
      }catch{ return '‚Äî' }
    };
    const toC = v => Math.round(v);
    const c2f = v => Math.round((v*9/5)+32);
    const kmh = v => Math.round(v);
    const mm  = v => Math.round(v*10)/10;

    // WMO k√≥dy -> emoji (ƒæahk√©, pekne ƒçitateƒæn√©)
    const WMO_ICON = {
      0:"‚òÄÔ∏è", 1:"üå§Ô∏è", 2:"‚õÖ", 3:"‚òÅÔ∏è",
      45:"üå´Ô∏è", 48:"üå´Ô∏è",
      51:"üå¶Ô∏è", 53:"üå¶Ô∏è", 55:"üå¶Ô∏è",
      56:"üåßÔ∏è", 57:"üåßÔ∏è",
      61:"üåßÔ∏è", 63:"üåßÔ∏è", 65:"üåßÔ∏è",
      66:"üåßÔ∏è", 67:"üåßÔ∏è",
      71:"üå®Ô∏è", 73:"üå®Ô∏è", 75:"üå®Ô∏è",
      77:"üå®Ô∏è",
      80:"üåßÔ∏è", 81:"üåßÔ∏è", 82:"üåßÔ∏è",
      85:"‚ùÑÔ∏è", 86:"‚ùÑÔ∏è",
      95:"‚õàÔ∏è", 96:"‚õàÔ∏è", 99:"‚õàÔ∏è"
    };

    // Mesiac (0..1) -> f√°za text
    function moonPhaseText(frac){
      if(frac==null) return "‚Äî";
      const x = frac;
      if(x<0.03 || x>0.97) return "Nov";
      if(x<0.22) return "Dorastaj√∫ci kos√°k";
      if(x<0.28) return "Prv√° ≈°tvr≈•";
      if(x<0.47) return "Dorastaj√∫ci mesiac";
      if(x<0.53) return "√öplnok";
      if(x<0.72) return "C√∫vaj√∫ci mesiac";
      if(x<0.78) return "Posledn√° ≈°tvr≈•";
      return "Ub√∫daj√∫ci kos√°k";
    }

    // Rosn√Ω bod (Magnus)
    function dewPointC(tC, rh){
      try{
        const a=17.62,b=243.12;
        const gamma = Math.log(rh/100) + (a*tC)/(b+tC);
        return +((b*gamma)/(a-gamma)).toFixed(1);
      }catch{ return NaN }
    }

    // Tlak z MSL k povrchu? (nech√°me MSL, je OK)
    // Viditeƒænos≈• ak ch√Ωba, nebudeme h√°da≈•.

    // Throttle
    function throttle(fn,ms){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); };
    }

    // App state
    const state = {
      units: 'c', // c/f
      tzShiftMin: 0,
      lastCoords: null,
      lastPlace: null,
      swReg: null
    };

    /* =========================
       THEME
    ========================== */
    const themeBtn = $('#btnTheme');
    function applyTheme(t){
      if(t==='light') document.body.classList.add('light');
      else document.body.classList.remove('light');
      localStorage.setItem('theme', t);
      themeBtn.textContent = (t==='light') ? 'üåû' : 'üåô';
    }
    themeBtn.addEventListener('click', ()=>{
      const cur = localStorage.getItem('theme') || 'dark';
      applyTheme(cur==='dark' ? 'light' : 'dark');
    });

    /* =========================
       SUGGEST BOX (Open-Meteo geocoding)
    ========================== */
    const suggestEl = $('#suggest');
    const q = $('#q');
    const doSuggest = throttle(async ()=>{
      const name = q.value.trim();
      if(!name){ suggestEl.classList.add('hidden'); suggestEl.innerHTML=''; return; }
      try{
        const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=6&language=sk&format=json`;
        const res = await fetch(url);
        const data = await res.json();
        if(!data.results){ suggestEl.classList.add('hidden'); suggestEl.innerHTML=''; return; }
        suggestEl.classList.remove('hidden');
        suggestEl.innerHTML = `
          <div class="glass p-2 rounded-xl border border-white/15">
            ${data.results.map(r=>`
              <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/10"
                      data-lat="${r.latitude}" data-lon="${r.longitude}"
                      data-name="${r.name}" data-cty="${r.country}">
                <div class="font-semibold">${r.name}</div>
                <div class="opacity-70 text-xs">${r.admin1 ?? ''} ${r.country ?? ''}</div>
              </button>
            `).join('')}
          </div>
        `;
        $$('#suggest button').forEach(b=>{
          b.addEventListener('click', ()=>{
            suggestEl.classList.add('hidden');
            q.value = b.dataset.name;
            fetchAll({
              lat: +b.dataset.lat,
              lon: +b.dataset.lon,
              label: `${b.dataset.name}, ${b.dataset.cty || ''}`.trim()
            });
          });
        });
      }catch{
        suggestEl.classList.add('hidden'); suggestEl.innerHTML='';
      }
    }, 220);
    q.addEventListener('input', doSuggest);
    document.addEventListener('click', (e)=>{
      if(!suggestEl.contains(e.target) && e.target!==q) suggestEl.classList.add('hidden');
    });

    /* =========================
       FETCH & RENDER
    ========================== */
    const btnSearch = $('#btnSearch');
    const btnGeo = $('#btnGeo');

    btnSearch.addEventListener('click', async ()=>{
      const name = q.value.trim();
      if(!name){ q.focus(); return; }
      const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=sk&format=json`;
      try{
        const res = await fetch(url);
        const data = await res.json();
        if(!data.results || !data.results.length) return showBanner('Mesto sa nena≈°lo.');
        const r = data.results[0];
        fetchAll({ lat:r.latitude, lon:r.longitude, label:`${r.name}, ${r.country}` });
      }catch(e){
        showBanner('Nepodarilo sa n√°js≈• lokalitu. Sk√∫s to znova.');
      }
    });

    btnGeo.addEventListener('click', ()=>{
      if(!navigator.geolocation){ return showBanner('Geolok√°cia nie je podporovan√°.'); }
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude:lat, longitude:lon} = pos.coords;
        fetchAll({ lat, lon, label:'Moja poloha' });
      }, err=>{
        showBanner('Nepodarilo sa z√≠ska≈• polohu. Sk√∫s to povoli≈• v prehliadaƒçi.');
      }, {enableHighAccuracy:true, timeout:10000});
    });

    async function fetchAll({lat, lon, label}){
      state.lastCoords = {lat, lon};
      state.lastPlace = label;
      localStorage.setItem('lastCoords', JSON.stringify(state.lastCoords));
      localStorage.setItem('lastPlace', state.lastPlace);

      // Compose Open-Meteo query
      const params = new URLSearchParams({
        latitude: lat, longitude: lon,
        current_weather: 'true',
        hourly: [
          'temperature_2m','relative_humidity_2m','apparent_temperature',
          'precipitation','weathercode','visibility','surface_pressure',
          'wind_speed_10m','wind_gusts_10m','uv_index'
        ].join(','),
        daily: [
          'temperature_2m_max','temperature_2m_min','precipitation_sum',
          'weathercode','sunrise','sunset','uv_index_max','wind_speed_10m_max',
          'wind_gusts_10m_max','moon_phase'
        ].join(','),
        timezone: 'auto'
      });

      const url = `https://api.open-meteo.com/v1/forecast?${params.toString()}`;
      try{
        const res = await fetch(url);
        const data = await res.json();
        renderAll(data, {lat, lon, label});
        tuneBackground(data);
        tuneRadar(lat, lon);
      }catch(e){
        showBanner('Chyba pri naƒç√≠tan√≠ poƒçasia.');
        console.error(e);
      }
    }

    function tuneBackground(data){
      try{
        const code = data?.current_weather?.weathercode ?? 3;
        // prepni gradient podƒæa poƒçasia
        let bg = 'linear-gradient(135deg, #0ea5e9, #2563eb)';
        if([61,63,65,80,81,82,56,57,66,67].includes(code)) bg = 'linear-gradient(135deg, #1f2937, #3b82f6)'; // d√°≈æƒè
        else if([95,96,99].includes(code)) bg='linear-gradient(135deg, #0f172a, #4338ca)'; // b√∫rky
        else if([71,73,75,85,86,77].includes(code)) bg='linear-gradient(135deg, #93c5fd, #1e3a8a)'; // sneh
        else if([0,1,2].includes(code)) bg='linear-gradient(135deg, #06b6d4, #60a5fa)'; // slneƒçno
        document.body.style.background = bg;
      }catch{}
    }

    function renderAll(d, meta){
      const tz = d.timezone ?? 'local';
      const cur = d.current_weather;
      const H = d.hourly;
      const D = d.daily;

      // store timezone shift estimate (approx) from hourly times (assume first index is now-ish)
      state.tzShiftMin = 0; // not needed with timezone=auto, but left for formatTime hook

      // --- Header / location
      $('#locName').textContent = meta.label || 'Vybran√° lokalita';
      $('#locMeta').textContent = `lat ${meta.lat.toFixed(4)}, lon ${meta.lon.toFixed(4)} ‚Ä¢ ${tz}`;

      // --- Current
      const nowIdx = nearestIndexToNow(H.time);
      const rhNow = H.relative_humidity_2m?.[nowIdx] ?? null;
      const feels = H.apparent_temperature?.[nowIdx] ?? null;
      const press = H.surface_pressure?.[nowIdx] ?? null;
      const vis = H.visibility?.[nowIdx] ?? null;
      const uvNow = H.uv_index?.[nowIdx] ?? null;

      $('#currentIcon').textContent = WMO_ICON[cur.weathercode] || '‚ùì';
      setTemp('#curTemp', cur.temperature);
      setTemp('#curFeels', feels);
      $('#curWind').textContent = `${kmh(cur.windspeed)} km/h`;
      $('#curHumidity').textContent = (rhNow!=null? `${rhNow}%` : '‚Äî');
      $('#curPressure').textContent = (press!=null? `${Math.round(press)} hPa` : '‚Äî');
      $('#curUv').textContent = (uvNow!=null? `${uvNow}` : '‚Äî');
      const dp = (rhNow!=null? dewPointC(cur.temperature, rhNow) : null);
      $('#curDew').textContent = (dp!=null && !Number.isNaN(dp)) ? `${dp}¬∞C` : '‚Äî';
      $('#curVis').textContent = (vis!=null? `${Math.round(vis/1000)} km` : '‚Äî');
      $('#updated').textContent = (cur.time ? new Date(cur.time).toLocaleString() : '‚Äî');

      // Sun/Moon
      $('#sunrise').textContent = D.sunrise?.[0] ? formatTime(D.sunrise[0]) : '‚Äî';
      $('#sunset').textContent  = D.sunset?.[0]  ? formatTime(D.sunset[0])  : '‚Äî';
      $('#moon').textContent    = D.moon_phase?.[0]!=null ? moonPhaseText(D.moon_phase[0]) : '‚Äî';

      // --- Hourly (24h)
      const hoursHTML = H.time.slice(nowIdx, nowIdx+24).map((t, i)=>{
        const idx = nowIdx+i;
        const code = H.weathercode?.[idx];
        const icon = WMO_ICON[code] || '‚ùì';
        const temp = H.temperature_2m?.[idx];
        const pr = H.precipitation?.[idx];
        const gust = H.wind_gusts_10m?.[idx];
        return `
          <div class="glass p-3 w-24 shrink-0 text-center">
            <div class="text-xs opacity-75">${formatTime(t)}</div>
            <div class="text-2xl my-1 select-none">${icon}</div>
            <div class="text-lg font-semibold">${fmtTemp(temp)}</div>
            <div class="text-xs opacity-75">üíß ${mm(pr||0)} mm</div>
            <div class="text-xs opacity-75">üí® ${kmh(gust||0)} km/h</div>
          </div>
        `;
      }).join('');
      $('#hourlyWrap').innerHTML = hoursHTML;

      // --- Daily (7)
      const dailyHTML = D.time.slice(0,7).map((t,i)=>{
        const icon = WMO_ICON[D.weathercode?.[i]] || '‚ùì';
        const tmin = D.temperature_2m_min?.[i];
        const tmax = D.temperature_2m_max?.[i];
        const pcp  = D.precipitation_sum?.[i];
        const uv   = D.uv_index_max?.[i];
        const wmax = D.wind_speed_10m_max?.[i];
        const gmax = D.wind_gusts_10m_max?.[i];
        return `
          <div class="glass p-4 text-center card-hover">
            <div class="font-semibold mb-1">${formatDate(t)}</div>
            <div class="text-3xl select-none">${icon}</div>
            <div class="mt-1"><span class="font-semibold">${fmtTemp(tmax)}</span> / ${fmtTemp(tmin)}</div>
            <div class="mt-1 text-xs opacity-80 flex flex-col gap-0.5">
              <span>üíß ${mm(pcp||0)} mm</span>
              <span>üîÜ UV ${uv ?? '‚Äî'}</span>
              <span>üí® ${kmh(wmax||0)} km/h (poryv ${kmh(gmax||0)})</span>
            </div>
          </div>
        `;
      }).join('');
      $('#dailyGrid').innerHTML = dailyHTML;

      // --- Charts
      drawCharts(D);
    }

    function nearestIndexToNow(times){
      try{
        const now = Date.now();
        let best = 0, bestd = Infinity;
        for(let i=0;i<times.length;i++){
          const d = Math.abs(new Date(times[i]).getTime()-now);
          if(d<bestd){bestd=d; best=i;}
        }
        return best;
      }catch{ return 0 }
    }

    function setTemp(sel, v){
      if(v==null || Number.isNaN(+v)){ $(sel).textContent='‚Äî'; return; }
      $(sel).textContent = fmtTemp(v);
    }
    function fmtTemp(v){
      if(v==null || Number.isNaN(+v)) return '‚Äî';
      if(state.units==='f') return `${c2f(+v)}¬∞F`;
      return `${toC(+v)}¬∞C`;
    }

    /* =========================
       CHARTS
    ========================== */
    let chartTemp, chartPcpWind;
    function drawCharts(D){
      const labels = D.time.map(t=>new Date(t).toLocaleDateString([], {day:'2-digit', month:'2-digit'}));
      const maxT = D.temperature_2m_max.map(v=> state.units==='f' ? c2f(v) : toC(v));
      const minT = D.temperature_2m_min.map(v=> state.units==='f' ? c2f(v) : toC(v));
      const pcp  = D.precipitation_sum.map(v=> mm(v));
      const wind = D.wind_speed_10m_max.map(v=> kmh(v));

      const ctx1 = $('#chartTemp');
      chartTemp?.destroy();
      chartTemp = new Chart(ctx1, {
        type:'line',
        data:{ labels, datasets:[
          { label:'Max', data:maxT, borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,.2)', tension:.35 },
          { label:'Min', data:minT, borderColor:'#3b82f6', backgroundColor:'rgba(59,130,246,.2)', tension:.35 }
        ]},
        options:{
          responsive:true,
          plugins:{ legend:{ labels:{ color: getComputedStyle(document.body).color } } },
          scales:{
            x:{ ticks:{ color:getComputedStyle(document.body).color }},
            y:{ ticks:{ color:getComputedStyle(document.body).color }}
          }
        }
      });

      const ctx2 = $('#chartPcpWind');
      chartPcpWind?.destroy();
      chartPcpWind = new Chart(ctx2, {
        type:'bar',
        data:{ labels, datasets:[
          { type:'bar', label:'Zr√°≈æky (mm)', data:pcp, backgroundColor:'rgba(59,130,246,.35)' },
          { type:'line', label:'Vietor (km/h)', data:wind, borderColor:'#22c55e', tension:.35, yAxisID:'y1' }
        ]},
        options:{
          responsive:true,
          plugins:{ legend:{ labels:{ color:getComputedStyle(document.body).color } } },
          scales:{
            x:{ ticks:{ color:getComputedStyle(document.body).color }},
            y:{ ticks:{ color:getComputedStyle(document.body).color }, position:'left' },
            y1:{ ticks:{ color:getComputedStyle(document.body).color }, position:'right', grid:{ drawOnChartArea:false } }
          }
        }
      });
    }

    /* =========================
       RADAR
    ========================== */
    function tuneRadar(lat, lon){
      const url = `https://embed.windy.com/embed2.html?lat=${lat.toFixed(3)}&lon=${lon.toFixed(3)}&zoom=7&level=surface&overlay=rain&menu=&message=true&marker=&calendar=&pressure=&type=map&location=coordinates&detail=&detailLat=${lat.toFixed(3)}&detailLon=${lon.toFixed(3)}&metricWind=km/h&metricTemp=%C2%B0C`;
      $('#radarFrame').src = url;
    }

    /* =========================
       BANNER
    ========================== */
    function showBanner(msg){
      $('#bannerText').textContent = msg;
      $('#banner').classList.remove('hidden');
    }
    $('#bannerClose').addEventListener('click', ()=>$('#banner').classList.add('hidden'));

    /* =========================
       UNITS TOGGLE
    ========================== */
    $('#btnC').addEventListener('click', ()=>{ state.units='c'; localStorage.setItem('units','c'); reRenderUnits(); });
    $('#btnF').addEventListener('click', ()=>{ state.units='f'; localStorage.setItem('units','f'); reRenderUnits(); });

    function reRenderUnits(){
      // re-run current rendering using last data by refetching (simple, robust)
      const last = localStorage.getItem('lastCoords');
      if(!last) return;
      const {lat, lon} = JSON.parse(last);
      const label = localStorage.getItem('lastPlace') || 'Posledn√° poloha';
      fetchAll({lat, lon, label});
      $('#hourUnits').textContent = state.units==='f' ? '¬∞F' : '¬∞C';
    }

    /* =========================
       ABOUT MODAL
    ========================== */
    $('#aboutBtn').addEventListener('click', (e)=>{ e.preventDefault(); about.showModal(); });

    /* =========================
       PWA (single-file SW)
    ========================== */
    let deferredPrompt=null;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault();
      deferredPrompt = e;
      $('#btnInstall').classList.remove('hidden');
    });
    $('#btnInstall').addEventListener('click', async ()=>{
      if(!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt=null;
      $('#btnInstall').classList.add('hidden');
    });

    async function registerSW(){
      const swCode = `
        const CACHE = 'meteo-on-top-v1';
        self.addEventListener('install', e=>{
          e.waitUntil(caches.open(CACHE).then(c=>c.addAll([
            './'
          ])));
          self.skipWaiting();
        });
        self.addEventListener('activate', e=>{ e.waitUntil(self.clients.claim()); });
        self.addEventListener('fetch', e=>{
          const {request} = e;
          const url = new URL(request.url);
          if(url.origin===location.origin){
            e.respondWith(
              caches.match(request).then(r=> r || fetch(request).then(resp=>{
                const copy = resp.clone();
                caches.open(CACHE).then(c=>c.put(request, copy));
                return resp;
              }).catch(()=> caches.match('./')))
            );
          }else{
            e.respondWith(fetch(request).catch(()=> new Response('Offline',{status:503})));
          }
        });
      `;
      const blob = new Blob([swCode], {type:'text/javascript'});
      const swUrl = URL.createObjectURL(blob);
      try{
        state.swReg = await navigator.serviceWorker.register(swUrl);
      }catch(e){ console.warn('SW register fail', e); }
    }

    /* =========================
       INIT
    ========================== */
    (function init(){
      // Theme
      const savedTheme = localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: light)').matches ? 'light':'dark');
      applyTheme(savedTheme);

      // Units
      state.units = localStorage.getItem('units') || 'c';
      $('#hourUnits').textContent = state.units==='f' ? '¬∞F' : '¬∞C';

      // Build stamp
      const now = new Date();
      $('#buildStamp').textContent = `Build ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;

      // Last location
      const last = localStorage.getItem('lastCoords');
      const label = localStorage.getItem('lastPlace');
      if(last){
        const {lat, lon} = JSON.parse(last);
        fetchAll({lat, lon, label: label || 'Posledn√° poloha'});
      }

      // SW
      if('serviceWorker' in navigator){ registerSW(); }
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>3D Globe™ – Predpoveď Počasia (Performance-Lite)</title>

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<link href="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
:root{
  --bg:#001a34;--panel:#002241;--btn:#1c3556;--blue:#3b9af8;--text:#eaf5ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);overflow:hidden}
#map{position:absolute;inset:0}
.btn{background:var(--btn);border-radius:9999px}
.btn:hover{background:var(--blue)}
.panel{background:rgba(0,0,0,.5);backdrop-filter:saturate(1.2) blur(6px);border:1px solid rgba(255,255,255,.08)}
.labelchip{background:rgba(0,0,0,.55);padding:.2rem .45rem;border-radius:.4rem;font-weight:600}
#layerControls{transition:transform .2s ease}
.header{min-width:160px}
.timeline{height:74px}
.tick{position:absolute;top:36px;width:1px;height:10px;background:rgba(255,255,255,.35)}
.tick.big{height:16px;background:#fff}
</style>
</head>
<body>
<div id="map"></div>

<!-- ovládanie -->
<div class="absolute top-3 right-3 flex gap-2 pointer-events-auto">
  <button id="btnFull" class="btn w-11 h-11 grid place-items-center text-white shadow"><i class="fa-solid fa-expand"></i></button>
  <button id="btnLayers" class="btn w-11 h-11 grid place-items-center text-white shadow"><i class="fa-solid fa-layer-group"></i></button>
</div>

<!-- bočný panel -->
<div id="layerControls" class="fixed top-0 right-0 h-full w-80 max-w-[90vw] panel p-5 z-40 translate-x-full overflow-y-auto">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-semibold">Vrstvy</h2>
    <button id="btnClosePanel" class="text-white/70 hover:text-white text-2xl leading-none">&times;</button>
  </div>

  <div class="space-y-2" id="layerList"></div>

  <div class="mt-6">
    <h3 class="font-semibold mb-2">Priehľadnosť</h3>
    <div class="flex items-center gap-3">
      <input id="opacity" type="range" min="20" max="100" value="85" class="w-full" />
      <span id="opv" class="w-10 text-center">85%</span>
    </div>
  </div>

  <div class="mt-6">
    <label class="flex items-center gap-2">
      <input id="chkLabels" type="checkbox" class="accent-blue-400" />
      <span>Dátové štítky (iba zoom ≥ 6)</span>
    </label>
    <label class="flex items-center gap-2 mt-2">
      <input id="chkIsobars" type="checkbox" class="accent-blue-400" />
      <span>Izobary (výpočet vo workeri)</span>
    </label>
    <label class="flex items-center gap-2 mt-2">
      <input id="chkAlerts" type="checkbox" class="accent-blue-400" />
      <span>Výstrahy (SK)</span>
    </label>
  </div>

  <div id="legend" class="mt-6"></div>
</div>

<!-- časová os -->
<div class="panel absolute left-3 right-3 bottom-3 p-3 rounded-2xl flex flex-col sm:flex-row items-center gap-3 pointer-events-auto">
  <div class="flex items-center gap-2">
    <button id="btnPrev" class="btn w-10 h-10 grid place-items-center"><i class="fa-solid fa-backward"></i></button>
    <button id="btnPlay" class="btn w-12 h-12 grid place-items-center text-lg"><i class="fa-solid fa-play"></i></button>
    <button id="btnNext" class="btn w-10 h-10 grid place-items-center"><i class="fa-solid fa-forward"></i></button>
  </div>
  <div id="hdr" class="header font-semibold select-none"></div>
  <div id="tl" class="timeline relative flex-1 select-none overflow-hidden rounded-lg border border-white/10">
    <div class="absolute inset-x-0 top-1/2 -translate-y-1/2 h-[2px] bg-white/25"></div>
    <div id="ticks"></div>
    <div class="absolute left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2 w-[3px] h-6 bg-[var(--blue)] rounded-full shadow"></div>
  </div>
</div>

<!-- pop-up kontajner -->
<div id="pop" class="pointer-events-none"></div>

<script src="https://kit.fontawesome.com/a4130fa7fd.js" crossorigin="anonymous"></script>
<script>
/* ==== KONštanty a stav ==== */
mapboxgl.accessToken='pk.eyJ1IjoibmNpa2FsYSIsImEiOiJja3NhbGNqaTkxMWh1MnVsdWNjaWppOTkxIn0.VRSFufdvlbGJ6PwnucFc1Q';
const OWM='b1b15e88fa797225412429c1c50c122a1'; // demo kľúč OWM (tile)
const MAX_DAYS=7;                 // menej dopredu -> rýchlejšie
const HOUR_STEP_MS=1_000;         // rýchlosť autoplay
const LABEL_ZOOM_MIN=6;
const LAYER_DEBOUNCE=800;         // ms
const workerURL=createIsobarWorker(); // blob URL workera

// jediná "aktívna" dlaždicová vrstva pre výkon
const LAYERS=[
  {name:'Teplota', code:'temp', unit:'°C', url:`https://maps.openweathermap.org/maps/2.0/weather/TA2/{z}/{x}/{y}?date={date}&appid=${OWM}`, point:'temperature_2m'},
  {name:'Tlak (dlaždice)', code:'pressure', unit:'hPa', url:`https://maps.openweathermap.org/maps/2.0/weather/APM/{z}/{x}/{y}?date={date}&appid=${OWM}`, point:'pressure_msl'},
  {name:'Vietor', code:'wind', unit:'m/s', url:`https://maps.openweathermap.org/maps/2.0/weather/WND/{z}/{x}/{y}?date={date}&appid=${OWM}`, point:'wind_speed_10m', winddir:'wind_direction_10m'},
  {name:'Oblačnosť', code:'clouds', unit:'%', url:`https://maps.openweathermap.org/maps/2.0/weather/CL/{z}/{x}/{y}?date={date}&appid=${OWM}`, point:'cloud_cover'},
  {name:'Vlhkosť', code:'humidity', unit:'%', url:`https://maps.openweathermap.org/maps/2.0/weather/HRD0/{z}/{x}/{y}?date={date}&appid=${OWM}`, point:'relative_humidity_2m'}
];

let currentIdx=0;                 // hodiny od "start"
let startDate=new Date(); startDate.setMinutes(0,0,0);
let currentDate=new Date(startDate);
let playing=false, playTimer=null;
let activeTile=LAYERS[0];         // default
let map, abortCtl=null;
let cache=new Map();              // key->JSON (point data)

/* ==== Mapbox init ==== */
map=new mapboxgl.Map({
  container:'map',
  style:'mapbox://styles/ncikala/cm1t58iop010401qv5xwi3yb3',
  center:[19.1451,48.6690], zoom:5, pitch:0, projection:'globe', antialias:false
});
map.on('load',()=>{
  map.setFog({});
  initUI();
  applyActiveLayer(true);
});

/* ==== UI ==== */
function $(id){return document.getElementById(id)}
$('btnFull').onclick=()=>document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen();
$('btnLayers').onclick=()=>$('layerControls').style.transform='translateX(0)';
$('btnClosePanel').onclick=()=>$('layerControls').style.transform='translateX(100%)';
$('btnPrev').onclick=()=>step(-1);
$('btnNext').onclick=()=>step(1);
$('btnPlay').onclick=togglePlay;
$('opacity').oninput=(e)=>{const v=+e.target.value;$('opv').textContent=v+'%';setOpacity(v/100)}
$('chkLabels').onchange=debounce(updateLabels,LAYER_DEBOUNCE);
$('chkIsobars').onchange=()=>{toggleIsobars($('chkIsobars').checked)};
$('chkAlerts').onchange=()=>{toggleAlerts($('chkAlerts').checked)};

// zoznam vrstiev (radio – iba jedna dlaždicová naraz)
function initUI(){
  const list=$('layerList');
  LAYERS.forEach((L,i)=>{
    const id='l_'+L.code;
    const row=document.createElement('label');
    row.className='flex items-center gap-3 p-2 rounded hover:bg-white/10 cursor-pointer';
    row.innerHTML=`<input type="radio" name="layer" id="${id}" ${i===0?'checked':''} class="accent-blue-400">
                   <span>${L.name}</span>`;
    row.querySelector('input').onchange=()=>{activeTile=L;applyActiveLayer(true)};
    list.appendChild(row);
  });

  // časová os: len dôležité značky (každé 3h + polnoci)
  drawTicks();
  updateHeader();
}

/* ==== Časová os ==== */
function drawTicks(){
  const ticks=$('ticks'); ticks.innerHTML='';
  const total=MAX_DAYS*24;
  for(let h=0;h<=total;h+=3){
    const x=(h/total)*100;
    const t=document.createElement('div');
    const big=(h%24===0);
    t.className='tick'+(big?' big':'');
    t.style.left=x+'%';
    ticks.appendChild(t);
  }
}
function updateHeader(){
  currentDate=new Date(startDate.getTime());currentDate.setHours(startDate.getHours()+currentIdx);
  const d=currentDate;
  const days=['NE','PO','UT','ST','ŠT','PI','SO'];
  $('hdr').innerHTML=`${days[d.getDay()]} ${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}. &nbsp; ${String(d.getHours()).padStart(2,'0')}:00`;
}
function step(dir){
  const total=MAX_DAYS*24-1;
  currentIdx=Math.max(0,Math.min(total,currentIdx+dir));
  updateHeader();
  applyActiveLayer(false); // prepnúť čas (tile URL)
  // vedľajšie vrstvy
  if($('chkIsobars').checked) debouncedIsobars();
  if($('chkLabels').checked) debouncedLabels();
}
function togglePlay(){
  playing=!playing;
  $('btnPlay').innerHTML=playing?'<i class="fa-solid fa-pause"></i>':'<i class="fa-solid fa-play"></i>';
  if(!playing){clearInterval(playTimer);return}
  playTimer=setInterval(()=>{
    const max=MAX_DAYS*24-1;
    currentIdx=(currentIdx<max)?currentIdx+1:0;
    updateHeader(); applyActiveLayer(false);
    if($('chkIsobars').checked) debouncedIsobars();
    if($('chkLabels').checked) debouncedLabels();
  },HOUR_STEP_MS);
}

/* ==== Debounce helpers ==== */
function debounce(fn,ms){let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn.apply(this,a),ms)}}
const debouncedLabels=debounce(updateLabels,LAYER_DEBOUNCE);
const debouncedIsobars=debounce(updateIsobars,LAYER_DEBOUNCE);
const onMapIdle=debounce(()=>{
  if($('chkLabels').checked) updateLabels();
  if($('chkIsobars').checked) updateIsobars();
},LAYER_DEBOUNCE);

map.on('moveend',onMapIdle);
map.on('zoomend',onMapIdle);

/* ==== Tiles – jedna aktívna vrstva ==== */
function applyActiveLayer(first=false){
  // zruš staré zdroje
  map.getStyle().layers?.forEach(l=>{
    if(/^tile_/.test(l.id)) map.removeLayer(l.id);
  });
  map.getStyle().sources && Object.keys(map.getStyle().sources).forEach(s=>{
    if(/^src_/.test(s)) map.removeSource(s);
  });

  const unix=Math.floor((new Date(startDate.getTime()+currentIdx*3600000)).getTime()/1000);
  const url=activeTile.url.replace('{date}',unix);

  map.addSource('src_'+activeTile.code,{type:'raster',tiles:[url],tileSize:256,attribution:'OpenWeatherMap'});
  map.addLayer({id:'tile_'+activeTile.code,type:'raster',source:'src_'+activeTile.code,paint:{
    'raster-opacity':(+$('opacity').value)/100,
    'raster-saturation':0.2,'raster-contrast':0.15,'raster-fade-duration':200
  }}, first ? undefined : findFirstSymbolId());

  // legenda
  const legendURL={
    temp:'t2m.png',pressure:'hPa.png',wind:'wind.png',clouds:'cloud.png',humidity:'humidity.png'
  }[activeTile.code];
  $('legend').innerHTML=legendURL?`<h3 class="font-semibold mb-2">Legenda</h3>
    <img class="rounded-lg w-full" src="https://www.meteopocasie.sk/legendy/${legendURL}" alt="Legenda" />`:'';

  // refresh vedľajších vecí
  if(!$('chkLabels').checked) clearLabels();
}
function setOpacity(op){const id='tile_'+activeTile.code;if(map.getLayer(id)) map.setPaintProperty(id,'raster-opacity',op)}
function findFirstSymbolId(){const ls=map.getStyle().layers;return ls.find(l=>l.type==='symbol')?.id}

/* ==== Dátové štítky (on-demand, hrubá mriežka, iba pri zoom≥6) ==== */
let labelMarkers=[];
function clearLabels(){labelMarkers.forEach(m=>m.remove());labelMarkers.length=0}
async function updateLabels(){
  clearLabels();
  if(map.getZoom()<LABEL_ZOOM_MIN || !$('chkLabels').checked) return;
  const b=map.getBounds(); const z=map.getZoom();
  const grid = z<7?3 : z<8?4 : 5;  // veľmi riedke
  const latStep=(b.getNorth()-b.getSouth())/grid;
  const lonStep=(b.getEast()-b.getWest())/grid;

  if(abortCtl) abortCtl.abort();
  abortCtl=new AbortController();

  const when=new Date(startDate.getTime()+currentIdx*3600000); when.setMinutes(0,0,0);
  const day=when.toISOString().slice(0,10);

  for(let i=1;i<=grid;i++){
    for(let j=1;j<=grid;j++){
      const lat=b.getSouth()+i*latStep- latStep/2;
      const lon=((b.getWest()+j*lonStep- lonStep/2)+540)%360-180;

      const key=[lat.toFixed(2),lon.toFixed(2),activeTile.code,day,when.getHours()].join('|');
      let data=cache.get(key);
      if(!data){
        const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat.toFixed(2)}&longitude=${lon.toFixed(2)}&hourly=${[activeTile.point,activeTile.winddir].filter(Boolean).join(',')}&start_date=${day}&end_date=${day}&timezone=auto`;
        try{
          const r=await fetch(url,{signal:abortCtl.signal}); if(!r.ok) continue;
          const j=await r.json(); data=j; cache.set(key,data);
        }catch{continue}
      }
      // nájdi hodinu
      const idx=data.hourly.time.findIndex(t=>new Date(t).getTime()===when.getTime());
      if(idx<0) continue;
      let val=data.hourly[activeTile.point]?.[idx];
      if(val==null) continue;

      let html=`<span class="labelchip">${Math.round(val)}${activeTile.unit}</span>`;
      if(activeTile.code==='wind' && data.hourly[activeTile.winddir]){
        const dir=data.hourly[activeTile.winddir][idx]||0;
        html=`<span class="labelchip" style="display:flex;gap:.35rem;align-items:center"><i class="fa-solid fa-location-arrow" style="transform:rotate(${dir}deg)"></i>${Math.round(val)}${activeTile.unit}</span>`;
      }
      const el=document.createElement('div'); el.innerHTML=html;
      labelMarkers.push(new mapboxgl.Marker({element:el.firstChild,anchor:'center'}).setLngLat([lon,lat]).addTo(map));
    }
  }
}

/* ==== Izobary (Web Worker) ==== */
let isobarLayerAdded=false, isobarWorker=null;
function toggleIsobars(on){
  if(on){ if(!isobarWorker){isobarWorker=new Worker(workerURL)}; updateIsobars(); }
  else{
    ['iso','iso-labels'].forEach(id=>{ if(map.getLayer(id)) map.removeLayer(id); if(map.getSource(id)) map.removeSource(id); });
    isobarLayerAdded=false;
  }
}
async function updateIsobars(){
  if(!$('chkIsobars').checked) return;
  const b=map.getBounds(); const z=map.getZoom();
  const when=new Date(startDate.getTime()+currentIdx*3600000); when.setMinutes(0,0,0);
  const day=when.toISOString().slice(0,10);

  // riedka mriežka podľa zoomu
  const grid = z<3?8 : z<5?10 : 12;
  const latStep=(b.getNorth()-b.getSouth())/grid;
  const lonStep=(b.getEast()-b.getWest())/grid;

  // nazbieraj body tlaku
  const tasks=[];
  for(let la=b.getSouth();la<=b.getNorth();la+=latStep){
    for(let lo=b.getWest();lo<=b.getEast();lo+=lonStep){
      const lat=+la.toFixed(2), lon=+lo.toFixed(2);
      const key=[lat,lon,'pressure',day,when.getHours()].join('|');
      if(cache.get(key)){ tasks.push(Promise.resolve({lat,lon,press:pick(cache.get(key),when)})); continue; }
      const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=pressure_msl&start_date=${day}&end_date=${day}&timezone=auto`;
      tasks.push(fetch(url).then(r=>r.json()).then(j=>{cache.set(key,j);return {lat,lon,press:pick(j,when)}}).catch(()=>null));
    }
  }
  const pts=(await Promise.all(tasks)).filter(Boolean);

  // pošli do workera
  isobarWorker.onmessage=(ev)=>{
    const {lines,labels}=ev.data;
    if(!isobarLayerAdded){
      map.addSource('iso',{type:'geojson',data:lines});
      map.addLayer({id:'iso',type:'line',source:'iso',paint:{'line-color':'#fff','line-width':1.2,'line-opacity':(+$('opacity').value)/100}},findFirstSymbolId());
      map.addSource('iso-labels',{type:'geojson',data:labels});
      map.addLayer({id:'iso-labels',type:'symbol',source:'iso-labels',layout:{'text-field':['format',['get','label'],{},'\n',{},['to-string',['round',['get','pressure']]],{}],'text-size':12,'text-allow-overlap':true,'text-ignore-placement':true},paint:{'text-color':'#fff','text-halo-color':'#000','text-halo-width':1.5,'text-opacity':(+$('opacity').value)/100}});
      isobarLayerAdded=true;
    }else{
      map.getSource('iso').setData(lines);
      map.getSource('iso-labels').setData(labels);
    }
  };
  isobarWorker.postMessage({points:pts,breaksStart:960,breaksStep:4,breaksCount:30,grid});
}
function pick(j,when){
  const i=j?.hourly?.time?.findIndex(t=>new Date(t).getTime()===when.getTime());
  return i>=0? j.hourly.pressure_msl[i] : null;
}

/* ==== Výstrahy (len SK, jednoduché sfarbenie) ==== */
let skLoaded=false;
async function toggleAlerts(on){
  if(!on){
    if(map.getLayer('sk-fill')) map.removeLayer('sk-fill');
    if(map.getLayer('sk-line')) map.removeLayer('sk-line');
    if(map.getSource('sk')) map.removeSource('sk');
    return;
  }
  const res=await fetch('sk-map.json'); if(!res.ok) return;
  const gj=await res.json();
  if(!map.getSource('sk')) map.addSource('sk',{type:'geojson',data:gj});
  if(!map.getLayer('sk-fill')) map.addLayer({id:'sk-fill',type:'fill',source:'sk',paint:{'fill-color':'rgba(250,204,21,.35)','fill-outline-color':'#fff'}},findFirstSymbolId());
  if(!map.getLayer('sk-line')) map.addLayer({id:'sk-line',type:'line',source:'sk',paint:{'line-color':'#fff','line-width':.6}});
}

/* ==== Pomocné ==== */
function createIsobarWorker(){
  const code=`
  self.onmessage=async (ev)=>{
    const {points,breaksStart,breaksStep,breaksCount,grid}=ev.data;
    // jednoduchá aproximácia izolínií bez Turf: marching squares na hrubom rastri
    // pre rýchlosť použijeme knižnicu od nuly (malé) – ale tu spravíme basic:
    // skonvertuj do gridu
    if(points.length<9){ self.postMessage({lines:{type:'FeatureCollection',features:[]},labels:{type:'FeatureCollection',features:[]}}); return; }
    // vytvor hrubý grid mapu (lat,lon,pressure)
    const lats=[...new Set(points.map(p=>p.lat))].sort((a,b)=>a-b);
    const lons=[...new Set(points.map(p=>p.lon))].sort((a,b)=>a-b);
    const P=Array.from({length:lats.length},()=>Array(lons.length).fill(null));
    points.forEach(p=>{
      const i=lats.indexOf(p.lat), j=lons.indexOf(p.lon);
      if(i>=0 && j>=0) P[i][j]=p.press;
    });
    const breaks=Array.from({length:breaksCount},(_,i)=>breaksStart+i*breaksStep);
    const feats=[];
    // veľmi jednoduché „izočiary“ – spojnice medzi bunkami kde cez prah prechádza lineárne (nie perfektné, ale ľahké)
    function interp(a,b,pa,pb,t){return [a[0]+(b[0]-a[0])*t, a[1]+(b[1]-a[1])*t]}
    for(const lvl of breaks){
      for(let i=0;i<lats.length-1;i++){
        for(let j=0;j<lons.length-1;j++){
          const z00=P[i][j], z10=P[i+1][j], z01=P[i][j+1], z11=P[i+1][j+1];
          if([z00,z10,z01,z11].some(v=>v==null)) continue;
          const cell=[[lons[j],lats[i]],[lons[j+1],lats[i]],[lons[j+1],lats[i+1]],[lons[j],lats[i+1]]];
          // hrany: vľavo(z00-z10) dole(z00-z01) vpravo(z01-z11) hore(z10-z11)
          const pts=[];
          const edges=[
            {a:cell[0],b:cell[3],za:z00,zb:z10},
            {a:cell[0],b:cell[1],za:z00,zb:z01},
            {a:cell[1],b:cell[2],za:z01,zb:z11},
            {a:cell[3],b:cell[2],za:z10,zb:z11},
          ];
          edges.forEach(e=>{
            const {a,b,za,zb}=e;
            if((lvl>=za && lvl<=zb) || (lvl>=zb && lvl<=za)){
              const t=(lvl-za)/(zb-za);
              pts.push(interp(a,b,za,zb,t));
            }
          });
          if(pts.length===2){
            feats.push({type:'Feature',geometry:{type:'LineString',coordinates:pts},properties:{level:lvl}});
          }
        }
      }
    }
    // high/low štítky – hľadáme lokálne extrémy v mriežke
    const labels=[];
    for(let i=1;i<lats.length-1;i++){
      for(let j=1;j<lons.length-1;j++){
        const c=P[i][j]; if(c==null) continue;
        let hi=true, lo=true;
        for(let di=-1;di<=1;di++){
          for(let dj=-1;dj<=1;dj++){
            if(!di && !dj) continue;
            const n=P[i+di][j+dj]; if(n==null) continue;
            if(n>=c) hi=false; if(n<=c) lo=false;
          }
        }
        if(hi) labels.push({type:'Feature',geometry:{type:'Point',coordinates:[lons[j],lats[i]]},properties:{label:'V',pressure:c}});
        if(lo) labels.push({type:'Feature',geometry:{type:'Point',coordinates:[lons[j],lats[i]]},properties:{label:'N',pressure:c}});
      }
    }
    self.postMessage({
      lines:{type:'FeatureCollection',features:feats},
      labels:{type:'FeatureCollection',features:labels}
    });
  };`;
  const blob=new Blob([code],{type:'application/javascript'});
  return URL.createObjectURL(blob);
}
</script>
</body>
</html>

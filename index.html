<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes, maximum-scale=6, viewport-fit=cover" />
    <title>Počasie</title>
    <link rel="icon" type="image/png" href="https://placehold.co/32x32/143344/d8f7ff?text=W" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <!-- Tailwind CSS pre jednoduchý a moderný štýl -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/sk.min.js"></script>
    <style>
        :root {
            --bg0: #0b0f14;
            --bg1: #0e1620;
            --panel: #152433;
            --stroke: #233448;
            --txt: #eaf3ff;
            --muted: #a8bed5;
            --accent: #3ad0e6;
            --r: 14px;
            --shadow: 0 10px 28px rgba(0,0,0,.28);
            --gap: 10px;
        }

        /* Globálne štýly a resety */
        * {
            box-sizing: border-box;
        }

        html,
        body {
            min-height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            color: var(--txt);
            font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: linear-gradient(180deg, var(--bg1), var(--bg0));
            overflow-x: hidden;
            overflow-y: auto;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            min-height: 100dvh;
        }

        .wrap {
            width: 100%;
            max-width: 1120px;
            margin-inline: auto;
            padding: 22px 14px 40px;
        }

        header h1 {
            margin: 0 0 14px;
            text-align: center;
            font-size: 28px;
            letter-spacing: .3px;
        }
        
        /* Karty s predpoveďou, hlavný prvok štýlu */
        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, .06), rgba(255, 255, 255, .03));
            border: 1px solid var(--stroke);
            border-radius: var(--r);
            box-shadow: var(--shadow);
            padding: 16px 14px;
            transition: all 0.3s ease-in-out;
            transform: scale(1);
        }
        
        /* Efekt hover pre interaktívne karty */
        .card:hover {
          box-shadow: 0 15px 35px rgba(0,0,0,.35);
          transform: scale(1.01);
        }
        
        .card h3 {
            margin: 0 0 14px;
            text-align: center;
            font-size: 18px;
        }

        /* Sekcia s 4 kartami na mobilnom zobrazení */
        .colset {
            display: grid;
            grid-auto-flow: column;
            gap: 8px;
            overflow-x: auto;
            scrollbar-gutter: stable both-edges;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-x: contain;
            cursor: grab;
            padding: 8px 0 12px;
            scroll-snap-type: x mandatory;
            padding: 0 10px;
        }
        
        .colset.dragging {
            cursor: grabbing;
        }

        /* Individuálna karta v sekcii */
        .col {
            flex: 0 0 calc(50% - 4px); /* Dve karty na riadok pre väčšie mobily, 4 pre menšie */
            min-width: 150px;
            background: var(--panel);
            border: 1px solid var(--stroke);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 182px;
            position: relative;
            gap: 8px;
            scroll-snap-align: start;
        }

        /* Pre obrazovky menšie ako 420px sa zmestia 4 karty vedľa seba */
        @media (max-width: 420px) {
            .col {
                flex: 0 0 calc(25% - 6px); /* 4 karty na riadok pre úzke mobily */
                min-width: 85px; /* Minimalna šírka karty aby sa zmestil text */
                font-size: 12px;
                padding: 8px;
            }
            .c-top, .m-txt {
              font-size: 10px !important;
            }
        }
        
        /* Pre tablety a väčšie obrazovky */
        @media (min-width: 780px) {
            .col {
                min-width: 180px;
            }
        }

        .temps .c-max {
            font-size: 28px;
            font-weight: 700;
            color: #ff6c6c;
            line-height: 1;
        }
        
        .temps .c-min {
            font-size: 18px;
            color: #ffbb7c;
            margin-top: 4px;
            line-height: 1;
        }
        
        .c-ico {
            font-size: 26px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .metrics {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
        }

        .metric {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .metric .m-ico {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            line-height: 1;
        }

        .metric .m-txt {
            font-size: 13.5px;
            font-weight: 500;
            color: #e9f3ff;
            letter-spacing: .05px;
            line-height: 1.25;
            text-align: center;
            word-break: keep-all;
        }

        .colset::-webkit-scrollbar {
            height: 10px;
        }

        .colset::-webkit-scrollbar-track {
            background: #0f1c2a;
            border-radius: 8px;
        }

        .colset::-webkit-scrollbar-thumb {
            background: #33516f;
            border-radius: 8px;
        }

        .colset::-webkit-scrollbar-thumb:hover {
            background: #3f6b94;
        }

        .colset {
            scrollbar-width: thin;
            scrollbar-color: #33516f #0f1c2a;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <header>
            <h1 class="text-3xl font-bold">Počasie</h1>
        </header>

        <div class="toolbar">
            <div class="searchCol relative">
                <input id="q" class="search w-full bg-[#152535] border border-[#233448] text-white rounded-xl p-3 outline-none focus:border-[#3ad0e6] transition-colors" type="text" placeholder="Hľadaj mesto (napr. Bratislava, Košice)" />
                <div id="suggestions" class="absolute top-full left-0 right-0 z-40 hidden grid gap-1 p-2 bg-[#0f1c2a] border border-[#233448] rounded-xl max-h-[55vh] overflow-y-auto"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mt-5">
            <section class="card">
                <div class="grid grid-cols-2 gap-4 items-start">
                    <div>
                        <h3 id="place" class="text-xl font-semibold overflow-hidden whitespace-nowrap text-ellipsis">—</h3>
                        <div class="text-5xl font-bold mt-2" id="temp">—°</div>
                        <div class="flex flex-wrap gap-2 mt-4">
                            <span class="chip bg-[#143344] border border-[#233448] text-[#d8f7ff] rounded-full px-4 py-2 text-sm" id="uv">UV index —</span>
                            <span class="chip bg-[#143344] border border-[#233448] text-[#d8f7ff] rounded-full px-4 py-2 text-sm" id="aqi">Kvalita ovzdušia —</span>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-4 text-[#a8bed5] text-sm">
                            <div>Pocitová teplota: <strong id="apparent" class="text-white">—</strong></div>
                            <div>Vietor: <strong id="wind" class="text-white">—</strong></div>
                            <div>Vlhkosť: <strong id="hum" class="text-white">—</strong></div>
                            <div>Tlak: <strong id="press" class="text-white">—</strong></div>
                            <div>Východ slnka: <strong id="sunrise" class="text-white">—</strong></div>
                            <div>Západ slnka: <strong id="sunset" class="text-white">—</strong></div>
                        </div>
                    </div>
                    <div id="icon" class="text-7xl flex items-center justify-center">☀️</div>
                </div>

                <div class="mt-6">
                    <h3 class="text-lg font-semibold mb-2">Dnešný súhrn</h3>
                    <p id="summary" class="bg-[#0f1c2a] border border-[#233448] text-[#dbeeff] rounded-lg p-3 text-center">
                        —
                    </p>
                </div>
            </section>

            <!-- Sekcia grafu, upravená na základe požiadavky -->
            <section class="card">
                <h3 class="text-lg font-semibold mb-2 text-center">Teplota počas 24 hodín</h3>
                <div class="h-64 md:h-72 mt-4"><canvas id="hourly"></canvas></div>
            </section>
        </div>

        <section class="card mt-5">
            <h3 class="text-lg font-semibold text-center">Dnešná predpoveď</h3>
            <div id="parts" class="colset"></div>
        </section>

        <section class="card mt-5">
            <h3 class="text-lg font-semibold text-center">7-dňová predpoveď</h3>
            <div id="days" class="colset"></div>
        </section>

        <section class="card mt-5">
            <h3 class="text-lg font-semibold text-center">15-minútová predpoveď (24 h)</h3>
            <div id="min15" class="colset"></div>
        </section>

        <section class="card mt-5">
            <div class="text-center">
                <h3 class="text-lg font-semibold">Počasie presne pred rokom</h3>
                <div id="hist-date" class="text-[#a8bed5] text-sm">—</div>
            </div>
            <div class="flex flex-wrap items-center justify-center gap-4 mt-4">
                <div id="hist-emoji" class="text-4xl">—</div>
                <div class="font-bold text-xl" id="hist-text">—</div>
                <span class="badge bg-[#ff5e5e] text-white font-bold rounded-lg px-3 py-1" id="hist-max">—</span>
                <span class="badge bg-[#ffd265] text-[#2b2300] font-bold rounded-lg px-3 py-1" id="hist-min">—</span>
            </div>
            <div class="text-[#a8bed5] text-xs mt-2 text-center" id="hist-extra">—</div>
        </section>
    </div>

    <footer class="text-center py-4 text-[#cfe8ff] text-sm border-t border-t-[rgba(255,255,255,.12)] mt-5">
        &copy; <span id="year"></span> Richard / Počasie
    </footer>
    <div id="err" class="fixed left-3 right-3 bottom-3 bg-[#2a1111] border border-[#6b2a2a] text-[#ffd9d9] rounded-lg p-3 text-sm hidden z-50"></div>

    <script>
      // Tento kód obsahuje väčšinu pôvodnej logiky, ale je upravený tak, aby fungoval s novým dizajnom.
      // Dôležité je, že som ponechal funkcie pre prácu s počasím a emoji, ale pridal som moderné metódy pre DOM manipuláciu.
      const APP_VERSION = '2025-08-15-mobile-flex-fix-5';
      const $ = s => document.querySelector(s);
      const NBSP_NARROW = '\u202F';
      const fmt0 = (v,u='') => (v==null || Number.isNaN(v)) ? '—' : (Math.round(v) + u);
      const fmt1 = (v,u='') => (v==null || Number.isNaN(v)) ? '—' : ((Math.round(v*10)/10).toFixed(1) + u);

      // WMO kódy počasia
      const WMO = {
        0: ['Jasno'],
        1: ['Prevažne jasno'],
        2: ['Polojasno'],
        3: ['Zamračené'],
        45: ['Hmla'],
        48: ['Mrznúca hmla'],
        51: ['Slabé mrholenie'],
        53: ['Mrholenie'],
        55: ['Silné mrholenie'],
        61: ['Slabý dážď'],
        63: ['Dážď'],
        65: ['Lejak'],
        66: ['Mrznúci dážď'],
        67: ['Mrznúci dážď'],
        71: ['Slabé sneženie'],
        73: ['Sneženie'],
        75: ['Silné sneženie'],
        77: ['Snehové zrná'],
        80: ['Prehánky'],
        81: ['Prehánky'],
        82: ['Silné prehánky'],
        85: ['Snehové prehánky'],
        86: ['Silné snehové prehánky'],
        95: ['Búrky'],
        96: ['Búrky s krúpami'],
        99: ['Silné búrky s krúpami']
      };
      const RAIN_CODES = new Set([51, 53, 55, 61, 63, 65, 66, 67, 80, 81, 82, 95, 96, 99]);
      const uvCat = u => u < 3 ? 'nízky' : u < 6 ? 'mierny' : u < 8 ? 'vysoký' : u < 11 ? 'veľmi vysoký' : 'extrémny';

      function wmoEmoji(code, night = false, ctx = {}) {
        const k = Number(code);
        function fogAlt() {
          const t = Number.isFinite(ctx.temp) ? ctx.temp : null;
          const w = Number.isFinite(ctx.wind) ? ctx.wind : null;
          const p = Number.isFinite(ctx.precip) ? ctx.precip : null;
          const prob = Number.isFinite(ctx.prob) ? ctx.prob : null;
          if (t != null && t <= 0) return '❄️';
          if ((p != null && p > 0) || (prob != null && prob >= 30)) return '🌧️';
          if (w != null && w >= 20) return '💨';
          return night ? '🌙' : '☁️';
        }
        if ([45, 48].includes(k)) return fogAlt();
        if ([0, 1].includes(k)) return night ? '🌙' : '☀️';
        if (k === 2) return night ? '🌙' : '⛅';
        if (k === 3) return '☁️';
        if ([51, 53, 55].includes(k)) return '🌦️';
        if ([61, 63, 65, 80, 81, 82].includes(k)) return '🌧️';
        if ([71, 73, 75, 77, 85, 86].includes(k)) return '❄️';
        if ([95, 96, 99].includes(k)) return '⛈️';
        return night ? '🌙' : '🌤️';
      }

      function willRain(args) {
        const code = args && args.code != null ? Number(args.code) : null;
        const precip = args && args.precip != null ? Number(args.precip) : null;
        const temp = args && args.temp != null ? Number(args.temp) : null;
        const prob = args && args.prob != null ? Number(args.prob) : null;
        const precipSum = args && args.precipSum != null ? Number(args.precipSum) : null;
        if (prob != null && prob >= 30) return true;
        if (code != null && RAIN_CODES.has(code)) return true;
        if (precipSum != null && precipSum >= 0.1) return true;
        if (precip != null && precip > 0) {
          if (temp == null) return true;
          return temp > 1
        }
        return false;
      }
      const windEmoji = () => '💨';

      function isNightAt(dtLike, daily) {
        const dt = typeof dtLike === 'string' ? new Date(dtLike) : dtLike;
        try {
          const dayStr = dt.toISOString().slice(0, 10);
          const times = daily && daily.time ? daily.time : [];
          const i = times.indexOf(dayStr);
          if (i >= 0 && daily && daily.sunrise && daily.sunset && daily.sunset[i]) {
            const sr = new Date(daily.sunrise[i]);
            const ss = new Date(daily.sunset[i]);
            return (dt < sr || dt >= ss);
          }
        } catch (e) {}
        const h = dt.getHours();
        return (h < 6 || h >= 21);
      }

      const pad = n => String(n).padStart(2, '0');
      const localHourKey = (date) => {
        const d = typeof date === 'string' ? new Date(date) : new Date(date);
        return d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-' + pad(d.getDate()) + 'T' + pad(d.getHours());
      };

      function valueAtHourLocal(timesISO, arr, date) {
        const key = localHourKey(date);
        let idx = timesISO.findIndex(t => t.slice(0, 13) === key);
        if (idx >= 0) return arr[idx];
        let best = 0,
          bestDiff = 1e18;
        timesISO.forEach((t, i) => {
          const diff = Math.abs(new Date(t) - new Date(date));
          if (diff < bestDiff) {
            best = i;
            bestDiff = diff;
          }
        });
        return arr[best];
      }

      const lerp = (a, b, t) => a + (b - a) * t;

      function valueAt15min(timesISO, arr, date) {
        const ts = timesISO.map(t => new Date(t));
        for (let i = 0; i < ts.length - 1; i++) {
          const t0 = ts[i],
            t1 = ts[i + 1];
          if (date >= t0 && date <= t1) {
            const r = (date - t0) / (t1 - t0),
              v0 = arr[i],
              v1 = arr[i + 1];
            if (v0 == null || v1 == null) return null;
            return lerp(v0, v1, r);
          }
        }
        return null;
      }

      function codeAt15min(timesISO, codes, date) {
        const ts = timesISO.map(t => new Date(t));
        for (let i = 0; i < ts.length - 1; i++) {
          const t0 = ts[i],
            t1 = ts[i + 1];
          if (date >= t0 && date <= t1) {
            const mid = (t0.getTime() + t1.getTime()) / 2;
            return (date < new Date(mid)) ? codes[i] : codes[i + 1];
          }
        }
        return codes[codes.length - 1] ?? 0;
      }

      function pickDayCondition(d) {
        const times = (d.hourly && d.hourly.time) ? d.hourly.time : [];
        const codes = (d.hourly && d.hourly.weather_code) ? d.hourly.weather_code : [];
        const day = (d.current && d.current.time ? d.current.time : '').slice(0, 10);
        let startH = 9,
          endH = 18;
        const sr = (d.daily && d.daily.sunrise && d.daily.sunrise[0]) ? d.daily.sunrise[0] : null;
        const ss = (d.daily && d.daily.sunset && d.daily.sunset[0]) ? d.daily.sunset[0] : null;
        if (sr && ss) {
          const sh = new Date(sr).getHours(),
            eh = new Date(ss).getHours();
          if (!Number.isNaN(sh) && !Number.isNaN(eh) && sh < eh) {
            startH = sh;
            endH = eh;
          }
        }
        const freq = {};
        for (let i = 0; i < times.length; i++) {
          if (!times[i].startsWith(day)) continue;
          const h = Number(times[i].slice(11, 13));
          if (h < startH || h > endH) continue;
          const c = (codes[i] ?? 0);
          freq[c] = (freq[c] || 0) + 1;
        }
        let best = (d.daily && d.daily.weather_code && d.daily.weather_code[0] != null) ? d.daily.weather_code[0] : (codes[0] ?? 0);
        let bestCnt = -1;
        Object.keys(freq).forEach(k => {
          const cnt = freq[k];
          if (cnt > bestCnt) {
            bestCnt = cnt;
            best = Number(k);
          }
        });
        return best;
      }

      const aqiCat = (v) => {
        if (v == null || Number.isNaN(v)) return '—';
        if (v <= 50) return 'dobrá';
        if (v <= 100) return 'mierne zhoršená';
        if (v <= 150) return 'riziková';
        if (v <= 200) return 'zlá';
        if (v <= 300) return 'veľmi zlá';
        return 'nebezpečná';
      };

      let state = {
        place: '—',
        lat: 48.1486,
        lon: 17.1077,
        last: null
      };
      let hourlyChart = null;
      const LS_KEY = 'wx_prefs_v3';
      const toast = (msg) => {
        const el = $('#err');
        if (!el) return;
        el.textContent = msg;
        el.style.display = 'block';
        setTimeout(() => {
          el.style.display = 'none'
        }, 5000)
      };

      try {
        const raw = localStorage.getItem(LS_KEY);
        if (raw) {
          const p = JSON.parse(raw);
          if (+p.lat && +p.lon && p.place) {
            state = { ...state,
              ...p
            };
          }
        }
      } catch (e) {}
      const savePrefs = () => {
        try {
          localStorage.setItem(LS_KEY, JSON.stringify({
            lat: state.lat,
            lon: state.lon,
            place: state.place
          }));
        } catch (e) {}
      };

      async function reverseGeocodeOpenMeteo() {
        if (!state.lat || !state.lon) return;
        const url = `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${state.lat}&longitude=${state.lon}`;
        try {
          const res = await fetch(url).then(r => r.json());
          const p = res.results?.[0];
          if (p && p.name) {
            state.place = p.name + (p.admin1 ? (', ' + p.admin1) : '') + (p.country_code ? (', ' + p.country_code) : '');
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function fetchWeather() {
        const {
          lat,
          lon
        } = state;
        if (!lat || !lon) return;

        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,apparent_temperature,precipitation,wind_speed_10m,relative_humidity_2m,surface_pressure,is_day&hourly=temperature_2m,relative_humidity_2m,precipitation_probability,weather_code,uv_index,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,sunrise,sunset,uv_index_max,precipitation_sum,precipitation_probability_max,wind_speed_10m_max&minutely_15=temperature_2m,weather_code,precipitation&timezone=auto&forecast_days=10&models=best_match`;
        const aqiUrl = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=european_aqi&timezone=auto`;
        const histUrl = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${moment().subtract(1,'years').format('YYYY-MM-DD')}&end_date=${moment().subtract(1,'years').format('YYYY-MM-DD')}&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`;

        const [res, aqiRes, histRes] = await Promise.all([
          fetch(url).then(r => r.json()),
          fetch(aqiUrl).then(r => r.json()).catch(() => ({})),
          fetch(histUrl).then(r => r.json()).catch(() => ({}))
        ]);

        if (res.error) {
          toast(res.reason);
          return;
        }

        if (res) {
          state.last = res;
          state.aqi = aqiRes;
          state.hist = histRes;
          await reverseGeocodeOpenMeteo();
          savePrefs();
          renderData();
        }
      }

      function setLocation(lat, lon, place) {
        state.lat = lat;
        state.lon = lon;
        state.place = place;
        state.last = null;
        savePrefs();
        fetchWeather().catch(() => toast('Načítanie počasia zlyhalo'));
      }

      function renderData() {
        if (!state.last) return;
        const d = state.last;
        const cur = d.current;
        const daily = d.daily;
        const aqi = state.aqi;

        const isNight = cur.is_day === 0;

        $('#place').textContent = state.place;
        $('#temp').textContent = fmt0(cur.temperature_2m, '°');
        $('#icon').textContent = wmoEmoji(cur.weather_code, isNight, {
          temp: cur.temperature_2m,
          precip: cur.precipitation,
          wind: cur.wind_speed_10m
        });
        $('#uv').textContent = `UV index ${fmt0(valueAtHourLocal(d.hourly.time,d.hourly.uv_index,new Date()))} (${uvCat(valueAtHourLocal(d.hourly.time,d.hourly.uv_index,new Date()))})`;
        const aqiVal = aqi.hourly?.european_aqi?.[0];
        $('#aqi').textContent = `Kvalita ovzdušia ${aqiVal ? aqiVal : '—'} (${aqiCat(aqiVal)})`;
        $('#apparent').textContent = fmt0(cur.apparent_temperature, '°');
        $('#wind').textContent = fmt0(cur.wind_speed_10m) + ' km/h';
        $('#hum').textContent = fmt0(cur.relative_humidity_2m) + ' %';
        $('#press').textContent = fmt0(cur.surface_pressure) + ' hPa';
        $('#sunrise').textContent = moment(daily.sunrise[0]).format('HH:mm');
        $('#sunset').textContent = moment(daily.sunset[0]).format('HH:mm');
        $('#summary').textContent = WMO[cur.weather_code]?.[0] || '—';

        renderHourly();
        renderForecastParts();
        renderForecastDays();
        renderMin15();
        renderHistory();
      }

      function renderHourly() {
        if (!state.last) return;
        const d = state.last;
        const times = d.hourly.time.map(t => moment(t).format('HH:mm'));
        const temperatures = d.hourly.temperature_2m;
        const hourlyCtx = $('#hourly').getContext('2d');
        if (hourlyChart) hourlyChart.destroy();

        hourlyChart = new Chart(hourlyCtx, {
          type: 'line',
          data: {
            labels: times,
            datasets: [{
              label: 'Teplota (°C)',
              data: temperatures,
              borderColor: '#3ad0e6',
              borderWidth: 2,
              pointBackgroundColor: '#3ad0e6',
              pointBorderColor: '#3ad0e6',
              tension: 0.4,
              fill: false, // Odstránené farebné vyplnenie pod čiarou
              backgroundColor: 'transparent',
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                ticks: {
                  color: '#a8bed5',
                  autoSkip: true,
                  maxRotation: 0,
                  minRotation: 0,
                  callback: function(val, index) {
                    return index % 3 === 0 ? this.getLabelForValue(val) : '';
                  }
                },
                grid: {
                  color: 'rgba(35, 52, 72, 0.2)' // Jemnejšie mriežka
                },
              },
              y: {
                ticks: {
                  color: '#a8bed5'
                },
                grid: {
                  color: 'rgba(35, 52, 72, 0.2)' // Jemnejšie mriežka
                },
                beginAtZero: false,
              }
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: '#152433',
                titleColor: '#eaf3ff',
                bodyColor: '#eaf3ff',
                borderColor: '#233448',
                borderWidth: 1,
                callbacks: {
                  title: function(context) {
                    return `Čas: ${context[0].label}`;
                  },
                  label: function(context) {
                    return `Teplota: ${context.raw}°C`;
                  }
                }
              }
            }
          }
        });
      }

      function renderForecastParts() {
        if (!state.last) return;
        const d = state.last;
        const today = moment().startOf('day');
        const partsEl = $('#parts');
        partsEl.innerHTML = '';
        
        for (let i = 0; i < 24; i += 6) {
          const dt = today.clone().add(i, 'hours');
          const isNight = isNightAt(dt.toISOString(), d.daily);
          const temp = valueAtHourLocal(d.hourly.time, d.hourly.temperature_2m, dt);
          const code = valueAtHourLocal(d.hourly.time, d.hourly.weather_code, dt);
          const prob = valueAtHourLocal(d.hourly.time, d.hourly.precipitation_probability, dt);
          const wind = valueAtHourLocal(d.hourly.time, d.hourly.wind_speed_10m, dt);

          const col = document.createElement('div');
          col.className = 'col';
          col.innerHTML = `
              <div class="c-top">${dt.format('ddd HH:mm')}</div>
              <div class="c-ico text-4xl">${wmoEmoji(code, isNight, { temp, prob, wind })}</div>
              <div class="temps">
                  <div class="c-max">${fmt0(temp, '°')}</div>
              </div>
              <div class="metrics">
                  ${willRain({code, prob, temp}) ? `
                    <div class="metric">
                        <div class="m-ico">💧</div>
                        <div class="m-txt">${fmt0(prob, '%')}</div>
                    </div>` : ''}
                    <div class="metric">
                      <div class="m-ico">💨</div>
                      <div class="m-txt">${fmt0(wind)} km/h</div>
                  </div>
              </div>
          `;
          partsEl.appendChild(col);
        }
      }
      
      function renderForecastDays() {
        if (!state.last) return;
        const d = state.last;
        const dailyEl = $('#days');
        dailyEl.innerHTML = '';
        
        for (let i = 0; i < Math.min(7, d.daily.time.length); i++) {
          const day = d.daily;
          const dt = moment(day.time[i]);
          const code = pickDayCondition({ hourly: d.hourly, current: {time: day.time[i]}, daily: day });
          
          const col = document.createElement('div');
          col.className = 'col';
          col.innerHTML = `
              <div class="c-top">${dt.format('ddd')}</div>
              <div class="c-ico text-4xl">${wmoEmoji(code)}</div>
              <div class="temps">
                  <div class="c-max">${fmt0(day.temperature_2m_max[i], '°')}</div>
                  <div class="c-min">${fmt0(day.temperature_2m_min[i], '°')}</div>
              </div>
              <div class="metrics">
                ${willRain({code: day.weather_code[i], precipSum: day.precipitation_sum[i], prob: day.precipitation_probability_max[i]}) ? `
                    <div class="metric">
                        <div class="m-ico">💧</div>
                        <div class="m-txt">${fmt0(day.precipitation_probability_max[i], '%')}</div>
                    </div>` : ''}
                    <div class="metric">
                      <div class="m-ico">💨</div>
                      <div class="m-txt">${fmt0(day.wind_speed_10m_max[i])} km/h</div>
                  </div>
              </div>
          `;
          dailyEl.appendChild(col);
        }
      }

      function renderMin15() {
        if (!state.last) return;
        const d = state.last;
        const min15El = $('#min15');
        min15El.innerHTML = '';
        
        const now = moment();
        for (let i = 0; i < 24; i++) {
          const dt = now.clone().add(i*15, 'minutes');
          const isNight = isNightAt(dt.toISOString(), d.daily);
          const temp = valueAt15min(d.minutely_15.time, d.minutely_15.temperature_2m, dt);
          const code = codeAt15min(d.minutely_15.time, d.minutely_15.weather_code, dt);
          const precip = valueAt15min(d.minutely_15.time, d.minutely_15.precipitation, dt);

          const col = document.createElement('div');
          col.className = 'col';
          col.innerHTML = `
            <div class="c-top">${dt.format('HH:mm')}</div>
            <div class="c-ico text-4xl">${wmoEmoji(code, isNight, { temp, precip })}</div>
            <div class="temps">
                <div class="c-max">${fmt0(temp, '°')}</div>
            </div>
            <div class="metrics">
                ${willRain({code, precip, temp}) ? `
                    <div class="metric">
                        <div class="m-ico">💧</div>
                        <div class="m-txt">${fmt1(precip)} mm</div>
                    </div>` : ''}
            </div>
          `;
          min15El.appendChild(col);
        }
      }
      
      function renderHistory() {
        if (!state.hist || !state.hist.daily || state.hist.daily.time.length === 0) {
            $('#hist-date').textContent = 'Údaje spred roka nie sú dostupné';
            $('#hist-emoji').textContent = '—';
            $('#hist-text').textContent = '—';
            $('#hist-max').textContent = '—';
            $('#hist-min').textContent = '—';
            $('#hist-extra').textContent = '—';
            return;
        }
        
        const day = state.hist.daily;
        const date = moment(day.time[0]);
        const emoji = wmoEmoji(day.weather_code[0]);
        const text = WMO[day.weather_code[0]]?.[0] || '—';
        const max = fmt0(day.temperature_2m_max[0]);
        const min = fmt0(day.temperature_2m_min[0]);
        
        $('#hist-date').textContent = `Dňa ${date.format('D. M. YYYY')}`;
        $('#hist-emoji').textContent = emoji;
        $('#hist-text').textContent = text;
        $('#hist-max').textContent = `${max}°C`;
        $('#hist-min').textContent = `${min}°C`;
        $('#hist-extra').textContent = '—';
      }

      function enableDragScroll(el) {
        let isDown = false;
        let startX;
        let scrollLeft;

        el.addEventListener('mousedown', (e) => {
          isDown = true;
          el.classList.add('dragging');
          startX = e.pageX - el.offsetLeft;
          scrollLeft = el.scrollLeft;
        });
        el.addEventListener('mouseleave', () => {
          isDown = false;
          el.classList.remove('dragging');
        });
        el.addEventListener('mouseup', () => {
          isDown = false;
          el.classList.remove('dragging');
        });
        el.addEventListener('mousemove', (e) => {
          if (!isDown) return;
          e.preventDefault();
          const x = e.pageX - el.offsetLeft;
          const walk = (x - startX);
          el.scrollLeft = scrollLeft - walk;
        });
      }

      function initGeolocation() {
        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition(pos => {
            setLocation(pos.coords.latitude, pos.coords.longitude, state.place);
          }, err => {
            console.error('Geolocation error:', err);
            toast('Nepodarilo sa zistiť vašu polohu. Zobrazujem predvolené miesto.');
            fetchWeather().catch(() => toast('Načítanie počasia zlyhalo'));
          });
        } else {
          toast('Váš prehliadač nepodporuje geolokáciu. Zobrazujem predvolené miesto.');
          fetchWeather().catch(() => toast('Načítanie počasia zlyhalo'));
        }
      }

      // Kód pre vyhľadávanie miest
      let searchTimeout = null;
      $('#q').addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(async () => {
          const query = $('#q').value;
          if (query.length < 3) {
            $('#suggestions').style.display = 'none';
            return;
          }
          const url = `https://geocoding-api.open-meteo.com/v1/search?name=${query}&count=10&language=sk&format=json`;
          const res = await fetch(url).then(r => r.json()).catch(() => ({}));
          const arr = res.results || [];
          const box = $('#suggestions');
          box.innerHTML = '';
          box.style.display = 'grid';
          if (!arr.length) {
            box.innerHTML = '<div class="sugg text-[#a8bed5] p-2">Nič sa nenašlo</div>';
            return
          }
          arr.forEach(p => {
            const b = document.createElement('div');
            b.className = 'sugg bg-[#13263a] border border-[#233448] rounded-xl p-3 cursor-pointer hover:bg-[#1a3045] transition-colors';
            b.textContent = p.name + (p.admin1 ? (', ' + p.admin1) : '') + ', ' + p.country_code;
            b.addEventListener('click', () => {
              setLocation(p.latitude, p.longitude, b.textContent);
              box.style.display = 'none'
            });
            box.appendChild(b);
          });
        }, 250);
      });
      document.addEventListener('click', e => {
        const box = $('#suggestions');
        if (box && !box.contains(e.target) && e.target !== $('#q')) box.style.display = 'none'
      });

      document.getElementById('year').textContent = new Date().getFullYear();

      function initDragBars() {
        ['parts', 'days', 'min15'].forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            enableDragScroll(el)
          }
        })
      }

      initGeolocation();
      window.addEventListener('resize', () => {
        if (state.last) {
          renderHourly();
        }
      });
      setTimeout(() => {
        if (!state.last) fetchWeather().catch(() => toast('Načítanie počasia zlyhalo'))
      }, 1200);
      initDragBars();
    </script>
</body>
</html>

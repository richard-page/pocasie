<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes, maximum-scale=6, viewport-fit=cover" />
<title>Poƒçasie</title>
<link rel="icon" type="image/png" href="favicon.png" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg0:#0b0f14; --bg1:#0e1620; --panel:#152433; --stroke:#233448;
    --txt:#eaf3ff; --muted:#a8bed5; --accent:#3ad0e6;
    --r:14px; --shadow:0 10px 28px rgba(0,0,0,.28);
    --gap:8px
  }
  *{box-sizing:border-box}
  html,body{min-height:100%; margin:0; padding:0}
  body{
    color:var(--txt); font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:linear-gradient(180deg,var(--bg1),var(--bg0));
    overflow-x:hidden; overflow-y:auto; -webkit-text-size-adjust:100%; -webkit-tap-highlight-color:transparent; min-height:100dvh
  }
  .wrap{width:100%; max-width:1120px; margin-inline:auto; padding:22px 14px 40px}
  header h1{margin:0 0 14px; text-align:center; font-size:28px; letter-spacing:.3px}

  .toolbar{display:grid; grid-template-columns:1fr; gap:12px; margin:14px 0 14px}
  .searchCol{display:flex; flex-direction:column; gap:8px; position:relative}
  .search{width:100%; background:#152535; border:1px solid var(--stroke); color:#fff; border-radius:12px; padding:12px 14px; outline:none; font-size:16px; min-height:46px}
  .search:focus{border-color:#2e4a67}
  #suggestions{display:none; gap:6px; position:absolute; top:calc(100% + 6px); left:0; right:0; z-index:40; background:#0f1c2a; border:1px solid var(--stroke); border-radius:12px; padding:8px; max-height:55vh; overflow:auto}
  .sugg{background:#13263a; border:1px solid var(--stroke); border-radius:10px; padding:10px 12px; cursor:pointer}

  .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid var(--stroke); border-radius:var(--r); box-shadow:var(--shadow); padding:16px 14px}
  .card h3{margin:0 0 14px; text-align:center; font-size:18px}
  section.card{margin-top:18px !important}

  #place{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-align:left; margin:0}

  .row{display:grid; grid-template-columns:1fr; gap:18px; margin-top:6px}
  .meta{display:grid; grid-template-columns:1fr; gap:10px; color:#a8bed5; font-size:14px}
  .meta strong{color:#fff}

  .chipRow{display:flex; flex-direction:column; gap:10px; align-items:flex-start}
  .chip{display:inline-flex; align-items:center; gap:8px; background:#143344; border:1px solid var(--stroke); color:#d8f7ff; border-radius:999px; padding:8px 14px; font-size:13px; line-height:1}
  @media (min-width:900px){ .chipRow{flex-direction:row; flex-wrap:wrap} }

  .tempNow{font-size:44px; font-weight:700; line-height:1; margin:6px 0}
  .icon{width:64px; height:64px; display:flex; align-items:center; justify-content:center; font-size:48px}
  .gridInfo{display:grid; grid-template-columns:1fr auto; gap:16px; align-items:start}

  .chartWrap{height:240px}
  canvas{background:#0f1c2a; border:1px solid var(--stroke); border-radius:12px}

  .summarySection{margin-top:14px}
  .summarySection h3{margin-bottom:10px}
  #summary{margin:0 auto; max-width:780px; color:#dbeeff; background:#0f1c2a; border:1px solid var(--stroke); border-radius:10px; padding:12px; text-align:center}

  /* horizont√°lne karty ‚Äì 4 na mobil */
  .colset{
    --cols:4;
    display:flex;
    gap:var(--gap);
    overflow-x:auto; overflow-y:hidden;
    scrollbar-gutter:stable both-edges;
    -webkit-overflow-scrolling:touch;
    touch-action:pan-x pan-y;
    overscroll-behavior-x:contain;
    cursor:grab;
    padding:8px 0 12px;
    scroll-snap-type:x proximity
  }
  .colset.dragging{cursor:grabbing; user-select:none}

  .col{
    flex:0 0 calc((100% - (var(--cols) - 1)*var(--gap)) / var(--cols));
    background:var(--panel); border:1px solid var(--stroke); border-radius:12px;
    padding:14px;
    display:grid; grid-template-rows:auto auto auto auto;
    align-items:center; justify-items:center;
    text-align:center; min-height:182px; row-gap:10px;
    min-width:0; overflow:visible; scroll-snap-align:start;
    transition:background .18s ease, border-color .18s ease, transform .12s ease;
  }
  .col.sel{ background:#173041; border-color:#33516f; transform:translateY(-2px); }

  .temps{display:grid; place-items:center}
  .temps .c-max{font-size:28px; font-weight:700; color:#ff6c6c; line-height:1}
  .c-ico{font-size:28px}

  /* Info obdƒ∫≈ænik ‚Äì default skryt√Ω, uk√°≈æe sa po kliknut√≠ */
  .infoWrap{ margin-top:10px; display:none }
  .infoWrap.open{ display:block }
  .infoCard{
    background:#0f1c2a; border:1px solid var(--stroke); border-radius:12px;
    padding:12px 14px; box-shadow:var(--shadow);
  }
  .infoTitle{ margin:0 0 8px; font-weight:600; font-size:15.5px }
  .infoGrid{ display:grid; gap:10px; grid-template-columns:1fr; }
  .infoRow{ display:flex; align-items:flex-start; gap:10px; }
  .infoIco{ font-size:18px; line-height:1.1; opacity:.9; }
  .infoTxt{ font-size:14.5px; color:#e9f3ff; line-height:1.35 }
  .infoSub{ font-size:13px; color:#bcd1e5; margin-top:6px }

  /* ===== tvoj po≈æadovan√Ω blok ===== */
  .c-top{
    width:100%;
    min-height:2.4em;
    display:flex; align-items:center; justify-content:center;
    padding-inline:8px;
  }
  .c-top__inner{
    white-space:nowrap;
    overflow:visible;
    text-overflow:unset;
    font-weight:600;
    font-size:clamp(11px, 3.4vw, 16px);
    line-height:1.2;
    text-align:center;
  }
  /* jemn√© minimum, aby sa ‚ÄûPoobede‚Äú zmestilo na 1 riadok */
  .karta, .col{ min-width:100px; }
  /* ===== koniec bloku ===== */

  .colset::-webkit-scrollbar{height:10px}
  .colset::-webkit-scrollbar-track{background:#0f1c2a; border-radius:8px}
  .colset::-webkit-scrollbar-thumb{background:#33516f; border-radius:8px}
  .colset::-webkit-scrollbar-thumb:hover{background:#3f6b94}
  .colset{scrollbar-width:thin; scrollbar-color:#33516f #0f1c2a}

  @media (min-width:780px){
    .wrap{padding:24px 16px 44px}
    .row{grid-template-columns:1.05fr 1fr; gap:18px}
    .meta{grid-template-columns:repeat(2,minmax(0,1fr))}
    .chartWrap{height:270px}
  }
  @media (min-width:1100px){ .chartWrap{height:300px} }

  #err{position:fixed;left:10px;right:10px;bottom:12px;background:#2a1111;border:1px solid #6b2a2a;color:#ffd9d9;border-radius:10px;padding:10px 12px;font-size:14px;display:none;z-index:99}
</style>
</head>
<body>
  <div class="wrap">
    <header><h1>Poƒçasie</h1></header>

    <div class="toolbar">
      <div class="searchCol">
        <input id="q" class="search" type="text" placeholder="Hƒæadaj mesto (napr. Bratislava, Ko≈°ice)" />
        <div id="suggestions"></div>
      </div>
    </div>

    <div class="row">
      <section class="card">
        <div class="gridInfo">
          <div>
            <h3 id="place">‚Äî</h3>
            <div class="tempNow" id="temp">‚Äî¬∞</div>
            <div class="chipRow">
              <span class="chip" id="uv">UV index ‚Äî</span>
              <span class="chip" id="aqi">Kvalita ovzdu≈°ia ‚Äî</span>
            </div>
            <div class="meta" style="margin-top:8px">
              <div>Pocitov√° teplota: <strong id="apparent">‚Äî</strong></div>
              <div>Vietor: <strong id="wind">‚Äî</strong></div>
              <div>Vlhkos≈•: <strong id="hum">‚Äî</strong></div>
              <div>Tlak: <strong id="press">‚Äî</strong></div>
              <div>V√Ωchod slnka: <strong id="sunrise">‚Äî</strong></div>
              <div>Z√°pad slnka: <strong id="sunset">‚Äî</strong></div>
            </div>
          </div>
          <div id="icon" class="icon">‚Äî</div>
        </div>

        <div class="summarySection">
          <h3>Dne≈°n√Ω s√∫hrn</h3>
          <p id="summary">‚Äî</p>
        </div>
      </section>

      <section class="card">
        <h3>Teplota poƒças 24 hod√≠n</h3>
        <div class="chartWrap"><canvas id="hourly"></canvas></div>
      </section>
    </div>

    <section class="card">
      <h3>Predpoveƒè</h3>
      <div id="parts" class="colset"></div>
      <div class="infoWrap" id="infoWrap">
        <div id="partInfo" class="infoCard">
          <div class="infoTitle">‚Äî</div>
          <div class="infoGrid" id="partInfoGrid">
            <div class="infoRow"><span class="infoIco">üåßÔ∏è</span><div class="infoTxt" id="pi_rain">Zr√°≈æky: ‚Äî</div></div>
            <div class="infoRow"><span class="infoIco">‚ÜóÔ∏è</span><div class="infoTxt" id="pi_press">Tlak vzduchu: ‚Äî</div></div>
            <div class="infoRow"><span class="infoIco">üíß</span><div class="infoTxt" id="pi_hum">Rel. vlhkos≈•: ‚Äî ‚Ä¢ Rosn√Ω bod: ‚Äî</div></div>
            <div class="infoRow"><span class="infoIco">üß≠</span><div class="infoTxt" id="pi_wind">Vietor: ‚Äî</div></div>
            <div class="infoRow"><span class="infoIco">üí®</span><div class="infoTxt" id="pi_gust">N√°razy vetra: ‚Äî</div></div>
            <div class="infoSub" id="pi_note"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h3>7-d≈àov√° predpoveƒè</h3>
      <div id="days" class="colset"></div>
    </section>

    <section class="card">
      <h3>15-min√∫tov√° predpoveƒè (24 h)</h3>
      <div id="min15" class="colset"></div>
    </section>

    <section class="card">
      <div class="head" style="text-align:center">
        <h3>Poƒçasie presne pred rokom</h3>
        <div id="hist-date" style="color:var(--muted);font-size:12px">‚Äî</div>
      </div>
      <div class="histRow" style="display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap">
        <div id="hist-emoji" style="font-size:26px">‚Äî</div>
        <div style="font-weight:700" id="hist-text">‚Äî</div>
        <span class="badge max" id="hist-max">‚Äî</span>
        <span class="badge min" id="hist-min">‚Äî</span>
      </div>
      <div class="infoSub" id="hist-extra">‚Äî</div>
    </section>
  </div>

  <footer>&copy; <span id="year"></span> Richard / Poƒçasie</footer>
  <div id="err"></div>

  <script>
    const APP_VERSION = '2025-08-16-info-panel-click-v3';
    const $ = s => document.querySelector(s);
    const NBSP_NARROW = '\u202F';
    const fmt0 = (v,u='') => (v==null || Number.isNaN(v)) ? '‚Äî' : (Math.round(v) + u);
    const fmt1 = (v,u='') => (v==null || Number.isNaN(v)) ? '‚Äî' : ((Math.round(v*10)/10).toFixed(1) + u);

    const WMO = {
      0:['Jasno'],1:['Preva≈æne jasno'],2:['Polojasno'],3:['Zamraƒçen√©'],
      45:['Hmla'],48:['Mrzn√∫ca hmla'],
      51:['Slab√© mrholenie'],53:['Mrholenie'],55:['Siln√© mrholenie'],
      61:['Slab√Ω d√°≈æƒè'],63:['D√°≈æƒè'],65:['Lejak'],66:['Mrzn√∫ci d√°≈æƒè'],67:['Mrzn√∫ci d√°≈æƒè'],
      71:['Slab√© sne≈æenie'],73:['Sne≈æenie'],75:['Siln√© sne≈æenie'],77:['Snehov√© zrn√°'],
      80:['Preh√°nky'],81:['Preh√°nky'],82:['Siln√© preh√°nky'],
      85:['Snehov√© preh√°nky'],86:['Siln√© snehov√© preh√°nky'],
      95:['B√∫rky'],96:['B√∫rky s kr√∫pami'],99:['Siln√© b√∫rky s kr√∫pami']
    };
    const RAIN_CODES = new Set([51,53,55,61,63,65,66,67,80,81,82,95,96,99]);
    const uvCat = u => u<3?'n√≠zky':u<6?'mierny':u<8?'vysok√Ω':u<11?'veƒæmi vysok√Ω':'extr√©mny';
    const windEmoji = ()=> 'üí®';

    // emoji: preh√°nky vs d√°≈æƒè; hmla sa nezobrazuje
    function wmoEmoji(code, night=false){
      const k = Number(code);
      if ([45,48].includes(k)) return '';
      if ([0,1].includes(k)) return night ? 'üåô' : '‚òÄÔ∏è';
      if (k===2) return night ? 'üåô' : '‚õÖ';
      if (k===3) return '‚òÅÔ∏è';
      if ([51,53,55,80,81,82].includes(k)) return 'üå¶Ô∏è';
      if ([61,63,65].includes(k)) return 'üåßÔ∏è';
      if ([71,73,75,77,85,86].includes(k)) return '‚ùÑÔ∏è';
      if ([95,96,99].includes(k)) return '‚õàÔ∏è';
      return night ? 'üåô' : 'üå§Ô∏è';
    }

    const pad = n => String(n).padStart(2,'0');
    const localHourKey = date => {
      const d = typeof date==='string' ? new Date(date) : new Date(date);
      return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) + 'T' + pad(d.getHours());
    };
    function valueAtHourLocal(timesISO, arr, date){
      if(!timesISO||!arr) return null;
      const key = localHourKey(date);
      let idx = timesISO.findIndex(t => t.slice(0,13) === key);
      if (idx >= 0) return arr[idx];
      let best=0, bestDiff=1e18;
      timesISO.forEach((t,i)=>{ const diff=Math.abs(new Date(t)-new Date(date)); if(diff<bestDiff){best=i;bestDiff=diff;} });
      return arr[best];
    }
    const lerp=(a,b,t)=>a+(b-a)*t;
    function valueAt15min(timesISO, arr, date){
      if(!timesISO||!arr) return null;
      const ts=timesISO.map(t=>new Date(t));
      for(let i=0;i<ts.length-1;i++){
        const t0=ts[i], t1=ts[i+1];
        if(date>=t0 && date<=t1){
          const r=(date-t0)/(t1-t0), v0=arr[i], v1=arr[i+1];
          if(v0==null || v1==null) return null;
          return lerp(v0,v1,r);
        }
      }
      return null;
    }
    function codeAt15min(timesISO, codes, date){
      if(!timesISO||!codes) return 0;
      const ts=timesISO.map(t=>new Date(t));
      for(let i=0;i<ts.length-1;i++){
        const t0=ts[i], t1=ts[i+1];
        if (date>=t0 && date<=t1){
          const mid=(t0.getTime()+t1.getTime())/2;
          return (date.getTime() < mid) ? codes[i] : codes[i+1];
        }
      }
      return codes[codes.length-1] ?? 0;
    }

    function isNightAt(dtLike, daily){
      const dt = typeof dtLike==='string' ? new Date(dtLike) : dtLike;
      try{
        const dayStr = dt.toISOString().slice(0,10);
        const times = daily && daily.time ? daily.time : [];
        const i = times.indexOf(dayStr);
        if (i>=0 && daily && daily.sunrise && daily.sunset && daily.sunset[i]){
          const sr = new Date(daily.sunrise[i]);
          const ss = new Date(daily.sunset[i]);
          return (dt < sr || dt >= ss);
        }
      }catch(e){}
      const h = dt.getHours();
      return (h<6 || h>=21);
    }

    /* helpers: intervaly */
    function indicesBetween(timesISO, start, end){
      const out=[]; if(!timesISO) return out;
      for(let i=0;i<timesISO.length;i++){ const t=new Date(timesISO[i]); if(t>=start && t<end) out.push(i); }
      return out;
    }
    function avg(arr, idxs){ if(!arr||!idxs.length) return null; let s=0,c=0; idxs.forEach(i=>{ const v=Number(arr[i]); if(Number.isFinite(v)){s+=v;c++;}}); return c? s/c : null; }
    function max(arr, idxs){ if(!arr||!idxs.length) return null; let m=null; idxs.forEach(i=>{ const v=Number(arr[i]); if(Number.isFinite(v)) m = (m==null||v>m)?v:m; }); return m; }
    function sum(arr, idxs){ if(!arr||!idxs.length) return 0; let s=0; idxs.forEach(i=>{ const v=Number(arr[i]); if(Number.isFinite(v)) s+=v; }); return s; }
    function countIf(arr, idxs, pred){ if(!arr||!idxs.length) return 0; let c=0; idxs.forEach(i=>{ const v=Number(arr[i]); if(pred(v)) c++; }); return c; }
    function modeCode(arr, idxs){ const f={}; let best=null,cnt=-1; idxs.forEach(i=>{ const k=Number(arr[i]??0); f[k]=(f[k]||0)+1; if(f[k]>cnt){cnt=f[k]; best=k;} }); return best??0; }

    function precipStatsInRange(hourly, idxList){
      const P = hourly.precipitation || [];
      const PP = hourly.precipitation_probability || [];
      let hiMm=sum(P, idxList);
      let hiH=countIf(P, idxList, v=>Number(v)>0);
      let pmax = max(PP, idxList) ?? (hiH>0?100:0);
      let loMm = hiMm * (pmax/100);
      let loH  = Math.round(hiH * (pmax/100));
      return {prob:pmax, loMm, hiMm, loH, hiH};
    }
    const clamp0 = v => Math.max(0, Math.round(v));
    function formatPrecipLine(s){
      const loMM = Math.min(s.loMm, s.hiMm), hiMM = Math.max(s.loMm, s.hiMm);
      const loH  = Math.min(s.loH,  s.hiH),  hiH  = Math.max(s.loH,  s.hiH);
      return clamp0(s.prob)+' % | '+clamp0(loMM)+'‚Äì'+clamp0(hiMM)+' mm | '+clamp0(loH)+'‚Äì'+clamp0(hiH)+' h';
    }

    function windDirToCardinal(deg){
      if(deg==null||Number.isNaN(deg)) return '‚Äî';
      const dirs=['S','SSV','SV','VSV','V','VJ','JV','JJV','J','JJZ','JZ','ZJZ','Z','ZSZ','SZ','SSZ'];
      const i=Math.round(((deg%360)+360)%360/22.5)%16;
      return dirs[i];
    }
    function windDescriptor(kmh){
      if(kmh==null||Number.isNaN(kmh)) return '‚Äî';
      if(kmh<6) return 'slab√Ω vietor';
      if(kmh<16) return 'mierny vietor';
      if(kmh<26) return 'ƒçerstv√Ω vietor';
      return 'siln√Ω vietor';
    }

    let state={place:'‚Äî', lat:48.1486, lon:17.1077, last:null};
    let hourlyChart=null;
    const LS_KEY='wx_prefs_v3';
    const toast=msg=>{ const el=$('#err'); if(!el) return; el.textContent=msg; el.style.display='block'; setTimeout(()=>{el.style.display='none'}, 5000) };

    try{
      const raw=localStorage.getItem(LS_KEY);
      if(raw){
        const p=JSON.parse(raw);
        if(+p.lat && +p.lon && p.place){ state={...state, ...p}; }
      }
    }catch(e){}
    const savePrefs=()=>{ try{ localStorage.setItem(LS_KEY, JSON.stringify({lat:state.lat, lon:state.lon, place:state.place})); }catch(e){} };

    async function reverseGeocodeOpenMeteo(lat, lon){
      try{
        const url = 'https://geocoding-api.open-meteo.com/v1/reverse?latitude='+lat+'&longitude='+lon+'&language=sk&format=json';
        const j = await fetch(url).then(r=>r.json());
        const r = j && j.results && j.results[0] ? j.results[0] : null;
        if (r){
          const name = r.name || r.city || r.town || r.village || '';
          const admin = r.admin1 ? ', '+r.admin1 : '';
          const cc = r.country_code ? ', '+r.country_code : '';
          if (name) return name+admin+cc;
          if (r.admin1) return r.admin1+cc;
        }
      }catch(e){ }
      return null;
    }
    async function reverseGeocodeNominatim(lat, lon){
      try{
        const url = 'https://nominatim.openstreetmap.org/reverse?lat='+lat+'&lon='+lon+'&format=json&accept-language=sk';
        const res=await fetch(url, {headers:{'Accept':'application/json'}});
        const data=await res.json();
        const a=data.address||{};
        const name=a.city||a.town||a.village||a.municipality||a.hamlet||a.suburb||'';
        const admin=a.state||a.county||a.region||'';
        const cc=a.country_code?(', '+a.country_code.toUpperCase()):'';
        if(name) return name+(admin? ', '+admin:'')+cc;
        if (admin) return admin+cc;
      }catch(e){}
      return null;
    }
    async function reverseGeocode(lat, lon){
      const a = await reverseGeocodeOpenMeteo(lat, lon);
      if (a) return a;
      const b = await reverseGeocodeNominatim(lat, lon);
      if (b) return b;
      return 'Moja poloha';
    }

    async function setLocation(lat,lon,labelOpt){
      state.lat=lat; state.lon=lon;
      const label = labelOpt || await reverseGeocode(lat, lon) || 'Moja poloha';
      state.place = label;
      savePrefs();
      await fetchWeather().catch(e=>toast(e.message||'Chyba naƒç√≠tania poƒçasia'));
    }

    function initGeolocation(){
      if(!('geolocation'in navigator)){ fetchWeather().catch(()=>toast('Geolok√°cia nedostupn√°')); return; }
      const placeEl=$('#place'); placeEl.textContent='Zis≈•ujem polohu‚Ä¶';
      navigator.geolocation.getCurrentPosition(async pos=>{
        const coords = pos.coords || {};
        const latitude = coords.latitude, longitude = coords.longitude;
        if (latitude!=null && longitude!=null) await setLocation(latitude, longitude);
        else fetchWeather().catch(()=>toast('Geolok√°cia zlyhala'));
      }, ()=>{
        fetchWeather().catch(()=>toast('Geolok√°cia zablokovan√°'));
      }, {enableHighAccuracy:true, timeout:10000, maximumAge:300000});
    }

    /* ========= Fetch ========= */
    async function fetchWeather(){
      const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;
      const p=new URLSearchParams({
        latitude:state.lat, longitude:state.lon, timezone:tz,
        current:'temperature_2m,apparent_temperature,relative_humidity_2m,pressure_msl,wind_speed_10m,weather_code,uv_index',
        hourly:'temperature_2m,precipitation,precipitation_probability,weather_code,wind_speed_10m,wind_direction_10m,wind_gusts_10m,relative_humidity_2m,pressure_msl,dew_point_2m',
        daily:'weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,precipitation_sum,precipitation_hours,uv_index_max,wind_speed_10m_max,wind_gusts_10m_max,sunrise,sunset',
        forecast_days:'7'
      });
      const r=await fetch('https://api.open-meteo.com/v1/forecast?'+p+'&v='+APP_VERSION);
      state.last=await r.json();
      renderAll(); drawHourly(); await fetchAQ().catch(()=>{}); renderDays(state.last); fetchHistory().catch(()=>{});
    }

    function renderAll(){
      const d=state.last || {}; const cur=d.current || {};
      $('#place').textContent=state.place;
      $('#temp').textContent=fmt0(cur.temperature_2m,'¬∞');
      $('#apparent').textContent=fmt0(cur.apparent_temperature,'¬∞');
      $('#wind').textContent=fmt1(cur.wind_speed_10m, NBSP_NARROW+'km/h');
      $('#hum').textContent=fmt0(cur.relative_humidity_2m, NBSP_NARROW+'%');
      $('#press').textContent=fmt0(cur.pressure_msl, NBSP_NARROW+'hPa');
      $('#icon').textContent=wmoEmoji(cur.weather_code, isNightAt(cur.time, (state.last||{}).daily||{}));

      const dly=d.daily || {};
      const tmax=dly.temperature_2m_max && dly.temperature_2m_max[0];
      const tmin=dly.temperature_2m_min && dly.temperature_2m_min[0];
      const ps=dly.precipitation_sum && dly.precipitation_sum[0];
      const pp=dly.precipitation_probability_max && dly.precipitation_probability_max[0];
      const wmax=dly.wind_speed_10m_max && dly.wind_speed_10m_max[0];
      const condToday=(WMO[pickDayCondition(d)] && WMO[pickDayCondition(d)][0])||'‚Äî';
      const rainTxt = (ps!=null && ps >= 0.1) ? ('zr√°≈æky do '+fmt1(ps, NBSP_NARROW+'mm')) : ((pp!=null && pp>20) ? ('bez v√Ωrazn√Ωch zr√°≈æok (pravdepodobnos≈• '+pp+'%)') : 'bez zr√°≈æok');
      const uvTxt = (dly.uv_index_max && dly.uv_index_max[0]!=null) ? ('UV '+uvCat(dly.uv_index_max[0])+' (max '+fmt1(dly.uv_index_max[0])+')') : 'UV √∫daj nedostupn√Ω';
      $('#summary').innerHTML='Dnes <strong>'+condToday.toLowerCase()+'</strong>, max <strong>'+fmt0(tmax,'¬∞')+'</strong>, min <strong>'+fmt0(tmin,'¬∞')+'</strong>, '+rainTxt+', vietor do <strong>'+fmt1(wmax, NBSP_NARROW+'km/h')+'</strong>, '+uvTxt+'.';

      const sr=(dly.sunrise && dly.sunrise[0]) ? new Date(dly.sunrise[0]) : null;
      const ss=(dly.sunset && dly.sunset[0]) ? new Date(dly.sunset[0]) : null;
      $('#sunrise').textContent=sr?sr.toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit'}):'‚Äî';
      $('#sunset').textContent=ss?ss.toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit'}):'‚Äî';

      renderParts(); renderMin15();
    }

    async function fetchAQ(){
      try{
        const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;
        const p=new URLSearchParams({latitude:state.lat, longitude:state.lon, timezone:tz, hourly:'us_aqi,pm2_5,pm10'});
        const j=await fetch('https://air-quality-api.open-meteo.com/v1/air-quality?'+p+'&v='+APP_VERSION).then(r=>r.json());
        const t=(state && state.last && state.last.current && state.last.current.time) ? state.last.current.time : (j.hourly && j.hourly.time ? j.hourly.time[0] : null);
        const aqi=valueAtHourLocal(j.hourly.time, j.hourly.us_aqi, t);
        const chip=$('#aqi'); const num=(aqi==null||Number.isNaN(aqi))?'‚Äî':String(Math.round(aqi));
        chip.textContent='Kvalita ovzdu≈°ia '+num+' ‚Ä¢ '+aqiCat(aqi);
      }catch(e){ $('#aqi').textContent='Kvalita ovzdu≈°ia ‚Äî'; }
    }

    function drawHourly(){
      const d=state.last || {}; const cur=d.current || {};
      const hours=(d.hourly && d.hourly.time) ? d.hourly.time : [];
      if(!hours.length) return;
      const key=localHourKey(cur.time || hours[0]);
      let i=hours.findIndex(h=>h.slice(0,13)===key); if(i<0)i=0;
      const labels=hours.slice(i,i+24).map(h=>h.split('T')[1]);
      const t24=(d.hourly && d.hourly.temperature_2m) ? d.hourly.temperature_2m.slice(i,i+24) : [];
      if(hourlyChart) try{ hourlyChart.destroy(); }catch(_){}
      if (window.Chart){
        hourlyChart=new Chart($('#hourly'),{
          type:'line',
          data:{labels, datasets:[{label:'Teplota (¬∞C)', data:t24, borderWidth:2, pointRadius:2, tension:.35}]},
          options:{responsive:true, maintainAspectRatio:false, interaction:{mode:'nearest', intersect:false},
            scales:{x:{grid:{color:'rgba(255,255,255,.08)'}}, y:{grid:{color:'rgba(255,255,255,.08)'}}},
            plugins:{legend:{display:false}}
          }
        });
      }
    }

    function pickDayCondition(d){
      const times=(d.hourly && d.hourly.time) ? d.hourly.time : [];
      const day=(d.current && d.current.time ? d.current.time : '').slice(0,10);
      let startH=9,endH=18;
      const sr=(d.daily && d.daily.sunrise && d.daily.sunrise[0]) ? d.daily.sunrise[0] : null;
      const ss=(d.daily && d.daily.sunset && d.daily.sunset[0]) ? d.daily.sunset[0] : null;
      if(sr && ss){
        const sh=new Date(sr).getHours(), eh=new Date(ss).getHours();
        if(!Number.isNaN(sh) && !Number.isNaN(eh) && sh<eh){startH=sh;endH=eh;}
      }
      const idxs=[]; for(let i=0;i<times.length;i++){ if(times[i].startsWith(day)){ const h=+times[i].slice(11,13); if(h>=startH && h<=endH) idxs.push(i); } }
      return modeCode((d.hourly && d.hourly.weather_code)||[], idxs) || 0;
    }

    /* ======= Predpoveƒè ‚Äì karty + klik panel ======= */
    const PART_LABELS=['Doobede','Poobede','Veƒçer','Noc'];
    function partWindow(base,label){
      const day=new Date(base); const start=new Date(day), end=new Date(day);
      if(label==='Doobede'){ start.setHours(9,0,0,0); end.setHours(12,0,0,0); }
      else if(label==='Poobede'){ start.setHours(12,0,0,0); end.setHours(17,0,0,0); }
      else if(label==='Veƒçer'){ start.setHours(17,0,0,0); end.setHours(22,0,0,0); }
      else { start.setHours(22,0,0,0); end.setDate(end.getDate()+1); end.setHours(6,0,0,0); }
      return {start,end};
    }

    const partDataStore={}; // label -> data
    function buildPartData(label){
      const d=state.last||{}; const H=d.hourly||{};
      const base=new Date((d.current && d.current.time) ? d.current.time : Date.now());
      const {start,end}=partWindow(base,label);
      const idx = indicesBetween(H.time||[], start, end);

      const tempMid = valueAtHourLocal(H.time, H.temperature_2m, new Date((start.getTime()+end.getTime())/2));
      const code = modeCode(H.weather_code||[], idx);
      const ico  = wmoEmoji(code, false);
      const pStats=precipStatsInRange(H, idx);

      const press = avg(H.pressure_msl||[], idx);
      const hum   = avg(H.relative_humidity_2m||[], idx);
      const dew   = avg(H.dew_point_2m||[], idx);

      const wspd  = avg(H.wind_speed_10m||[], idx);
      const wdir  = avg(H.wind_direction_10m||[], idx);
      const gust  = max(H.wind_gusts_10m||[], idx);

      const title = `${label} ‚Äî ${(WMO[code] && WMO[code][0] || '‚Äî').toLowerCase()}`;

      return {
        label, tempMid, icon:ico,
        pLine:formatPrecipLine(pStats),
        press, hum, dew, wspd, wdir, gust, title
      };
    }

    function renderParts(){
      const wrap=$('#parts'); wrap.innerHTML='';
      const d=state.last || {}; const base=new Date((d.current && d.current.time) ? d.current.time : Date.now());

      PART_LABELS.forEach((label)=>{
        const pdata=buildPartData(label); partDataStore[label]=pdata;

        const el=document.createElement('div'); el.className='col'; el.dataset.part=label;
        el.innerHTML=
          `<div class="c-top"><span class="c-top__inner">${label}</span></div>
           <div class="temps"><div class="c-max">${fmt0(pdata.tempMid,'¬∞')}</div></div>
           <div class="c-ico">${pdata.icon||'‚Äî'}</div>
           <div class="c-prob">üíß ${pdata.pLine.split('|')[0].trim()}</div>`;
        wrap.appendChild(el);
      });

      // panel je na zaƒçiatku skryt√Ω
      $('#infoWrap').classList.remove('open');

      // click (ignoruj poƒças ≈•ahania)
      wrap.addEventListener('click', (e)=>{
        if(wrap.classList.contains('dragging')) return;
        const card=e.target.closest('.col'); if(!card) return;
        const label=card.dataset.part;
        // toggle: ak u≈æ je vybran√° a panel je otvoren√Ω, zavri
        const alreadySel = card.classList.contains('sel') && $('#infoWrap').classList.contains('open');
        if(alreadySel){
          card.classList.remove('sel');
          $('#infoWrap').classList.remove('open');
          return;
        }
        selectPart(label, true);
      });

      enableDragScroll(wrap);
    }

    function selectPart(label, openPanel){
      const cards=[...document.querySelectorAll('#parts .col')];
      cards.forEach(c=>c.classList.toggle('sel', c.dataset.part===label));
      const d=partDataStore[label] || buildPartData(label);
      // panel
      $('.infoTitle').textContent = d.title;
      $('#pi_rain').textContent   = 'Zr√°≈æky: '+d.pLine;
      $('#pi_press').textContent  = 'Tlak vzduchu: '+fmt0(d.press, NBSP_NARROW+'hPa');
      $('#pi_hum').textContent    = 'Rel. vlhkos≈•: '+fmt0(d.hum, NBSP_NARROW+'%')+' ‚Ä¢ Rosn√Ω bod: '+fmt0(d.dew,'¬∞');
      const card = windDescriptor(d.wspd)+' zo '+windDirToCardinal(d.wdir)+' ('+fmt1(d.wspd, NBSP_NARROW+'km/h')+')';
      $('#pi_wind').textContent   = 'Vietor: '+card;
      $('#pi_gust').textContent   = 'N√°razy vetra: do '+fmt1(d.gust, NBSP_NARROW+'km/h');
      $('#pi_note').textContent   = '';
      if(openPanel) $('#infoWrap').classList.add('open');
    }

    /* ======= 7 dn√≠ ======= */
    function renderDays(data){
      const box=$('#days'); box.innerHTML='';
      const days=(data.daily || {}); const times=days.time || [];
      const n=Math.min(7,times.length);
      for(let i=0;i<n;i++){
        const dt=new Date(times[i]+'T00:00:00');
        const top=dt.toLocaleDateString('sk-SK',{weekday:'short'})+' '+dt.toLocaleDateString('sk-SK',{day:'2-digit',month:'2-digit'});
        const code=days.weather_code ? days.weather_code[i] : null;
        const maxT=days.temperature_2m_max ? days.temperature_2m_max[i] : null;
        const minT=days.temperature_2m_min ? days.temperature_2m_min[i] : null;
        const prob=days.precipitation_probability_max ? days.precipitation_probability_max[i] : null;
        const sum =days.precipitation_sum ? days.precipitation_sum[i] : null;
        const hrs =days.precipitation_hours ? days.precipitation_hours[i] : null;

        let line='‚Äî';
        if(sum!=null || prob!=null || hrs!=null){
          const hiMm=Number(sum||0), hiH=Number(hrs||0), p=Number(prob|| (hiMm>0?100:0));
          const loMm=hiMm*(p/100), loH=Math.round(hiH*(p/100));
          line = formatPrecipLine({prob:p, loMm, hiMm, loH, hiH});
        }

        const el=document.createElement('div'); el.className='col';
        el.innerHTML=
           `<div class="c-top"><span class="c-top__inner">${top}</span></div>
            <div class="temps"><div class="c-max">${fmt0(maxT,'¬∞')}</div></div>
            <div class="c-ico">${wmoEmoji(code,false)}</div>
            <div class="c-prob">üíß ${fmt0(prob, NBSP_NARROW+'%')}</div>`;
        el.title = 'Zr√°≈æky: '+line;
        box.appendChild(el);
      }
      enableDragScroll(box);
    }

    /* ======= 15-min ======= */
    function renderMin15(){
      const d=state.last || {}; const box=$('#min15'); box.innerHTML='';
      if(!(d.hourly && d.hourly.time && d.hourly.time.length)){ box.innerHTML='<div style="opacity:.8;color:#bcd1e5;padding:8px 10px;">Bez d√°t</div>'; return; }
      const start=new Date((d.current && d.current.time) ? d.current.time : d.hourly.time[0]);
      const m=start.getMinutes(); const add=(15-(m%15))%15; if(add>0) start.setMinutes(m+add,0,0);
      for(let k=0;k<96;k++){
        const t=new Date(start.getTime()+k*15*60*1000);
        const tmp=valueAt15min(d.hourly.time, d.hourly.temperature_2m, t);
        const prep=valueAt15min(d.hourly.time, d.hourly.precipitation, t);
        const code=codeAt15min(d.hourly.time, d.hourly.weather_code, t);
        const el=document.createElement('div'); el.className='col';
        el.innerHTML=
            `<div class="c-top"><span class="c-top__inner">${t.toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit'})}</span></div>
             <div class="temps"><div class="c-max">${fmt0(tmp,'¬∞')}</div></div>
             <div class="c-ico">${wmoEmoji(code, isNightAt(t,(state.last||{}).daily||{}))}</div>
             <div class="c-prob">üíß ${fmt0(prep, NBSP_NARROW+'mm/h')}</div>`;
        box.appendChild(el);
      }
      enableDragScroll(box);
    }

    /* ======= Drag ======= */
    function enableDragScroll(el){
      let isDown=false, startX=0, startScroll=0, lastX=0, lastT=0, vx=0;
      el.addEventListener('pointerdown', e=>{
        if(e.button!==0) return; isDown=true; startX=e.clientX; startScroll=el.scrollLeft; lastX=e.clientX; lastT=performance.now(); vx=0; el.classList.add('dragging'); el.setPointerCapture(e.pointerId); e.preventDefault()
      });
      el.addEventListener('pointermove', e=>{
        if(!isDown) return; const now=performance.now(); const dx=e.clientX-startX; el.scrollLeft = startScroll - dx; const ddx = e.clientX - lastX; const dt  = Math.max(1, now - lastT); vx = -(ddx/dt); lastX=e.clientX; lastT=now; e.preventDefault()
      });
      function momentum(v){ let velocity = v * 14; const friction = 0.92; function step(){ if(Math.abs(velocity) < 0.25) return; el.scrollLeft += velocity; velocity *= friction; if(el.scrollLeft<=0 || Math.ceil(el.scrollLeft)>=el.scrollWidth-el.clientWidth) return; requestAnimationFrame(step) } requestAnimationFrame(step) }
      el.addEventListener('pointerup', e=>{ if(!isDown) return; isDown=false; el.classList.remove('dragging'); try{ el.releasePointerCapture(e.pointerId) }catch(_){} momentum(vx) });
      el.addEventListener('pointercancel', ()=>{ isDown=false; el.classList.remove('dragging') });
      el.addEventListener('wheel', (e)=>{ const delta = Math.abs(e.deltaY) > Math.abs(e.deltaX) ? e.deltaY : e.deltaX; el.scrollLeft += delta * 0.6; e.preventDefault() }, {passive:false});
    }

    /* ======= Hist√≥ria ======= */
    async function fetchHistory(){
      try{
        const baseTime=(state && state.last && state.last.current && state.last.current.time) ? new Date(state.last.current.time) : new Date();
        const lastYear=new Date(baseTime); lastYear.setFullYear(lastYear.getFullYear()-1);
        const day=lastYear.toISOString().slice(0,10);
        $('#hist-date').textContent=new Intl.DateTimeFormat('sk-SK',{dateStyle:'full'}).format(lastYear);
        const p=new URLSearchParams({latitude:state.lat, longitude:state.lon, start_date:day, end_date:day, daily:'weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum', timezone:'auto'});
        const j=await fetch('https://archive-api.open-meteo.com/v1/archive?'+p+'&v='+APP_VERSION).then(r=>r.json());
        const dd=j.daily || {};
        const code=dd.weather_code ? dd.weather_code[0] : null;
        const tmax=dd.temperature_2m_max ? dd.temperature_2m_max[0] : null;
        const tmin=dd.temperature_2m_min ? dd.temperature_2m_min[0] : null;
        const pr=(dd.precipitation_sum && dd.precipitation_sum[0]!=null) ? dd.precipitation_sum[0] : 0;
        const avgT = (tmax!=null && tmin!=null) ? (tmax+tmin)/2 : null;
        $('#hist-emoji').textContent=wmoEmoji(code,false);
        $('#hist-text').textContent=(WMO[code] && WMO[code][0])||'‚Äî';
        $('#hist-max').textContent=fmt1(tmax,'¬∞C');
        $('#hist-min').textContent=fmt1(tmin,'¬∞C');
        $('#hist-extra').textContent=pr>0?('Zr√°≈æky: '+fmt1(pr, NBSP_NARROW+'mm')):'Bez zr√°≈æok.';
      }catch(e){
        $('#hist-extra').textContent='Hist√≥riu sa nepodarilo naƒç√≠ta≈•.';
      }
    }

    /* ======= vyhƒæad√°vanie ======= */
    let timer;
    $('#q').addEventListener('input', e=>{
      const q=e.target.value.trim(); clearTimeout(timer);
      if(q.length<2){ $('#suggestions').style.display='none'; return }
      timer=setTimeout(async ()=>{
        const url='https://geocoding-api.open-meteo.com/v1/search?name='+encodeURIComponent(q)+'&count=6&language=sk&format=json';
        const res=await fetch(url).then(r=>r.json()).catch(()=>({}));
        const arr=res.results||[];
        const box=$('#suggestions'); box.innerHTML=''; box.style.display='grid';
        if(!arr.length){ box.innerHTML='<div class="sugg">Niƒç sa nena≈°lo</div>'; return }
        arr.forEach(p=>{
          const b=document.createElement('div'); b.className='sugg';
          b.textContent=p.name+(p.admin1?(', '+p.admin1):'')+', '+p.country_code;
          b.addEventListener('click', ()=>{ setLocation(p.latitude,p.longitude,b.textContent); box.style.display='none' });
          box.appendChild(b);
        });
      },250);
    });
    document.addEventListener('click', e=>{ const box=$('#suggestions'); if(box && !box.contains(e.target) && e.target!==$('#q')) box.style.display='none' });
    document.getElementById('year').textContent=new Date().getFullYear();

    /* init */
    function initDragBars(){ ['days','min15'].forEach(id=>{ const el=document.getElementById(id); if(el){ enableDragScroll(el) } }) }
    initGeolocation();
    window.addEventListener('resize', ()=>{ if(state.last){ drawHourly(); renderMin15() }});
    setTimeout(()=>{ if(!state.last) fetchWeather().catch(()=>toast('Naƒç√≠tanie poƒçasia zlyhalo')) },1200);
    initDragBars();

    if(!window.__wx_auto_refresh){
      window.__wx_auto_refresh=setInterval(()=>{ if(state.lat && state.lon){ fetchWeather().catch(()=>{}); fetchAQ().catch(()=>{}) } }, 5*60*1000);
    }
  </script>
</body>
</html>

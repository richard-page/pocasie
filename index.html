<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Počasie</title>
<link rel="icon" type="image/png" href="favicon.png" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg0:#0b0f14; --bg1:#0e1620; --panel:#152433; --stroke:#233448;
    --txt:#eaf3ff; --muted:#a8bed5; --accent:#3ad0e6;
    --r:14px; --shadow:0 10px 28px rgba(0,0,0,.28);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--txt);
    font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:linear-gradient(180deg,var(--bg1),var(--bg0));
    min-height:100dvh; display:flex; flex-direction:column; overflow-x:hidden;
    -webkit-text-size-adjust:100%; -webkit-tap-highlight-color:transparent;
  }

  .wrap{width:100%; max-width:1120px; margin-inline:auto; padding:16px 12px 28px; flex:1}
  header h1{margin:0 0 10px; text-align:center; font-size:28px; letter-spacing:.3px}

  .toolbar{display:grid; grid-template-columns:1fr; gap:10px; margin:10px 0 12px}
  .searchCol{display:flex; flex-direction:column; gap:6px; position:relative}
  .search{
    width:100%; background:#152535; border:1px solid var(--stroke); color:#fff;
    border-radius:12px; padding:12px 14px; outline:none; font-size:16px; min-height:46px;
  }
  .search:focus{border-color:#2e4a67}
  #suggestions{
    display:none; gap:6px; position:absolute; top:calc(100% + 6px); left:0; right:0; z-index:40;
    background:#0f1c2a; border:1px solid var(--stroke); border-radius:12px; padding:8px; max-height:55vh; overflow:auto;
  }
  .sugg{background:#13263a; border:1px solid var(--stroke); border-radius:10px; padding:10px 12px; cursor:pointer}

  .pill{
    background:#1b2c3d; border:1px solid var(--stroke); color:#dfeaff; border-radius:12px;
    padding:10px 12px; font-weight:600; cursor:pointer; min-height:40px; font-size:14px; text-align:center
  }
  .pill.active{background:var(--accent); border-color:#2abbd0; color:#002a32}

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid var(--stroke); border-radius:var(--r); box-shadow:var(--shadow); padding:14px;
  }
  .card h3{margin:0 0 10px; text-align:center; font-size:18px}

  #place{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .row{display:grid; grid-template-columns:1fr; gap:12px; margin-top:4px}
  .meta{display:grid; grid-template-columns:1fr; gap:8px; color:var(--muted); font-size:14px}
  .meta strong{color:#fff}

  /* Stabilné chipy AQI/UV */
  .chipRow{display:grid; grid-template-columns:1fr 1fr; gap:8px; align-items:center; min-height:34px}
  .chip{display:flex; align-items:center; justify-content:center; gap:8px;
        background:#143344; border:1px solid var(--stroke); color:#d8f7ff; border-radius:999px;
        padding:6px 10px; font-size:12px; min-height:28px; white-space:nowrap}
  #uv,#aqi{min-width:0}

  .tempNow{font-size:44px; font-weight:700; line-height:1; margin:6px 0}
  .icon{width:64px; height:64px; display:flex; align-items:center; justify-content:center; font-size:48px}
  .gridInfo{display:grid; grid-template-columns:1fr auto; gap:14px; align-items:start}

  .chartWrap{height:220px}
  canvas{background:#0f1c2a; border:1px solid var(--stroke); border-radius:12px}

  .summarySection{margin-top:12px}
  .summarySection h3{margin-bottom:8px}
  #summary{margin:0 auto; max-width:720px; color:#dbeeff; background:#0f1c2a; border:1px solid var(--stroke); border-radius:10px; padding:12px; text-align:center}

  .histRow{display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap}
  .badge{display:inline-block; padding:6px 10px; border-radius:10px; font-weight:700}
  .badge.max{background:#ff5e5e; color:#fff}
  .badge.min{background:#ffd265; color:#2b2300}
  .histSub{color:#a8bed5; font-size:12px; margin-top:6px; text-align:center}

  footer{padding:14px 10px; text-align:center; color:#cfe8ff; font-size:14px; border-top:1px solid rgba(255,255,255,.12)}

  /* === STĹPCE === */
  .colset{display:grid; gap:12px}
  .col{
    background:var(--panel); border:1px solid var(--stroke); border-radius:12px; padding:10px;
    display:grid; grid-template-rows:auto auto auto auto auto auto; align-items:center; justify-items:center;
    text-align:center; overflow:hidden; min-height:176px; contain:content;
  }
  .c-top,.c-row{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .c-top{opacity:.9}
  .c-max{font-size:26px; font-weight:700; color:#ff6c6c; margin-top:6px; line-height:1}
  .c-min{font-size:16px; color:#ffbb7c; margin-top:2px; line-height:1}
  .c-ico{font-size:26px; margin-top:6px}
  .c-row{color:#cfe6ff; font-size:12px; margin-top:6px; line-height:1.15}

  /* Mobil: viac stĺpcov + scroll, nič nie je orezané */
  @media (max-width:900px){
    .colset{
      --gap:8px; --cols:5; gap:var(--gap);
      grid-auto-flow:column;
      grid-auto-columns:max(112px, calc((100% - (var(--cols) - 1)*var(--gap))/var(--cols)));
      overflow-x:auto; padding:0 2px 8px;
      scroll-snap-type:x mandatory; scroll-padding-inline:2px;
      -webkit-overflow-scrolling:touch; touch-action:pan-x; overscroll-behavior-x:contain; scrollbar-width:none
    }
    .colset::-webkit-scrollbar{display:none}
    .col{scroll-snap-align:start; padding:8px}
    .c-top{font-size:13px}
    .c-max{font-size:22px}
    .c-min{font-size:14px}
    .c-ico{font-size:22px}
    .c-row{font-size:11px}
  }

  /* Desktop rozloženie */
  @media (min-width:900.1px){
    #parts.colset{grid-template-columns:repeat(4,minmax(0,1fr))}
    #days.colset{grid-template-columns:repeat(7,minmax(0,1fr))}
    #min15.colset{grid-auto-flow:column; grid-auto-columns:minmax(110px,1fr);
                  overflow-x:auto; padding-bottom:6px; scroll-snap-type:x proximity; touch-action:pan-x}
    #min15.colset::-webkit-scrollbar{height:8px}
  }

  @media (min-width:780px){
    .wrap{padding:22px 16px 36px}
    .row{grid-template-columns:1.05fr 1fr; gap:16px}
    .meta{grid-template-columns:repeat(2,minmax(0,1fr))}
    .chartWrap{height:260px}
  }
  @media (min-width:1100px){ .chartWrap{height:300px} }
</style>
</head>

<body>
  <div class="wrap">
    <header><h1>Počasie</h1></header>

    <div class="toolbar">
      <div class="searchCol">
        <input id="q" class="search" type="text" placeholder="Hľadaj mesto (napr. Bratislava, Košice)" />
        <div id="suggestions"></div>
      </div>
    </div>

    <div class="row">
      <section class="card">
        <div class="gridInfo">
          <div>
            <h3 id="place">Bratislava, SK</h3>
            <div id="time" style="color:var(--muted);font-size:14px">—</div>
            <div class="tempNow" id="temp">—°</div>

            <div class="chipRow">
              <span class="chip" id="uv">UV index —</span>
              <span class="chip" id="aqi">Kvalita ovzdušia —</span>
            </div>

            <div class="meta" style="margin-top:8px">
              <div>Pocitová teplota: <strong id="apparent">—</strong></div>
              <div>Vietor: <strong id="wind">—</strong></div>
              <div>Vlhkosť: <strong id="hum">—</strong></div>
              <div>Tlak: <strong id="press">—</strong></div>
              <div>Východ slnka: <strong id="sunrise">—</strong></div>
              <div>Západ slnka: <strong id="sunset">—</strong></div>
            </div>
          </div>
          <div id="icon" class="icon">—</div>
        </div>

        <div class="summarySection">
          <h3>Dnešný súhrn</h3>
          <p id="summary">—</p>
        </div>
      </section>

      <section class="card">
        <h3>Teplota počas 24 hodín</h3>
        <div class="chartWrap"><canvas id="hourly"></canvas></div>
      </section>
    </div>

    <section class="card" style="margin-top:12px">
      <h3>Predpoveď</h3>
      <div id="parts" class="colset"></div>
    </section>

    <section class="card" style="margin-top:12px">
      <h3 style="margin-bottom:8px">7-dňová predpoveď</h3>
      <div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <button class="pill" id="tab-ecmwf">ECMWF IFS</button>
        <button class="pill" id="tab-icon">ICON (DWD)</button>
        <button class="pill" id="tab-gfs">GFS (NOAA)</button>
      </div>
      <div id="days" class="colset"></div>
    </section>

    <section class="card" style="margin-top:12px">
      <h3>15-minútová predpoveď (24 h)</h3>
      <div id="min15" class="colset"></div>
    </section>

    <section class="card" style="margin-top:12px">
      <div class="head" style="text-align:center">
        <h3>Počasie presne pred rokom</h3>
        <div id="hist-date" style="color:var(--muted);font-size:12px">—</div>
      </div>
      <div class="histRow" style="margin-top:6px">
        <div id="hist-emoji" style="font-size:26px">—</div>
        <div style="font-weight:700" id="hist-text">—</div>
        <span class="badge max" id="hist-max">—</span>
        <span class="badge min" id="hist-min">—</span>
      </div>
      <div class="histSub" id="hist-extra">—</div>
    </section>
  </div>

  <footer>&copy; <span id="year"></span> Richard / Počasie</footer>

  <script>
    const APP_VERSION = '2025-08-14-fixes-v2';
    const $ = s => document.querySelector(s);
    const fmt0 = (v,u='') => (v==null || Number.isNaN(v)) ? '—' : `${Math.round(v)}${u}`;
    const fmt1 = (v,u='') => (v==null || Number.isNaN(v)) ? '—' : `${(Math.round(v*10)/10).toFixed(1)}${u}`;

    const WMO = {0:['Jasno'],1:['Prevažne jasno'],2:['Polojasno'],3:['Zamračené'],
      45:['Hmla'],48:['Mrznúca hmla'],51:['Slabé mrholenie'],53:['Mrholenie'],55:['Silné mrholenie'],
      61:['Slabý dážď'],63:['Dážď'],65:['Lejak'],66:['Mrznúci dážď'],67:['Mrznúci dážď'],
      71:['Slabé sneženie'],73:['Sneženie'],75:['Silné sneženie'],77:['Snehové zrná'],
      80:['Prehánky'],81:['Prehánky'],82:['Silné prehánky'],85:['Snehové prehánky'],86:['Silné snehové prehánky'],
      95:['Búrky'],96:['Búrky s krúpami'],99:['Silné búrky s krúpami']};

    const uvCat = u => u<3?'nízky':u<6?'mierny':u<8?'vysoký':u<11?'veľmi vysoký':'extrémny';

    function wmoEmoji(code, night=false){
      const k = Number(code);
      if ([0,1].includes(k)) return night ? '🌙' : '☀️';
      if (k===2) return night ? '🌙' : '⛅';
      if (k===3) return '☁️';
      if ([45,48].includes(k)) return '🌫️';
      if ([51,53,55].includes(k)) return '🌦️';
      if ([61,63,65,80,81,82].includes(k)) return '🌧️';
      if ([71,73,75,77,85,86].includes(k)) return '❄️';
      if ([95,96,99].includes(k)) return '⛈️';
      return night ? '🌙' : '🌤️';
    }

    function isNightAt(dtLike, daily){
      const dt = typeof dtLike==='string' ? new Date(dtLike) : dtLike;
      try{
        const dayStr = dt.toISOString().slice(0,10);
        const i = daily?.time?.indexOf(dayStr);
        if (i>=0 && daily.sunrise?.[i] && daily.sunset?.[i]){
          const sr = new Date(daily.sunrise[i]);
          const ss = new Date(daily.sunset[i]);
          return (dt < sr || dt >= ss);
        }
      }catch(_){}
      const h = dt.getHours(); return (h<6 || h>=21);
    }

    // ***** DÔLEŽITÉ: kľúč hodiny v LOKÁLNOM čase (nie UTC) *****
    const pad = n => String(n).padStart(2,'0');
    function localHourKey(date){
      const d = typeof date==='string' ? new Date(date) : new Date(date);
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}`;
    }
    function valueAtHourLocal(timesISO, arr, date){
      const key = localHourKey(date);
      let idx = timesISO.findIndex(t => t.slice(0,13) === key);
      if (idx >= 0) return arr[idx];
      // fallback – najbližšia hodina
      let best=0, bestDiff=1e18;
      timesISO.forEach((t,i)=>{ const diff=Math.abs(new Date(t)-new Date(date)); if(diff<bestDiff){best=i;bestDiff=diff;}});
      return arr[best];
    }

    // 15-min interpolácia
    const lerp=(a,b,t)=>a+(b-a)*t;
    function valueAt15min(timesISO, arr, date){
      const ts=timesISO.map(t=>new Date(t));
      for(let i=0;i<ts.length-1;i++){
        const t0=ts[i], t1=ts[i+1];
        if(date>=t0 && date<=t1){
          const r=(date-t0)/(t1-t0), v0=arr[i], v1=arr[i+1];
          if(v0==null || v1==null) return null;
          return lerp(v0,v1,r);
        }
      }
      return null;
    }
    function codeAt15min(timesISO, codes, date){
      const ts=timesISO.map(t=>new Date(t));
      for(let i=0;i<ts.length-1;i++){
        const t0=ts[i], t1=ts[i+1];
        if(date>=t0 && date<=t1){ return (date < new Date((t0+t1)/2)) ? codes[i] : codes[i+1]; }
      }
      return codes[codes.length-1] ?? 0;
    }

    function pickDayCondition(d){
      const times=d.hourly?.time||[], codes=d.hourly?.weather_code||[];
      const day=(d.current?.time||'').slice(0,10); let startH=9,endH=18;
      const sr=d.daily?.sunrise?.[0], ss=d.daily?.sunset?.[0];
      if(sr && ss){ const sh=new Date(sr).getHours(), eh=new Date(ss).getHours(); if(sh<eh){startH=sh;endH=eh;} }
      const freq=new Map();
      for(let i=0;i<times.length;i++){
        if(!times[i].startsWith(day)) continue;
        const h=Number(times[i].slice(11,13)); if(h<startH || h>endH) continue;
        const c=codes[i]??0; freq.set(c,(freq.get(c)||0)+1);
      }
      let best=d.daily?.weather_code?.[0] ?? codes[0] ?? 0, bestCnt=-1;
      freq.forEach((cnt,code)=>{ if(cnt>bestCnt){bestCnt=cnt;best=code;} });
      return best;
    }

    function aqiCat(v){
      if(v==null||Number.isNaN(v)) return '—';
      if(v<=50) return 'dobrá'; if(v<=100) return 'mierne zhoršená';
      if(v<=150) return 'riziková'; if(v<=200) return 'zlá';
      if(v<=300) return 'veľmi zlá'; return 'nebezpečná';
    }

    let state={place:'Bratislava, SK', lat:48.1486, lon:17.1077, last:null};
    let hourlyChart=null, activeModel='ecmwf';
    const LS_KEY='wx_prefs_v3';

    // obnova preferencií
    try{ const raw=localStorage.getItem(LS_KEY); if(raw){ const p=JSON.parse(raw); if(+p.lat && +p.lon && p.place){ state={...state, ...p}; } } }catch(_){}
    const savePrefs=()=>{ try{ localStorage.setItem(LS_KEY, JSON.stringify({lat:state.lat, lon:state.lon, place:state.place})); }catch(_){} };

    async function reverseGeocode(lat,lon){
      try{
        const j = await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=sk&format=json`).then(r=>r.json());
        const r=j?.results?.[0]; if(r){ return `${r.name || r.admin1 || ''}${r.country_code?`, ${r.country_code}`:''}`.trim(); }
      }catch(_){}
      return `${lat.toFixed(3)}, ${lon.toFixed(3)}`;
    }
    async function setLocation(lat,lon,labelOpt){ state.lat=lat; state.lon=lon; state.place=labelOpt || await reverseGeocode(lat,lon); savePrefs(); await fetchWeather().catch(e=>alert(e.message)); }

    function initGeolocation(){
      if(!('geolocation'in navigator)){ fetchWeather().catch(()=>{}); return; }
      const placeEl=$('#place'); const prev=placeEl.textContent; placeEl.textContent='Zisťujem polohu…';
      navigator.geolocation.getCurrentPosition(async pos=>{ const {latitude,longitude}=pos.coords; await setLocation(latitude,longitude); }, _=>{ placeEl.textContent=prev; fetchWeather().catch(()=>{}); }, {enableHighAccuracy:true, timeout:10000, maximumAge:300000});
    }

    async function fetchWeather(){
      const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;
      const p=new URLSearchParams({
        latitude:state.lat, longitude:state.lon, timezone:tz,
        current:'temperature_2m,apparent_temperature,relative_humidity_2m,pressure_msl,wind_speed_10m,weather_code,uv_index',
        hourly:'temperature_2m,precipitation,weather_code,wind_speed_10m',
        daily:'weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,precipitation_sum,uv_index_max,wind_speed_10m_max,sunrise,sunset',
        forecast_days:'3'
      });
      const r=await fetch(`https://api.open-meteo.com/v1/forecast?${p}&v=${APP_VERSION}`);
      state.last=await r.json();
      renderAll(); drawHourly(); await fetchAQ().catch(()=>{}); fetchModels(activeModel); fetchHistory().catch(()=>{});
    }

    function renderAll(){
      const d=state.last, cur=d.current, tz=d.timezone;
      $('#place').textContent=state.place;
      $('#time').textContent=new Intl.DateTimeFormat('sk-SK',{dateStyle:'medium',timeStyle:'short',timeZone:tz}).format(new Date(cur.time));
      $('#temp').textContent=fmt0(cur.temperature_2m,'°');
      $('#apparent').textContent=fmt0(cur.apparent_temperature,'°');
      $('#wind').textContent=fmt1(cur.wind_speed_10m,' km/h');
      $('#hum').textContent=fmt0(cur.relative_humidity_2m,'%');
      $('#press').textContent=fmt0(cur.pressure_msl,' hPa');
      $('#icon').textContent=wmoEmoji(cur.weather_code, isNightAt(cur.time, d.daily));

      const uvi=(cur.uv_index ?? d.daily?.uv_index_max?.[0] ?? null);
      $('#uv').textContent = uvi!=null ? `UV index ${fmt1(uvi)} • ${uvCat(uvi)}` : 'UV index —';

      const dd=d.daily, tmax=dd.temperature_2m_max[0], tmin=dd.temperature_2m_min[0], ps=dd.precipitation_sum[0], pp=dd.precipitation_probability_max?.[0], wmax=dd.wind_speed_10m_max[0];
      const condToday=(WMO[pickDayCondition(d)]?.[0])||'—';
      const rainTxt = ps < 0.1 ? (pp && pp>20 ? `bez výraznych zrážok (pravdepodobnosť ${pp}%)` : 'bez zrážok') : `zrážky do ${fmt1(ps,' mm')}`;
      const uvTxt = dd.uv_index_max?.[0]!=null ? `UV ${uvCat(dd.uv_index_max[0])} (max ${fmt1(dd.uv_index_max[0])})` : 'UV údaj nedostupný';
      $('#summary').innerHTML=`Dnes <strong>${condToday.toLowerCase()}</strong>, max <strong>${fmt0(tmax,'°')}</strong>, min <strong>${fmt0(tmin,'°')}</strong>, ${rainTxt}, vietor do <strong>${fmt1(wmax,' km/h')}</strong>, ${uvTxt}.`;

      const sr=dd.sunrise?.[0]?new Date(dd.sunrise[0]):null, ss=dd.sunset?.[0]?new Date(dd.sunset[0]):null;
      $('#sunrise').textContent=sr?sr.toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit'}):'—';
      $('#sunset').textContent=ss?ss.toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit'}):'—';

      renderParts(); renderMin15();
    }

    async function fetchAQ(){
      try{
        const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;
        const p=new URLSearchParams({latitude:state.lat, longitude:state.lon, timezone:tz, hourly:'us_aqi,pm2_5,pm10'});
        const j=await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?${p}&v=${APP_VERSION}`).then(r=>r.json());
        const t=(state?.last?.current?.time)||j.hourly.time[0];
        const aqi=valueAtHourLocal(j.hourly.time, j.hourly.us_aqi, t);
        const chip=$('#aqi'); const num=(aqi==null||Number.isNaN(aqi))?'—':String(Math.round(aqi));
        chip.textContent=`Kvalita ovzdušia ${num} • ${aqiCat(aqi)}`;
      }catch(_){ $('#aqi').textContent='Kvalita ovzdušia —'; }
    }

    function drawHourly(){
      const d=state.last, cur=d.current, hours=d.hourly.time, key=localHourKey(cur.time);
      let i=hours.findIndex(h=>h.slice(0,13)===key); if(i<0)i=0;
      const labels=hours.slice(i,i+24).map(h=>h.split('T')[1]);
      const t24=d.hourly.temperature_2m.slice(i,i+24);
      if(hourlyChart) hourlyChart.destroy();
      hourlyChart=new Chart($('#hourly'),{
        type:'line',
        data:{labels, datasets:[{label:'Teplota (°C)', data:t24, borderWidth:2, pointRadius:2, tension:.35}]},
        options:{responsive:true, maintainAspectRatio:false, interaction:{mode:'nearest', intersect:false},
          scales:{x:{grid:{color:'rgba(255,255,255,.08)'}}, y:{grid:{color:'rgba(255,255,255,.08)'}}},
          plugins:{legend:{labels:{color:'#fff'}, onClick:()=>{}, onHover:(e)=>{if(e&&e.native) e.native.target.style.cursor='default';}}}}
      });
    }

    function renderParts(){
      const wrap=$('#parts'); wrap.innerHTML='';
      const d=state.last; const base=new Date(d.current.time);
      function slot(dt,label){
        const temp=valueAtHourLocal(d.hourly.time, d.hourly.temperature_2m, dt);
        const pr=valueAtHourLocal(d.hourly.time, d.hourly.precipitation, dt);
        const wind=valueAtHourLocal(d.hourly.time, d.hourly.wind_speed_10m, dt);
        const code=valueAtHourLocal(d.hourly.time, d.hourly.weather_code, dt);
        const el=document.createElement('div'); el.className='col';
        el.innerHTML=`<div class="c-top">${label}</div>
                      <div class="c-max">${fmt0(temp,'°')}</div>
                      <div class="c-min">${temp!=null?fmt0(temp-5,'°'):'—'}</div>
                      <div class="c-ico">${wmoEmoji(code, isNightAt(dt, d.daily))}</div>
                      <div class="c-row">Zrážky ${fmt0(pr,' mm/h')}</div>
                      <div class="c-row">Vietor ${fmt0(wind,' km/h')}</div>`;
        wrap.appendChild(el);
      }
      const doobeda=new Date(base); doobeda.setHours(10,0,0,0); slot(doobeda,'Doobeda');
      const poobede=new Date(base); poobede.setHours(15,0,0,0); slot(poobede,'Poobede');
      const sunset=d.daily?.sunset?.[0]?new Date(d.daily.sunset[0]):null;
      const vecer=sunset?new Date(sunset.getTime()+30*60*1000):(h=>{const t=new Date(base); t.setHours(21,0,0,0); return t;})();
      slot(vecer,'Večer');
      const noc=new Date(base); noc.setDate(base.getDate()+1); noc.setHours(2,0,0,0); slot(noc,'Noc');
    }

    function renderDays(d){
      const box=$('#days'); box.innerHTML=''; const days=d.daily; const n=Math.min(7,days.time.length);
      for(let i=0;i<n;i++){
        const dt=new Date(days.time[i]+'T00:00:00');
        const top=`${dt.toLocaleDateString('sk-SK',{weekday:'short'})} ${dt.toLocaleDateString('sk-SK',{day:'2-digit',month:'2-digit'})}`;
        const code=days.weather_code?.[i], max=days.temperature_2m_max[i], min=days.temperature_2m_min[i], pp=days.precipitation_probability_max?.[i];
        const el=document.createElement('div'); el.className='col';
        el.innerHTML=`<div class="c-top">${top}</div>
                      <div class="c-max">${fmt0(max,'°')}</div>
                      <div class="c-min">${fmt0(min,'°')}</div>
                      <div class="c-ico">${wmoEmoji(code,false)}</div>
                      <div class="c-row">💧 ${pp!=null?pp+' %':'—'}</div>
                      <div class="c-row"></div>`;
        box.appendChild(el);
      }
    }

    function renderMin15(){
      const d=state.last, box=$('#min15'); box.innerHTML='';
      if(!d?.hourly?.time?.length){ box.innerHTML='<div style="opacity:.8;color:#bcd1e5;padding:8px 10px;">Bez dát</div>'; return; }
      const start=new Date(d.current.time); const m=start.getMinutes(); const add=(15-(m%15))%15; if(add>0) start.setMinutes(m+add,0,0);
      for(let k=0;k<96;k++){
        const t=new Date(start.getTime()+k*15*60*1000);
        const tmp=valueAt15min(d.hourly.time, d.hourly.temperature_2m, t);
        const prep=valueAt15min(d.hourly.time, d.hourly.precipitation, t);
        const code=codeAt15min(d.hourly.time, d.hourly.weather_code, t);
        const wind=valueAt15min(d.hourly.time, d.hourly.wind_speed_10m, t);
        const el=document.createElement('div'); el.className='col';
        el.innerHTML=`<div class="c-top">${t.toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit'})}</div>
                      <div class="c-max">${fmt0(tmp,'°')}</div>
                      <div class="c-min">${tmp!=null?fmt0(tmp-5,'°'):'—'}</div>
                      <div class="c-ico">${wmoEmoji(code, isNightAt(t,d.daily))}</div>
                      <div class="c-row">Zrážky ${prep!=null?fmt0(prep,' mm/h'):'—'}</div>
                      <div class="c-row">Vietor ${wind!=null?fmt0(wind,' km/h'):'—'}</div>`;
        box.appendChild(el);
      }
    }

    async function fetchModels(which){
      activeModel=which;
      ['ecmwf','icon','gfs'].forEach(id=>{ const btn=document.querySelector(`#tab-${id}`); if(btn) btn.classList.toggle('active', id===which); });
      const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;
      const daily='weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max';
      const base = which==='ecmwf' ? 'https://api.open-meteo.com/v1/ecmwf'
                 : which==='icon'  ? 'https://api.open-meteo.com/v1/dwd-icon'
                 : 'https://api.open-meteo.com/v1/gfs';
      try{
        const j=await fetch(`${base}?${new URLSearchParams({latitude:state.lat, longitude:state.lon, timezone:tz, daily, forecast_days:'7'})}&v=${APP_VERSION}`).then(r=>r.json());
        renderDays(j);
      }catch(_){ $('#days').innerHTML='<div style="color:#ffd4d4">Model sa nepodarilo načítať.</div>'; }
    }

    async function fetchHistory(){
      try{
        const baseTime=state?.last?.current?.time ? new Date(state.last.current.time) : new Date();
        const lastYear=new Date(baseTime); lastYear.setFullYear(lastYear.getFullYear()-1);
        const day=lastYear.toISOString().slice(0,10); $('#hist-date').textContent=new Intl.DateTimeFormat('sk-SK',{dateStyle:'full'}).format(lastYear);
        const p=new URLSearchParams({latitude:state.lat, longitude:state.lon, start_date:day, end_date:day, daily:'weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum', timezone:'auto'});
        const j=await fetch(`https://archive-api.open-meteo.com/v1/archive?${p}&v=${APP_VERSION}`).then(r=>r.json());
        const dd=j.daily, code=dd.weather_code[0], tmax=dd.temperature_2m_max[0], tmin=dd.temperature_2m_min[0], pr=dd.precipitation_sum?.[0]??0;
        $('#hist-emoji').textContent=wmoEmoji(code,false); $('#hist-text').textContent=(WMO[code]?.[0])||'—';
        $('#hist-max').textContent=`${fmt1(tmax)}°C`; $('#hist-min').textContent=`${fmt1(tmin)}°C`; $('#hist-extra').textContent=pr>0?`Zrážky: ${fmt1(pr,' mm')}`:'Bez zrážok.';
      }catch(_){ $('#hist-extra').textContent='Históriu sa nepodarilo načítať.'; }
    }

    // vyhľadávanie miest
    let timer;
    $('#q').addEventListener('input', e=>{
      const q=e.target.value.trim(); clearTimeout(timer);
      if(q.length<2){ $('#suggestions').style.display='none'; return; }
      timer=setTimeout(async ()=>{
        const url=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=6&language=sk&format=json`;
        const res=await fetch(url).then(r=>r.json()).catch(()=>({})); const arr=res.results||[];
        const box=$('#suggestions'); box.innerHTML=''; box.style.display='grid';
        if(!arr.length){ box.innerHTML='<div class="sugg">Nič sa nenašlo</div>'; return; }
        arr.forEach(p=>{
          const b=document.createElement('div'); b.className='sugg';
          b.textContent=`${p.name}${p.admin1?`, ${p.admin1}`:''}, ${p.country_code}`;
          b.addEventListener('click', ()=>{ setLocation(p.latitude,p.longitude,b.textContent); box.style.display='none'; });
          box.appendChild(b);
        });
      },250);
    });
    document.addEventListener('click', e=>{ const box=$('#suggestions'); if(box && !box.contains(e.target) && e.target!==$('#q')) box.style.display='none'; });

    // prepínače modelov
    document.getElementById('tab-ecmwf').addEventListener('click', ()=>fetchModels('ecmwf'));
    document.getElementById('tab-icon').addEventListener('click',  ()=>fetchModels('icon'));
    document.getElementById('tab-gfs').addEventListener('click',   ()=>fetchModels('gfs'));

    document.getElementById('year').textContent=new Date().getFullYear();

    initGeolocation();
    window.addEventListener('resize', ()=>{ if(state.last){ drawHourly(); renderMin15(); }});
    setTimeout(()=>{ if(!state.last) fetchWeather().catch(()=>{}); },1200);
    fetchModels('ecmwf');

    if(!window.__wx_auto_refresh){
      window.__wx_auto_refresh=setInterval(()=>{
        if(state.lat && state.lon){ fetchWeather().catch(()=>{}); fetchAQ().catch(()=>{}); }
      }, 5*60*1000);
    }
  </script>
</body>
</html>
